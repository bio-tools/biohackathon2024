<?DTDIdentifier.IdentifierValue article.dtd?>
<?DTDIdentifier.IdentifierType system?>
<?SourceDTD.DTDName article.dtd?>
<?SourceDTD.Version 1.0?>
<?ConverterInfo.XSLTName bmc2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">BMC Genomics</journal-id>
    <journal-id journal-id-type="iso-abbrev">BMC Genomics</journal-id>
    <journal-title-group>
      <journal-title>BMC Genomics</journal-title>
    </journal-title-group>
    <issn pub-type="epub">1471-2164</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">3548766</article-id>
    <article-id pub-id-type="publisher-id">1471-2164-13-689</article-id>
    <article-id pub-id-type="pmid">23228338</article-id>
    <article-id pub-id-type="doi">10.1186/1471-2164-13-689</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Software</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>OSAT: a tool for sample-to-batch allocations in genomics experiments</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes" id="A1">
        <name>
          <surname>Yan</surname>
          <given-names>Li</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>Li.Yan@RoswellPark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A2">
        <name>
          <surname>Ma</surname>
          <given-names>Changxing</given-names>
        </name>
        <xref ref-type="aff" rid="I2">2</xref>
        <email>cxma@buffalo.edu</email>
      </contrib>
      <contrib contrib-type="author" id="A3">
        <name>
          <surname>Wang</surname>
          <given-names>Dan</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>Dan.Wang@RoswellPark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A4">
        <name>
          <surname>Hu</surname>
          <given-names>Qiang</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>Qiang.Hu@RoswellPark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A5">
        <name>
          <surname>Qin</surname>
          <given-names>Maochun</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>Maochun.Qin@RoswellPark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A6">
        <name>
          <surname>Conroy</surname>
          <given-names>Jeffrey M</given-names>
        </name>
        <xref ref-type="aff" rid="I3">3</xref>
        <email>Jeffrey.Conroy@roswellpark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A7">
        <name>
          <surname>Sucheston</surname>
          <given-names>Lara E</given-names>
        </name>
        <xref ref-type="aff" rid="I4">4</xref>
        <email>Lara.Sucheston@roswellpark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A8">
        <name>
          <surname>Ambrosone</surname>
          <given-names>Christine B</given-names>
        </name>
        <xref ref-type="aff" rid="I4">4</xref>
        <email>Christine.Ambrosone@roswellpark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A9">
        <name>
          <surname>Johnson</surname>
          <given-names>Candace S</given-names>
        </name>
        <xref ref-type="aff" rid="I5">5</xref>
        <email>Candace.Johnson@roswellpark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A10">
        <name>
          <surname>Wang</surname>
          <given-names>Jianmin</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>Jianmin.Wang@RoswellPark.org</email>
      </contrib>
      <contrib contrib-type="author" id="A11">
        <name>
          <surname>Liu</surname>
          <given-names>Song</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>Song.Liu@RoswellPark.org</email>
      </contrib>
    </contrib-group>
    <aff id="I1"><label>1</label>Department of Biostatistics and Bioinformatics, Roswell Park Cancer Institute, Buffalo, NY, 14263, USA</aff>
    <aff id="I2"><label>2</label>Department of Biostatistics, SUNY University at Buffalo, Buffalo, NY, 14214, USA</aff>
    <aff id="I3"><label>3</label>Cancer Genetics, Roswell Park Cancer Institute, Buffalo, NY, 14263, USA</aff>
    <aff id="I4"><label>4</label>Cancer Prevention and Control, Roswell Park Cancer Institute, Buffalo, NY, 14263, USA</aff>
    <aff id="I5"><label>5</label>Pharmacology and Therapeutics, Roswell Park Cancer Institute, Buffalo, NY, 14263, USA</aff>
    <pub-date pub-type="collection">
      <year>2012</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>10</day>
      <month>12</month>
      <year>2012</year>
    </pub-date>
    <volume>13</volume>
    <fpage>689</fpage>
    <lpage>689</lpage>
    <history>
      <date date-type="received">
        <day>10</day>
        <month>7</month>
        <year>2012</year>
      </date>
      <date date-type="accepted">
        <day>4</day>
        <month>12</month>
        <year>2012</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>Copyright ©2012 Yan et al.; licensee BioMed Central Ltd.</copyright-statement>
      <copyright-year>2012</copyright-year>
      <copyright-holder>Yan et al.; licensee BioMed Central Ltd.</copyright-holder>
      <license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/2.0">http://creativecommons.org/licenses/by/2.0</ext-link>), which permits unrestricted use, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="http://www.biomedcentral.com/1471-2164/13/689"/>
    <abstract>
      <sec>
        <title>Background</title>
        <p>Batch effect is one type of variability that is not of primary interest but ubiquitous in sizable genomic experiments. To minimize the impact of batch effects, an ideal experiment design should ensure the even distribution of biological groups and confounding factors across batches. However, due to the practical complications, the availability of the final collection of samples in genomics study might be unbalanced and incomplete, which, without appropriate attention in sample-to-batch allocation, could lead to drastic batch effects. Therefore, it is necessary to develop effective and handy tool to assign collected samples across batches in an appropriate way in order to minimize the impact of batch effects.</p>
      </sec>
      <sec>
        <title>Results</title>
        <p>We describe OSAT (Optimal Sample Assignment Tool), a bioconductor package designed for automated sample-to-batch allocations in genomics experiments.</p>
      </sec>
      <sec>
        <title>Conclusions</title>
        <p>OSAT is developed to facilitate the allocation of collected samples to different batches in genomics study. Through optimizing the even distribution of samples in groups of biological interest into different batches, it can reduce the confounding or correlation between batches and the biological variables of interest. It can also optimize the homogeneous distribution of confounding factors across batches. It can handle challenging instances where incomplete and unbalanced sample collections are involved as well as ideally balanced designs.</p>
      </sec>
    </abstract>
  </article-meta>
</front>
<body>
  <sec>
    <title>Background</title>
    <p>A sizable genomics study such as microarray often involves the use of multiple batches (groups) of experiment due to practical complication. The systematic, non-biological differences between batches in genomics experiment are referred as batch effects. Batch effects are wide-spread occurrences in genomic studies, and it has been shown that noticeable variation between different batch runs can be a real concern, sometimes even larger than the biological differences [<xref ref-type="bibr" rid="B1">1</xref>-<xref ref-type="bibr" rid="B5">5</xref>]. Without sound experiment designs and statistical analysis methods to handle batch effects, misleading or even erroneous conclusions could be made. This especially important issue is unfortunately often overlooked, partially due to the complexity and multiple steps involved in genomics studies.</p>
    <p>To minimize the impact of batch effects, a careful experiment design should ensure the even distribution of biological groups and confounding factors across batches. It would be problematic if one batch run contains most samples of a particular biological group. In an ideal genomics design, the groups of the main interest, as well as important confounding variables should be balanced and replicated across the batches to form a Randomized Complete Block Design (RCBD) [<xref ref-type="bibr" rid="B6">6</xref>-<xref ref-type="bibr" rid="B8">8</xref>]. It makes the separation of the real biological effect of our interests and effects by other confounding factors statistically more powerful.</p>
    <p>However, despite all best effort, it is often than not that the collected samples are not complying with the original ideal RCBD design. This is due to the fact that these studies are mostly observational or quasi-experimental since we usually do not have full control over sample availability [<xref ref-type="bibr" rid="B1">1</xref>]. In clinical genomics study, samples may be rare, difficult or expensive to collect, irreplaceable or fail QC before profiling. The resulted unbalance and incompleteness nature of sample availability in genomics study, without appropriate attention in sample-to-batch allocation, could lead to drastic batch effects. Therefore, it is necessary to develop effective and handy tool to assign collected samples across batches in an appropriate way in order to minimize the impact of batch effects.</p>
    <p>We developed OSAT to facilitate the allocation of collected samples into different batches in genomics studies. OSAT is not aimed to be a software for experimental design carried out before sample collection, rather, it is developed to fulfill the needs arise from some practical limitations occurring in the genomics experiments. Specifically, OSTA is developed to address one practical issue in genomics studies – when the available experimental samples ready to be profiled in the genomics instruments are collected, how should one allocate these samples to different batches in a proper way to achieve an optimal setup minimizing the impact of batch effects at the genomic profiling stage? With a block randomization step followed by an optimization step, it produces setup that optimizes the even distribution of samples in groups of biological interest into different batches, reducing the confounding or correlation between batches and the biological variables of interest. It can also optimize the even distribution of confounding factors across batches. OSAT can handle challenging instances where incomplete and unbalanced sample collections are involved as well as ideal balanced RCBD.</p>
  </sec>
  <sec sec-type="results">
    <title>Results</title>
    <sec>
      <title>Datasets</title>
      <p>An exemplary data is used for demonstration. It represents samples from a study where the primary interest is to investigate the expression differentiation in case versus control groups (variable SampleType). Two additional variables, Race and AgeGrp, are clinically important variables that may have impact on final outcome. We consider them as confounding variables. A total of 576 samples are included in the study, with one sample per row in the example file. As shown in Additional file <xref ref-type="supplementary-material" rid="S1">1</xref>: Table S1–S2, none of the three variables are characterized by balanced distribution.</p>
    </sec>
    <sec>
      <title>Comparison of different sample assignment algorithms</title>
      <p>The default algorithm implemented in OSAT will first block three variables considered (<italic>i.e</italic>., SampleType, Race and AgeGrp) to generate a single initial assignment setup, and then identify the optimal one with most homogeneous cross-batch strata distribution through shuffling the initial setup. Alternatively, if blocking the primary variable (<italic>i.e.</italic>, SampleType) is the most important and the optimization of the other two variables is less important (but desired), a different algorithm implemented in OSATcan be used. It works by first blocking SampleType only to generate a pool of assignment setups, and then select the optimal one with most homogeneous cross-batch strata (<italic>i.e.</italic>, SampleType, Race and AgeGrp) distribution.</p>
      <p>As shown in Figure <xref ref-type="fig" rid="F1">1a</xref>-c, the final setup produced by the default algorithm is characterized by relatively uniform distribution of all three variables across the batches. Pearson’s χ<sup>2</sup> test examining the association between batches and each of the variables considered indicate that all there variables considered are highly uncorrelated with batches (p-value &gt; 0.99, Table <xref ref-type="table" rid="T1">1</xref>). On the other hand, as shown in Figure <xref ref-type="fig" rid="F2">2a</xref>-c, the final setup produced by the alternative algorithm is characterized by almost perfectly uniform distribution of SampleType variable (with small variation only due to the inherent limitation of the starting data such as unbalanced sample collection), with the uniformity of the other two variables not included in block randomization step decreased. Pearson's χ<sup>2</sup> test (Table <xref ref-type="table" rid="T1">1</xref>) shows that the resulting chi-square for SampleType decreases while those for Race and AgeGrp increase, indicating the tradeoff in prioritizing variable of primary interest for block randomization. Nevertheless, as shown in Figure <xref ref-type="fig" rid="F1">1d</xref> and Figure <xref ref-type="fig" rid="F2">2d</xref>, both algorithms produce final setups which show more homogeneous cross-batch strata distribution than the corresponding starting ones.</p>
      <fig id="F1" position="float">
        <label>Figure 1</label>
        <caption>
          <p><bold>Summary of final setup produced by the default algorithm. a)</bold> the distribution of SampleType characteristic across the plates; <bold>b)</bold> the distribution of Race characteristic across the plates; <bold>c)</bold> the distribution of AgeGrp characteristic across the plates; <bold>d)</bold> the index of optimization steps versus value of the objective function. The blue diamond indicates the starting point, and the red diamond marks the final optimized setup.</p>
        </caption>
        <graphic xlink:href="1471-2164-13-689-1"/>
      </fig>
      <table-wrap position="float" id="T1">
        <label>Table 1</label>
        <caption>
          <p>Comparison of sample assignment by two algorithms implemented in OSAT and an undesired sample assignment through complete randomization</p>
        </caption>
        <table frame="hsides" rules="groups" border="1">
          <colgroup>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
          </colgroup>
          <thead valign="top">
            <tr>
              <th rowspan="2" align="left" valign="top"> <hr/></th>
              <th rowspan="2" align="left" valign="top"> <hr/></th>
              <th colspan="2" align="left" valign="bottom">
                <bold>Default algorithm</bold>
                <hr/>
              </th>
              <th colspan="2" align="left" valign="bottom">
                <bold>Alternative algorithm</bold>
                <hr/>
              </th>
              <th rowspan="2" colspan="2" align="left" valign="top">
                <bold>An undesired setup through complete randomization</bold>
                <hr/>
              </th>
            </tr>
            <tr>
              <th colspan="2" align="left" valign="bottom">
                <bold>(optimal.shuffle)</bold>
                <hr/>
              </th>
              <th colspan="2" align="left" valign="bottom">
                <bold>(optimal.block)</bold>
                <hr/>
              </th>
            </tr>
            <tr>
              <th align="left">
                <bold>Variable</bold>
              </th>
              <th align="left">
                <bold>
                  <italic>DF</italic>
                </bold>
              </th>
              <th align="left">
                <bold>
                  <italic>Chi-square</italic>
                </bold>
              </th>
              <th align="left">
                <bold>
                  <italic>P value</italic>
                </bold>
              </th>
              <th align="left">
                <bold>
                  <italic>Chi-square</italic>
                </bold>
              </th>
              <th align="left">
                <bold>
                  <italic>P value</italic>
                </bold>
              </th>
              <th align="left">
                <bold>
                  <italic>Chi-square</italic>
                </bold>
              </th>
              <th align="left">
                <bold>
                  <italic>P value</italic>
                </bold>
              </th>
            </tr>
          </thead>
          <tbody valign="top">
            <tr>
              <td align="left" valign="bottom">
                <bold>SampleType</bold>
                <hr/>
              </td>
              <td align="left" valign="bottom">5<hr/></td>
              <td align="left" valign="bottom">0.2034518<hr/></td>
              <td align="left" valign="bottom">0.9990763<hr/></td>
              <td align="left" valign="bottom">0.03507789<hr/></td>
              <td align="left" valign="bottom">0.9999879<hr/></td>
              <td align="left" valign="bottom">13.25243<hr/></td>
              <td align="left" valign="bottom">0.021124664<hr/></td>
            </tr>
            <tr>
              <td align="left" valign="bottom">
                <bold>Race</bold>
                <hr/>
              </td>
              <td align="left" valign="bottom">5<hr/></td>
              <td align="left" valign="bottom">0.2380335<hr/></td>
              <td align="left" valign="bottom">0.9986490<hr/></td>
              <td align="left" valign="bottom">3.68541503<hr/></td>
              <td align="left" valign="bottom">0.5955359<hr/></td>
              <td align="left" valign="bottom">14.22455<hr/></td>
              <td align="left" valign="bottom">0.014244218<hr/></td>
            </tr>
            <tr>
              <td align="left">
                <bold>Age_grp</bold>
              </td>
              <td align="left">20</td>
              <td align="left">0.8138166</td>
              <td align="left">1.0000000</td>
              <td align="left">5.08147313</td>
              <td align="left">0.9996856</td>
              <td align="left">39.75020</td>
              <td align="left">0.005371387</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <fig id="F2" position="float">
        <label>Figure 2</label>
        <caption>
          <p><bold>Summary of final setup produced by the alternative algorithm. a)</bold> the distribution of SampleType characteristic across the plates; <bold>b)</bold> the distribution of Race characteristic across the plates; <bold>c)</bold> the distribution of AgeGrp characteristic across the plates; <bold>d)</bold> the index of generated setups versus value of the objective function. The blue diamond indicates the first setup generated, and the red diamond marks the final selected setup.</p>
        </caption>
        <graphic xlink:href="1471-2164-13-689-2"/>
      </fig>
      <p>Simply performing complete randomizations might lead to undesired sample-to-batch assignment, especially for unbalanced and/or incomplete sample sets. In fact, there is substantial chance that variables will be statistically dependent on batches if a complete randomization is carried out, especially for incomplete and/or unbalanced sample collections. As shown in Figure <xref ref-type="fig" rid="F3">3</xref>, an undesired setup can be produced through complete randomization of sample-to-batch assignment. The Pearson's χ<sup>2</sup> tests indicate all three variables are statistically dependent on batches with p-values &lt; 0.05 (Table <xref ref-type="table" rid="T1">1</xref>).</p>
      <fig id="F3" position="float">
        <label>Figure 3</label>
        <caption>
          <p><bold>Summary of an undesired setup produced by complete randomization. a)</bold> the distribution of SampleType characteristic across the plates; <bold>b)</bold> the distribution of Race characteristic across the plates; <bold>c)</bold> the distribution of AgeGrp characteristic across the plates.</p>
        </caption>
        <graphic xlink:href="1471-2164-13-689-3"/>
      </fig>
    </sec>
  </sec>
  <sec sec-type="conclusions">
    <title>Conclusions</title>
    <p>Genomics experiments are often driven by the availability of the final collection of samples which might be unbalanced and incomplete. The unbalance and incompleteness nature of sample availability thus calls for the development of effective tools to assign collected samples across batches in an appropriate way in order to minimize the impact of batch effects at the genomics experiment stage. OSAT is developed to facilitate the allocation of collected samples to different batches in genomics study. With a block randomization step followed by an optimization step, it produces setup that optimizes the even distribution of samples in groups of biological interest into different batches, reducing the confounding or correlation between batches and the biological variables of interest. It can also optimize the homogeneous distribution of confounding factors across batches. While motivated to handle challenging instances where incomplete and unbalanced sample collections are involved, OSAT can also handle ideal balanced RCBD.</p>
    <p>Partly due to its simplicity in implementation, complete randomization has been frequently used in the sample assignment step of experiment practice. When sample size is large enough, randomized design will be close to a balanced design. However, simple randomization could lead to undesirable imbalanced design where efficiency and confounding might be an issue after the data collection. As we demonstrated in the manuscript, simply performing randomizations might lead to undesired sample-to-batch setup showing batch dependence, especially for unbalanced and/or incomplete sample sets which doesn’t comply with the original ideal design. OSAT package is designed to avoid such scenario, by providing a simple pipeline to create sample assignment that minimizes the association between sample characteristics and batches. The software was implemented in a flexible way so that it can be adopted by genomics practitioner who might not be specialized in experiment design.</p>
    <p>It should be emphasized that although the impact of batch effect on genomics study might be minimized through proper design and sample allocation, it may not be completely eliminated. Even with perfect design and best effort in all stages of experiment including sample-to-batch assignment, it is impossible to define or control all potential batch effects. Many statistical methods have been developed to estimate and reduce the impact of batch effect at the data analysis stage (<italic>i.e.,</italic> after the experiment part is done) [<xref ref-type="bibr" rid="B1">1</xref>,<xref ref-type="bibr" rid="B9">9</xref>-<xref ref-type="bibr" rid="B12">12</xref>]. It would be helpful that analytic methods handling batch effects are employed in all stages of a genomics study, from experiment design to data analysis.</p>
    <p>Experimental design has been applied in many areas, with methods being tailored to the needs of various fields. A collection of R packages for experimental design is available at <ext-link ext-link-type="uri" xlink:href="http://cran.r-project.org/web/views/ExperimentalDesign.html">http://cran.r-project.org/web/views/ExperimentalDesign.html</ext-link>. Many of these existing experiment design software work for ideal situation (i.e., before sample collection) where the sample size is fixed and/or model is specified. For example, the software in above link includes optimal design (e.g. <italic>AlgDesign</italic>, requiring model specification), orthogonal arrays for main effects experiments (e.g., function <italic>oa.design</italic>, constrained by sample size/number of factors), factorial 2-level designs (e.g., Package <italic>FrF2</italic>, particularly important in industrial experimentation), and etc. We developed OSAT to facilitate the allocation of collected samples into different batches in genomics studies. Our software implements the general experiment design methodology to achieve the optimal sample-to-batch assignment in order to minimize the impact of batch effects. It is specifically used in the profiling stage of a genomics study when the available experimental samples ready to be profiled in the genomics instruments are collected. It provides predefined batch layout for some of the most commonly used genomics platforms. Written in a modularized style in the open source R environment, it provides the flexibility for users to define the batch layout of their own experiment platform, as well as optimization objective function for their specific needs, in sample-to-batch assignment in order to minimize the impact of batch effects. To our best knowledge, there is no other tool for this important utility within the framework of Bioconductor.</p>
  </sec>
  <sec sec-type="methods">
    <title>Methods</title>
    <sec>
      <title>Methodology</title>
      <p>The current version of OSAT provides two algorithms for creation of sample assignment across the batches based on the principle of block randomization, which is an effective approach in controlling variability from nuisance variables such as batches and its interaction with variables of our primary interest [<xref ref-type="bibr" rid="B6">6</xref>-<xref ref-type="bibr" rid="B8">8</xref>,<xref ref-type="bibr" rid="B13">13</xref>]. Both algorithms are composed of a block randomization step and an optimization step. The default algorithm (implemented in function <italic>optimal.shuffle</italic>) sought to first block all variables considered to generate a single initial assignment setup, then identify the optimal one which minimizes the objective functions (<italic>i.e.,</italic> the one with most homogeneous cross-batch strata distribution) through shuffling the initial setup. The alternative algorithm (implemented in function <italic>optimal.blcok</italic>) sought to first block specified variables (<italic>e.g.</italic>, list of variables of primary interests) to generate a pool of assignment setups, then select the optimal one which minimize the objective functions based on all variables considered (including those variables which are not included in the block randomization step). A detailed description is provided as below.</p>
      <p>By combining the variables of interest, we can create a unified variable with its levels based on all possible combinations of the levels of the variables involved. Assuming there are a total of <italic>s</italic> levels in the unified variable (referred as optimization strata in this package) with <italic>S</italic><sub><italic>j</italic></sub> samples in each stratum, <italic>j</italic> = 1 … <italic>s</italic>, and assuming we have <italic>m</italic> batches with <italic>B</italic><sub><italic>i</italic></sub>, <italic>i = 1… m</italic> wells available in each batch. In an ideal balanced RCBD experiment, we have equal sample size in each strata: <italic>S</italic><sub><italic>1</italic></sub><italic>= …= S</italic><sub><italic>s</italic></sub><italic>= S,</italic> and each batch includes the same number of available wells, <italic>B</italic><sub><italic>1</italic></sub><italic>= … = B</italic><sub><italic>m</italic></sub><italic>= B</italic>, with equal number of samples from each sample strata.</p>
      <p>The expected number of sample from each stratum to each batch is denoted as <italic>E</italic><sub><italic>ij</italic></sub>. One can split it to its integer part and fractal part as</p>
      <p>
        <disp-formula>
          <mml:math id="M1" name="1471-2164-13-689-i1" overflow="scroll">
            <mml:mrow>
              <mml:msub>
                <mml:mi>E</mml:mi>
                <mml:mi mathvariant="italic">ij</mml:mi>
              </mml:msub>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>B</mml:mi>
                    <mml:mi>i</mml:mi>
                  </mml:msub>
                  <mml:mi>j</mml:mi>
                </mml:mrow>
                <mml:mstyle displaystyle="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mo>∑</mml:mo>
                      <mml:mi>i</mml:mi>
                    </mml:msub>
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>B</mml:mi>
                        <mml:mi>i</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                  </mml:mrow>
                </mml:mstyle>
              </mml:mfrac>
              <mml:mo>=</mml:mo>
              <mml:mfenced open="⌊" close="⌋">
                <mml:msub>
                  <mml:mi>E</mml:mi>
                  <mml:mi mathvariant="italic">ij</mml:mi>
                </mml:msub>
              </mml:mfenced>
              <mml:mo>+</mml:mo>
              <mml:msub>
                <mml:mi>δ</mml:mi>
                <mml:mi mathvariant="italic">ij</mml:mi>
              </mml:msub>
            </mml:mrow>
          </mml:math>
        </disp-formula>
      </p>
      <p>where ⌊<italic>E</italic><sub><italic>ij</italic></sub>⌋ is the integer part of the expected number and <italic>δ</italic><sub><italic>ij</italic></sub> is the fractal part. In the case of equalbatch size, it reduces to <inline-formula><mml:math id="M2" name="1471-2164-13-689-i2" overflow="scroll"><mml:mrow><mml:mfenced open="⌊" close="⌋"><mml:msub><mml:mi>E</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub></mml:mfenced><mml:mo>=</mml:mo><mml:mfrac><mml:msub><mml:mi>S</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mi>m</mml:mi></mml:mfrac></mml:mrow></mml:math></inline-formula> . When we have RCBD, all <italic>δ</italic><sub><italic>ij</italic></sub> are zero.</p>
      <p>For an actual sample assignment</p>
      <p>
        <disp-formula>
          <mml:math id="M3" name="1471-2164-13-689-i3" overflow="scroll">
            <mml:mrow>
              <mml:mtable columnalign="center">
                <mml:mtr columnalign="center">
                  <mml:mtd columnalign="center">
                    <mml:msub>
                      <mml:mi>B</mml:mi>
                      <mml:mn>1</mml:mn>
                    </mml:msub>
                  </mml:mtd>
                </mml:mtr>
                <mml:mtr columnalign="center">
                  <mml:mtd columnalign="center">
                    <mml:mo>⋮</mml:mo>
                  </mml:mtd>
                </mml:mtr>
                <mml:mtr columnalign="center">
                  <mml:mtd columnalign="center">
                    <mml:msub>
                      <mml:mi>B</mml:mi>
                      <mml:mi>m</mml:mi>
                    </mml:msub>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
              <mml:mtable columnalign="center">
                <mml:mtr columnalign="center">
                  <mml:mtd columnalign="center">
                    <mml:mtable columnalign="center">
                      <mml:mtr columnalign="center">
                        <mml:mtd columnalign="center">
                          <mml:msub>
                            <mml:mi>S</mml:mi>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                        </mml:mtd>
                        <mml:mtd columnalign="center">
                          <mml:mo>…</mml:mo>
                        </mml:mtd>
                        <mml:mtd columnalign="center">
                          <mml:msub>
                            <mml:mi>S</mml:mi>
                            <mml:mi>s</mml:mi>
                          </mml:msub>
                        </mml:mtd>
                      </mml:mtr>
                    </mml:mtable>
                  </mml:mtd>
                </mml:mtr>
                <mml:mtr columnalign="center">
                  <mml:mtd columnalign="center">
                    <mml:mfenced open="(" close=")">
                      <mml:mtable columnalign="left">
                        <mml:mtr columnalign="left">
                          <mml:mtd columnalign="left">
                            <mml:msub>
                              <mml:mi>n</mml:mi>
                              <mml:mn>11</mml:mn>
                            </mml:msub>
                          </mml:mtd>
                          <mml:mtd columnalign="left">
                            <mml:mo>…</mml:mo>
                          </mml:mtd>
                          <mml:mtd columnalign="left">
                            <mml:msub>
                              <mml:mi>n</mml:mi>
                              <mml:mrow>
                                <mml:mn>1</mml:mn>
                                <mml:mi>s</mml:mi>
                              </mml:mrow>
                            </mml:msub>
                          </mml:mtd>
                        </mml:mtr>
                        <mml:mtr columnalign="left">
                          <mml:mtd columnalign="left">
                            <mml:mo>⋮</mml:mo>
                          </mml:mtd>
                          <mml:mtd columnalign="left">
                            <mml:mo>⋱</mml:mo>
                          </mml:mtd>
                          <mml:mtd columnalign="left">
                            <mml:mo>⋮</mml:mo>
                          </mml:mtd>
                        </mml:mtr>
                        <mml:mtr columnalign="left">
                          <mml:mtd columnalign="left">
                            <mml:msub>
                              <mml:mi>n</mml:mi>
                              <mml:mrow>
                                <mml:mi>m</mml:mi>
                                <mml:mn>1</mml:mn>
                              </mml:mrow>
                            </mml:msub>
                          </mml:mtd>
                          <mml:mtd columnalign="left">
                            <mml:mo>…</mml:mo>
                          </mml:mtd>
                          <mml:mtd columnalign="left">
                            <mml:msub>
                              <mml:mi>n</mml:mi>
                              <mml:mi mathvariant="italic">ms</mml:mi>
                            </mml:msub>
                          </mml:mtd>
                        </mml:mtr>
                      </mml:mtable>
                    </mml:mfenced>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
          </mml:math>
        </disp-formula>
      </p>
      <p>where <italic>n</italic><sub><italic>ij</italic></sub> is the number of sample in each optimization strata from an actual sample assignment. Our goal is, through a block randomization step and an optimization step, to minimize the difference between expected sample size <italic>E</italic><sub><italic>ij</italic></sub> and the actual sample size <italic>n</italic><sub><italic>ij</italic></sub>.</p>
      <p>The block randomization step is to create initial setup(s) of randomized sample assignment based on strata combining the blocking variables considered. The blocking variables include all variables of interests in the default algorithm, but only a specified subset of variables in the alternative algorithm.</p>
      <p>In this step, we sample <italic>i</italic> sets of samples from each strata <italic>S</italic><sub><italic>j</italic></sub> with size ⌊<italic>E</italic><sub><italic>ij</italic></sub>⌋, as well as <italic>j</italic> sets of wells from each <italic>B</italic><sub><italic>j</italic></sub> batches with size of ⌊<italic>E</italic><sub><italic>ij</italic></sub>⌋. The two selections are linked together by the <italic>ij</italic> subgroup, randomized in each of them. The rest of samples <italic>r</italic><sub><italic>j</italic></sub> = <italic>S</italic><sub><italic>j</italic></sub> − ∑ <sub><italic>i</italic></sub>⌊<italic>E</italic><sub><italic>ij</italic></sub>⌋ can be assigned to the available wells in each Block <italic>w</italic><sub><italic>i</italic></sub> = <italic>B</italic><sub><italic>i</italic></sub> − ∑ <sub><italic>j</italic></sub>⌊<italic>E</italic><sub><italic>ij</italic></sub>⌋. The probability of a sample in <italic>r</italic><sub><italic>j</italic></sub> from strata <italic>S</italic><sub><italic>j</italic></sub> being assigned to a well from block <italic>B</italic><sub><italic>i</italic></sub> is proportional to the fractal part of the expected sample size <italic>δ</italic><sub><italic>ij</italic></sub>. For a RCBD, each batch will have equal number of samples with same characteristic and there is no need for further optimization. However, for other instances where the collection of samples is unbalanced and/or incomplete, an optimization step is needed to create a more optimal setup of sample assignment.</p>
      <p>The optimization step aims to identify an optimal setup of sample assignments from multiple candidates. To select optimal sample assignment, we need to measure the variation of sample characteristics between batches. In this package, we define the optimal design as a sample assignment setup that minimizes our objective function based on principle of least square method [<xref ref-type="bibr" rid="B13">13</xref>]. The objective function can be defined as</p>
      <p>
        <disp-formula>
          <mml:math id="M4" name="1471-2164-13-689-i4" overflow="scroll">
            <mml:mrow>
              <mml:mi>V</mml:mi>
              <mml:mo>=</mml:mo>
              <mml:mstyle displaystyle="true">
                <mml:munder>
                  <mml:mo>∑</mml:mo>
                  <mml:mi mathvariant="italic">ij</mml:mi>
                </mml:munder>
                <mml:mrow>
                  <mml:msup>
                    <mml:mfenced open="(" close=")">
                      <mml:mrow>
                        <mml:msub>
                          <mml:mi>n</mml:mi>
                          <mml:mi mathvariant="italic">ij</mml:mi>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mi>E</mml:mi>
                          <mml:mi mathvariant="italic">ij</mml:mi>
                        </mml:msub>
                      </mml:mrow>
                    </mml:mfenced>
                    <mml:mn>2</mml:mn>
                  </mml:msup>
                </mml:mrow>
              </mml:mstyle>
            </mml:mrow>
          </mml:math>
        </disp-formula>
      </p>
      <p>where <italic>E</italic><sub><italic>ij</italic></sub> and <italic>n</italic><sub><italic>ij</italic></sub> were defined previously.</p>
      <p>In the default algorithm implemented in OSAT, optimization is conducted through shuffling the initial setup obtained in the block randomization step. Specifically, after initial setup is created, we randomly select <italic>k</italic> samples from different batches and shuffle them between batches to create a new sample assignment. Value of the objective function is calculated for the new setup and compared to that of the original one. If the new value is smaller, the new assignment will replace the previous one. This procedure will continue until we reach a pre-set number of attempts (5000 by default).</p>
      <p>In the alternative algorithm, multiple (typically thousands of or more) sample assignment setups are first generated by procedure described in the block randomization step above, based only on the list of specified blocking variable(s). The optimal one will be chosen by selecting the setup (from the pool generated in the block randomization step) which minimizes the value of the objective function based on all variables considered. This algorithm will guarantee the identification of a setup that is conformed to the blocking requirement for the list of specified blocking variables, while attempting to minimize the between-batches variations of the other variables considered.</p>
    </sec>
  </sec>
  <sec>
    <title>Implementation</title>
    <p>We provide a brief overview of the OSAT usage as below. A more detailed description of package functionality can be found in the package vignette and manual.</p>
    <sec>
      <title>Data format</title>
      <p>To begin, sample variables to be considered in the sample-to-batch assignment will be encapsulated in an object using function</p>
      <p>sample&lt;− setup.sample (x, optimal, …)where in data frame <italic>x</italic> each sample is represented by a row and category variables including our primary interest and other variables are listed as columns. The parameter <italic>optimal</italic> indicates the vector of variables to be considered.</p>
    </sec>
    <sec>
      <title>Batch layout</title>
      <p>Next, the number of plates to be used in the genomic experiment, the layout design of these plates, and the level of batch effect to be considered are captured in a container object using constructor functionContainer &lt;− setup.container(plate, n, batch, …)where parameter <italic>plate</italic> is an object representing the layout (number and type of chip used, rows and columns of wells, the ordering of them, and <italic>etc.</italic>) of the plate used in the experiment. Layouts of some commonly used plates and chips are predefined in our package (<italic>e.g.</italic>, the IlluminaBeadChip Plate). The user can define their own layout using the classes and methods provided in OSAT. Optional parameter <italic>batch</italic> has default value “plates”, indicate batch effect will be considered at the plate level. User can use <italic>batch="chips"</italic> to consider batch effect at chip level.</p>
    </sec>
    <sec>
      <title>Block randomization and optimization</title>
      <p>Third, sample-to-batch assignment can be created through function</p>
      <p>create.optimized.setup(fun="optimal.shuffle",sample, container, …)</p>
      <p>The default algorithm is implemented in function <italic>optimal.shuffle</italic>, while the alternative algorithm is implemented in function <italic>optimal.blcok</italic>. Users can also define objective function following the instruction in the package vignette.</p>
    </sec>
    <sec>
      <title>Output</title>
      <p>Last, bar plot of sample counts by batches for all variables considered is provided for visual inspection of the sample assignment. Chi-square tests are also to examine the dependence of sample variables on batches. The final sample-to-batch assignment can be output to CSV.</p>
    </sec>
  </sec>
  <sec>
    <title>Availability and requirements</title>
    <p>Project name: OSATProject home page: <ext-link ext-link-type="uri" xlink:href="http://bioconductor.org/packages/2.11/bioc/html/OSAT.html">http://bioconductor.org/packages/2.11/bioc/html/OSAT.html</ext-link>Operating system(s): Windows, Unix-like (Linux, Mac OSX)</p>
    <p>Programming language: R &gt;= 2.15</p>
    <p>License: Artistic-2.0Any restrictions to use by non-academics: None</p>
  </sec>
  <sec>
    <title>Competing interests</title>
    <p>The authors declare that they have no competing interests.</p>
  </sec>
  <sec>
    <title>Authors’ contributions</title>
    <p>LY, CM and SL conceived and designed the study. LY developed the software. LY CM and SL drafted the manuscript. QH, DW, MQ, JMC, LES, CAB, CSJ and JW all contributed to the study design. All authors read and approved the final manuscript.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="S1">
      <caption>
        <title>Additional file 1</title>
        <p><bold>Table S1.</bold> Example data. <bold>Table S2.</bold> Data distribution. <bold>Figure S1.</bold> Number of samples per plate. Paired specimens are placed on the same chip. Sample assignment use optimal.block method.</p>
      </caption>
      <media xlink:href="1471-2164-13-689-S1.pdf" mimetype="application" mime-subtype="pdf">
        <caption>
          <p>Click here for file</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <sec>
    <title>Acknowledgements</title>
    <p>We wish to thank the anonymous reviewers for their valuable comments and suggestions, which were helpful in improving the paper. The work was supported in part by the National Institute of Health grant R01HL102278 to LES, R01CA133264 to CBA, R01-CA095045 to CSJ, and R21CA162218 to SL.</p>
  </sec>
  <ref-list>
    <ref id="B1">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Lambert</surname>
          <given-names>CG</given-names>
        </name>
        <name>
          <surname>Black</surname>
          <given-names>LJ</given-names>
        </name>
        <article-title>Learning from our GWAS mistakes: from experimental design to scientific method</article-title>
        <source>Biostat(Oxford, England)</source>
        <year>2012</year>
        <volume>13</volume>
        <issue>2</issue>
        <fpage>195</fpage>
      </mixed-citation>
    </ref>
    <ref id="B2">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Baggerly</surname>
          <given-names>KA</given-names>
        </name>
        <name>
          <surname>Coombes</surname>
          <given-names>KR</given-names>
        </name>
        <name>
          <surname>Neeley</surname>
          <given-names>ES</given-names>
        </name>
        <article-title>Run batch effects potentially compromise the usefulness of genomic signatures for ovarian cancer</article-title>
        <source>J Clin Oncol</source>
        <year>2008</year>
        <volume>26</volume>
        <issue>7</issue>
        <fpage>1186</fpage>
        <pub-id pub-id-type="doi">10.1200/JCO.2007.15.1951</pub-id>
        <pub-id pub-id-type="pmid">18309960</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B3">
      <mixed-citation publication-type="book">
        <name>
          <surname>Scherer</surname>
          <given-names>A</given-names>
        </name>
        <source>Batch effects and noise in microarray experiments: sources and solutions</source>
        <year>2009</year>
        <publisher-name>New York: John Wiley and Sons</publisher-name>
      </mixed-citation>
    </ref>
    <ref id="B4">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Leek</surname>
          <given-names>JT</given-names>
        </name>
        <name>
          <surname>Scharpf</surname>
          <given-names>RB</given-names>
        </name>
        <name>
          <surname>Bravo</surname>
          <given-names>HC</given-names>
        </name>
        <name>
          <surname>Simcha</surname>
          <given-names>D</given-names>
        </name>
        <name>
          <surname>Langmead</surname>
          <given-names>B</given-names>
        </name>
        <name>
          <surname>Johnson</surname>
          <given-names>WE</given-names>
        </name>
        <name>
          <surname>Geman</surname>
          <given-names>D</given-names>
        </name>
        <name>
          <surname>Baggerly</surname>
          <given-names>K</given-names>
        </name>
        <name>
          <surname>Irizarry</surname>
          <given-names>RA</given-names>
        </name>
        <article-title>Tackling the widespread and critical impact of batch effects in high-throughput data</article-title>
        <source>Nat Rev Genet</source>
        <year>2010</year>
        <volume>11</volume>
        <issue>10</issue>
        <fpage>733</fpage>
        <pub-id pub-id-type="doi">10.1038/nrg2825</pub-id>
        <pub-id pub-id-type="pmid">20838408</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B5">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Mak</surname>
          <given-names>HC</given-names>
        </name>
        <name>
          <surname>Storey</surname>
          <given-names>J</given-names>
        </name>
        <article-title>The importance of new statistical methods for high-throughput sequencing</article-title>
        <source>Nat Biotechnol</source>
        <year>2011</year>
        <volume>29</volume>
        <issue>4</issue>
        <fpage>331</fpage>
        <pub-id pub-id-type="doi">10.1038/nbt.1831</pub-id>
        <pub-id pub-id-type="pmid">21478851</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B6">
      <mixed-citation publication-type="book">
        <name>
          <surname>Murray</surname>
          <given-names>L</given-names>
        </name>
        <source>Randomized Complete Block Designs</source>
        <year>2005</year>
        <publisher-name>New York: John Wiley &amp; Sons Ltd</publisher-name>
      </mixed-citation>
    </ref>
    <ref id="B7">
      <mixed-citation publication-type="book">
        <name>
          <surname>Montgomery</surname>
          <given-names>DC</given-names>
        </name>
        <source>Design and Analysis of Experiments</source>
        <year>2008</year>
        <edition>7th</edition>
        <publisher-name>John Wiley &amp; Sons: Wiley</publisher-name>
      </mixed-citation>
    </ref>
    <ref id="B8">
      <mixed-citation publication-type="book">
        <name>
          <surname>Fang</surname>
          <given-names>K</given-names>
        </name>
        <name>
          <surname>Ma</surname>
          <given-names>C</given-names>
        </name>
        <source>Uniform and Orthogonal Designs</source>
        <year>2001</year>
        <publisher-name>Beijing: Science Press</publisher-name>
      </mixed-citation>
    </ref>
    <ref id="B9">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Huang</surname>
          <given-names>H</given-names>
        </name>
        <name>
          <surname>Lu</surname>
          <given-names>X</given-names>
        </name>
        <name>
          <surname>Liu</surname>
          <given-names>Y</given-names>
        </name>
        <name>
          <surname>Haaland</surname>
          <given-names>P</given-names>
        </name>
        <name>
          <surname>Marron</surname>
          <given-names>JS</given-names>
        </name>
        <article-title>R/DWD: Distance-Weighted Discrimination for classification, visualization and batch adjustment</article-title>
        <source>Bioinformatics</source>
        <year>2012</year>
        <volume>28</volume>
        <issue>8</issue>
        <fpage>1182</fpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bts096</pub-id>
        <pub-id pub-id-type="pmid">22368246</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B10">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Marsit</surname>
          <given-names>CJ</given-names>
        </name>
        <name>
          <surname>Koestler</surname>
          <given-names>DC</given-names>
        </name>
        <name>
          <surname>Christensen</surname>
          <given-names>BC</given-names>
        </name>
        <name>
          <surname>Karagas</surname>
          <given-names>MR</given-names>
        </name>
        <name>
          <surname>Houseman</surname>
          <given-names>EA</given-names>
        </name>
        <name>
          <surname>Kelsey</surname>
          <given-names>KT</given-names>
        </name>
        <article-title>DNA methylation array analysis identifies profiles of blood-derived DNA methylation associated with bladder cancer</article-title>
        <source>J clin oncol: official journal of the American Society of Clinical Oncology</source>
        <year>2011</year>
        <volume>29</volume>
        <issue>9</issue>
        <fpage>1133</fpage>
        <pub-id pub-id-type="doi">10.1200/JCO.2010.31.3577</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B11">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Li</surname>
          <given-names>C</given-names>
        </name>
        <name>
          <surname>Rabinovic</surname>
          <given-names>A</given-names>
        </name>
        <article-title>Adjusting batch effects in microarray expression data using empirical Bayesmethods</article-title>
        <source>Biostatistics</source>
        <year>2007</year>
        <volume>8</volume>
        <fpage>118</fpage>
        <pub-id pub-id-type="doi">10.1093/biostatistics/kxj037</pub-id>
        <pub-id pub-id-type="pmid">16632515</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B12">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Ma</surname>
          <given-names>C</given-names>
        </name>
        <name>
          <surname>Fang</surname>
          <given-names>K</given-names>
        </name>
        <name>
          <surname>Liski</surname>
          <given-names>E</given-names>
        </name>
        <article-title>A new approach in constructing orthogonal and nearly orthogonal arrays</article-title>
        <source>Metrika</source>
        <year>2000</year>
        <volume>50</volume>
        <issue>3</issue>
        <fpage>255</fpage>
        <pub-id pub-id-type="doi">10.1007/s001840050049</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B13">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Chen</surname>
          <given-names>C</given-names>
        </name>
        <name>
          <surname>Grennan</surname>
          <given-names>K</given-names>
        </name>
        <name>
          <surname>Badner</surname>
          <given-names>J</given-names>
        </name>
        <name>
          <surname>Zhang</surname>
          <given-names>D</given-names>
        </name>
        <name>
          <surname>Gershon</surname>
          <given-names>E</given-names>
        </name>
        <name>
          <surname>Jin</surname>
          <given-names>L</given-names>
        </name>
        <name>
          <surname>Liu</surname>
          <given-names>C</given-names>
        </name>
        <article-title>Removing batch effects inanalysis of expression microarray data: an evaluation of six batch adjustment methods</article-title>
        <source>PLoS One</source>
        <year>2011</year>
        <volume>6</volume>
        <issue>2</issue>
        <fpage>e17238</fpage>
        <pub-id pub-id-type="doi">10.1371/journal.pone.0017238</pub-id>
        <pub-id pub-id-type="pmid">21386892</pub-id>
      </mixed-citation>
    </ref>
  </ref-list>
</back>
