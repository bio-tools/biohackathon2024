<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">BMC Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">BMC Bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>BMC Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="epub">1471-2105</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7119286</article-id>
    <article-id pub-id-type="publisher-id">3425</article-id>
    <article-id pub-id-type="doi">10.1186/s12859-020-3425-x</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Methodology Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>OffsampleAI: artificial intelligence approach to recognize off-sample mass spectrometry images</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Ovchinnikova</surname>
          <given-names>Katja</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Kovalev</surname>
          <given-names>Vitaly</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Stuart</surname>
          <given-names>Lachlan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-9464-6125</contrib-id>
        <name>
          <surname>Alexandrov</surname>
          <given-names>Theodore</given-names>
        </name>
        <address>
          <email>theodore.alexandrov@embl.de</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0495 846X</institution-id><institution-id institution-id-type="GRID">grid.4709.a</institution-id><institution>Structural and Computational Biology Unit, </institution><institution>European Molecular Biology Laboratory, </institution></institution-wrap>Heidelberg, Germany </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0495 846X</institution-id><institution-id institution-id-type="GRID">grid.4709.a</institution-id><institution>Metabolomics Core Facility, </institution><institution>European Molecular Biology Laboratory, </institution></institution-wrap>Heidelberg, Germany </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0001 2107 4242</institution-id><institution-id institution-id-type="GRID">grid.266100.3</institution-id><institution>Skaggs School of Pharmacy and Pharmaceutical Sciences, </institution><institution>University of California, San Diego, </institution></institution-wrap>La Jolla, CA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>3</day>
      <month>4</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>3</day>
      <month>4</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2020</year>
    </pub-date>
    <volume>21</volume>
    <elocation-id>129</elocation-id>
    <history>
      <date date-type="received">
        <day>12</day>
        <month>6</month>
        <year>2019</year>
      </date>
      <date date-type="accepted">
        <day>19</day>
        <month>2</month>
        <year>2020</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s). 2020</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold>This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons licence, and indicate if changes were made. The images or other third party material in this article are included in the article's Creative Commons licence, unless indicated otherwise in a credit line to the material. If material is not included in the article's Creative Commons licence and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this licence, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated in a credit line to the data.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <sec>
        <title>Background</title>
        <p id="Par1">Imaging mass spectrometry (imaging MS) is an enabling technology for spatial metabolomics of tissue sections with rapidly growing areas of applications in biology and medicine. However, imaging MS data is polluted with off-sample ions caused by sample preparation, particularly by the MALDI (matrix-assisted laser desorption/ionization) matrix application. Off-sample ion images confound and hinder statistical analysis, metabolite identification and downstream analysis with no automated solutions available.</p>
      </sec>
      <sec>
        <title>Results</title>
        <p id="Par2">We developed an artificial intelligence approach to recognize off-sample ion images. First, we created a high-quality gold standard of 23,238 expert-tagged ion images from 87 public datasets from the METASPACE knowledge base. Next, we developed several machine and deep learning methods for recognizing off-sample ion images. The following methods were able to reproduce expert judgements with a high agreement: residual deep learning (<italic>F</italic>1-score 0.97), semi-automated spatio-molecular biclustering (<italic>F</italic>1-score 0.96), and molecular co-localization (<italic>F</italic>1-score 0.90). In a test-case study, we investigated off-sample images corresponding to the most common MALDI matrix (2,5-dihydroxybenzoic acid, DHB) and characterized properties of matrix clusters.</p>
      </sec>
      <sec>
        <title>Conclusions</title>
        <p id="Par3">Overall, our work illustrates how artificial intelligence approaches enabled by open-access data, web technologies, and machine and deep learning open novel avenues to address long-standing challenges in imaging MS.</p>
      </sec>
    </abstract>
    <kwd-group xml:lang="en">
      <title>Keywords</title>
      <kwd>Imaging mass spectrometry</kwd>
      <kwd>Off-sample images</kwd>
      <kwd>Pattern recognition</kwd>
      <kwd>Machine learning</kwd>
      <kwd>Deep learning</kwd>
      <kwd>Artificial intelligence</kwd>
      <kwd>METASPACE</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100010661</institution-id>
            <institution>Horizon 2020 Framework Programme</institution>
          </institution-wrap>
        </funding-source>
        <award-id>634402</award-id>
        <principal-award-recipient>
          <name>
            <surname>Alexandrov</surname>
            <given-names>Theodore</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Horizon 2020 Framework Programme ()</institution>
        </funding-source>
        <award-id>825184</award-id>
        <principal-award-recipient>
          <name>
            <surname>Alexandrov</surname>
            <given-names>Theodore</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000781</institution-id>
            <institution>European Research Council</institution>
          </institution-wrap>
        </funding-source>
        <award-id>773089</award-id>
        <principal-award-recipient>
          <name>
            <surname>Alexandrov</surname>
            <given-names>Theodore</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000062</institution-id>
            <institution>National Institute of Diabetes and Digestive and Kidney Diseases</institution>
          </institution-wrap>
        </funding-source>
        <award-id>KPMP</award-id>
        <principal-award-recipient>
          <name>
            <surname>Alexandrov</surname>
            <given-names>Theodore</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2020</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par15">Imaging mass spectrometry (imaging MS) emerged as a powerful and versatile technology for spatial molecular analysis [<xref ref-type="bibr" rid="CR3">3</xref>, <xref ref-type="bibr" rid="CR5">5</xref>, <xref ref-type="bibr" rid="CR6">6</xref>] with a particular interest in clinical and pharma applications [<xref ref-type="bibr" rid="CR17">17</xref>, <xref ref-type="bibr" rid="CR20">20</xref>]. The capacities and potential of imaging MS were boosted with the introduction of high- and ultrahigh- resolving power mass spectrometry analyzers such as FTICR (Fourier-transform ion cyclotron resonance) and Orbitrap that rapidly shifted the current focus towards applications in spatial metabolomics and lipidomics [<xref ref-type="bibr" rid="CR14">14</xref>]. Among various flavors of imaging MS, matrix-assisted laser-desorption ionization MALDI-imaging is the most widespread [<xref ref-type="bibr" rid="CR14">14</xref>]. MALDI-imaging requires applying the so-called matrix onto the tissue section leading to formation of a layer of crystals covering the sample to facilitate “soft” energy transfer to sample analytes, enhance their ionization, and reduce in-source fragmentation [<xref ref-type="bibr" rid="CR8">8</xref>]. However, the addition of ionizable matrix molecules contaminates the data with matrix ion signals which are not relevant for the molecular content of the sample and, moreover, can be isomeric or isobaric with sample analytes and thus mask out their spatial distribution. The matrix signals cannot be eliminated from the data with a simple approach, e.g. by considering [M + H] + matrix ions since a matrix forms hundreds of so-called matrix clusters, namely ions composed of matrix molecules. The presence of matrix cluster ions pollutes MALDI-imaging data by adding biologically irrelevant signals. This confounds quality control and statistical analyses, leads to false hits in metabolite identification and hinders downstream pathways analysis. Despite these negative effects being widely recognized, currently there is no solution for filtering out the matrix signals as their formation in general as well as for specific MALDI matrices, sample preparation protocols, and types of samples is poorly understood. A combinatorial model for matrix clusters was proposed [<xref ref-type="bibr" rid="CR9">9</xref>] which suggests thousands of theoretically possible clusters whereas only some of them are observed in real experiments.</p>
    <p id="Par16">An expert can recognize a matrix ion image upon visual examination. A typical matrix image exhibits the so-called “background” or “off-sample” pattern with high intensities in the area outside of the sample and low intensities within the sample area due to the ion suppression effect [<xref ref-type="bibr" rid="CR12">12</xref>, <xref ref-type="bibr" rid="CR19">19</xref>]. Manual filtering of off-sample ion images is not feasible due to the sheer size of an imaging MS dataset containing 10<sup>4</sup>–10<sup>7</sup> ion images representing at least 10<sup>2</sup>–10<sup>3</sup> molecules [<xref ref-type="bibr" rid="CR15">15</xref>]. To the best of our knowledge, no automated methods for recognizing off-sample ion images were published [<xref ref-type="bibr" rid="CR2">2</xref>]. presents a semi-automated method which requires manual selection of the off-sample area and some parameters and provides no evaluation or error analysis. Various software packages for imaging MS provide co-localization methods which in principle can be used for off-sample recognition but were never evaluated for this specific task. This gap likely persists due to the lack of a gold-standard dataset for evaluation of potential methods.</p>
    <p id="Par17">Artificial intelligence is a boosting field of research that already delivered numerous breakthroughs in image analysis in particular in image recognition. In this paper, we present an artificial intelligence approach to recognize off-sample mass spectrometry images. The approach capitalizes on using open-access data from the METASPACE knowledge base which was created by us [<xref ref-type="bibr" rid="CR15">15</xref>] and populated by over 3000 public submissions from various labs (<ext-link ext-link-type="uri" xlink:href="http://metaspace2020.eu">http://metaspace2020.eu</ext-link>). We shared a large number of mass spectrometry images from public METASPACE datasets with experts who tagged them as either on- or off-sample. We curated and integrated their judgements into a high-quality gold standard set. We developed several machine and deep learning algorithms for recognizing off-sample images. We trained and evaluated them on the gold standard and performed error analysis. In a test-case study, we investigated the off-sample images corresponding to the most popular MALDI matrix (2,5-dihydroxybenzoic acid, DHB) [<xref ref-type="bibr" rid="CR18">18</xref>] and derived properties of matrix clusters using a cluster-generating combinatorial model. We have implemented the best method as a filter in the METASPACE free cloud platform. Overall, our work illustrates how artificial intelligence approaches enabled by open-access data, web technologies, and machine and deep learning open novel avenues to address long-standing challenges in imaging MS.</p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <sec id="Sec3">
      <title>Datasets selected for the gold standard</title>
      <p id="Par18">For the gold standard set, we selected 87 public imaging MS datasets from METASPACE (Supplementary Data <xref rid="MOESM3" ref-type="media">D3</xref>). The datasets span various technologies and samples (Fig. <xref rid="Fig1" ref-type="fig">1</xref>). Importantly for the methods development, the gold standards includes datasets with both rectangular and non-rectangular imaged area. Also, some datasets included several tissue sections in the imaged area. For examples of representative off-sample ion images from the gold standard datasets see Fig. <xref rid="Fig2" ref-type="fig">2</xref>.
<fig id="Fig1"><label>Fig. 1</label><caption><p>Properties of the public METASPACE datasets selected for the gold standard. They represent a variety of labs, types of samples, and technologies. Following a stratified random selection, this gold standard set reflects the full set of public datasets in the METASPACE knowledge base and, taking into account the size of METASPACE currently encompassing over 3000 public datasets, can be considered to be a representative sample in the field of imaging MS</p></caption><graphic xlink:href="12859_2020_3425_Fig1_HTML" id="MO1"/></fig>
<fig id="Fig2"><label>Fig. 2</label><caption><p>Representative off-sample ion images from the gold standard datasets illustrating a variety of spatial patterns exhibited by such images as well as particular aspects of the imaging MS datasets. <bold>a</bold>-<bold>c</bold>: Illustrative images from several datasets showing the indicative off-sample pattern (high intensities outside of the tissue section) from DESI- (<bold>a</bold>) and MALDI-imaging (<bold>b</bold>-<bold>c</bold>). <bold>d</bold>: A dataset with several tissue sections. <bold>e</bold>: A non-rectangular dataset where the acquisition area was selected around a whole body mouse tissue section. <bold>f</bold>: The indicative off-sample pattern. <bold>g</bold>: A gradually-changing off-sample pattern. <bold>h</bold>-<bold>k</bold>: Different spatial patterns of off-sample images in the same dataset (MALDI-imaging, DHB matrix). <bold>h</bold>: The indicative pattern. <bold>i</bold>: Everywhere-pattern. <bold>j</bold>: Gradually-changing pattern. <bold>k</bold>: Spotty pattern with spots everywhere, potentially due to a special matrix (DHB) application. <bold>l</bold>-<bold>o</bold>: Different spatial patterns of off-sample images in the same dataset (DESI-imaging). <bold>l</bold>: Mainly off-sample localization. <bold>m</bold>: Gradual off-sample localization. <bold>n</bold>: Off-sample leakage pattern. <bold>o</bold>: Everywhere pattern. <bold>p</bold>-<bold>s</bold>: Examples of off-sample MALDI ion images with only a narrow band of off-sample pixels due to the acquisition area selected precisely around the tissue section. METASPACE links to the ion images: <bold>a</bold>, <bold>b</bold>, <bold>c</bold>, <bold>d</bold>, <bold>e</bold>, <bold>f</bold>, <bold>g</bold>, <bold>h</bold>, <bold>i</bold>, <bold>j</bold>, <bold>k</bold>, <bold>l</bold>, <bold>m</bold>, <bold>n</bold>, <bold>o</bold>, <bold>p</bold>, <bold>q</bold>, <bold>r</bold>, <bold>s</bold>. For acknowledgements for these and other gold standard datasets, see section Acknowledgements</p></caption><graphic xlink:href="12859_2020_3425_Fig2_HTML" id="MO2"/></fig></p>
    </sec>
    <sec id="Sec4">
      <title>Pilot study on creating a gold standard</title>
      <p id="Par19">The pilot study helped us learn about a variety of spatial patterns in off- and on-sample images (Fig. <xref rid="Fig2" ref-type="fig">2</xref>, Supplementary Data <xref rid="MOESM3" ref-type="media">D1</xref>) as well as about the complexity and subjectivity of the tagging task, pitfalls of using automated strategies, as well as estimate resources necessary to obtain a sufficiently large gold standard set of tagged ion images. Moreover, we understood the importance of avoiding semi-automated tagging in order to avoid potential biases. This required implementing a web app for tagging, as simple approaches not requiring any special software are not feasible for obtaining a sufficient number of tagger ion images.</p>
    </sec>
    <sec id="Sec5">
      <title>Gold standard</title>
      <p id="Par20">The obtained gold standard includes 23,238 manually tagged ion images, of them 13,329 “off-sample” and 9909 “on-sample”, available at <ext-link ext-link-type="uri" xlink:href="https://github.com/metaspace2020/offsample">https://github.com/metaspace2020/offsample</ext-link>. The ion images tagged as “unknown” were not included into the gold standard.</p>
    </sec>
    <sec id="Sec6">
      <title>Agreement between taggers</title>
      <p id="Par21">Supplementary Table <xref rid="MOESM2" ref-type="media">S1</xref> shows the average pairwise inter-tagger agreement values for each of the five selected datasets. Note that those datasets, in curator opinion, were among the most difficult datasets to tag. The tagger-curator agreement values range from 0.89 to 1.0 with the average of 0.97 and inter-tagger average agreement values ranging from 0.71 to 0.98 with the average of 0.89. We speculate that the dataset “Servier_Ctrl_mouse_wb_median_plane_DHB” was likely hard to tag due the whole-body section including organs of various properties (density, ionization) as well as presence of the skin-localized ions which resemble matrix ions with high intensity at the perimeter of the section (Supplementary Figure <xref rid="MOESM1" ref-type="media">S2</xref>). Next, we evaluated the performance of each tagger individually, and their agreement with other taggers. Supplementary Table <xref rid="MOESM2" ref-type="media">S2</xref> shows that taggers highly agree with the curator (with the Cohen κ greater than 0.95). The opposite would indicate excessive curation that could be associated with a bias introduced by the curator. Tagger2, Tagger3, and Tagger4 show a strong inter-tagger agreement (Cohen κ greater than 0.92), while Tagger1 and Tagger5 show a moderate inter-tagger agreement (Cohen κ 0.74 and 0.88).</p>
      <p id="Par22">To provide an additional validation of the achieved high inter-tagger agreement, we also calculated Krippendorff’s alpha. The average Krippendorff’s alpha is equal to 0.9 similar to Cohen’s κ (0.89); see Supplementary Table <xref rid="MOESM2" ref-type="media">S1</xref>.</p>
    </sec>
    <sec id="Sec7">
      <title>Performance of the off-sample recognition methods</title>
      <sec id="Sec8">
        <title>Spatio-molecular biclustering method</title>
        <p id="Par23">The results of the unsupervised spatio-molecular biclustering method are shown in Supplementary Table <xref rid="MOESM2" ref-type="media">S3</xref>. The biclustering method performed the best when combined with the SVM (support vector machine) with linear kernel, among other machine learning methods. The optimal values of the method parameters for cluster assignment were <italic>cluster_percent</italic> = 0.09, <italic>border_percent</italic> = 0.1, <italic>full_percent</italic> = 0.1. We investigated the datasets for which the method performed poorly, i.e. the <italic>F</italic>1 score per dataset for either the “off-sample” or “on-sample” class was below 0.7, which accounted to eight datasets in total. We visually inspected the spatial clusters for each dataset. For three out of eight datasets, the spatial clusters were visibly noisy (e.g. Supplementary Figure <xref rid="MOESM1" ref-type="media">S1</xref>a) as compared to visibly homogeneous clusters for the remaining 84 datasets (e.g. Supplementary Figure <xref rid="MOESM1" ref-type="media">S1</xref>b). For two out of poorly performed eight datasets, we observed the wrong assignment of large spatial clusters to either “off-sample” or “on-sample” class (Supplementary Figure <xref rid="MOESM1" ref-type="media">S1</xref>c-d). We additionally examined all other datasets and confirmed that for all but these two datasets, the assignment was correct.</p>
        <p id="Par24">In order to improve the method, we considered a semi-automated strategy when a user would curate the assignment of two largest spatial clusters. This semi-automated method is easy to implement as the curation can be performed just once for a dataset, and requires a quick visual examination and one click for assignment of one of the two spatial clusters to the “off-sample” class. For the semi-automated method, we manually swapped labels for two datasets for which automated assignment failed (Supplementary Figure <xref rid="MOESM1" ref-type="media">S1</xref>c-d) that improved the performance up to the <italic>F</italic>1 score of 0.96 for off-sample and 0.97 for on-sample (Supplementary Table <xref rid="MOESM2" ref-type="media">S3</xref>, second row).</p>
        <p id="Par25">For 78 out of 87 datasets, the method produced two large spatial clusters per dataset. For the remaining nine datasets, two large clusters and, in addition, from one to eight smaller spatial clusters per dataset were found. In total, 14 out of 16 of the small clusters were assigned correctly.</p>
      </sec>
      <sec id="Sec9">
        <title>Molecular co-localization method</title>
        <p id="Par26">Similar to the bi-clustering method, the molecular co-localization method performed the best when combined with the SVM with the linear kernel. The performance is shown in Supplementary Table <xref rid="MOESM2" ref-type="media">S4</xref> (first row). Since the molecular co-localization method maps all ion images into the molecular space of all molecular formulas annotated at FDR (false discovery rate) &lt; =50%, it is natural to assume that this method works the best when applied to datasets of similar molecular content. To test this hypothesis, we applied it only to a group of MALDI-imaging datasets acquired using the 2,5-dihydroxybenzoic acid (DHB) matrix in the positive ion mode. The polarity mode and the MALDI matrix are among the most influential parameters determining the molecular content, as molecules have preferential ionization polarity and affinity to a MALDI matrix. Supplementary Table <xref rid="MOESM2" ref-type="media">S4</xref> (second row) shows that indeed, the performance of the classifier when applied to DHB data only has been improved, particularly for recognizing off-sample images with the <italic>F</italic>1-score increased from 0.9 to 0.96 (though not significant considering the confidence intervals of +/− 0.06).</p>
      </sec>
      <sec id="Sec10">
        <title>Comparing performance of all methods</title>
        <p id="Par27">Table <xref rid="Tab1" ref-type="table">1</xref> compares the performance of all developed methods for recognizing off-sample ion images. Since our intended application was filtering out off-sample ions, we were mostly interested in the high <italic>F</italic>1 values for off-sample detection. The best performing method was the deep residual learning that achieved the <italic>F</italic>1 off-sample score of 0.97 +/− 0.01. This method had high stable recall and precision values for off-sample detection (0.98 +/− 0.03 and 0.96 +/− 0.03), while its detection of on-sample was less reliable (0.94 +/− 0.07). The second best method with the <italic>F</italic>1 score of 0.96 +/− 0.03 for off-sample was the semi-automated spatio-molecular biclustering where curation of the cluster assignments to off/on classes was performed for two datasets. This method proved to be the most reliable for on-sample detection with <italic>F</italic>1 equal to 0.97 +/− 0.01.The spatio-molecular biclustering method without any curation achieved the <italic>F</italic>1 score of 0.93 +/− 0.1 for off-sample and 0.95 +/− 0.06 for on-sample. Note that the biclustering method is unsupervised and the gold standard was used only to select the parameters. The off-sample <italic>F</italic>1 score of the molecular co-localization method was 0.90 +/− 0.07 only. Note that the molecular co-localization method performed considerably better (<italic>F</italic>1 score of 0.96 +/− 0 .06) on a reduced set of DHB positive data (Supplementary Table <xref rid="MOESM2" ref-type="media">S4</xref>) that potentially indicates that molecular co-localization can perform on par with other methods when applied to data collected with the same matrix. Supplementary Data <xref rid="MOESM3" ref-type="media">D1</xref> describes the performance of the template-image method which achieved the <italic>F</italic>1 score of 0.96 +/− 0.06 and 0.92 +/− 0.14 in semi- and fully-automated scenarios, respectively (Supplementary Table <xref rid="MOESM2" ref-type="media">S6</xref>).
<table-wrap id="Tab1"><label>Table 1</label><caption><p>Performance of the developed methods for recognizing off-sample ion images as evaluated on the gold standard of 23,238 ion images showing <italic>F</italic>1-score (<italic>F</italic>1), precision (<italic>P</italic>), and recall (<italic>R</italic>). For each measure, we show the average and confidence intervals (+ − two standard deviations) over five folds of the cross validation</p></caption><table frame="hsides" rules="groups"><thead><tr><th rowspan="2"/><th colspan="3">off-sample</th><th colspan="3">on-sample</th></tr><tr><th><italic>F</italic>1</th><th><italic>P</italic></th><th><italic>R</italic></th><th><italic>F</italic>1</th><th><italic>P</italic></th><th><italic>R</italic></th></tr></thead><tbody><tr><td>Deep residual learning</td><td>.97 (+/−.01)</td><td>.96 (+/−.03)</td><td>.98 (+/−.03)</td><td>.96 (+/−.04)</td><td>.97 (+/−.03)</td><td>.94 (+/−.07)</td></tr><tr><td>Semi-automated spatio-molecular biclustering, clusters curated for 2 datasets</td><td>.96 (+/−.03)</td><td>.96 (+/−.07)</td><td>.96 (+/−.04)</td><td>.97 (+/−.01)</td><td>.97 (+/−.03)</td><td>.97 (+/−.03)</td></tr><tr><td>Spatio-molecular biclustering</td><td>.93 (+/−.10)</td><td>.92 (+/−.10)</td><td>.94 (+/−.11)</td><td>.95 (+/−.06)</td><td>.95 (+/−.06)</td><td>.95 (+/−.06)</td></tr><tr><td>Molecular co-localization</td><td>.90 (+/− .07)</td><td>.95 (+/− .08)</td><td>.86 (+/− .15)</td><td>.93 (+/− .05)</td><td>.91 (+/− .11)</td><td>.96 (+/− .07)</td></tr></tbody></table></table-wrap></p>
      </sec>
    </sec>
    <sec id="Sec11">
      <title>Off-sample results for specific types of imaging mass spectrometry</title>
      <sec id="Sec12">
        <title>MALDI imaging with the DHB matrix</title>
        <p id="Par28">Recognition of off-sample ion images can have numerous applications and generally is expected to improve downstream data analysis. Here, we applied it to characterize the properties of DHB matrix clusters. First, we selected 31 MALDI-imaging datasets from the gold standard which were acquired using the DHB matrix in the positive ion mode; see Supplementary Data <xref rid="MOESM3" ref-type="media">D4</xref>. Then, 353 molecular formulas of the DHB matrix clusters were generated following a combinatorial model proposed earlier [<xref ref-type="bibr" rid="CR9">9</xref>]. We then created a custom molecular database for METASPACE by combining these molecular formulas with the HMDB (Human Metabolome Database) v4 database [<xref ref-type="bibr" rid="CR21">21</xref>] and re-annotated the 31 datasets using this database.</p>
        <p id="Par29">For the 31 selected datasets, 6677 ions of DHB matrix clusters were annotated by METASPACE with an FDR &lt; =50%. Of them, 3134 (47%) were recognized as off-sample and thus can be confidently associated with the matrix. These ions represent approximately 5% of all 58,203 annotated ions for the selected datasets. Per dataset, we recognized from zero (for one dataset only) to 314 off-sample DHB matrix cluster ions (101.1 ions on average). This quantifies the amount of biologically-unrelated information that should be removed prior to any downstream analysis.</p>
        <p id="Par30">From the recognized matrix cluster ions, 4.3% of them are isomeric with non-matrix molecules in HMDB v4. This quantifies the ambiguity of metabolite annotation which turns out to be relatively low.</p>
        <p id="Par31">Figure <xref rid="Fig3" ref-type="fig">3</xref> shows the parameters of the recognized matrix clusters. Interestingly, the recognized clusters exhibit broad patterns for all individual components of the combinatorial model “n*M + p*(M-H2O)-x*H + y*K + z*Na” [<xref ref-type="bibr" rid="CR9">9</xref>] with a slight prevalence to form clusters including two molecules of DHB. Supplementary Table <xref rid="MOESM2" ref-type="media">S5</xref> shows the most frequently recognized matrix clusters; for a full list, see Supplementary Data <xref rid="MOESM3" ref-type="media">D4</xref>. Two most frequent clusters were recognized in 28 out of 31 datasets. Note that the protonated ion of the intact DHB matrix, [M + H]+, the ion that one would commonly expect to be detected, was recognized only in 11 datasets (35% of all datasets). Interestingly, among the most frequently detected matrix clusters (Supplementary Table <xref rid="MOESM2" ref-type="media">S5</xref>) there are no clusters containing potassium (K). This is also visible in Fig. <xref rid="Fig3" ref-type="fig">3</xref>e which shows that for a prevalent majority of recognized DHB cluster ions the parameter “y” corresponding to the inclusion of potassium in the cluster ion is equal to 0. The most frequent matrix cluster with potassium was “2*M + 1*(M-H2O)-1*H + 1*K + 0*Na”, detected in 14 datasets (45% of all datasets).
<fig id="Fig3"><label>Fig. 3</label><caption><p>Parameters of the recognized DHB clusters. <bold>a</bold>: The formula n*M+p*(M-H2O)-x*H+y*K+z*Na represents the combinatorial model for matrix clusters from (Keller and Li, 2000) with M representing the DHB matrix molecular formula (C<sub>7</sub>H<sub>6</sub>O<sub>4</sub>). <bold>b</bold>-<bold>c</bold>: Histograms of parameters of the formula from A among ions in 31 MALDI-imaging DHB positive mode datasets which were annotated by METASPACE with an FDR&lt;=50% and ion image recognized as off-sample</p></caption><graphic xlink:href="12859_2020_3425_Fig3_HTML" id="MO3"/></fig></p>
      </sec>
      <sec id="Sec13">
        <title>DESI imaging</title>
        <p id="Par32">We have applied the best off-sample classifier to all DESI (desorption electrospray ionization) imaging datasets from the gold standard (see Supplementary Data <xref rid="MOESM3" ref-type="media">D5</xref> as well as all images in section “Gold standard ion images predictions” at <ext-link ext-link-type="uri" xlink:href="https://github.com/metaspace2020/offsample">https://github.com/metaspace2020/offsample</ext-link>). Among all molecules formulas detected in METASPACE with FDR of at least 50%, ions with two molecular formulae were classified in more than half of the datasets (in datasets from two labs: Takats lab from Imperial College London and Everlin lab from UT Austin: C18H30O3S (in 14 out of 24 datasets) and C17H28O3S (in 13 out of 24 datasets). Interestingly, some off-sample DESI ion images show “glowing” or “border” spatial patterns with high intensities around the border of the tissue section (see Supplementary Figure <xref rid="MOESM1" ref-type="media">S4</xref>).</p>
      </sec>
    </sec>
  </sec>
  <sec id="Sec14">
    <title>Discussion</title>
    <p id="Par33">Machine learning, and in particular deep learning, has demonstrated its capacities to outperform other approaches in various fields of science and technology including image and speech recognition, computer vision, and artificial intelligence [<xref ref-type="bibr" rid="CR11">11</xref>]. Currently, deep learning is making its way into computational biology [<xref ref-type="bibr" rid="CR1">1</xref>]. However, for exploiting potential of machine learning algorithms, one needs annotated or tagged data for training and evaluation. When solving molecular questions in the context of imaging mass spectrometry, the annotated data is often hard to obtain due to the lack of ground truth information about molecular content of the analyzed sample. Here, we decided to explore the potential of machine and deep learning approaches to tackle a problem which on a small scale can be solved by an expert: recognition of off-sample ion images. Our expertise in creating a high-quality gold standard [<xref ref-type="bibr" rid="CR13">13</xref>] together with the exploited techniques of modern web development helped create a high-quality gold standard of 23,238 images.</p>
    <p id="Par34">This work was enabled by METASPACE, an open knowledge base of imaging MS data [<xref ref-type="bibr" rid="CR15">15</xref>]. We used public datasets from 20 laboratories with the goal to obtain a gold standard that would be representative for the current state of the art, and to create methods that would have a wide impact in applications involving common imaging MS technologies and types of samples. By making their data public on METASPACE, these labs and their members made this study possible. Public semi-structured data is becoming increasingly useful and, through enabling novel computational developments, will ultimately benefit the field of imaging MS.</p>
    <p id="Par35">The software technologies used in METASPACE are another cornerstone in this study. The tagging web app TagOff was created based on METASPACE. Moreover, the flexible technology behind METASPACE enabled us to create a custom molecular database including DHB matrix clusters to screen for them in tens of datasets in a short time. We also used METASPACE for interactive data visualization, and sharing data and images in this paper. As a future step, we are planning to integrate the developed recognition of off-sample ion images into METASPACE and make it available to all users and in particular to those who provided public data used for training classifiers.</p>
    <p id="Par36">Working with semi-structured data from various sources is challenging because of the lack of complete information about biological systems, sample preparation, data acquisition, and data pre-processing. METASPACE metadata captures essential parts of this information (<ext-link ext-link-type="uri" xlink:href="https://github.com/metaspace2020/metadata">https://github.com/metaspace2020/metadata</ext-link>). Here, we demonstrated that the problem of recognizing off-sample ion images can be successfully solved using minimal metadata.</p>
    <p id="Par37">Note that our approach does not solve the segmentation problem of finding pixels which are in the off-sample region. Our approach is aimed to find and filter out those ion images which correspond to MALDI matrix or other background interferences. Although its results can be used to infer off-sample region e.g. creating an average off-sample ion image and taking high-intensity regions, this task is beyond the scope of this study.</p>
    <p id="Par38">In this work, we compared classification approaches of different kinds: machine learning employing either molecular or spatio-molecular content as well as a computer vision approach based on deep learning. We discovered that deep learning outperforms other approaches in the <italic>F</italic>1 off-sample score, with a semi-automatic expert-driven method based on spatio-molecular biclustering almost matching and outperforming it in the <italic>F</italic>1 on-sample score. The usual drawback, also experienced by us when using various deep learning frameworks, is that deep learning networks require a substantial training time, namely days on specially-devoted GPU (graphics processing unit)-equipped power station than hinders optimization. However, a combination of using a modern and fast framework (fast.ai), advanced deep learning methodology (residual learning), and training optimization make it possible to outperform the best expert-driven approaches.</p>
    <p id="Par39">Finally, we have implemented the deep learning classifier in the METASPACE platform, accessible for as new filter (click at “Add filter”, then “Show/hide off-sample annotations”). The implementation is also available through the REST API (<ext-link ext-link-type="uri" xlink:href="https://github.com/metaspace2020/metaspace/tree/master/metaspace/off-sample">https://github.com/metaspace2020/metaspace/tree/master/metaspace/off-sample</ext-link>). We believe that this example of how open-source software can be improved by using public data, collective input from the users, and deep learning, represents a model how challenging problems can be solved in the age of machine learning and open-access data.</p>
  </sec>
  <sec id="Sec15">
    <title>Conclusions</title>
    <p id="Par40">We believe that this work will not only help solve an important problem in imaging MS, but also will serve as an example of creating a high-quality annotated gold standard and subsequently applying machine learning and deep learning methods in this field. The access to public semi-structured data allowed us to create a gold standard data which is representative for the field of imaging MS and to develop methods that will have a wide impact beyond just one laboratory or research group.</p>
  </sec>
  <sec id="Sec16">
    <title>Methods</title>
    <sec id="Sec17">
      <title>Creating a gold standard set of ion images</title>
      <p id="Par41">In image recognition, a gold standard set is a collection of images manually tagged by experts called taggers often curated to ensure the highest quality. Having a gold standard set enables training and evaluating machine learning algorithms. However, creating an unbiased, representative, and balanced gold standard is a substantial challenge on its own. To the best of our knowledge, there exists no gold standard set of off-sample images for imaging MS.</p>
      <sec id="Sec18">
        <title>Selecting imaging MS datasets for the gold standard</title>
        <p id="Par42">To create a gold standard set of off-sample and on-sample ion images, we selected public datasets from METASPACE with the aim to have a manageable number of diverse yet representative sample of datasets from different labs, samples, and imaging MS methods. First, we randomly selected 100 datasets from the public datasets in METASPACE. We added 14 more manually picked datasets to increase the diversity of the set and to represent a particular lab, biological model, sample preparation protocol, imaging MS source or analyzer that were not picked by the random sampling. We excluded 27 datasets from one big METASPACE submitter to reduce the lab, technology, and sample type bias, which left us with 87 gold standard imaging MS datasets.</p>
      </sec>
      <sec id="Sec19">
        <title>Pilot study</title>
        <p id="Par43">Before creating a gold standard, we ran a pilot study to investigate the difficulty of recognizing off-sample ion images, as well as to learn potential pitfalls and obstacles of the tagging process by involving two taggers; see Supplementary Data <xref rid="MOESM3" ref-type="media">D1</xref> for more information.</p>
      </sec>
      <sec id="Sec20">
        <title>Web app for manual tagging of ion images</title>
        <p id="Par44">The TagOff webapp (<ext-link ext-link-type="uri" xlink:href="https://github.com/metaspace2020/offsample">https://github.com/metaspace2020/offsample</ext-link>) was developed with the aim to facilitate tagging as well as help inspect tagged images, correct the tagging, and curate the gold standard. For a public dataset in METASPACE, the web app downloads ion images from METASPACE using the GraphQL API (link), shows ion images, and let a tagger tag each image into one of three classes (“off-sample”, “on-sample”, “unknown”). Tagging can be performed either by a single- or double-mouse click or, alternatively, by pressing shortcut keys while hovering the mouse. Also, we implemented a random subsampling that selects a specified number of ion images randomly; if a dataset has a lower number of ion images, all ion images would be considered. For each selected dataset and each tagger involved, we generated unique URLs containing the dataset and tagger names, and the maximal number of ion images to be considered. The tagging results are stored in real time, associated with the tagger name, and can be opened by either the same tagger or a curator; see Fig. <xref rid="Fig4" ref-type="fig">4</xref>, video in Supplementary Data <xref rid="MOESM3" ref-type="media">D2</xref>.
<fig id="Fig4"><label>Fig. 4</label><caption><p>The TagOff web app for facilitated tagging off-sample ion images by using mouse clicks or keyboard shortcuts. <bold>a</bold>: The layout of the web page in TagOff. <bold>b</bold>: A tagger tagging ion images from a DESI-imaging dataset of five liver sections, contributed by Nicole Strittmatter, AstraZeneca (<ext-link ext-link-type="uri" xlink:href="https://metaspace2020.eu/annotations?ds=2016-12-09_10h16m23s&amp;q=DESI%20quan_Swales&amp;sort=-msm">link</ext-link>)</p></caption><graphic xlink:href="12859_2020_3425_Fig4_HTML" id="MO4"/></fig></p>
      </sec>
      <sec id="Sec21">
        <title>Creating the gold standard set</title>
        <p id="Par45">For every gold standard imaging MS dataset, we considered annotations at a False Positive Rate &lt; = 50% (the most permissive value in METASPACE) and randomly selected 500 ion images for tagging. For datasets with less than 500 ions annotated, all ion images were considered. We recruited five taggers with previous experience in mass spectrometry and explained to them the motivation behind the study and how to use the TagOff web app. No optical images or information about sample, imaging MS, protocols used to acquire the images were provided to the taggers. The taggers were instructed to spend less than 1 s per ion image. We also explained molecular and sample preparation factors contributing to generation of off-sample ion images (matrix application in MALDI, spraying in DESI), the ion suppression effect leading to lower intensities of matrix signals within the sample region, as well as advanced imaging MS effects which can affect how images look like (high noise, metabolite leakage, wet matrix application). Importantly, the tagging was performed before recognition methods were developed to ensure that taggers are not biased by knowing how methods work.</p>
        <p id="Par46">All 87 gold standard datasets were randomly distributed between five taggers, with each dataset assigned to one tagger. Each tagger received a set of pre-generated TagOff URLs. After the tagging process was completed, “off-sample” and “on-sample” tags in each dataset were reviewed by a curator with experience in imaging MS by quick skimming through images of the same class and re-tagging when necessary. The curation aimed to ensure that the taggers understood the task correctly and to minimally correct obvious mistakes. For two taggers, after seeing inconsistencies in the first tagged datasets, the curator instructed the taggers again and asked to repeat the tagging.</p>
      </sec>
    </sec>
    <sec id="Sec22">
      <title>Evaluating the gold standard</title>
      <p id="Par47">We assessed the complexity of the off-sample classification task and the reproducibility of the taggers judgements by calculating an inter-tagger agreement. For this, after the tagging was completed, the curator selected five gold standard datasets which were, in their opinion, among the most difficult datasets to tag. All taggers, who did not tag these datasets initially, were asked to tag them additionally, so that each of these five datasets was tagged by all five taggers. Then, we computed the taggers’ pairwise Cohen’s kappa agreement coefficient [<xref ref-type="bibr" rid="CR4">4</xref>] for all ion images from these five datasets which were tagged as “off-sample” or “on-sample”. The images tagged as “unknown” by at least one tagger in the pair were ignored. We also computed Krippendorff’s alpha [<xref ref-type="bibr" rid="CR10">10</xref>] ignoring “unknown” tags.</p>
    </sec>
    <sec id="Sec23">
      <title>Methods for automated recognition of off-sample images</title>
      <p id="Par48">We developed three methods for automated recognition of off-sample ion images. Supplementary Data <xref rid="MOESM3" ref-type="media">D1</xref> describes one more, template-image method.</p>
      <sec id="Sec24">
        <title>Spatio-molecular biclustering method</title>
        <p id="Par49">The “spatio-molecular biclustering” method assumes that pixels of the off-sample area have similar molecular profiles as well as molecules corresponding to the off-sample area have similar distributions. First, for each dataset we found the border pixels. Note that, as discussed earlier, some of the considered datasets have non-rectangular calculated borders. Second, for each dataset we considered a matrix of ion intensities in all pixels. We performed biclustering using <italic>SpectralCoclustering</italic> from the scikit-learn v0.19.1. We iteratively increased the number of clusters from two to 20 until we found two large spatial clusters occupying more than <italic>cluster_percent</italic> (method parameter) percent of all pixels. Third, we assigned the resulting clusters to either “off-sample” or “on-sample” class. For the two large clusters, the cluster with a larger number of border pixels was assigned to “off-sample”; the other large cluster was assigned to “on-sample”. For a smaller cluster, the cluster was classified as off-sample if its border pixels occupied more than <italic>border_percent</italic> of all border pixels or more than <italic>full_percent</italic> of all small cluster pixels; otherwise it was assigned to “on-sample”. Biclustering of pixels and ions immediately provided assignment of ions to either “off-sample” or “on-sample”. Note that biclustering is an unsupervised method and requires no training. For selecting the parameters <italic>cluster_percent</italic>, <italic>border_percent</italic>, and <italic>full_percent</italic>, we used the five-fold cross validation. The resulting parameters were averaged over the five folds.</p>
      </sec>
      <sec id="Sec25">
        <title>Molecular co-localization method</title>
        <p id="Par50">The “molecular co-localization” method assumes that off-sample ions are similar across datasets in terms of which ions they are co-localized with. We considered all ions annotated in at least one gold standard dataset with an FDR &lt; = 50%. Within each dataset, we considered each ion as a vector of its intensities in all pixels. We represented all ions in a molecular space of all molecular formulas in all gold standard datasets as follows. First, we computed pairwise cosine similarities between all ions. Then, for each ion I and each molecular formula M (corresponding to a dimension of the molecular space), we considered the maximal similarity between the ion I and the ions M_n corresponding to the molecular formula M. Then, once the ions were mapped into this molecular space, we considered we considered a variety of classifiers from the scikit-learn Python package v0.19.1, including the Nearest Neighbors, linear SVM, RBF (radial basis function) SVM, Decision Tree, Random Forest, Naive Bayes, AdaBoost, QDA (quadratic discriminant analysis), Gaussian Process, Neural Net classifiers, and evaluated them on the gold standard images as described later in section “Classifiers evaluation”.</p>
      </sec>
      <sec id="Sec26">
        <title>Deep residual learning method</title>
        <p id="Par51">In the last method, we exploited Deep Residual Learning, a recently introduced deep learning approach to image recognition [<xref ref-type="bibr" rid="CR7">7</xref>]. The advantage of the residual learning is faster training of a network which at the same time is deeper than comparable networks. Residual learning was demonstrated to outperform other deep learning approaches in the tasks of image recognition and segmentation in several competitions in 2015. We used the fastai library (v1.0.34) with the PyTorch framework (v1.0) with the ResNet-50 model from the torchvision library (v0.2.1). First, all ion images of non-rectangular datasets were padded with zeros. Then, the images were normalized with the ImageNet statistics (per channel mean and std), resized and cropped to 224 × 224 and, per requirement of the model, converted into RGB three-channels images by pasting the same ion image into all three channels. In order to increase the training set, we applied data augmentation with the settings default for the fast.ai library that included the following transformations: image random crop/pad, horizontal and vertical flip, image warping, rotation, zooming, brightness and contrast adjustment. We used the ResNet-50 network pre-trained on the ImageNet images [<xref ref-type="bibr" rid="CR16">16</xref>]. The training is described in detail in Supplementary Data <xref rid="MOESM3" ref-type="media">D1</xref>. The validation was performed as described later. The trained deep learning model as well as a microservice implementation are available at <ext-link ext-link-type="uri" xlink:href="https://github.com/metaspace2020/offsample">https://github.com/metaspace2020/offsample</ext-link>.</p>
      </sec>
    </sec>
    <sec id="Sec27">
      <title>Classifiers evaluation</title>
      <p id="Par52">The considered classifiers were optimized to maximize the <italic>F</italic>1 score for the off-sample class. We also calculated the precision and recall to provide more detailed information about the performance. For each algorithm, we performed five-fold cross-validation when the whole gold standard was randomly split into five parts, each subsequently taken out for evaluation of the classifier trained on the rest of the data. To avoid overfitting, we used a grouped five-fold cross validation where ion images from the same dataset were all assigned either to the training or validation part.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec28">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="12859_2020_3425_MOESM1_ESM.pdf">
            <caption>
              <p><bold>Additional file 1 </bold>: <bold>Supplementary Figures S1-S4</bold></p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="12859_2020_3425_MOESM2_ESM.pdf">
            <caption>
              <p><bold>Additional file 2 </bold>: <bold>Supplementary Tables S1-S6</bold></p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="12859_2020_3425_MOESM3_ESM.zip">
            <caption>
              <p><bold>Additional file 3 </bold>: <bold>Supplementary Data D1-D5: D1:</bold> “Supplementary methods and results.pdf”. <bold>D2:</bold> “Interactive tagging of ion images using web app.mov”, video of a tagger using the TagOff web app. <bold>D3:</bold> “Gold standard datasets.csv”, metadata of 87 public datasets from METASPACE selected for the gold standard. <bold>D4:</bold> “DHB matrix clusters frequencies.csv”, results of annotation of 31 gold standard datasets acquired using the MALDI DHB matrix and positive ion mode and off-sample recognition for DHB matrix clusters generated according to a combinatorial model. <bold>D5</bold>: “DESI offsample ions frequencies.csv”, a file showing for each molecular formula the number of DESI imaging datasets from the gold standard where ions with such molecular formula were classified as off-sample.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <glossary>
    <title>Abbreviations</title>
    <def-list>
      <def-item>
        <term>DESI</term>
        <def>
          <p id="Par4">Desorption electrospray ionization</p>
        </def>
      </def-item>
      <def-item>
        <term>DHB</term>
        <def>
          <p id="Par5">2,5-dihydroxybenzoic acid</p>
        </def>
      </def-item>
      <def-item>
        <term>FDR</term>
        <def>
          <p id="Par6">False discovery rate</p>
        </def>
      </def-item>
      <def-item>
        <term>FTICR</term>
        <def>
          <p id="Par7">Fourier-transform ion cyclotron resonance</p>
        </def>
      </def-item>
      <def-item>
        <term>GPU</term>
        <def>
          <p id="Par8">Graphics processing unit</p>
        </def>
      </def-item>
      <def-item>
        <term>HMDB</term>
        <def>
          <p id="Par9">Human metabolome database</p>
        </def>
      </def-item>
      <def-item>
        <term>MALDI</term>
        <def>
          <p id="Par10">Matrix-assisted laser desorption/ionization</p>
        </def>
      </def-item>
      <def-item>
        <term>MS</term>
        <def>
          <p id="Par11">Mass spectrometry</p>
        </def>
      </def-item>
      <def-item>
        <term>QDA</term>
        <def>
          <p id="Par12">Quadratic Discriminant Analysis</p>
        </def>
      </def-item>
      <def-item>
        <term>RBF</term>
        <def>
          <p id="Par13">Radial Basis Function</p>
        </def>
      </def-item>
      <def-item>
        <term>SVM</term>
        <def>
          <p id="Par14">Support vector machine</p>
        </def>
      </def-item>
    </def-list>
  </glossary>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher’s Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p><bold>Supplementary information</bold> accompanies this paper at 10.1186/s12859-020-3425-x.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank the taggers: Angelos Rigopoulos, Aslihan Anal, Mohammed Shahraz, Masha Naumenko (all EMBL). We thank the METASPACE submitters whose data was used in this work: Sarah Aboulmagd, Michael Becker, Dhaka Bhandari, Mark Bokhart, Berin Boughton, Shane Ellis, Mathieu Gaudin, Erin Gemperline, Cristina Gonzalez Lopez, Richard Goodwin, Anne Mette Handler, Bram Heijs, Sophie Jacobsen, Christian Janfelt, Emrys Jones, Patrik Kadesch, Pegah Khamehgir-Silz, Mario Kompauer, Lingjun Li, Manuel Liebeke, Michael Linscheid, James McKenzie, David Muddiman, Andrew Palmer, József Pánczél, Marina Reuter, Livia S. Eberlin, Veronika Saharuka, Marta Sans, Julian Schneemann, Kumar Sharma, Bernhard Spengler, Nicole Strittmatter, Zoltan Takats, Dusan Velickovic, Eric Weaver, Guanshi Zhang.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors’ contributions</title>
    <p>KO and TA designed the study. LS implemented the TagOff webapp. KO conceived the tagging experiments and integrated the taggers data into the gold standard. KO developed machine learning methods. VK developed the deep learning method. TA supervised the study. KO and TA wrote the manuscript. All authors contributed to the writing. All authors read and approved the final manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>We acknowledge the funding from the EU Horizon2020 projects METASPACE (634402) and CloudButton (825184), NIH NIDDK project KPMP, and ERC Consolidator project METACELL (773089).</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>The gold standard, source code for evaluation, deep learning model, results of the deep learning model for all ion images from the gold standard, and a microservice implementation with REST API are available at: <ext-link ext-link-type="uri" xlink:href="https://github.com/metaspace2020/offsample">https://github.com/metaspace2020/offsample</ext-link>.</p>
  </notes>
  <notes>
    <title>Ethics approval and consent to participate</title>
    <p id="Par53">No ethics approval was necessary as only already published data was used in this study.</p>
  </notes>
  <notes>
    <title>Consent for publication</title>
    <p id="Par54">The written consent was given by a tagger to use his photo in Fig. <xref rid="Fig1" ref-type="fig">1</xref>.</p>
  </notes>
  <notes notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par55">Until 2020, Theodore Alexandrov was on the Scientific Advisory Board of SCiLS, a company developing software for imaging mass spectrometry.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Angermueller</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Deep learning for computational biology</article-title>
        <source>Mol Syst Biol</source>
        <year>2016</year>
        <volume>12</volume>
        <fpage>878</fpage>
        <pub-id pub-id-type="doi">10.15252/msb.20156651</pub-id>
        <pub-id pub-id-type="pmid">27474269</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bokhart</surname>
            <given-names>MT</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MSiReader v1.0: evolving open-source mass spectrometry imaging software for targeted and untargeted analyses</article-title>
        <source>J Am Soc Mass Spectrom</source>
        <year>2018</year>
        <volume>29</volume>
        <fpage>8</fpage>
        <lpage>16</lpage>
        <pub-id pub-id-type="doi">10.1007/s13361-017-1809-6</pub-id>
        <pub-id pub-id-type="pmid">28932998</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buchberger</surname>
            <given-names>AR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Mass spectrometry imaging: a review of emerging advancements and future insights</article-title>
        <source>Anal Chem</source>
        <year>2018</year>
        <volume>90</volume>
        <fpage>240</fpage>
        <lpage>265</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.analchem.7b04733</pub-id>
        <pub-id pub-id-type="pmid">29155564</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cohen</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Weighted kappa: nominal scale agreement with provision for scaled disagreement or partial credit</article-title>
        <source>Psychol Bull</source>
        <year>1968</year>
        <volume>70</volume>
        <fpage>213</fpage>
        <lpage>220</lpage>
        <pub-id pub-id-type="doi">10.1037/h0026256</pub-id>
        <pub-id pub-id-type="pmid">19673146</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Doerr</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Mass spectrometry imaging takes off</article-title>
        <source>Nat Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>32</fpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4546</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dreisewerd</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Yew</surname>
            <given-names>JY</given-names>
          </name>
        </person-group>
        <article-title>Mass spectrometry imaging goes three dimensional</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>1139</fpage>
        <lpage>1140</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4513</pub-id>
        <pub-id pub-id-type="pmid">29190273</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>He</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Deep Residual Learning for Image Recognition</article-title>
        <source>2016 IEEE conference on computer vision and pattern recognition (CVPR)</source>
        <year>2016</year>
        <fpage>770</fpage>
        <lpage>778</lpage>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Karas</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Krüger</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Ion formation in MALDI: the cluster ionization mechanism</article-title>
        <source>Chem Rev</source>
        <year>2003</year>
        <volume>103</volume>
        <fpage>427</fpage>
        <lpage>440</lpage>
        <pub-id pub-id-type="doi">10.1021/cr010376a</pub-id>
        <pub-id pub-id-type="pmid">12580637</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Keller</surname>
            <given-names>BO</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>Discerning matrix-cluster peaks in matrix-assisted laser desorption/ionization time-of-flight mass spectra of dilute peptide mixtures</article-title>
        <source>J Am Soc Mass Spectrom</source>
        <year>2000</year>
        <volume>11</volume>
        <fpage>88</fpage>
        <lpage>93</lpage>
        <pub-id pub-id-type="doi">10.1016/S1044-0305(99)00126-9</pub-id>
        <pub-id pub-id-type="pmid">10631669</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Krippendorff</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <source>Content analysis: an introduction to its methodology</source>
        <year>2004</year>
        <publisher-loc>Thousand Oaks</publisher-loc>
        <publisher-name>SAGE</publisher-name>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>LeCun</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Deep learning</article-title>
        <source>Nature</source>
        <year>2015</year>
        <volume>521</volume>
        <fpage>436</fpage>
        <lpage>444</lpage>
        <pub-id pub-id-type="doi">10.1038/nature14539</pub-id>
        <pub-id pub-id-type="pmid">26017442</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lee</surname>
            <given-names>MCW</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell analyses of transcriptional heterogeneity during drug tolerance transition in cancer cells by RNA sequencing</article-title>
        <source>Proc Natl Acad Sci U S A</source>
        <year>2014</year>
        <volume>111</volume>
        <fpage>E4726</fpage>
        <lpage>E4735</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.1404656111</pub-id>
        <pub-id pub-id-type="pmid">25339441</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palmer</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Using collective expert judgements to evaluate quality measures of mass spectrometry images</article-title>
        <source>Bioinformatics</source>
        <year>2015</year>
        <volume>31</volume>
        <fpage>i375</fpage>
        <lpage>i384</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btv266</pub-id>
        <pub-id pub-id-type="pmid">26072506</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palmer</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Where imaging mass spectrometry stands: here are the numbers</article-title>
        <source>Metabolomics</source>
        <year>2016</year>
        <volume>12</volume>
        <fpage>1</fpage>
        <lpage>3</lpage>
        <pub-id pub-id-type="doi">10.1007/s11306-016-1047-0</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palmer</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>FDR-controlled metabolite annotation for high-resolution imaging mass spectrometry</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>57</fpage>
        <lpage>60</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4072</pub-id>
        <pub-id pub-id-type="pmid">27842059</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Russakovsky</surname>
            <given-names>O</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>ImageNet large scale visual recognition challenge</article-title>
        <source>Int J Comput Vis</source>
        <year>2015</year>
        <volume>115</volume>
        <fpage>211</fpage>
        <lpage>252</lpage>
        <pub-id pub-id-type="doi">10.1007/s11263-015-0816-y</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schulz</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Advanced MALDI mass spectrometry imaging in pharmaceutical research and drug development</article-title>
        <source>Curr Opin Biotechnol</source>
        <year>2018</year>
        <volume>55</volume>
        <fpage>51</fpage>
        <lpage>59</lpage>
        <pub-id pub-id-type="doi">10.1016/j.copbio.2018.08.003</pub-id>
        <pub-id pub-id-type="pmid">30153614</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Strupat</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>2,5-Dihydroxybenzoic acid: a new matrix for laser desorption—ionization mass spectrometry</article-title>
        <source>Int J Mass Spectrom Ion Process</source>
        <year>1991</year>
        <volume>111</volume>
        <fpage>89</fpage>
        <lpage>102</lpage>
        <pub-id pub-id-type="doi">10.1016/0168-1176(91)85050-V</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Taylor</surname>
            <given-names>AJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Exploring ion suppression in mass spectrometry imaging of a heterogeneous tissue</article-title>
        <source>Anal Chem</source>
        <year>2018</year>
        <volume>90</volume>
        <fpage>5637</fpage>
        <lpage>5645</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.analchem.7b05005</pub-id>
        <pub-id pub-id-type="pmid">29461803</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vaysse</surname>
            <given-names>P-M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Mass spectrometry imaging for clinical research - latest developments, applications, and current limitations</article-title>
        <source>Analyst</source>
        <year>2017</year>
        <volume>142</volume>
        <fpage>2690</fpage>
        <lpage>2712</lpage>
        <pub-id pub-id-type="doi">10.1039/C7AN00565B</pub-id>
        <pub-id pub-id-type="pmid">28642940</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wishart</surname>
            <given-names>DS</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>HMDB 4.0: the human metabolome database for 2018</article-title>
        <source>Nucleic Acids Res</source>
        <year>2018</year>
        <volume>46</volume>
        <fpage>D608</fpage>
        <lpage>D617</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkx1089</pub-id>
        <pub-id pub-id-type="pmid">29140435</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
