<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Biotechnol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Biotechnol</journal-id>
    <journal-title-group>
      <journal-title>Nature Biotechnology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1087-0156</issn>
    <issn pub-type="epub">1546-1696</issn>
    <publisher>
      <publisher-name>Nature Publishing Group US</publisher-name>
      <publisher-loc>New York</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10513360</article-id>
    <article-id pub-id-type="pmid">36797494</article-id>
    <article-id pub-id-type="publisher-id">1657</article-id>
    <article-id pub-id-type="doi">10.1038/s41587-023-01657-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>TACCO unifies annotation transfer and decomposition of cell identities for single-cell and spatial omics</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-1447-6811</contrib-id>
        <name>
          <surname>Mages</surname>
          <given-names>Simon</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <name>
          <surname>Moriel</surname>
          <given-names>Noa</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-7118-9179</contrib-id>
        <name>
          <surname>Avraham-Davidi</surname>
          <given-names>Inbal</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Murray</surname>
          <given-names>Evan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-7519-731X</contrib-id>
        <name>
          <surname>Watter</surname>
          <given-names>Jan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-2308-3649</contrib-id>
        <name>
          <surname>Chen</surname>
          <given-names>Fei</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-6313-3570</contrib-id>
        <name>
          <surname>Rozenblatt-Rosen</surname>
          <given-names>Orit</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff9">9</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3628-9278</contrib-id>
        <name>
          <surname>Klughammer</surname>
          <given-names>Johanna</given-names>
        </name>
        <address>
          <email>klughammer@genzentrum.lmu.de</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3293-3158</contrib-id>
        <name>
          <surname>Regev</surname>
          <given-names>Aviv</given-names>
        </name>
        <address>
          <email>aviv.regev.sc@gmail.com</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff6">6</xref>
        <xref ref-type="aff" rid="Aff9">9</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-0074-9196</contrib-id>
        <name>
          <surname>Nitzan</surname>
          <given-names>Mor</given-names>
        </name>
        <address>
          <email>mor.nitzan@mail.huji.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff7">7</xref>
        <xref ref-type="aff" rid="Aff8">8</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05a0ya142</institution-id><institution-id institution-id-type="GRID">grid.66859.34</institution-id><institution>Klarman Cell Observatory, Broad Institute of MIT and Harvard, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05591te55</institution-id><institution-id institution-id-type="GRID">grid.5252.0</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 973X</institution-id><institution>Gene Center and Department of Biochemistry, </institution><institution>Ludwig-Maximilians-University Munich, </institution></institution-wrap>Munich, Germany </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>School of Computer Science and Engineering, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05a0ya142</institution-id><institution-id institution-id-type="GRID">grid.66859.34</institution-id><institution>Broad Institute of MIT and Harvard, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03vek6s52</institution-id><institution-id institution-id-type="GRID">grid.38142.3c</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 754X</institution-id><institution>Department of Stem Cell and Regenerative Biology, </institution><institution>Harvard University, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff6"><label>6</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/042nb2s44</institution-id><institution-id institution-id-type="GRID">grid.116068.8</institution-id><institution-id institution-id-type="ISNI">0000 0001 2341 2786</institution-id><institution>Massachusetts Institute of Technology, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff7"><label>7</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>Racah Institute of Physics, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff8"><label>8</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>Faculty of Medicine, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff9"><label>9</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/04gndp242</institution-id><institution-id institution-id-type="ISNI">0000 0004 5899 3818</institution-id><institution>Present Address: Genentech, </institution></institution-wrap>South San Francisco, CA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>16</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>16</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <year>2023</year>
    </pub-date>
    <volume>41</volume>
    <issue>10</issue>
    <fpage>1465</fpage>
    <lpage>1473</lpage>
    <history>
      <date date-type="received">
        <day>15</day>
        <month>6</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>2</day>
        <month>1</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Transferring annotations of single-cell-, spatial- and multi-omics data is often challenging owing both to technical limitations, such as low spatial resolution or high dropout fraction, and to biological variations, such as continuous spectra of cell states. Based on the concept that these data are often best described as continuous mixtures of cells or molecules, we present a computational framework for the transfer of annotations to cells and their combinations (TACCO), which consists of an optimal transport model extended with different wrappers to annotate a wide variety of data. We apply TACCO to identify cell types and states, decipher spatiomolecular tissue structure at the cell and molecular level and resolve differentiation trajectories using synthetic and biological datasets. While matching or exceeding the accuracy of specialized tools for the individual tasks, TACCO reduces the computational requirements by up to an order of magnitude and scales to larger datasets (for example, considering the runtime of annotation transfer for 1 M simulated dropout observations).</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">Annotation transfer from reference to new datasets is improved with a probabilistic approach.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Software</kwd>
      <kwd>Data integration</kwd>
      <kwd>Data processing</kwd>
      <kwd>Computational platforms and environments</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100001659</institution-id>
            <institution>Deutsche Forschungsgemeinschaft (German Research Foundation)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>MA 9108/1-1</award-id>
        <principal-award-recipient>
          <name>
            <surname>Mages</surname>
            <given-names>Simon</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100000854</institution-id>
            <institution>Human Frontier Science Program (HFSP)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>LT000452/2019-L</award-id>
        <principal-award-recipient>
          <name>
            <surname>Klughammer</surname>
            <given-names>Johanna</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000051</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Human Genome Research Institute (NHGRI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>5RM1HG006193-09</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000054</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Cancer Institute (NCI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1U24 CA180922</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100006955</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1U19 MH114821</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000062</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Institute of Diabetes and Digestive and Kidney Diseases (National Institute of Diabetes &amp; Digestive &amp; Kidney Diseases)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1RC2 DK114784</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000011</institution-id>
            <institution>Howard Hughes Medical Institute (HHMI)</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Klarman Cell Observatory MIT Ludwig Center Manton Family Foundation</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100003977</institution-id>
            <institution>Israel Science Foundation (ISF)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1079/21</award-id>
        <principal-award-recipient>
          <name>
            <surname>Nitzan</surname>
            <given-names>Mor</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100005155</institution-id>
            <institution>Azrieli Foundation</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100006785</institution-id>
            <institution>Google</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem Horizon Europe ERC Grant (101040660)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© Springer Nature America, Inc. 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Main</title>
    <p id="Par3">Single-cell and spatial genomics methods provide high-dimensional measurements of biological systems at unprecedented scale and resolution<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR2">2</xref></sup>. One of the key challenges is attaching meaningful and interpretable representations of the experimental measurements to denote cellular features, such as types, states, cell-cycle stages or position within tissues<sup><xref ref-type="bibr" rid="CR3">3</xref>,<xref ref-type="bibr" rid="CR4">4</xref></sup> to decipher cellular dynamics, communication and collective behavior. For several biological systems, annotated reference datasets exist that can be leveraged for annotating new, more complex and information-rich datasets.</p>
    <p id="Par4">However, when the new dataset varies substantially from the reference, transferring annotations is a challenging task. A prime example is the transfer of annotations from scRNA-seq to spatial transcriptomics with supracellular spatial resolution. For instance, Slide-seq<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR6">6</xref></sup> uses spatially scattered beads to measure the combined expression of multiple neighboring cells, possibly of different types. Transferred annotations, like cell type, thus become compositional annotations, such as cell-type fractions per bead (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). Similarly, for spatial data with subcellular or even single-molecule resolution<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, compositional annotations of local neighborhoods allow segmentation-free annotation and cell assignment of single molecules. Furthermore, compositional annotations can arise not only from cell mixtures but also from ambiguity of categorical annotations (Fig. <xref rid="Fig1" ref-type="fig">1b</xref>). For example, technical noise, caused by dropout or contamination of ambient RNA, can mask the true identity of an individual cell. Finally, biological continua as observed in cell differentiation or regulatory cellular spectra also require probabilistic cell-type assignments (Fig. <xref rid="Fig1" ref-type="fig">1b</xref>).<fig id="Fig1"><label>Fig. 1</label><caption><title>TACCO, a flexible framework for the annotation and analysis of cells and cell-like objects.</title><p><bold>a</bold>, TACCO generates annotations for new datasets of mixtures (top left) using an annotated single-cell reference (top right) and provides methods for downstream analysis of the resulting compositional annotations (bottom left). <bold>b</bold>, Compositional annotations. Illustrative embeddings of cells and cell-like objects annotated (left) for mixtures (pie charts) of idealized pure contributions (triangles); (middle) as ambiguous annotations (triangles with colored borders) for technical artifacts like high ambient contributions or dropout levels and (right) continuous annotations (circles) along biological continua. <bold>c</bold>, Annotation process. Far left: a labeled reference dataset (for example, scRNA-seq data and colored triangles) and a new dataset (for example, Slide-seq beads and circles) are first presented in a common high-dimensional space (for example, expression space) optionally using platform normalization to make the datasets comparable. Near left: TACCO represents the reference categories by one or multiple representative profiles (large colored triangles). Near right: TACCO uses semi-unbalanced entropic optimal transport to transfer annotations from the reference categories to the new dataset (arrows), generating compositional annotations for the new datapoints (colored pie charts). To improve the capture of subdominant contributions, this process is iterated. Far right: TACCO provides compositional annotations for the new dataset. <bold>d</bold>, TACCO analysis tools for compositional annotations, especially for spatial data. From left: spatial relationship analysis on long (tissue) and short (cellular neighborships) length scales; inferring spatial regions by both spatial and annotation information; enrichment of compositional annotations and splitting compositionally annotated count data into pure contributions for downstream analysis with single-cell analysis tools.</p></caption><graphic xlink:href="41587_2023_1657_Fig1_HTML" id="d32e524"/></fig></p>
    <p id="Par5">While different decomposition or mapping methods have been developed for specific use cases such as decomposition of spatial measurements<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR8">8</xref>–<xref ref-type="bibr" rid="CR11">11</xref></sup>, spatial single-cell mapping<sup><xref ref-type="bibr" rid="CR12">12</xref>–<xref ref-type="bibr" rid="CR14">14</xref></sup> or resolving trajectories<sup><xref ref-type="bibr" rid="CR15">15</xref>–<xref ref-type="bibr" rid="CR18">18</xref></sup>, they are in fact conceptually similar. In particular, in each of these cases, proximity in expression space translates to higher contributions in the annotation, suggesting that it should be possible to develop a general unifying framework across these tasks.</p>
    <p id="Par6">We implement this idea in a computational framework for the transfer of annotations to cells and their combinations (TACCO). TACCO is an optimal transport-based, flexible and efficient framework for annotation and analysis of single-cell and spatial omics data. We demonstrate TACCO’s applicability in various use cases, including identification of cell types and states, analysis of spatiomolecular tissue structure at different scales and single-cell differentiation fate prediction. Finally, we show that TACCO performs favorably in terms of accuracy and computing requirements when compared to other methods.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>TACCO: a framework for transferring annotations</title>
      <p id="Par7">We developed TACCO, a fast and flexible computational decomposition framework (Fig. <xref rid="Fig1" ref-type="fig">1c</xref>). TACCO takes as input an unannotated dataset consisting of observations (for example, the expression profiles of Slide-seq beads) and a corresponding reference dataset with annotations in a reference representation (for example, single-cell expression profiles with cell-type annotations) and computes a compositional annotation of the unannotated observations (for example, cell-type fractions of the Slide-seq beads). Working in a common high-dimensional space (for example, gene expression space), TACCO determines these compositions using a variation of the optimal transport (OT) algorithm (<xref rid="Sec25" ref-type="sec">Methods</xref>). At its core, OT creates a probabilistic map between the unannotated observations (for example, Slide-seq beads) and the means of the classes in the reference representation (for example, mean cell-type profiles) according to their relative similarity. This approach was previously used to map ancestor and descendant cells during differentiation<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>, recover the spatial organization of cells<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR19">19</xref>–<xref ref-type="bibr" rid="CR21">21</xref></sup> and associate measurements across modalities (for example, single-cell ATAC-seq and scRNA-seq)<sup><xref ref-type="bibr" rid="CR22">22</xref>–<xref ref-type="bibr" rid="CR24">24</xref></sup>. Through the OT framework, users can set the similarity metric, constrain or bias the marginals of the mapping and control the entropy of the annotation distributions (<xref rid="Sec25" ref-type="sec">Methods</xref>). By default, TACCO uses Bhattacharyya coefficients as a similarity metric (<xref rid="Sec25" ref-type="sec">Methods</xref>), which are formally equivalent to the overlaps of probability amplitudes in quantum mechanics and closely related to expectation values of measurements.</p>
      <p id="Par8">To address concrete biological perturbations and experimental variations between the new and reference data, TACCO provides a set of generic boosters (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>), including (1) platform normalization (as in robust cell type decomposition (RCTD)<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>), which introduces scaling factors in the transformation between experimental platforms (for example, Drop-seq<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> to Slide-seq<sup><xref ref-type="bibr" rid="CR5">5</xref></sup>); (2) subclustering with multiple centers to capture within-class heterogeneity and (3) bisectioning for recursive annotation, assigning only part of the annotation in each step and working with the residual in the next step to increase sensitivity to subdominant annotation contributions (<xref rid="Sec25" ref-type="sec">Methods</xref>).</p>
      <p id="Par9">TACCO is also equipped with different analysis tools that leverage the obtained compositional annotations (Fig. <xref rid="Fig1" ref-type="fig">1d</xref>). It adapts categorical annotation analyses to be applicable to mixture annotations across multiple samples, such as the quantification of spatial co-occurrence<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> of annotations to analyze long- and short-range spatial structure, and calculates enrichments of annotations. For spatial data, TACCO can combine spatial and annotation information to define regions with similar annotation compositions across samples. Moreover, TACCO can split compositionally annotated expression data (for example, cell-type annotated Slide-seq beads) into categorically annotated expression data (for example, split beads per cell type) using a matrix scaling algorithm, yielding data that are amenable to standard downstream single-cell analysis workflows.</p>
      <p id="Par10">We evaluated TACCO on the following four different use cases: (1) decomposing cell-type fractions from spatially convoluted gene expression (in silico mixed scRNA-seq profiles for benchmarking and decomposing colon Slide-seq<sup><xref ref-type="bibr" rid="CR6">6</xref></sup> bead measurements); (2) inferring the source cell types of imaged single molecules (without requiring segmentation of cell boundaries from images) for the somatosensory cortex imaged with osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>; (3) recovering cell type for scRNA-seq data with harsh dropout and with ambient RNA contamination (on simulated data) and (4) predicting differentiation fates of early hematopoietic progenitor cells<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. As we show below, TACCO consistently achieved performance comparable to or better than other benchmarked methods and excelled especially in speed and memory consumption.</p>
    </sec>
    <sec id="Sec4">
      <title>Accurate decomposition of in silico mixed expression</title>
      <p id="Par11">We first validated TACCO on simulated Slide-seq data that were generated from an annotated (real) scRNA-seq atlas of the mouse colon<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>) as weighted mixtures of cells drawn from the reference atlas with Gaussian weights parameterized by bead size (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>, <xref rid="Sec25" ref-type="sec">Methods</xref>). We measured the L2 error between the ground-truth weights and the cell-type fractions inferred by TACCO for varying bead sizes. TACCO matched in reconstruction accuracy with RCTD<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> and consistent with this outperformed all other tested state-of-the-art methods (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). Moreover, TACCO was much faster and had lower memory consumption than RCTD because RCTD fits a detailed model dense in parameters. For example, at bead size 1.0 (that is, bead and cells are of comparable size), the L2 errors were 0.081, 0.26 and 0.084 for TACCO, NMFreg<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> and RCTD, while TACCO and RCTD runtimes were 84 s and 1469 s, and memory consumption was 2.7 GB and 10.4 GB, respectively. After annotation, TACCO uses the mean reference profiles and the compositional annotation to distribute the actual counts per gene and observation between the cell types and thereby generates separate observations per cell type, keeping the full gene space intact. A subsequent dimensionality reduction then recovers the low-dimensional structure of the reference data (Fig. <xref rid="Fig2" ref-type="fig">2a</xref> and Extended Data Fig. <xref rid="Fig6" ref-type="fig">2</xref>).<fig id="Fig2"><label>Fig. 2</label><caption><title>TACCO compositional annotation, cell segmentation and analysis of spatial expression data.</title><p><bold>a</bold>, Analysis of in silico mixtures. UMAP embedding of scRNA-seq profiles of mouse colon (1)<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> and of in silico mixed scRNA-seq data before (2) and after (4) applying TACCOs splitting procedure into pure contributions. (3) L2 error (<italic>y</italic> axis) of cell-type annotations for each simulated bead size (<italic>x</italic> axis). Dashed lines: categorical annotation methods. <bold>b</bold>, A Slide-seq puck of normal mouse colon<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> colored by TACCO cell-type annotations (1, colors are weighted and summed per bead) or by TACCO-defined regions (2) (<xref rid="Sec25" ref-type="sec">Methods</xref>; Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>); (3) short-range (up to 20 µm) neighborship enrichment <italic>z</italic> scores over randomly permuted annotation assignments; (4) long-range (up to 500 µm) dependence of the composition of cell types around beads (log<sub>2</sub>(<italic>p</italic>(annotations|center)); <italic>y</italic> axis) at different distances from region 2 (muscularis; <italic>x</italic> axis) for each cell-type annotation (color). <bold>c</bold>, Comparison of TACCO and Baysor for single-molecule cell-type-of-origin annotation performance based on the single-molecule FISH: (1–3) Entire section profiled by osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> (left) and zoom-in on a small region (right) colored by (1) the published annotation of cells from watershed-based segmentation of the poly(A) signal or (2,3) the segmentation-free single-molecule annotation for cell-type-of-origin by TACCO (2) or Baysor (3) (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6a</xref>); (4) measured astrocyte marker gene expression on the zoom-in as ground truth for the astrocyte annotation in (1–3). Gray molecules are unannotated. <bold>d</bold>, Effective cell segmentation of osmFISH data by TACCO. tSNE embeddings of RNA profiles in cell-like objects from the published watershed-based segmentation colored by the published cell-type annotation (1), from TACCOs annotation-based segmentation (using the annotations in c (2)) (2, 3), colored by either TACCOs single-molecule annotations summed per cell (2) or by the published segmented cell annotation pulled back to single molecules (as in c(1)) and summed per cell (3) (<xref rid="Sec25" ref-type="sec">Methods</xref>; Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). <bold>e</bold>, Recovery of layered tissue structure in osmFISH data. Long-range (up to 2,000 µm) dependence of the composition of cell types (<italic>p</italic>(annotations|center = hippocampus), <italic>y</italic> axis) recovered by TACCO for TACCO-segmented objects at different distances from the hippocampus region annotation for each cell-type annotation (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6c</xref>).</p></caption><graphic xlink:href="41587_2023_1657_Fig2_HTML" id="d32e758"/></fig></p>
    </sec>
    <sec id="Sec5">
      <title>Decomposition and structural analysis of Slide-seq data</title>
      <p id="Par12">We next applied TACCO to the annotation of real Slide-seq data from mouse colon with matching scRNA-seq<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>). The different characteristics of scRNA-seq and Slide-seq data present annotation challenges. For example, cell composition can vary substantially, due to selection bias (much larger region assayed for scRNA-seq than Slide-seq) or because of differential capture efficiencies (for example, lower capture of fibroblasts by scRNA-seq<sup><xref ref-type="bibr" rid="CR30">30</xref></sup> compared to their true tissue prevalence). Moreover, Slide-seq’s low RNA capture rate yields much sparser data than scRNA-seq. Despite these challenges, TACCO recovered the expected layered structure of the colon along the muscularis–apical axis, short-range neighborship relations (closeness of stromal and immune cells with segregating epithelial cells) and long-range gradients on tissue structure scale from muscularis to apical plasma membrane (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>).</p>
      <p id="Par13">TACCO scales to real-world applications, such as annotating a large dataset of 40 Slide-seq pucks of the mouse olfactory bulb<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>. Using mean expression profiles of different cell types from scRNA-seq dataset from the same tissue<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, TACCO annotated the full dataset of &gt;1.4 million spatial observations on 8 CPU cores in under 12 min, yielding consistent results between consecutive pucks and two replicates (Extended Data Fig. <xref rid="Fig8" ref-type="fig">4a</xref>). As an alternative to cell-type mean profiles, TACCO can also use every individual cell profile as reference, similar to spatial reconstruction<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR13">13</xref></sup> (Extended Data Fig. <xref rid="Fig8" ref-type="fig">4b</xref>) and infer the cells’ spatial arrangement, by either a compositional annotation of beads with all single cells or by annotating the single cells with the most likely position in the puck. Each of the three approaches implemented with TACCO (using mean expression profiles, compositional annotation with cells or mapping cells to most likely position) gave qualitatively similar spatial distributions of cell type; however, using mean profiles was more efficient computationally, while annotating cells with unique positions introduced additional noise in the spatial cell-type distribution.</p>
    </sec>
    <sec id="Sec6">
      <title>Single-molecule cell-type assignment and segmentation</title>
      <p id="Par14">Next, for single-molecule, high-resolution spatial imaging data (for example, MERFISH<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> or osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>), TACCO includes a wrapper for annotating individual, spatially imaged molecules with cell types, without prior cell segmentation. Standard procedures first segment the captured molecules either based on an image of the cells<sup><xref ref-type="bibr" rid="CR27">27</xref>,<xref ref-type="bibr" rid="CR33">33</xref>–<xref ref-type="bibr" rid="CR35">35</xref></sup> or by finding local maxima in spatially blurred expression fields<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. Both can be challenging due to high cellular density, irregular cell shapes and misplaced molecules<sup><xref ref-type="bibr" rid="CR37">37</xref>,<xref ref-type="bibr" rid="CR38">38</xref></sup>. TACCO circumvents these limitations by annotating each molecule. To this end, TACCO bins molecules using a Cartesian grid into spatial neighborhoods, computes cell-type annotations for each neighborhood using the reference profiles (as for Slide-seq above) and assigns each molecule an annotation in a manner that recapitulates the neighborhood’s annotation fractions (<xref rid="Sec25" ref-type="sec">Methods</xref>). Applied to a mouse brain osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> dataset, TACCO successfully accounted for each molecule (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>), compared to only 36% of molecules annotated following cell segmentation and cell-type classification<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>). Moreover, TACCO matched 59% of the molecular annotations in the original study, substantially better than Baysor<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, a recent single-molecule annotation method based on Bayesian mixture models (Fig. <xref rid="Fig2" ref-type="fig">2c</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>) (35% matched) and comparable to SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>, which annotates kernel density estimates of the expression on a Cartesian grid (<xref rid="Sec25" ref-type="sec">Methods</xref>) (57% matched). Notably, TACCO was much faster than both methods (TACCO: 2 min; Baysor: 27 min and SSAM: 68 min; Extended Data Fig. <xref rid="Fig10" ref-type="fig">6a</xref>) with robust success over a wide range of parameter choices (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6b</xref>). For cells with nonspheroid shapes, such as astrocytes, single-molecule annotation is especially advantageous; while TACCO, Baysor and SSAM annotate all molecules, the baseline segmentation and classification approach only accounts for 17% of astrocyte marker molecules (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>).</p>
      <p id="Par15">Subsequent image-free segmentation to cell-like objects based on spatial and annotation information allowed TACCO to recover expression profiles with cell-type annotations, thus utilizing more of the available data and better representing distinct cell types than the baseline as indicated by a higher silhouette score for TACCO than the baseline (0.24 compared to 0.06; <xref rid="Sec25" ref-type="sec">Methods</xref>; Fig. <xref rid="Fig2" ref-type="fig">2d</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). Applying TACCO’s segmentation on Baysor’s annotation yields an even higher silhouette score (0.45) but at the cost of missing three categories in the annotation (Hippocampus, Inhibitory IC and Inhibitory Pthlh) and a large fraction of molecules in very small segmented objects (28.7% of molecules in objects with less than 20 molecules, compared to 8.3% for TACCO) resulting from a less spatially homogeneous single-molecule annotation of Baysor compared to TACCO (Fig. <xref rid="Fig2" ref-type="fig">2c</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). Using Baysor’s built-in segmentation instead resulted in a silhouette score (0.03) that was worse than baseline and a longer runtime (50 min versus 3–5 min for TACCO segmentations). Replacing TACCO’s annotation with SSAM’s in the TACCO segmentation yielded a comparable silhouette score (0.22).</p>
      <p id="Par16">TACCO’s downstream analyses can use this image-free segmented single-molecule dataset to evaluate short- and long-range spatial patterns by computing the cell-type composition as a function of the distance to specific annotated cells. For example, we demonstrate this by recovering the layered structure of the mouse brain by calculating the distance to annotated hippocampal cells (Fig. <xref rid="Fig2" ref-type="fig">2e</xref>). Thus, TACCO’s spatial analyses efficiently bridge spatial scales from single-molecule data to tissue scale. TACCO’s downstream analysis is generic and can be applied to the annotations and segmentation derived from other methods as well. For example, TACCO- and SSAM-based analyses reproduce the layered structure, but the TACCO-based analysis yielded clearer cell-type density peaks than the SSAM-based one, while Baysor-based analyses were less conclusive (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6c</xref>).</p>
    </sec>
    <sec id="Sec7">
      <title>Classifying cell types in the presence of technical artifacts</title>
      <p id="Par17">While TACCO is primarily a compositional annotation algorithm, it can be used as a cell-type classifier by interpreting the compositional annotation as probabilities and quoting the class with maximum probability as the classification result. Indeed, TACCO performed well in recovering the ground-truth cell-type classification of simulated data with either high dropout rates or high levels of ambient RNAs, as compared to bona fide classifiers, SingleR<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> and SVM, and other compositional annotation methods turned into classifiers (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>). Specifically, for data with high dropout rates, we simulated a reference dataset of distinct cell types using scsim<sup><xref ref-type="bibr" rid="CR40">40</xref>,<xref ref-type="bibr" rid="CR41">41</xref></sup>, where the probability of dropout is a function of log mean expression<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>. Although each cell’s type is preserved, increasing this technical noise leads to increasingly ‘fuzzy’ cell-type-specific signals. Based on the fraction of correctly labeled cells, TACCO outperformed both the classification methods and other compositional methods used as classifiers, with larger performance margins in TACCO’s favor for higher dropout rates. In particular, SVM, a top-performing cell-type classification method<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>, performed poorly when the test data shifted in gene expression. For example, on the same in silico dataset with mild dropout rate (dropmidpoint = −1), TACCO correctly assigned 99.9% of cells, whereas SVM only captured 44.7% correctly. For ambient RNA contributions (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>), we simulated a reference dataset of distinct cell types using scsim<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> with the ambient RNA model from CellBender<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>. TACCO outperformed all other baseline methods, based on the fraction of correctly labeled cells (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>).<fig id="Fig3"><label>Fig. 3</label><caption><title>TACCO addresses dropouts, ambient RNA and continuous annotations.</title><p><bold>a</bold>, Dropout task. (1) UMAP embedding of the simulated scRNA-seq profiles without dropout; (2) schematic of the probability of dropout (<italic>y</italic> axis) for genes with different mean expressions (<italic>x</italic> axis); (3) UMAP embedding of the simulated data from (1) but with dropout; (4) fraction of correctly annotated cells (<italic>y</italic> axis, defined by the agreement of annotated type with maximal probability and the cell’s true annotation) at different dropout rate (<italic>x</italic> axis) for different methods (colors). Dashed lines: categorical annotation methods. <bold>b</bold>, Ambient RNA task: (1) UMAP embedding of simulated scRNA-seq profiles without ambient contribution; (2) schematic of test data generation, where ambient RNA is added to the cell’s expression profile; (3) UMAP embedding of simulated scRNA-seq profiles from (1) but with additional ambient contribution; (4) fraction of correctly annotated cells (<italic>y</italic> axis, defined by agreement of annotated type with maximal probability and the cell’s true annotation) at different levels of ambient RNA contamination (<italic>x</italic> axis) for different methods (colors). Dashed lines: categorical annotation methods. <bold>c</bold>, Differentiation task: (1–3) Spring plot of scRNA-seq profiles from hematopoiesis<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> colored by cell types at day 4 and 6 (1); eventual clonal fate of day 2 cells (2), TACCO-predicted clonal fate of day 2 cells (3); (4) Pearson correlation coefficient (<italic>y</italic> axis) of predicted and actual fate (as evaluated in ref. <sup><xref ref-type="bibr" rid="CR28">28</xref></sup>) for each method (colors).</p></caption><graphic xlink:href="41587_2023_1657_Fig3_HTML" id="d32e1006"/></fig></p>
    </sec>
    <sec id="Sec8">
      <title>TACCO-based prediction of cell fate decisions from scRNA-seq</title>
      <p id="Par18">TACCO also resolved continuous biological variability in the context of cell differentiation. To this end, we used a recent dataset<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> based on the LARRY method, where hematopoietic stem and progenitor cells were clonally barcoded and clones were followed through subsequent cell division and differentiation, for cells profiled by scRNA-seq at day 2, 4 and 6. Most early cells (day 2) (96%) were undifferentiated<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>, while day 4 and 6 cells were mostly (61%) differentiated with distinct profiles; thus, for early progenitor cells, we construct a proxy of their fate identities based on the distribution of the annotations of their clonal relatives (linked via a shared barcode; Fig. <xref rid="Fig3" ref-type="fig">3c</xref>). We then challenged TACCO to predict the fates of early day 2 cells (test data) from the cell-type labeled expression of later, more differentiated cells (reference data). TACCO’s predictions are most correlated with the proxy clonal fates (Pearson’s <italic>r</italic> = 0.73), outperforming five other available methods (<italic>r</italic> = 0.19–0.62; Fig. <xref rid="Fig3" ref-type="fig">3c</xref>).</p>
      <p id="Par19">This difference in prediction accuracy impacted the biological features visible from the analysis. TACCO highlighted the uncertainty of early fate decisions and the correct commitment of cells from late stages, along with differentiation ‘watersheds’ at appropriate points, such as between basophils and neutrophils and between neutrophils and monocytes. Conversely, other methods either did not reproduce the watersheds (for example, WOT), did not reflect fate uncertainty at early stages (for example, SingleR), or did not capture the commitment of later stages (for example, NMFreg) (Extended Data Fig. <xref rid="Fig11" ref-type="fig">7</xref>).</p>
    </sec>
    <sec id="Sec9">
      <title>Benchmark of accuracy, runtime and memory requirements</title>
      <p id="Par20">We designed TACCO with a focus on practical usability. In addition to its broad applicability to many use cases, TACCO has a modest resource footprint in terms of computing time, memory requirements and specialized hardware needs. We benchmarked TACCO’s computational requirements relative to those of baseline methods on standard x86 hardware on the ‘dropout’, ‘mixture’ and ‘differentiation’ tasks with a range of datasets sizes (10<sup>3</sup>–10<sup>6</sup> observations; Fig. <xref rid="Fig4" ref-type="fig">4</xref>). Among all compositional annotation methods in the comparison, TACCO has the lowest runtime and memory requirements, often outperforming the other methods by an order of magnitude or more. Only plain SVM, a categorical annotation method, achieved comparable or better runtime and memory requirements depending on the problem size. However, for categorical annotation, TACCO can also run without the bisectioning booster which improves TACCO’s runtime even further. TACCO achieves all that while maintaining a stable and very competitive L2 error of the annotated compositions with respect to the ground truth across tasks and dataset sizes. While TACCO is very flexible and can be tuned to perform particularly well for specific use cases, a single configuration generally gives a decent performance in terms of runtime, memory and accuracy across various use cases (Extended Data Fig. <xref rid="Fig12" ref-type="fig">8</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>). Additionally, runtime and memory usage are also optimized in TACCO’s downstream analysis tools. For example, similar statistics of co-occurrence and neighborhood-enrichment testing are computed via Squidpy<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> and TACCO, but faster to compute with TACCO (Extended Data Fig. <xref rid="Fig13" ref-type="fig">9</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>).<fig id="Fig4"><label>Fig. 4</label><caption><title>Benchmarking TACCO’s runtime, memory requirement and accuracy of annotation transfer.</title><p>Runtime (top), memory (middle) and L2 error (bottom) of each method (colors) in the ‘mixture’ (left; with bead size = 1.0), ‘dropout’ (middle; with drop midpoint = −1.0) and ‘differentiation’ (right) use cases, at different numbers of observations (cells or beads, <italic>x</italic> axis), ranging from 2<sup>10</sup> ~ 1 k to 2<sup>20</sup> ~ 1 M, which are up/down sampled from the datasets in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. Reference size is fixed at 2<sup>14</sup> ~ 16 k. The maximum compute resources per run are 8 CPU cores for 8 h with 8 GB memory each. Missing data points indicate that either compute time or memory was insufficient to complete the annotation. Methods with an asterisk do not natively return (fractional) annotations of spatial measurements, which leaves the total annotation fractions in the spatial measurement as degrees of freedom. The wrapper fills that using the reference type fractions. Categorical annotation methods are dashed.</p></caption><graphic xlink:href="41587_2023_1657_Fig4_HTML" id="d32e1094"/></fig></p>
    </sec>
  </sec>
  <sec id="Sec10" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par21">In conclusion, TACCO is a compositional annotation approach and broader analysis package rooted in the realization that multiple tasks in high-dimensional biological representations rely on successfully resolving continuous mixtures over cells or molecules, either due to biological or technical reasons. To leverage annotations of a reference dataset to annotate another dataset, TACCO integrates core, interpretable annotation methods, such as OT, and computational manipulations addressing concrete data perturbations. Together, these yield a top-performing framework in terms of accuracy, scalability, speed and memory requirements, making TACCO applicable for a wide range of annotation tasks.</p>
    <p id="Par22">However, the flexibility and efficiency of TACCO’s OT-based annotation come at a price. It cannot incorporate diverse detailed knowledge about the data-generating process as methods from the (deep) variational inference class do. While certain applications may benefit from creating a specialized annotation method instead of TACCO, this often requires substantial manual effort, detailed knowledge of the system and computing resources.</p>
    <p id="Par23">A further limitation is the requirement of overlapping feature spaces for reference and target data. Therefore, to use TACCO’s annotation for the transfer of annotations between modalities (for example, RNA–protein, DNA accessibility/methylation–RNA), a translation between the modalities needs to be performed externally to TACCO.</p>
    <p id="Par24">TACCO could be further extended by modeling continuous reference annotations (for example, interpolating/extrapolating along a linear reference), by integrating additional priors such as spatial smoothness for annotating spatial transcriptomic data and by integrating manifold learning techniques to better approximate expression distances from reference profiles.</p>
    <p id="Par25">The analytical form of interpretable methods like OT also opens the door to theoretical work on the limitations and guarantees of projecting annotations from one data to another, leading to more informed method selection.</p>
    <p id="Par26">TACCO’s computational efficiency places it as a potential building block for the development of new ‘meta’ analysis tools which perform different tasks. A prominent example for this is already implemented within TACCO: TACCO’s single-molecule annotation relies on repeatedly performing compositional annotations, which is feasible due to its underlying efficiency.</p>
    <p id="Par27">While showing here several examples of compositional and categorical annotations, we anticipate that TACCO will help in deciphering many other datasets, such as in decomposing expression of overloaded scRNA-seq experiments (for example, MIRACL-seq<sup><xref ref-type="bibr" rid="CR45">45</xref></sup>, which overloads single nuclei to capture more rare cells) and in deciphering cells with complex continuous states, such as T cell spectra.</p>
  </sec>
  <sec id="Sec11">
    <title>Datasets</title>
    <sec id="Sec12">
      <title>Mouse colon scRNA-seq and in silico spatial mixing</title>
      <p id="Par28">Mouse colon scRNA-seq data<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, as available from <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link> in raw counts format after basic quality filtering, with the provided cell-type annotations, was used to simulate spatial mixing by sampling uniformly spatial coordinates for cells and for simulated beads on a square. To make boundary effects smaller, periodic boundary conditions were employed. On the resulting torus, the minimal Euclidean distance was taken between cells and beads. To factor in the ‘shape’ of the beads, that distance was plugged into a kernel to compute the weights of contributions of each cell to a bead. From these weights, expression counts of cells and cell-type annotation of cells, expression counts of beads, cell-type fractions and count fractions belonging to each type were computed.</p>
      <p id="Par29">A Gaussian kernel was used to determine the weight of cell <italic>c</italic> in bead <italic>b</italic> as follows:<disp-formula id="Equa"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left( {w_{{\mathrm{gauss}}}} \right)_{cb} = r\,{\mathrm{exp}}\left( { - 1/2\left( {d_{cb}/l} \right)^2} \right)$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:msub><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>w</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">gauss</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>r</mml:mi><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>/</mml:mo><mml:mn>2</mml:mn><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equa.gif" position="anchor"/></alternatives></disp-formula>where <italic>d</italic><sub><italic>cb</italic></sub> is the Euclidean distance between the centers of cell <italic>c</italic> and bead <italic>b</italic>, <italic>l</italic> = 1/2 bead_size √<italic>1/n</italic>, and <italic>n</italic> cells. To capture the higher sparsity of the spatial data, the weight was scaled by a capture rate parameter <italic>r</italic> such that a cell contributes a fraction of <italic>r</italic> of its counts to a bead with distance <italic>0</italic>. <italic>r</italic> = 1.0 was used everywhere except where explicitly stated.</p>
    </sec>
    <sec id="Sec13">
      <title>Mouse colon scRNA-seq and Slide-seq data</title>
      <p id="Par30">scRNA-seq (as in the section above) and Slide-seq data of normal mouse colon were obtained from ref. <sup><xref ref-type="bibr" rid="CR29">29</xref></sup>. Raw counts reported for Puck 2020-09-14_Puck_200701_21 were used as available from <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link>.</p>
    </sec>
    <sec id="Sec14">
      <title>Mouse olfactory bulb scRNA-seq and Slide-seq data</title>
      <p id="Par31">scRNA-seq of mouse olfactory bulb was obtained from <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR32">32</xref></sup>), and Slide-seq data of the same tissue from <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR31">31</xref></sup>). Raw counts were used for both datasets.</p>
    </sec>
    <sec id="Sec15">
      <title>Single-molecule osmFISH of the mouse cortex</title>
      <p id="Par32">osmFISH data were obtained from <ext-link ext-link-type="uri" xlink:href="http://linnarssonlab.org/osmFISH/availability/">http://linnarssonlab.org/osmFISH/availability/</ext-link> ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. Reference expression profiles and their corresponding annotations were obtained from osmFISH-segmented cell profiles provided in ‘osmFISH_SScortex_mouse_all_cells.loom’.</p>
      <p id="Par33">Raw mRNA locations were obtained from ‘mRNA_coords_raw_counting.hdf5’.</p>
      <p id="Par34">Preprocessing was performed using the procedure in <ext-link ext-link-type="uri" xlink:href="https://github.com/HiDiHlabs/ssam_example/blob/master/osmFISH_SSp.ipynb">https://github.com/HiDiHlabs/ssam_example/blob/master/osmFISH_SSp.ipynb</ext-link>. This includes (1) shifting and rescaling cell/RNA coordinates to match each other (with an RNA coordinate system); (2) removing RNA molecules of bad quality; (3) correcting incorrect gene names and (4) removing molecules outside the intended imaged frame.</p>
      <p id="Par35">‘polyT_seg.pkl’, which contains a mapping of osmFISH’s segmented cell to molecule, was used to project osmFISH’s cell annotation onto individual molecules (approximating the ground truth). To visualize annotations at single-molecule level (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>), a window of x range (1,150, 1,400) and y range (1,000, 1,600) was used.</p>
    </sec>
    <sec id="Sec16">
      <title>scRNA-seq simulations with scsim with enhanced dropout</title>
      <p id="Par36">Scsim<sup><xref ref-type="bibr" rid="CR41">41</xref></sup> with its corresponding default parameters (set in notebook ‘Step1_Simulate.ipynb’, with changing deloc to 5.0) was used to simulate scRNA-seq data. The dropout step described in Splatter<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> was implemented in Python, by fitting a sigmoid curve through genes’ log mean count and their cell fraction with zero reads, where the sigmoid is characterized by shape and midpoint parameters. To enhance dropout, the sigmoid was shifted (decrease its midpoint) and the adjusted dropout probability was computed. This probability was then used to binomially sample the observed counts.</p>
    </sec>
    <sec id="Sec17">
      <title>scRNA-seq simulations with scsim with ambient RNA</title>
      <p id="Par37">To simulate expression profiles with ambient RNA, scsim’s<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> simulation of mean expression per cells and genes (termed ‘updatedmean’ in scsim and denoted in Splatter<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> as <italic>λ</italic>, a matrix of the means for each gene and each cell) was combined with CellBender’s<sup><xref ref-type="bibr" rid="CR44">44</xref></sup> model of ambient RNA contamination and downstream sampling of counts.</p>
      <p id="Par38">Specifically, the mean expression of gene <italic>g</italic> and cell <italic>n</italic> (or here, the cell in drop <italic>n</italic>) was obtained from scsim as <italic>λ</italic><sub><italic>ng</italic></sub>. For CellBender’s probabilistic model, the probability of having a cell in the drop <italic>y</italic><sub><italic>n</italic></sub> is set to 1 (because empty drops are not considered), and <italic>ρ</italic><sub><italic>n</italic></sub> is set to 0 because 0 reads are exogenous to the drop as we account only for ambient RNA (pumped into the drop) and not for barcode swapping. Thus, the CellBender model simplifies to<disp-formula id="Equb"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_{ng}\sim {{{\mathrm{NB}}}}\left( {d_n^{{\mathrm{cell}}}\chi _{ng} + d_n^{{\mathrm{drop}}}\chi ^a_g,{\Phi}} \right)$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>~</mml:mo><mml:mi mathvariant="normal">NB</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Φ</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equb.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par39">The two models were combined as follows:</p>
      <p id="Par40"><inline-formula id="IEq1"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda _{ng} = d_n^{{\mathrm{cell}}}\chi _{ng}$$\end{document}</tex-math><mml:math id="M6"><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq1.gif"/></alternatives></inline-formula> is the mean expression (similar to CellBender, scsim also uses a log-normal distribution of cell size)</p>
      <p id="Par41"><inline-formula id="IEq2"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda' _g = {\mathrm{avg}}_n\lambda _{ng} = \chi _g^a$$\end{document}</tex-math><mml:math id="M8"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">avg</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq2.gif"/></alternatives></inline-formula> is the mean true count of gene <italic>g</italic>, that is, the ambient contribution of the gene</p>
      <p id="Par42">Given the fraction of ambient RNA, <italic>f</italic>
<sup>drop</sup>, and the library size, <inline-formula id="IEq3"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M10"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq3.gif"/></alternatives></inline-formula>, and scale, <inline-formula id="IEq4"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\sigma ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M12"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq4.gif"/></alternatives></inline-formula>, used for sampling the cell size, <inline-formula id="IEq5"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_n^{{\mathrm{cell}}},d_n^{{\mathrm{drop}}}$$\end{document}</tex-math><mml:math id="M14"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq5.gif"/></alternatives></inline-formula> ~ logNormal(<inline-formula id="IEq6"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M16"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq6.gif"/></alternatives></inline-formula> + log(<italic>f</italic><sup>drop</sup>), <inline-formula id="IEq7"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\sigma ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M18"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq7.gif"/></alternatives></inline-formula>) is sampled (that is, the same variance is employed as used for sampling the cell content and the mean is set to log(exp(<inline-formula id="IEq8"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M20"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq8.gif"/></alternatives></inline-formula>) <italic>f</italic>
<sup>drop</sup>).</p>
      <p id="Par43"><italic>Φ</italic> is sampled as defined in CellBender</p>
      <p id="Par44">Thus, we sample<disp-formula id="Equc"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_{ng}\sim {{{\mathrm{NB}}}}( {\lambda _{ng} + d_n^{{\mathrm{drop}}}\lambda' _g,{{{\Phi}}}} )$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>~</mml:mo><mml:mi mathvariant="normal">NB</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Φ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equc.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par45">For comparability, the reference is generated in the same way (using negative binomial sampling instead of scsim’s Poisson sampling) but without adding ambient RNA.</p>
    </sec>
    <sec id="Sec18">
      <title>scRNA-seq of clone-labeled hematopoiesis cells</title>
      <p id="Par46">Normalized counts (‘stateFate_inVitro_normed_counts.mtx’, together with the corresponding gene names and cell metadata) and cells’ clone matrix (‘stateFate_inVitro_clone_matrix.mtx’) were obtained from the GitHub repository <ext-link ext-link-type="uri" xlink:href="https://github.com/AllonKleinLab/paper-data/blob/master/">https://github.com/AllonKleinLab/paper-data/blob/master/</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR28">28</xref></sup>). Cells were filtered to those belonging to clones with cells on day 2 and on days 4 or 6. The fate bias for each cell on day 2 was computed from the fates of its clone on days 4 and 6 (normalized to 1). Differentiated cells captured on days 4 and 6 were then used as a reference for annotating cells of differentiated fate from day 2.</p>
    </sec>
    <sec id="Sec19">
      <title>TACCO configuration</title>
      <p id="Par47">With the exception of the analyses mentioned below, TACCO was generally applied with an identical parameter set across all analyses in this manuscript: core annotation method OT (default TACCO setting), basic platform normalization (default TACCO setting for OT), entropy regularization parameter epsilon 0.005 (default TACCO setting for OT), marginal relaxation parameter lambda of 0.1 (default TACCO setting for OT), four iterations of boosting with a divisor of three (default TACCO setting for OT) and multi_center = 10 (10 representing means for each type to account for variability with an annotation category). Aside from parameter stability analyses, the exceptions are as follows: (1) for Fig. <xref rid="Fig4" ref-type="fig">4</xref>, in addition to running TACCO with the default parameter values as described above, TACCO was also applied without boosting, using only the maximum annotation per observation as categorical annotation, and all other parameters identical as an optimized categorical annotation method ‘TACCO (cat)’. (2) For Extended Data Fig. <xref rid="Fig8" ref-type="fig">4</xref>, TACCO was used with TACCO’s default settings only, that is, all parameters identical to above but not using the multi_center booster. (3) For the single-molecule annotation of the osmFISH data, default parameters were used again, but no platform normalization was used because the reference shares identical platform effects with the data to annotate. The additional parameters specific to single-molecule annotation were set to bin_size = 10, reflecting the expected size of features, that is cells, of about 10 µm, and n_shifts = 3, as a tradeoff between speed and reduction of artifacts.</p>
    </sec>
    <sec id="Sec20">
      <title>Baysor configuration</title>
      <p id="Par48">Running Baysor on the osmFISH example with the osmFISH-specific configurations available in the github repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor">https://github.com/kharchenkolab/Baysor</ext-link>) and adapting the Baysor code (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>) to accept cell-type means achieved only 25% match with osmFISH’s annotations. Therefore, we adapted code and used parameters from the segmentation-free annotation transfer described in the BaysorAnalysis repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/BaysorAnalysis/blob/master/notebooks/segmentation_free/segmentation_free_allen_smfish.md">https://github.com/kharchenkolab/BaysorAnalysis/blob/master/notebooks/segmentation_free/segmentation_free_allen_smfish.md</ext-link>) and increased Baysor performance to achieve 35% match with osmFISH original annotations. These parameters are mainly default parameters: we used the functions build_molecule_graph() with filter = false, append_confidence() with nn_id = 16, and cluster_molecules_on_mrf() with do_maximize = false, max_iters = 1,000, and n_iters_without_update = 20.</p>
      <p id="Par49">For the segmentation we followed the Baysor code (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>) and used the specialized values for the osmFISH data from the repository, where available, and default values from the repository otherwise. Specifically, we used scale-std = ‘25%’ and prior-segmentation-confidence = 0.2 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>, iters = 500 and num-cells-init = 30,000 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/examples/osm-FISH/README.md">https://github.com/kharchenkolab/Baysor/blob/master/examples/osm-FISH/README.md</ext-link>, scale = 70.0 and min-molecules-per-cell = 30 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/configs/osm_fish.toml">https://github.com/kharchenkolab/Baysor/blob/master/configs/osm_fish.toml</ext-link> and new-component-fraction = 0.3 and new-component-weight = 0.2 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/common.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/common.jl</ext-link>.</p>
    </sec>
    <sec id="Sec21">
      <title>SSAM configuration</title>
      <p id="Par50">For SSAM, we followed the SSAM user guide and used default parameters except for find_local_max() for which we supplied the parameters recommended in the user guide: search_size = 3, min_norm = 0.027, min_expression = 0.2.</p>
      <p id="Par51">To map the SSAM annotations of the generated Cartesian grid back to individual molecules and to compare them with the single-molecule annotations from TACCO and Baysor, we assigned to every molecule the annotation of the grid point closest to it.</p>
    </sec>
    <sec id="Sec22">
      <title>RCTD configuration</title>
      <p id="Par52">For RCTD, we adapted the default parameters to work in the framework of TACCO such that all clusters in the reference are used (CELL_MIN_INSTANCE = 0), all cells end up with an annotation (UMI_min = 0), RCTD does not throw an exception for lowly covered types in the reference (UMI_min_sigma = min(300,median<sub>observations</sub>(total_counts_per_observation)-1)), and every observation gets a compositional annotation over all available types (doublet_mode = ‘full’).</p>
    </sec>
    <sec id="Sec23">
      <title>NovoSpaRc configuration</title>
      <p id="Par53">For NovoSpaRc, we used alpha = 1.0 and adapted the default parameters to use all available genes.</p>
    </sec>
    <sec id="Sec24">
      <title>Configuration of other annotation methods</title>
      <p id="Par54">For all other annotation methods (SVM, SingleR, NMFreg, WOT, Tangram), we used default parameters.</p>
    </sec>
  </sec>
  <sec id="Sec25">
    <title>Methods</title>
    <sec id="Sec26">
      <title>Overview of TACCO framework</title>
      <p id="Par55">TACCO is based on three guiding principles: modularity, interpretability and efficiency. TACCOs compositional annotation algorithm is built from a single fast core method, which is then supplemented by a diverse set of wrappers and ‘boosters’, each providing additional functionality and features. The framework is completed by a set of downstream analysis tools, some of which are especially optimized for analysis involving compositional annotations. TACCO relies on Anndata and seamlessly integrates with the Scanpy<sup><xref ref-type="bibr" rid="CR46">46</xref></sup> ecosystem.</p>
    </sec>
    <sec id="Sec27">
      <title>Compositional annotation</title>
      <p id="Par56">TACCO aims to annotate single cells and cell-like objects, like Slide-seq beads or Visium spots, with compositional annotations. In cases with discrete ground truth (for example, a B cell versus a fibroblast), we interpret the compositional annotation as probabilities of belonging to a category. Both objects <italic>b</italic> and categories <italic>t</italic> are in a common high-dimensional data space, for example, expression space. Generally, objects that are close to a category in that space should have a high contribution of that category in the compositional annotation.</p>
      <p id="Par57">The goal of the annotation is to find a matrix <italic>ρ</italic><sub><italic>tb</italic></sub> which gives the distribution of annotation over objects <italic>b</italic> and categories <italic>t</italic>. Some applications imply certain natural choices for the ‘units’ of <italic>ρ</italic><sub><italic>tb</italic></sub>. For example, in the case of count data, the natural units are counts as well, such that <italic>ρ</italic><sub><italic>tb</italic></sub> gives the counts in object <italic>b</italic> which are attributed to category <italic>t</italic>. The marginal distribution over categories is just the total number of counts Σ<sub><italic>t</italic></sub>
<italic>ρ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>b</italic></sub> per object <italic>b</italic> and is known. The marginal distribution over objects Σ<sub><italic>b</italic></sub>
<italic>ρ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>t</italic></sub> is not known beforehand and is an output of the annotation process. As the marginals per object are known in general, it is equivalent to cite only the normalized distributions <italic>ρ</italic>′<sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>tb</italic></sub>/<italic>ρ</italic><sub><italic>b</italic></sub> with Σ<sub><italic>t</italic></sub>
<italic>ρ</italic>′<sub><italic>tb</italic></sub> = 1 as an annotation result.</p>
    </sec>
    <sec id="Sec28">
      <title>Core annotation method by OT</title>
      <p id="Par58">TACCO’s core method is entropically regularized, partially balanced OT (an intrinsically fast variant of OT). Balanced OT solves the optimization problem <italic>γ</italic><sub>tb</sub> = argmin<sub><italic>γtb</italic></sub> Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub>
<italic>M</italic><sub><italic>tb</italic></sub> under the positivity constraint <italic>γ</italic><sub><italic>tb</italic></sub> ≥ <italic>0</italic> and the marginal constraints Σ<sub><italic>t</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> = <italic>c</italic><sub><italic>b</italic></sub> and Σ<sub><italic>b</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> = <italic>c</italic><sub><italic>t</italic></sub> with the transport cost Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub>
<italic>M</italic><sub><italic>tb</italic></sub> = <italic>&lt;</italic> <italic>γ</italic>, <italic>M</italic> &gt; <sub>F</sub> given by the Frobenius inner product of a mapping matrix <italic>γ</italic><sub><italic>tb</italic></sub> and a constant matrix <italic>M</italic><sub><italic>tb</italic></sub>. <italic>M</italic><sub><italic>tb</italic></sub> encodes the cost of ‘transporting’ or mapping an object <italic>b</italic> to an annotation <italic>t</italic> and must be chosen sensibly to yield a ‘good’ mapping <italic>γ</italic><sub><italic>tb</italic></sub>. The annotation problem is solved if the marginals <italic>c</italic><sub><italic>b</italic></sub> and <italic>c</italic><sub><italic>t</italic></sub> and the cost <italic>M</italic><sub><italic>tb</italic></sub> can be tuned such that <italic>γ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>tb</italic></sub>.</p>
      <p id="Par59">The marginal over annotations is known from the data <italic>c</italic><sub><italic>b</italic></sub> = <italic>ρ</italic><sub><italic>b</italic></sub>, while <italic>c</italic><sub><italic>t</italic></sub> = <italic>ρ</italic><sub><italic>t</italic></sub> is not. This can be used to encode prior knowledge about the data, for example, from a reference distribution. To support the general case when such a reference distribution is not available, partially balanced OT is used: instead of fixing the type marginal exactly, a Kullback–Leibler divergence penalty is imposed scaled with a parameter <italic>λ</italic>. This can be used to tune the amount of trust put in the prior distribution.</p>
      <p id="Par60">Choosing a well-performing cost function is more ambiguous. The cost function uses the information in data space and assigns a dissimilarity to each object-category combination. A straightforward choice is the cosine distance, or, for expression count data, the cosine distance on normalized and log1p-transformed data. In our benchmarks, the cosine distance on transformed data led to better results (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>), but the transformation is rather specific for count data. Inspired by the overlap of states in quantum mechanics, a different measure, the Bhattacharyya coefficients, is generally used, with similar performance and without direct reference to counts. Bhattacharyya coefficients are a general measure of the overlap of probability distributions and are defined as BC(<italic>p</italic>,<italic>q</italic>) <italic>=</italic> Σ<sub><italic>g</italic></sub>√<italic>p</italic><sub><italic>g</italic></sub><italic>q</italic><sub><italic>g</italic></sub> for two probability distributions <italic>p</italic> and <italic>q</italic> in the data space. To allow the user to adapt the method according to the needs of their particular application, TACCO implements several other metrics, as well as making all scipy metrics available.</p>
      <p id="Par61">OT’s optimization problem is in general nonconvex and numerically expensive. However, using entropic regularization makes it strictly convex and efficiently solvable by using the Sinkhorn–Knopp matrix scaling algorithm<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. For entropic regularization, the tunable entropy regularization term <italic>εΩ</italic>(<italic>γ</italic><sub><italic>tb</italic></sub>) <italic>=</italic> <italic>ε</italic> Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> log(<italic>γ</italic><sub><italic>tb</italic></sub>) is added to the objective function. This term favors mappings that do not map a given object to a single annotation.</p>
    </sec>
    <sec id="Sec29">
      <title>Alternative annotation methods</title>
      <p id="Par62">The core, OT-based annotation method can be swapped by a number of other built-in methods, including nonnegative least squares or support vector machine (SVM) or by wrapped external methods from both Python and R, including NMFreg<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> or RCTD<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. Custom core methods can also be added using a functional interface. The wrapped external and custom functions may already include ‘booster’ functionality (below). For example, RCTD already contains platform normalization. Many of the simple built-in methods are amenable to hand optimization, for example, by supporting data sparsity consistently, which makes them even faster. All the built-in methods are generally optimized for standard x86 hardware, but wrapped external methods may use GPU acceleration (for example, Tangram<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>).</p>
    </sec>
    <sec id="Sec30">
      <title>Overview of boosters</title>
      <p id="Par63">Boosters can improve the performance of the core method or provide support for ‘missing features’ for example, for platform normalization, for using subtype variability to enhance the type representation in single-cell data, for creating a deconvolution method from a categorical annotation method and the other way round (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>). They can be combined flexibly to adapt to special requirements for specific applications. The modularity introduced by boosters makes it straightforward to ‘unbox’ TACCO and understand what each part does. While most boosters do have some overhead in runtime, in the end, they all do the heavy lifting by calling the fast core method one or several times and transforming its inputs and/or outputs.</p>
    </sec>
    <sec id="Sec31">
      <title>Platform normalization</title>
      <p id="Par64">Dramatic differences in datasets can arise solely from differences in the experimental technique that impact the profiled cellular compartments (for example, single cell versus single nucleus), cellular compositions (due to differential capture of cells of different types) or gene biases. Annotation of data from one platform using a reference of another platform is much more difficult without accounting for these platform-dependent biases<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. This booster can be safely disabled if no platform effects are expected.</p>
      <p id="Par65">A platform normalization step mitigates platform-specific effects by rescaling data from one platform to make it comparable to data from a different platform, separately in each dimension <italic>g</italic> of the data space, for example, separately per gene. The necessary rescaling factors are estimated from data. A related but simpler approach compared to that given in ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup> is pursued, making less assumptions and therefore usable across a broader range of applications.</p>
      <p id="Par66">The representations of the categories <italic>t</italic> as sets of vectors in data space <inline-formula id="IEq9"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\pi ^A_{gt}\,{{{\mathrm{and}}}}\,\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M24"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">and</mml:mi><mml:mspace width="0.25em"/><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq9.gif"/></alternatives></inline-formula> on the two platforms <italic>A</italic> and <italic>B</italic> are linked to each other via the platform normalization factors <inline-formula id="IEq10"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g\,{{{\mathrm{as}}}}\,\pi ^A_{gt} = f^{AB}_g\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M26"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">as</mml:mi><mml:mspace width="0.25em"/><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq10.gif"/></alternatives></inline-formula>. If the category representations <inline-formula id="IEq11"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M28"><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq11.gif"/></alternatives></inline-formula> for platform <italic>B</italic> and the (pseudo-bulk) category marginals <inline-formula id="IEq12"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_t$$\end{document}</tex-math><mml:math id="M30"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq12.gif"/></alternatives></inline-formula> for platform <italic>A</italic> are known, the data space marginals <inline-formula id="IEq13"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_g$$\end{document}</tex-math><mml:math id="M32"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq13.gif"/></alternatives></inline-formula> can be written as <inline-formula id="IEq14"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rho^A_{g}} = {\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^A_{gt}\rho ^A_t}} = {f^{AB}_g}{\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^B_{gt}\rho ^A_t}}$$\end{document}</tex-math><mml:math id="M34"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq14.gif"/></alternatives></inline-formula>, and therefore <inline-formula id="IEq15"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g = \rho ^A_g/\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^B_{gt}\rho ^A_t}$$\end{document}</tex-math><mml:math id="M36"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>/</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq15.gif"/></alternatives></inline-formula>. The category marginals <inline-formula id="IEq16"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_t$$\end{document}</tex-math><mml:math id="M38"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq16.gif"/></alternatives></inline-formula> are themselves usually a result of the annotation procedure and used here as input to a preprocessing step for the procedure. However, an iterative scheme can also be used. Starting with the assumption that the annotation marginals are identical to the reference (which is reasonable for example, if matched spatial and single-cell data are available), most of the gene-wise platform effect can be already captured. Next, platform normalization is rerun after a first round of cell typing using improved type fractions, and the process is iterated until the normalization factors are stable. In practice, this procedure converges very rapidly with the initial step being by far the most relevant one.</p>
      <p id="Par67">After determining the gene-wise platform normalization factors <inline-formula id="IEq17"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g$$\end{document}</tex-math><mml:math id="M40"><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq17.gif"/></alternatives></inline-formula>, they are used to rescale the data space in either the reference or the test data or equivalently to work in the units of the test or the reference data. As the probabilities and the resulting annotation distribution are given in terms of these units, choosing test data units or reference data units can lead to quite different results. Which option should be preferred depends on the use case and downstream analyses. Here, test data units are chosen to retain integer count data for object splitting.</p>
    </sec>
    <sec id="Sec32">
      <title>Multicenter</title>
      <p id="Par68">In many cases, there are multiple observations per annotation category in the reference dataset, as is the case in single-cell data. To integrate the variability of these observations while maintaining speed, the observations per category are subclustered with <italic>k</italic>-means clustering to get multiple mean profiles per category. The annotation function is then called with this subannotation, and its result is summed over the subannotations to give an annotation in terms of the original categories. When the reference is already finely annotated, no improvement is expected from this booster, which could then lead to worse performance, because less data are available per subannotation to average noise and the reference gets overfitted.</p>
    </sec>
    <sec id="Sec33">
      <title>Bisectioning</title>
      <p id="Par69">Some annotation methods can be biased toward low-entropy annotations such that they may overweigh dominant categories in mixtures (the extreme case is a categorical classifier). Such methods can be adapted to compositional annotation by running the annotation method iteratively. In each iteration, the annotation is not used as the final result, but instead, a certain fraction of it is used to subtract a reconstructed approximation of the data from the original data. The residual is again subjected to the annotation method, while a fraction of the annotation result is added to the final annotation result. This procedure is very similar to gradient boosting. Bisectioning is useful when the objects are additive mixtures of the annotations in the data space. If the data consist (mainly) of objects which are best described by a single annotation, this booster can decrease performance, for example, by resolving the ambient contribution in single-cell data.</p>
    </sec>
    <sec id="Sec34">
      <title>Choosing parameters</title>
      <p id="Par70">While a single configuration of TACCO generally gives decent performance for a wide variety of use cases (Extended Data Fig. <xref rid="Fig12" ref-type="fig">8</xref>), it can be tuned to perform particularly well for certain use cases. Relevant parameters for the tuning include the following components.</p>
      <sec id="Sec35">
        <title>Boosting/bisectioning</title>
        <p id="Par71">TACCO’s default depends on the core annotation method. As OT itself lacks support for additive compositional annotations, TACCO activates this booster for OT by default. Higher values for the number of bisections and the bisection divisor generally lead to more precise compositional annotations but at the cost of increased runtime, which scales roughly linearly with the sum iterations+divisor. A divisor smaller than 3 can lead to sizable artifacts, and so a divisor equal to or greater than 3 is recommended.</p>
      </sec>
      <sec id="Sec36">
        <title>Multicenter</title>
        <p id="Par72">By default, TACCO does not use the multicenter booster (setting a number of representing means for each annotation category), as it is useful only in cases where the annotation categories have a large within-category variation. However, as many reference datasets come with coarse annotation categories, the multicenter booster is activated for most analyses in this study. This booster is not recommended if the categories already cover the full biologically significant heterogeneity in the data or if the dataset has only a single representing observation per category. A value of 5 or 10 is recommended in other cases (as this generally captures the heterogeneity in many datasets). Larger values are generally not recommended as they lead to an increase in runtime and have the potential for overfitting, by using irrelevant variability in the data for the annotation process.</p>
      </sec>
      <sec id="Sec37">
        <title>Platform_iterations</title>
        <p id="Par73">TACCO’s default depends on the core annotation method. As OT itself does not have built-in platform normalization and most pairs of reference and target data have nontrivial platform effects, basic platform normalization is the default for OT. It is generally recommended not to disable platform normalization, except for specific cases, for example, if part of the dataset of a single batch was manually annotated and the annotation should be transferred to the rest of the data.</p>
      </sec>
      <sec id="Sec38">
        <title>Max_annotation</title>
        <p id="Par74">TACCO’s default is a compositional annotation with nonzero values simultaneously possible for all annotation categories per observation. Max_annotation can be used to set the number of nonzero values per observation. For categorical annotation, one might want to restrict this to a single nonzero value per observation, corresponding to setting max_annotation to 1, while for data with very few contributing cells per observation (for example, Slide-seq or scRNA-Seq data with doublets) a suitable value could be 2 or 3.</p>
      </sec>
      <sec id="Sec39">
        <title>Marginal relaxation parameter lambda (OT-specific)</title>
        <p id="Par75">TACCO’s default value is chosen as a compromise between using prior information from the reference pseudobulk annotation composition (for example, cell-type proportions) and annotating in a fully data-driven manner. While larger values (larger cost of having a pseudobulk annotation composition different from the reference) can stabilize the annotation in cases of low correspondence between reference and target data, smaller values can give more precise pseudobulk annotation compositions if the two datasets are highly corresponding and do not exhibit batch effects that are not accounted for by platform normalization.</p>
      </sec>
      <sec id="Sec40">
        <title>Entropy regularization parameter epsilon (OT-specific)</title>
        <p id="Par76">TACCO’s default is chosen such that the regularization’s effect on the results is minimized: it biases the results toward high entropy configurations, that is, every observation (for example, spatial observation) is assigned a compositional annotation with large contributions from different categories (for example, cell types). This parameter must be nonzero, as the efficient regularized OT solver breaks down at zero epsilon (and numerically already at epsilon much smaller than 0.005). Except for specific settings (that is, prior information external to the dataset itself) in which it is beneficial to bias the result toward significant contributions of many annotation categories in the result, this parameter should only be changed in rare cases of numerical instability—which we did not observe with TACCO’s default.</p>
      </sec>
    </sec>
    <sec id="Sec41">
      <title>Object splitting</title>
      <p id="Par77">The annotation method generates an assignment of a composition of annotation categories for every observation. Generally, each observation is associated with more than one category with nonzero contribution. When the categories are cell types, this can be problematic for downstream applications that require the expression profiles of single cells as input, that is, pure profiles that can be attributed to a single cell. For example, as cell-type-related expression constitutes a strong signal, analysis of expression programs is easier across cells of shared type. Thus, it is desirable to derive several ‘virtual’ observations for every real observation, which correspond to the pure contribution of each annotation category.</p>
      <p id="Par78">A similar idea was proposed in ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, where the expected contribution of each cell type to the expression of one Slide-seq bead is approximated. In that approach, cell-type fractions that were reconstructed for every bead are taken as input in a Bayesian analysis, along with type-specific expression profiles and the bead-count matrix to yield expected reads per gene, bead and cell type. The result, however, lacks consistency with the annotation and the measured count matrix in the sense that the marginal over genes is not recovered. Here, we follow a similar strategy, but we directly integrate marginals as constraints of a matrix equivalence scaling problem in a data-driven frequentist approach.</p>
      <p id="Par79">In this approach, data generation is modeled as drawing single molecules labeled with gene <italic>g</italic>, cell type <italic>t</italic> and observation/bead <italic>b</italic> from the sample, which constitutes the central object—the joint probability <italic>p</italic>(<italic>gtb</italic>) for a given molecule to be of gene <italic>g</italic>, cell type <italic>t</italic> and bead <italic>b</italic>. In the actual experiment, only <italic>g</italic> and <italic>b</italic> are measured, yielding <italic>p</italic>(<italic>gb</italic>) <italic>=</italic> Σ<sub>t</sub>
<italic>p</italic>(<italic>gtb</italic>), the ‘t-marginal’. From the reference data, the reference profiles <italic>p</italic>(<italic>g</italic>|<italic>t</italic>) <italic>=</italic> Σ<sub><italic>b</italic></sub>
<italic>p</italic>(<italic>gtb</italic>)/<italic>p</italic>(<italic>t</italic>) are available, and from the annotation process the annotation result <italic>p</italic>(<italic>tb</italic>) = Σ<sub><italic>g</italic></sub>
<italic>p</italic>(<italic>gtb</italic>), the ‘g-marginal’ is obtained. Further, <italic>p</italic>(<italic>gtb</italic>) is modeled with a Bayesian-inspired product ansatz: <italic>p</italic>(<italic>gtb</italic>) = <italic>p</italic>(<italic>gt</italic>) <italic>n</italic>(<italic>gb</italic>) <italic>n</italic>(<italic>tb</italic>), with free parameters <italic>n</italic>(<italic>gb</italic>) and <italic>n</italic>(<italic>tb</italic>). These are fixed by enforcing the <italic>t</italic>- and <italic>g</italic>-marginals. The ansatz can be interpreted as adjusting the cell-type profiles and pseudobulk annotation with object-wise scaling factors per data dimension <italic>g</italic> and annotation category <italic>t</italic> such that the measurement and the annotations are reproduced exactly. To determine the parameters from the marginals, we have to solve a separate matrix equivalence scaling problem per object <italic>b</italic>.</p>
      <p id="Par80">Matrix equivalence scaling problems are guaranteed to have a solution if the matrix to be scaled, that is <italic>p</italic>(<italic>gt</italic>), has only positive entries. Therefore, a small positive number is added to all the elements of <italic>p</italic>(gt) to make the problem well defined. These problems can be solved by iterative normalization of the columns and rows of <italic>p</italic>(<italic>gt</italic>). This simple algorithm is known under many names, for example, the RAS algorithm<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> or for doubly stochastic matrices as the Sinkhorn–Knopp algorithm<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>, and it is also the algorithm used to solve OT efficiently<sup><xref ref-type="bibr" rid="CR49">49</xref></sup>. In contrast to OT, where there is a single matrix scaling problem, here a separate problem is solved for every object. Although this initially seems like a practical performance problem, these problems can be solved in parallel and use the same data, leading to speedups by reducing memory accesses. Moreover, we use the sparsity of the count frequency matrix <italic>p</italic>(bg) to implement the RAS algorithm very efficiently for the problem at hand.</p>
      <p id="Par81">By rescaling the resulting <italic>p</italic>(<italic>gtb</italic>) with the total weight per object (for example, total counts per cell for sequencing data), a consistent annotation-resolved split of the measurement is obtained, consisting of floating-point numbers. For expression count data, this split generally includes many values much smaller than 1. To optimize sparsity and obtain integer counts, an option is available to round this result by flooring and redistributing the remaining reads (via multinomial sampling from the remainders). The resulting split count matrix retains biological signal and can be used in standard downstream analyses (Extended Data Fig. <xref rid="Fig6" ref-type="fig">2</xref>).</p>
    </sec>
    <sec id="Sec42">
      <title>Single-molecule annotation</title>
      <p id="Par82">To annotate single molecules by cell-type assignment, TACCO first bins the single-molecule data in space to generate aggregate cell-like objects. TACCO then annotates them either using internal or wrapped external methods. Subsequently, TACCO maps the resulting compositional annotation back to the single molecules, as follows. First, object splitting is used to distribute molecules to annotations, resulting in a probability for every molecule species in the bin to have a certain annotation. This annotation is then distributed randomly among the molecules of that molecular species such that each molecule has only a single annotation and the population of molecules reproduce the annotation probability. Because spatial binning can introduce arbitrary boundary artifacts in the definition of local neighborhoods for molecules, TACCO repeats the binning and annotation for <italic>N</italic> (usually 2–3) spatial shifts of the Cartesian grid in steps of 1/<italic>N</italic> of the grid spacing per spatial dimension. For <italic>d</italic> spatial dimensions, this results in <italic>N</italic><sup><italic>d</italic></sup> annotations per molecule. The final annotation of each molecule is then determined by a majority vote. This simple single-molecule annotation is only feasible with fast annotation methods, which can be run multiple times on differently binned data in a reasonable amount of time.</p>
      <p id="Par83">In addition to the parameters for compositional annotation, the single-molecule annotation introduces extra parameters. We evaluated the annotation’s sensitivity to parameter value changes with respect to the baseline single-molecule TACCO configuration (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6b</xref>). Sizable changes in most parameters conserved about 80% of the single-molecule annotations relative to the baseline and were consistent with the reference annotation of the osmFISH-recovered cells at about 0.6, with one notable exception as follows: increasing OT’s entropic regularization parameter epsilon leads to significant reductions in accuracy and stability as it drives the annotation to be homogeneous regardless of the data. As for compositional annotation, we therefore recommend keeping the small default value which is just large enough to make OT numerically stable in practice.</p>
    </sec>
    <sec id="Sec43">
      <title>Image-free segmentation</title>
      <p id="Par84">An image-free, density-based cell segmentation approach uses the per-molecule annotation to determine molecule assignments at critical cross-category boundaries. We assume that the exact assignment of boundaries within a category is not very important as long as it gives rise to a reasonable size of the segmented objects. The segmentation is implemented as graph-based hierarchical spectral clustering.</p>
      <p id="Par85">As the number of single molecules can easily be of the order of 10<sup>9</sup>, an efficient Euclidean sparse distance matrix computation is required. As scipy’s sparse distance matrix calculation is serial and too slow for this application, a custom, fast, parallel and still generally applicable algorithm was developed and implemented. After calculating the distances <inline-formula id="IEq18"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{spatial}}}$$\end{document}</tex-math><mml:math id="M42"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">spatial</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq18.gif"/></alternatives></inline-formula> between molecules <italic>i</italic> and <italic>j</italic> in position space, a distance contribution is added in quadrature which is derived from the single-molecule annotation <inline-formula id="IEq19"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{annotation}}}$$\end{document}</tex-math><mml:math id="M44"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">annotation</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq19.gif"/></alternatives></inline-formula> to get a combined distance: <inline-formula id="IEq20"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{total}}} = \surd \left( {d_{ij}^{{\mathrm{spatial}}}} \right)^2 + \left( {d_{ij}^{{\mathrm{annotation}}}} \right)^2$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">total</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>√</mml:mi><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">spatial</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">annotation</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq20.gif"/></alternatives></inline-formula>. The annotation contribution can be either zero within an annotation and infinity between annotations, automatically derived using distances between the expression profiles of the annotations or manually specified. As the clustering works on affinities and not on distances, the distances have to be transformed into affinities, which is done by a Gaussian kernel with a subcellular distance scale.</p>
      <p id="Par86">As the number of molecules is so large, the clustering algorithm has to be fast and scalable, work entirely on sparse matrices and cut the neighborship graph at sensible places to generate reasonable cells-like objects. For this, a hierarchical clustering scheme was developed based on the spectral clustering implementation of scikit-learn as follows: it can handle sparse matrices, can use algebraic multigrid solvers for speed and, for only two clusters, solve the normalized graph cut problem<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. The best cuts are found iteratively in top-down fashion (binary splitting the data at each iteration). To keep the dataset tractable for the initial cuts, the spatial structure of the data is used to generate supernodes in the graph before clustering. When the clustering comes down into the size regime of a few single cells, several heuristics are employed to determine whether to accept a proposed cut based on the shape and size of the clusters, and on comparing the affinity loss of the proposed cut to the expected cost for cutting a homogeneous bulk graph of corresponding size and dimension. The final result is another column of annotation for the molecules containing unique object ids.</p>
      <p id="Par87">For visualization, these objects are filtered to include at least 20 molecules, and the associated expression profiles are normalized as in ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup> and embedded by a tSNE. To evaluate the self-consistency of annotation and segmentation, the silhouette score of the cell-type annotations is evaluated on identically filtered and normalized profiles using the silhouette_score function from scikit-learn.</p>
    </sec>
    <sec id="Sec44">
      <title>Region definition</title>
      <p id="Par88">For spatially convoluted expression data, such as in spatial transcriptomics methods including Slide-seq and Visium, clustering (of beads or spots) in expression space is less meaningful as individual cells are mixed. ‘Regions’ which are defined both in position and expression or annotation space can be a meaningful alternative. TACCO implements a method to define such regions (Extended Data Fig. <xref rid="Fig7" ref-type="fig">3a</xref>), consisting of the following two steps: (1) construction of one <italic>k</italic>-nearest neighbors graph based on expression (or annotation) distances and another <italic>k</italic>-nearest neighbors graph based on physical distances; and (2) combination of the two graphs as a weighted sum of the graphs’ adjacencies. Putting more weight on the position space adjacency gives contiguous regions in position space, while more weight on the expression adjacency leads to separated islands of similar expression being annotated with the same region and can connect regions across different spatial samples (for example, Slide-seq pucks). To account for the missing links from the position graph between samples, the cross-sample adjacency is scaled up by a balancing weight factor. The combined adjacency matrix is then subjected to standard Leiden clustering<sup><xref ref-type="bibr" rid="CR51">51</xref></sup> which assigns consistent region annotation across samples.</p>
    </sec>
    <sec id="Sec45">
      <title>Colocalization and neighborhood analysis</title>
      <p id="Par89">To score colocalization or co-occurrence of annotations<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>, TACCO calculates <italic>p</italic>(anno|center;<italic>x</italic>)/<italic>p</italic>(anno), the probability to find an annotation ‘anno’ at a distance <italic>x</italic> from a center annotation ‘center’ normalized by the probability to find ‘anno’ regardless of a ‘center’. This is well defined also for noncategorical annotations, which are commonplace for the compositional annotations created with TACCO and for pairs of unrelated annotations.</p>
      <p id="Par90">As the most time-consuming computations for co-occurrence are the same as for neighborhood-enrichment analyses, TACCO also calculates neighborhood-enrichment <italic>z</italic>-scores<sup><xref ref-type="bibr" rid="CR52">52</xref></sup> for a set of distance bins (as opposed to the set of direct neighbors on a graph) and again supports noncategorical annotation, pairs of unrelated annotations for ‘anno’ and ‘center’, and multiple samples while being competitive performance-wise (Extended Data Fig. <xref rid="Fig13" ref-type="fig">9</xref>).</p>
    </sec>
    <sec id="Sec46">
      <title>Annotation coordinates</title>
      <p id="Par91">To analyze a given annotation (for example, cell-type composition) with respect to its spatial distance from a reference annotation (for example, histological annotation; Extended Data Fig. <xref rid="Fig7" ref-type="fig">3b,c</xref>), TACCO implements an algorithm that determines a stable ‘annotation coordinate’ in position space by regularizing the minimum distance by a critical neighborhood size determined at the weights level and afterward correcting for the regularization bias. (This is required because for noisy spatial data and/or noncategorical reference annotations, simply taking the minimal distance between objects of certain annotations is unstable and/or not well defined.)</p>
      <p id="Par92">Specifically, TACCO first generates a matrix <italic>n</italic><sub><italic>A,x</italic></sub>(<italic>d</italic>) of occurrence histograms versus spatial distance <italic>d</italic> for every annotation category <italic>A</italic> and spatial position <italic>x</italic>, counting fractional annotations as fractional occurrence counts. The distance <inline-formula id="IEq21"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M48"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq21.gif"/></alternatives></inline-formula> where its cumulative sum over distance <inline-formula id="IEq22"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N_{A,x}\left( d \right) = \mathop {\sum}\nolimits_{{{{\mathrm{d}}}}^{\prime} = 0}^{{{\mathrm{d}}}} {n_{A,x}\left( {d^{\prime} } \right)}$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="normal">d</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">d</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq22.gif"/></alternatives></inline-formula> will be over a certain threshold <italic>N</italic><sub><italic>l</italic></sub> is a robust measure for the radius of the sphere centered at <italic>x</italic> and containing a total of <italic>N</italic><sub><italic>l</italic></sub> occurrences of annotation <italic>A</italic>. Even for data homogeneously annotated with <italic>A</italic>, the minimal possible value of <inline-formula id="IEq23"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M52"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq23.gif"/></alternatives></inline-formula> is however larger than 0 as the threshold <italic>N</italic><sub><italic>l</italic></sub> will in general be larger than <italic>l</italic> to have a stabilizing effect. To allow for a minimum value of 0 and obtain a measure for the distance from <italic>x</italic> to a significant amount of category <italic>A</italic>, <inline-formula id="IEq24"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M54"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq24.gif"/></alternatives></inline-formula> is corrected using a fictitious homogeneous annotation category <italic>H</italic> and the value of <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq25"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M56"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq25.gif"/></alternatives></inline-formula>) is found, followed by solving for the distance <inline-formula id="IEq26"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M58"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq26.gif"/></alternatives></inline-formula> at which <italic>N</italic><sub><italic>l</italic></sub> less occurrences appeared: <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq27"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M60"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq27.gif"/></alternatives></inline-formula>) = <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq28"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M62"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq28.gif"/></alternatives></inline-formula>) – <italic>N</italic><sub><italic>l</italic></sub>. <inline-formula id="IEq29"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M64"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq29.gif"/></alternatives></inline-formula> is now consistent with the regular minimum distance for noise-free categorical annotations, stable against noise and well defined for compositional annotations.</p>
    </sec>
    <sec id="Sec47">
      <title>Enrichments</title>
      <p id="Par93">TACCO supports various approaches to visualize compositional differences in the spatial structure of a sample and estimate the statistical significance of these differences/enrichments (Extended Data Fig. <xref rid="Fig7" ref-type="fig">3d–g</xref>). In particular, TACCO uses sample information to calculate enrichments not across observations (single cells/spatial beads, which are no independent observations and can lead to <italic>P</italic> value inflation), but across multiple samples, which gives meaningful and reasonable <italic>P</italic> values.</p>
      <p id="Par94">When there is just a single (or few) spatial sample(s) but with considerable size, different parts of that sample are treated as semi-independent biological replicates, by splitting the sample along a selection of coordinate axes to create a statistical ensemble for enrichment analysis. Increasing the number of splits to parts that cannot be regarded as independent replicates interpolates smoothly to where every observation is considered independent.</p>
    </sec>
    <sec id="Sec48">
      <title>Reporting summary</title>
      <p id="Par95">Further information on research design is available in the <xref rid="MOESM1" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec id="Sec49" sec-type="materials|methods">
    <title>Online content</title>
    <p id="Par96">Any methods, additional references, Nature Portfolio reporting summaries, source data, extended data, supplementary information, acknowledgements, peer review information; details of author contributions and competing interests; and statements of data and code availability are available at 10.1038/s41587-023-01657-3.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <sec id="Sec51">
      <title>Supplementary information</title>
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41587_2023_1657_MOESM1_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <app-group>
    <app id="App1">
      <sec id="Sec50">
        <title>Extended data</title>
        <p id="Par101">
          <fig id="Fig5">
            <label>Extended Data Fig. 1</label>
            <caption>
              <title>Effect of choice of cost matrix metric in OT and several booster options (platform normalization, multicenter, bisection) on annotation quality.</title>
              <p>L2 error (y axis, top; relevant for mixture annotations) and fraction of objects where the maximum annotation disagrees with the reference (y axis, bottom; relevant for classification problems) for different methods (colors) on different use cases (x axis). Baseline TACCO used the Bhattacharyya metric, platform normalization, multicenter, and bisection. Single cell: annotation of mouse colon scRNA-seq with itself as reference; Mixture: Gaussian mixtures of mouse colon scRNA-seq (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>); Dropout: simulated Dropout dataset (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>); Ambient: simulated ambient dataset (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>), Differentiation: hematopoiesis scRNA-seq (Fig. <xref rid="Fig3" ref-type="fig">3c</xref>).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig5_ESM" id="d32e3633"/>
          </fig>
        </p>
        <p id="Par102">
          <fig id="Fig6">
            <label>Extended Data Fig. 2</label>
            <caption>
              <title>TACCO splitting of mixed expression profiles into pure constituents.</title>
              <p>UMAP embeddings of in-silico mixed mouse colon scRNA-seq profiles (top four rows: real or balanced type composition and with and without downscaling the count-yield per cell by a factor of 10) or Slide-seq beads (bottom row), based on ground truth (far left, where available), TACCO annotation (second left), reference data (second right) and mixed expression data split using TACCO’s annotation as input embedded in a joint UMAP of the concatenated reference-split dataset (rightmost). The in silico mix uses a beadsize of 1.0. For the joint embedding data was filtered to include only observations with at least 30 counts in genes which were annotated highly variable in the reference dataset, except for capture_rate = 1.0 where a threshold of 100 is used.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig6_ESM" id="d32e3647"/>
          </fig>
        </p>
        <p id="Par103">
          <fig id="Fig7">
            <label>Extended Data Fig. 3</label>
            <caption>
              <title>Example workflow and visualizations for spatial data analysis in TACCO for the mouse colon dataset from the ‘Spatial mixture’ task (Fig. <xref rid="Fig2" ref-type="fig">2b</xref>).</title>
              <p>(<bold>a</bold>) Slide-seq puck with beads colored by regions defined by joint expression space and position space clustering. (<bold>b</bold>) Fraction of cells (y axis) of each type (color) in each region (x axis). (<bold>c</bold>) Slide-seq puck colored by the effective distance of each bead from each region. (<bold>d</bold>) Density (y axis) of cell type annotations at different effective distance from region 2 (x axis). (<bold>e</bold>) Slide-seq puck colored by spatial split of the puck along a selected coordinate axis into multiple biological replicates for statistical enrichment analysis. (<bold>f</bold>) Geometric mean normalized cell type fractions (y axis) for each cell type (x axis) from each region (1–4) and subregion (per spatial split as in e; individual bars). (<bold>g</bold>) Enrichment p-values (colors) of the normalized cell fractions in (f) (Benjamini-Hochberg-corrected one-sided Mann-Whitney-U test across spatial splits).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig7_ESM" id="d32e3686"/>
          </fig>
        </p>
        <p id="Par104">
          <fig id="Fig8">
            <label>Extended Data Fig. 4</label>
            <caption>
              <title>Annotating mouse olfactory bulb Slide-seq data<sup><xref ref-type="bibr" rid="CR31">31</xref></sup> using an scRNA-seq data<sup><xref ref-type="bibr" rid="CR32">32</xref></sup> with TACCO.</title>
              <p>(a) Compositional cell type annotation. Annotations (color legend) from a single TACCO run on 40 Slide-seq pucks across 2 replicates (replicate 1 in 1st and 3rd columns, replicate 2 in 2nd and 4th columns); (<bold>b</bold>) Comparison of different annotation strategies. Compositional cell type annotation (first row, color legend) and normalized cell type weights (remaining rows, color bar) from either direct compositional annotation of the spatial data (left column; default TACCO workflow, as in (a)); compositional single cell annotation of the spatial data, and deriving the cell type annotation from the single cell cell-type annotation (middle column); or positional annotation of the single cells in the reference with plotting the categorical cell type annotation at the positions of the beads with the maximum weight per cell (right column).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig8_ESM" id="d32e3711"/>
          </fig>
        </p>
        <p id="Par105">
          <fig id="Fig9">
            <label>Extended Data Fig. 5</label>
            <caption>
              <title>Comparisons of single-molecule annotations for osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>.</title>
              <p><bold>(a)</bold> tSNE of the expression profiles for objects (dots) resulting from different combinations of annotation (TACCO, Baysor<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>) and segmentation (TACCO, Baysor) methods (columns), colored by the aggregated single-molecule annotation from TACCO, Baysor, and SSAM (rows); <bold>(b)</bold> Distribution of annotations from the reference, Baysor and SSAM over the TACCO single molecule annotations; <bold>(c,d)</bold> Distributions of TACCO’s single-molecule annotations with respect to Baysor (c) and SSAM (d) single-molecule annotations.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig9_ESM" id="d32e3745"/>
          </fig>
        </p>
        <p id="Par106">
          <fig id="Fig10">
            <label>Extended Data Fig. 6</label>
            <caption>
              <title>Analysis of single-molecule annotations for osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>.</title>
              <p><bold>(a)</bold> SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup> pixel-based annotation mapped to single molecules (presented like TACCO’s and Baysor’s<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> single-molecule annotations in Fig. <xref rid="Fig2" ref-type="fig">2c</xref> (2,3)): Entire section profiled by osmFISH (left) and zoom-in on a small region (right) with the positions and mapped cell-type annotation of each measured molecule. <bold>(b)</bold> Impact of different choices (x axis) for different parameter categories (color) on TACCO’s single molecule annotation, based on consistency with annotation from osmFISH-recovered cells (y axis, top) or with the base configuration of the annotation, which is used in all other single molecule analyses with TACCO (y axis, bottom). <bold>(c)</bold> Comparison of cell type composition analysis (p(annotations|center = hippocampus), y axis) at different distances from the hippocampus region annotation (x axis) for each cell type annotation (color) from different methods (label top), all using a single cell type per segmented object; unlike in Fig. <xref rid="Fig2" ref-type="fig">2e</xref>), the hippocampus region annotation from osmFISH-recovered cells is used for all panels, as Baysor did not recover any hippocampus annotation.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig10_ESM" id="d32e3786"/>
          </fig>
        </p>
        <p id="Par107">
          <fig id="Fig11">
            <label>Extended Data Fig. 7</label>
            <caption>
              <title>Comparison of methods performance on the differentiation task.</title>
              <p>scRNA-seq profiles (dots) from a hematopoiesis dataset<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> colored by the eventual clonal fate of day 2 cells (leftmost) and by the predicted clonal fates of day 2 cells, for each method from Fig. <xref rid="Fig3" ref-type="fig">3c</xref> (4)). Reference profiles from differentiated cells (day 4 and 6) are in gray.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig11_ESM" id="d32e3807"/>
          </fig>
        </p>
        <p id="Par108">
          <fig id="Fig12">
            <label>Extended Data Fig. 8</label>
            <caption>
              <title>Impact of parameter variations on TACCO’s runtime, memory requirement and accuracy of annotation transfer.</title>
              <p>Runtime (y axis, top), memory requirement (y axis, middle) and L2 error (y axis, bottom) of each parameter choice (colors) in the ‘Mixture’ (left; with beadsize = 1.0), ‘Dropout’ (middle; with dropmidpoint = −1.00) and ‘Differentiation’ (right) use cases, at different numbers of observations (cells or beads, x axis), ranging from <inline-formula id="IEq30"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{10} \approx 1k$$\end{document}</tex-math><mml:math id="M66"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mi>k</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq30.gif"/></alternatives></inline-formula> to <inline-formula id="IEq31"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{20} \approx 1M$$\end{document}</tex-math><mml:math id="M68"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>20</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mi>M</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq31.gif"/></alternatives></inline-formula>, which are up/down sampled from the datasets in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. Reference size is fixed at <inline-formula id="IEq32"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{14} \approx 16k$$\end{document}</tex-math><mml:math id="M70"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>14</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>16</mml:mn><mml:mi>k</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq32.gif"/></alternatives></inline-formula>. The maximum compute resources per run are 8 CPU cores for 8 hours with 8 GB memory each.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig12_ESM" id="d32e3890"/>
          </fig>
        </p>
        <p id="Par109">
          <fig id="Fig13">
            <label>Extended Data Fig. 9</label>
            <caption>
              <title>Runtime comparison of TACCO and Squidpy<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>.</title>
              <p>Run time (y axis) co-occurrence (a) and neighborhood enrichment (b) analyses for TACCO (blue) and Squidpy (orange). Datasets ‘imc’ and ‘seqfish’ are example datasets provided with Squidpy.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig13_ESM" id="d32e3908"/>
          </fig>
        </p>
      </sec>
    </app>
  </app-group>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
    <fn>
      <p>These authors contributed equally: Simon Mages, Noa Moriel and Inbal Avraham-Davidi.</p>
    </fn>
  </fn-group>
  <sec>
    <sec id="FPar1">
      <title>Extended data</title>
      <p id="Par97">is available for this paper at 10.1038/s41587-023-01657-3.</p>
    </sec>
    <sec id="FPar2" sec-type="supplementary-material">
      <title>Supplementary information</title>
      <p id="Par98">The online version contains supplementary material available at 10.1038/s41587-023-01657-3.</p>
    </sec>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank L. Gaffney for help with figure preparation. S.M. was supported by a DFG research fellowship (MA 9108/1-1), N.M. was supported by the Israeli Council for Higher Education PhD fellowship, J.K. was supported by a HFSP long-term fellowship (LT000452/2019-L), A.R. was a Howard Hughes Medical Institute (HHMI) Investigator when conducting this work. The work was supported by the Klarman Cell Observatory, a CEGS grant (5RM1HG006193-09) from the NHGRI, the NIH/NIAID (grants 1U24 CA180922, 1U19 MH114821, 1RC2 DK114784), the MIT Ludwig Center, the Manton Family Foundation, and HHMI (A.R.); Azrieli Foundation Early Career Faculty Fellowship, Google Research Scholar program, an Israel Science Foundation research grant (1079/21), the European Union (ERC, DecodeSC, 101040660) (M.N.) and the Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem (N.M. and M.N.). Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or the European Research Council. Neither the European Union nor the granting authority can be held responsible for them. This publication is part of the Human Cell Atlas (<ext-link ext-link-type="uri" xlink:href="http://www.humancellatlas.org/publications/">www.humancellatlas.org/publications/</ext-link>).</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>N.M., I.A.-D., M.N. and A.R. conceived the study; S.M., N.M., J.K. and M.N. developed the algorithms and framework, with input from I.A.-D. and guidance from A.R.; S.M. and N.M. implemented the software and performed the analyses and benchmarks, with contributions from J.W.; I.A.-D., E.M. and F.C. provided mouse colon Slide-Seq data; I.A.-D., O.R.-R. and A.R. provided mouse colon single-cell RNA-seq data; I.A.-D., J.K. and A.R. assessed and interpreted biological applications; J.K., A.R. and M.N. supervised the research; S.M., N.M., I.A.-D., J.K., A.R. and M.N. wrote the manuscript.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar3">
      <title>Peer review information</title>
      <p id="Par99"><italic>Nature Biotechnology</italic> thanks the anonymous reviewers for their contribution to the peer review of this work.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The datasets analyzed during the current study are available from <ext-link ext-link-type="uri" xlink:href="http://linnarssonlab.org/osmFISH/availability/">http://linnarssonlab.org/osmFISH/availability/</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://github.com/AllonKleinLab/paper-data/tree/master/Lineage_tracing_on_transcriptional_landscapes_links_state_to_fate_during_differentiation">https://github.com/AllonKleinLab/paper-data/tree/master/Lineage_tracing_on_transcriptional_landscapes_links_state_to_fate_during_differentiation</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link>.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>TACCO is available as the open-source python package tacco, with source code freely available at <ext-link ext-link-type="uri" xlink:href="https://github.com/simonwm/tacco">https://github.com/simonwm/tacco</ext-link> and corresponding documentation at <ext-link ext-link-type="uri" xlink:href="https://simonwm.github.io/tacco/">https://simonwm.github.io/tacco/</ext-link>.</p>
  </notes>
  <notes id="FPar4" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par100">A.R. is a cofounder and equity holder of Celsius Therapeutics, an equity holder in Immunitas, and was a SAB member of ThermoFisher Scientific, Syros Pharmaceuticals, Neogene Therapeutics and Asimov until 31 July 2020. From 1 August 2020, A.R. is an employee of Genentech and has equity in Roche. F.C. is a founder and holds equity in Curio Biosciences. A.R. and O.R.-R. are co-inventors on patent applications filed by the Broad Institute for inventions related to single-cell genomics. O.R.-R. has given numerous lectures on the subject of single-cell genomics to a wide variety of audiences, and in some cases, she has received remuneration to cover time and costs. O.R.-R. is an employee of Genentech since October 19, 2020, and has equity in Roche. The remaining authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Integrative single-cell analysis</article-title>
        <source>Nat. Rev. Genet.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>257</fpage>
        <lpage>272</lpage>
        <?supplied-pmid 30696980?>
        <pub-id pub-id-type="pmid">30696980</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xing</surname>
            <given-names>QR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Unraveling heterogeneity in transcriptome and its regulation through single-cell multi-omics technologies</article-title>
        <source>Front. Genet.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>662</fpage>
        <?supplied-pmid 32765578?>
        <pub-id pub-id-type="pmid">32765578</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wagner</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Revealing the vectors of cellular identity with single-cell genomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2016</year>
        <volume>34</volume>
        <fpage>1145</fpage>
        <lpage>1160</lpage>
        <?supplied-pmid 27824854?>
        <pub-id pub-id-type="pmid">27824854</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lähnemann</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Eleven grand challenges in single-cell data science</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>31</fpage>
        <?supplied-pmid 32033589?>
        <pub-id pub-id-type="pmid">32033589</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rodriques</surname>
            <given-names>SG</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Slide-seq: a scalable technology for measuring genome-wide expression at high spatial resolution</article-title>
        <source>Science</source>
        <year>2019</year>
        <volume>363</volume>
        <fpage>1463</fpage>
        <lpage>1467</lpage>
        <?supplied-pmid 30923225?>
        <pub-id pub-id-type="pmid">30923225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stickels</surname>
            <given-names>RR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly sensitive spatial transcriptomics at near-cellular resolution with Slide-seqV2</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>39</volume>
        <fpage>313</fpage>
        <lpage>319</lpage>
        <?supplied-pmid 33288904?>
        <pub-id pub-id-type="pmid">33288904</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatially resolved single-cell genomics and transcriptomics by imaging</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>18</fpage>
        <lpage>22</lpage>
        <?supplied-pmid 33408406?>
        <pub-id pub-id-type="pmid">33408406</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cable</surname>
            <given-names>DM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Robust decomposition of cell type mixtures in spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>517</fpage>
        <lpage>526</lpage>
        <?supplied-pmid 33603203?>
        <pub-id pub-id-type="pmid">33603203</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Achim</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-throughput spatial mapping of single-cell RNA-seq data to tissue of origin</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>503</fpage>
        <lpage>509</lpage>
        <?supplied-pmid 25867922?>
        <pub-id pub-id-type="pmid">25867922</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Farrell</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Gennert</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Schier</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Spatial reconstruction of single-cell gene expression data</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>495</fpage>
        <lpage>502</lpage>
        <?supplied-pmid 25867923?>
        <pub-id pub-id-type="pmid">25867923</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Elosua-Bayes</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Nieto</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Mereu</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Gut</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Heyn</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>SPOTlight: seeded NMF regression to deconvolute spatial transcriptomics spots with single-cell transcriptomes</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2021</year>
        <volume>49</volume>
        <fpage>9</fpage>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Biancalani</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Deep learning and alignment of spatially resolved single-cell transcriptomes with Tangram</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>1352</fpage>
        <lpage>1362</lpage>
        <?supplied-pmid 34711971?>
        <pub-id pub-id-type="pmid">34711971</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nitzan</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Karaiskos</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Friedman</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Rajewsky</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Gene expression cartography</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>576</volume>
        <fpage>132</fpage>
        <lpage>137</lpage>
        <?supplied-pmid 31748748?>
        <pub-id pub-id-type="pmid">31748748</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Halpern</surname>
            <given-names>KB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell spatial reconstruction reveals global division of labour in the mammalian liver</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>542</volume>
        <fpage>352</fpage>
        <lpage>356</lpage>
        <?supplied-pmid 28166538?>
        <pub-id pub-id-type="pmid">28166538</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>SW</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>CoSpar identifies early cell fate biases from single-cell transcriptomic and lineage information</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>1066</fpage>
        <lpage>1074</lpage>
        <?supplied-pmid 35190690?>
        <pub-id pub-id-type="pmid">35190690</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schiebinger</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Optimal-transport analysis of single-cell gene expression identifies developmental trajectories in reprogramming</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>176</volume>
        <fpage>928</fpage>
        <lpage>943</lpage>
        <?supplied-pmid 30712874?>
        <pub-id pub-id-type="pmid">30712874</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Aran</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Reference-based analysis of lung single-cell sequencing reveals a transitional profibrotic macrophage</article-title>
        <source>Nat. Immunol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>163</fpage>
        <lpage>172</lpage>
        <?supplied-pmid 30643263?>
        <pub-id pub-id-type="pmid">30643263</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Herman</surname>
            <given-names>JS</given-names>
          </name>
          <name>
            <surname>Sagar</surname>
          </name>
          <name>
            <surname>Grün</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>FateID infers cell fate bias in multipotent progenitors from single-cell RNA-seq data</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>379</fpage>
        <lpage>386</lpage>
        <?supplied-pmid 29630061?>
        <pub-id pub-id-type="pmid">29630061</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Moriel</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>NovoSpaRc: flexible spatial reconstruction of single-cell gene expression with optimal transport</article-title>
        <source>Nat. Protoc.</source>
        <year>2021</year>
        <volume>16</volume>
        <fpage>4177</fpage>
        <lpage>4200</lpage>
        <?supplied-pmid 34349282?>
        <pub-id pub-id-type="pmid">34349282</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cang</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Nie</surname>
            <given-names>Q</given-names>
          </name>
        </person-group>
        <article-title>Inferring spatial and signaling relationships between cells from single cell transcriptomic data</article-title>
        <source>Nat. Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>2084</fpage>
        <?supplied-pmid 32350282?>
        <pub-id pub-id-type="pmid">32350282</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zeira</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Alignment and integration of spatial transcriptomics data</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>19</volume>
        <fpage>567</fpage>
        <lpage>575</lpage>
        <?supplied-pmid 35577957?>
        <pub-id pub-id-type="pmid">35577957</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Demetci</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Santorella</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Sandstede</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Noble</surname>
            <given-names>WS</given-names>
          </name>
          <name>
            <surname>Singh</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>SCOT: single-cell multi-omics alignment with optimal transport</article-title>
        <source>J. Comput. Biol.</source>
        <year>2022</year>
        <volume>29</volume>
        <fpage>3</fpage>
        <lpage>18</lpage>
        <?supplied-pmid 35050714?>
        <pub-id pub-id-type="pmid">35050714</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Hong</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Wan</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>Manifold alignment for heterogeneous single-cell multi-omics data integration using Pamona</article-title>
        <source>Bioinformatics</source>
        <year>2021</year>
        <volume>38</volume>
        <fpage>211</fpage>
        <lpage>219</lpage>
        <?supplied-pmid 34398192?>
        <pub-id pub-id-type="pmid">34398192</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <mixed-citation publication-type="other">Dover, K., Cang, Z., Ma, A., Nie, Q. &amp; Vershynin, R. AVIDA: alternating method for visualizing and integrating data. Preprint at <italic>arXiv</italic><ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/2206.00135">https://arxiv.org/abs/2206.00135</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly parallel genome-wide expression profiling of individual cells using nanoliter droplets</article-title>
        <source>Cell</source>
        <year>2015</year>
        <volume>161</volume>
        <fpage>1202</fpage>
        <lpage>1214</lpage>
        <?supplied-pmid 26000488?>
        <pub-id pub-id-type="pmid">26000488</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palla</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Squidpy: a scalable framework for spatial omics analysis</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>19</volume>
        <fpage>171</fpage>
        <lpage>178</lpage>
        <?supplied-pmid 35102346?>
        <pub-id pub-id-type="pmid">35102346</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Codeluppi</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatial organization of the somatosensory cortex revealed by osmFISH</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>932</fpage>
        <lpage>935</lpage>
        <?supplied-pmid 30377364?>
        <pub-id pub-id-type="pmid">30377364</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Weinreb</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Rodriguez-Fraticelli</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Camargo</surname>
            <given-names>FD</given-names>
          </name>
          <name>
            <surname>Klein</surname>
            <given-names>AM</given-names>
          </name>
        </person-group>
        <article-title>Lineage tracing on transcriptional landscapes links state to fate during differentiation</article-title>
        <source>Science</source>
        <year>2020</year>
        <volume>367</volume>
        <fpage>eaaw3381</fpage>
        <?supplied-pmid 31974159?>
        <pub-id pub-id-type="pmid">31974159</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Avraham-Davidi, I. et al. Integrative single cell and spatial transcriptomics of colorectal cancer reveals multicellular functional units that support tumor progression. Preprint at <italic>bioRxiv</italic><ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/2022.10.02.508492v1">https://www.biorxiv.org/content/10.1101/2022.10.02.508492v1</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Slyper</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell and single-nucleus RNA-Seq toolbox for fresh and frozen human tumors</article-title>
        <source>Nat. Med.</source>
        <year>2020</year>
        <volume>26</volume>
        <fpage>792</fpage>
        <lpage>802</lpage>
        <?supplied-pmid 32405060?>
        <pub-id pub-id-type="pmid">32405060</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>I-H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatial transcriptomic reconstruction of the mouse olfactory glomerular map suggests principles of odor processing</article-title>
        <source>Nat. Neurosci.</source>
        <year>2022</year>
        <volume>25</volume>
        <fpage>484</fpage>
        <lpage>492</lpage>
        <?supplied-pmid 35314823?>
        <pub-id pub-id-type="pmid">35314823</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tepe</surname>
            <given-names>B</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell RNA-seq of mouse olfactory bulb reveals cellular heterogeneity and activity-dependent molecular census of adult-born neurons</article-title>
        <source>Cell Rep.</source>
        <year>2018</year>
        <volume>25</volume>
        <fpage>2689</fpage>
        <lpage>2703</lpage>
        <?supplied-pmid 30517858?>
        <pub-id pub-id-type="pmid">30517858</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xia</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Fan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Emanuel</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatial transcriptome profiling by MERFISH reveals subcellular RNA compartmentalization and cell cycle-dependent gene expression</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2019</year>
        <volume>116</volume>
        <fpage>19490</fpage>
        <lpage>19499</lpage>
        <?supplied-pmid 31501331?>
        <pub-id pub-id-type="pmid">31501331</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eng</surname>
            <given-names>C-HL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale super-resolved imaging in tissues by RNA seqFISH</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>568</volume>
        <fpage>235</fpage>
        <lpage>239</lpage>
        <?supplied-pmid 30911168?>
        <pub-id pub-id-type="pmid">30911168</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Littman</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Joint cell segmentation and cell type annotation for spatial transcriptomics</article-title>
        <source>Mol. Syst. Biol.</source>
        <year>2021</year>
        <volume>17</volume>
        <fpage>e10108</fpage>
        <?supplied-pmid 34057817?>
        <pub-id pub-id-type="pmid">34057817</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Park</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell segmentation-free inference of cell types from in situ transcriptomics data</article-title>
        <source>Nat. Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <fpage>3545</fpage>
        <?supplied-pmid 34112806?>
        <pub-id pub-id-type="pmid">34112806</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palla</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Fischer</surname>
            <given-names>DS</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Spatial components of molecular tissue biology</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>308</fpage>
        <lpage>318</lpage>
        <?supplied-pmid 35132261?>
        <pub-id pub-id-type="pmid">35132261</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Prabhakaran</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Nawy</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Pe’er</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Sparcle: assigning transcripts to cells in multiplexed images</article-title>
        <source>Bioinforma. Adv.</source>
        <year>2022</year>
        <volume>2</volume>
        <fpage>vbac048</fpage>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Petukhov</surname>
            <given-names>V</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell segmentation in imaging-based spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>40</volume>
        <fpage>345</fpage>
        <lpage>354</lpage>
        <?supplied-pmid 34650268?>
        <pub-id pub-id-type="pmid">34650268</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <mixed-citation publication-type="other">Kotliar, D. scsim: simulate single-cell RNA-SEQ data using the Splatter statistical framework but implemented in python. <ext-link ext-link-type="uri" xlink:href="http://github.com/dylkot/scsim">github.com/dylkot/scsim</ext-link> (2021).</mixed-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kotliar</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Identifying gene expression programs of cell-type identity and cellular activity with single-cell RNA-seq</article-title>
        <source>eLife</source>
        <year>2019</year>
        <volume>8</volume>
        <fpage>e43803</fpage>
        <?supplied-pmid 31282856?>
        <pub-id pub-id-type="pmid">31282856</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zappia</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Splatter: simulation of single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2017</year>
        <volume>18</volume>
        <fpage>174</fpage>
        <?supplied-pmid 28899397?>
        <pub-id pub-id-type="pmid">28899397</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abdelaal</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A comparison of automatic cell identification methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>194</fpage>
        <?supplied-pmid 31500660?>
        <pub-id pub-id-type="pmid">31500660</pub-id>
      </element-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Fleming, S. J. et al. Unsupervised removal of systematic background noise from droplet-based single-cell experiments using CellBender. Preprint at <italic>bioRxiv</italic><ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/791699v2">https://www.biorxiv.org/content/10.1101/791699v2</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Drokhlyansky</surname>
            <given-names>E</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The human and mouse enteric nervous system at single-cell resolution</article-title>
        <source>Cell</source>
        <year>2020</year>
        <volume>182</volume>
        <fpage>1606</fpage>
        <lpage>1622</lpage>
        <?supplied-pmid 32888429?>
        <pub-id pub-id-type="pmid">32888429</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>15</fpage>
        <?supplied-pmid 29409532?>
        <pub-id pub-id-type="pmid">29409532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Knopp</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Sinkhorn</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Concerning nonnegative matrices and doubly stochastic matrices</article-title>
        <source>Pacific J. Math.</source>
        <year>1967</year>
        <volume>21</volume>
        <fpage>343</fpage>
        <lpage>348</lpage>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bacharach</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Estimating nonnegative matrices from marginal data</article-title>
        <source>Int. Econ. Rev.</source>
        <year>1965</year>
        <volume>6</volume>
        <fpage>294</fpage>
        <lpage>310</lpage>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Flamary</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>POT: Python optimal transport</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>1</fpage>
        <lpage>8</lpage>
      </element-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pedregosa</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Scikit-learn: machine learning in Python</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2011</year>
        <volume>12</volume>
        <fpage>2825</fpage>
        <lpage>2830</lpage>
      </element-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Traag</surname>
            <given-names>VA</given-names>
          </name>
          <name>
            <surname>Waltman</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>van Eck</surname>
            <given-names>NJ</given-names>
          </name>
        </person-group>
        <article-title>From Louvain to Leiden: guaranteeing well-connected communities</article-title>
        <source>Sci. Rep.</source>
        <year>2019</year>
        <volume>9</volume>
        <fpage>5233</fpage>
        <?supplied-pmid 30914743?>
        <pub-id pub-id-type="pmid">30914743</pub-id>
      </element-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Keren</surname>
            <given-names>L</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A structured tumor-immune microenvironment in triple negative breast cancer revealed by multiplexed ion beam imaging</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>174</volume>
        <fpage>1373</fpage>
        <lpage>1387</lpage>
        <?supplied-pmid 30193111?>
        <pub-id pub-id-type="pmid">30193111</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Biotechnol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Biotechnol</journal-id>
    <journal-title-group>
      <journal-title>Nature Biotechnology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1087-0156</issn>
    <issn pub-type="epub">1546-1696</issn>
    <publisher>
      <publisher-name>Nature Publishing Group US</publisher-name>
      <publisher-loc>New York</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10513360</article-id>
    <article-id pub-id-type="pmid">36797494</article-id>
    <article-id pub-id-type="publisher-id">1657</article-id>
    <article-id pub-id-type="doi">10.1038/s41587-023-01657-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>TACCO unifies annotation transfer and decomposition of cell identities for single-cell and spatial omics</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-1447-6811</contrib-id>
        <name>
          <surname>Mages</surname>
          <given-names>Simon</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <name>
          <surname>Moriel</surname>
          <given-names>Noa</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-7118-9179</contrib-id>
        <name>
          <surname>Avraham-Davidi</surname>
          <given-names>Inbal</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Murray</surname>
          <given-names>Evan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-7519-731X</contrib-id>
        <name>
          <surname>Watter</surname>
          <given-names>Jan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-2308-3649</contrib-id>
        <name>
          <surname>Chen</surname>
          <given-names>Fei</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-6313-3570</contrib-id>
        <name>
          <surname>Rozenblatt-Rosen</surname>
          <given-names>Orit</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff9">9</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3628-9278</contrib-id>
        <name>
          <surname>Klughammer</surname>
          <given-names>Johanna</given-names>
        </name>
        <address>
          <email>klughammer@genzentrum.lmu.de</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3293-3158</contrib-id>
        <name>
          <surname>Regev</surname>
          <given-names>Aviv</given-names>
        </name>
        <address>
          <email>aviv.regev.sc@gmail.com</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff6">6</xref>
        <xref ref-type="aff" rid="Aff9">9</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-0074-9196</contrib-id>
        <name>
          <surname>Nitzan</surname>
          <given-names>Mor</given-names>
        </name>
        <address>
          <email>mor.nitzan@mail.huji.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff7">7</xref>
        <xref ref-type="aff" rid="Aff8">8</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05a0ya142</institution-id><institution-id institution-id-type="GRID">grid.66859.34</institution-id><institution>Klarman Cell Observatory, Broad Institute of MIT and Harvard, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05591te55</institution-id><institution-id institution-id-type="GRID">grid.5252.0</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 973X</institution-id><institution>Gene Center and Department of Biochemistry, </institution><institution>Ludwig-Maximilians-University Munich, </institution></institution-wrap>Munich, Germany </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>School of Computer Science and Engineering, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05a0ya142</institution-id><institution-id institution-id-type="GRID">grid.66859.34</institution-id><institution>Broad Institute of MIT and Harvard, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03vek6s52</institution-id><institution-id institution-id-type="GRID">grid.38142.3c</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 754X</institution-id><institution>Department of Stem Cell and Regenerative Biology, </institution><institution>Harvard University, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff6"><label>6</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/042nb2s44</institution-id><institution-id institution-id-type="GRID">grid.116068.8</institution-id><institution-id institution-id-type="ISNI">0000 0001 2341 2786</institution-id><institution>Massachusetts Institute of Technology, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff7"><label>7</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>Racah Institute of Physics, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff8"><label>8</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>Faculty of Medicine, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff9"><label>9</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/04gndp242</institution-id><institution-id institution-id-type="ISNI">0000 0004 5899 3818</institution-id><institution>Present Address: Genentech, </institution></institution-wrap>South San Francisco, CA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>16</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>16</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <year>2023</year>
    </pub-date>
    <volume>41</volume>
    <issue>10</issue>
    <fpage>1465</fpage>
    <lpage>1473</lpage>
    <history>
      <date date-type="received">
        <day>15</day>
        <month>6</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>2</day>
        <month>1</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Transferring annotations of single-cell-, spatial- and multi-omics data is often challenging owing both to technical limitations, such as low spatial resolution or high dropout fraction, and to biological variations, such as continuous spectra of cell states. Based on the concept that these data are often best described as continuous mixtures of cells or molecules, we present a computational framework for the transfer of annotations to cells and their combinations (TACCO), which consists of an optimal transport model extended with different wrappers to annotate a wide variety of data. We apply TACCO to identify cell types and states, decipher spatiomolecular tissue structure at the cell and molecular level and resolve differentiation trajectories using synthetic and biological datasets. While matching or exceeding the accuracy of specialized tools for the individual tasks, TACCO reduces the computational requirements by up to an order of magnitude and scales to larger datasets (for example, considering the runtime of annotation transfer for 1 M simulated dropout observations).</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">Annotation transfer from reference to new datasets is improved with a probabilistic approach.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Software</kwd>
      <kwd>Data integration</kwd>
      <kwd>Data processing</kwd>
      <kwd>Computational platforms and environments</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100001659</institution-id>
            <institution>Deutsche Forschungsgemeinschaft (German Research Foundation)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>MA 9108/1-1</award-id>
        <principal-award-recipient>
          <name>
            <surname>Mages</surname>
            <given-names>Simon</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100000854</institution-id>
            <institution>Human Frontier Science Program (HFSP)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>LT000452/2019-L</award-id>
        <principal-award-recipient>
          <name>
            <surname>Klughammer</surname>
            <given-names>Johanna</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000051</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Human Genome Research Institute (NHGRI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>5RM1HG006193-09</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000054</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Cancer Institute (NCI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1U24 CA180922</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100006955</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1U19 MH114821</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000062</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Institute of Diabetes and Digestive and Kidney Diseases (National Institute of Diabetes &amp; Digestive &amp; Kidney Diseases)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1RC2 DK114784</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000011</institution-id>
            <institution>Howard Hughes Medical Institute (HHMI)</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Klarman Cell Observatory MIT Ludwig Center Manton Family Foundation</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100003977</institution-id>
            <institution>Israel Science Foundation (ISF)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1079/21</award-id>
        <principal-award-recipient>
          <name>
            <surname>Nitzan</surname>
            <given-names>Mor</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100005155</institution-id>
            <institution>Azrieli Foundation</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100006785</institution-id>
            <institution>Google</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem Horizon Europe ERC Grant (101040660)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© Springer Nature America, Inc. 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Main</title>
    <p id="Par3">Single-cell and spatial genomics methods provide high-dimensional measurements of biological systems at unprecedented scale and resolution<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR2">2</xref></sup>. One of the key challenges is attaching meaningful and interpretable representations of the experimental measurements to denote cellular features, such as types, states, cell-cycle stages or position within tissues<sup><xref ref-type="bibr" rid="CR3">3</xref>,<xref ref-type="bibr" rid="CR4">4</xref></sup> to decipher cellular dynamics, communication and collective behavior. For several biological systems, annotated reference datasets exist that can be leveraged for annotating new, more complex and information-rich datasets.</p>
    <p id="Par4">However, when the new dataset varies substantially from the reference, transferring annotations is a challenging task. A prime example is the transfer of annotations from scRNA-seq to spatial transcriptomics with supracellular spatial resolution. For instance, Slide-seq<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR6">6</xref></sup> uses spatially scattered beads to measure the combined expression of multiple neighboring cells, possibly of different types. Transferred annotations, like cell type, thus become compositional annotations, such as cell-type fractions per bead (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). Similarly, for spatial data with subcellular or even single-molecule resolution<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, compositional annotations of local neighborhoods allow segmentation-free annotation and cell assignment of single molecules. Furthermore, compositional annotations can arise not only from cell mixtures but also from ambiguity of categorical annotations (Fig. <xref rid="Fig1" ref-type="fig">1b</xref>). For example, technical noise, caused by dropout or contamination of ambient RNA, can mask the true identity of an individual cell. Finally, biological continua as observed in cell differentiation or regulatory cellular spectra also require probabilistic cell-type assignments (Fig. <xref rid="Fig1" ref-type="fig">1b</xref>).<fig id="Fig1"><label>Fig. 1</label><caption><title>TACCO, a flexible framework for the annotation and analysis of cells and cell-like objects.</title><p><bold>a</bold>, TACCO generates annotations for new datasets of mixtures (top left) using an annotated single-cell reference (top right) and provides methods for downstream analysis of the resulting compositional annotations (bottom left). <bold>b</bold>, Compositional annotations. Illustrative embeddings of cells and cell-like objects annotated (left) for mixtures (pie charts) of idealized pure contributions (triangles); (middle) as ambiguous annotations (triangles with colored borders) for technical artifacts like high ambient contributions or dropout levels and (right) continuous annotations (circles) along biological continua. <bold>c</bold>, Annotation process. Far left: a labeled reference dataset (for example, scRNA-seq data and colored triangles) and a new dataset (for example, Slide-seq beads and circles) are first presented in a common high-dimensional space (for example, expression space) optionally using platform normalization to make the datasets comparable. Near left: TACCO represents the reference categories by one or multiple representative profiles (large colored triangles). Near right: TACCO uses semi-unbalanced entropic optimal transport to transfer annotations from the reference categories to the new dataset (arrows), generating compositional annotations for the new datapoints (colored pie charts). To improve the capture of subdominant contributions, this process is iterated. Far right: TACCO provides compositional annotations for the new dataset. <bold>d</bold>, TACCO analysis tools for compositional annotations, especially for spatial data. From left: spatial relationship analysis on long (tissue) and short (cellular neighborships) length scales; inferring spatial regions by both spatial and annotation information; enrichment of compositional annotations and splitting compositionally annotated count data into pure contributions for downstream analysis with single-cell analysis tools.</p></caption><graphic xlink:href="41587_2023_1657_Fig1_HTML" id="d32e524"/></fig></p>
    <p id="Par5">While different decomposition or mapping methods have been developed for specific use cases such as decomposition of spatial measurements<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR8">8</xref>–<xref ref-type="bibr" rid="CR11">11</xref></sup>, spatial single-cell mapping<sup><xref ref-type="bibr" rid="CR12">12</xref>–<xref ref-type="bibr" rid="CR14">14</xref></sup> or resolving trajectories<sup><xref ref-type="bibr" rid="CR15">15</xref>–<xref ref-type="bibr" rid="CR18">18</xref></sup>, they are in fact conceptually similar. In particular, in each of these cases, proximity in expression space translates to higher contributions in the annotation, suggesting that it should be possible to develop a general unifying framework across these tasks.</p>
    <p id="Par6">We implement this idea in a computational framework for the transfer of annotations to cells and their combinations (TACCO). TACCO is an optimal transport-based, flexible and efficient framework for annotation and analysis of single-cell and spatial omics data. We demonstrate TACCO’s applicability in various use cases, including identification of cell types and states, analysis of spatiomolecular tissue structure at different scales and single-cell differentiation fate prediction. Finally, we show that TACCO performs favorably in terms of accuracy and computing requirements when compared to other methods.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>TACCO: a framework for transferring annotations</title>
      <p id="Par7">We developed TACCO, a fast and flexible computational decomposition framework (Fig. <xref rid="Fig1" ref-type="fig">1c</xref>). TACCO takes as input an unannotated dataset consisting of observations (for example, the expression profiles of Slide-seq beads) and a corresponding reference dataset with annotations in a reference representation (for example, single-cell expression profiles with cell-type annotations) and computes a compositional annotation of the unannotated observations (for example, cell-type fractions of the Slide-seq beads). Working in a common high-dimensional space (for example, gene expression space), TACCO determines these compositions using a variation of the optimal transport (OT) algorithm (<xref rid="Sec25" ref-type="sec">Methods</xref>). At its core, OT creates a probabilistic map between the unannotated observations (for example, Slide-seq beads) and the means of the classes in the reference representation (for example, mean cell-type profiles) according to their relative similarity. This approach was previously used to map ancestor and descendant cells during differentiation<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>, recover the spatial organization of cells<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR19">19</xref>–<xref ref-type="bibr" rid="CR21">21</xref></sup> and associate measurements across modalities (for example, single-cell ATAC-seq and scRNA-seq)<sup><xref ref-type="bibr" rid="CR22">22</xref>–<xref ref-type="bibr" rid="CR24">24</xref></sup>. Through the OT framework, users can set the similarity metric, constrain or bias the marginals of the mapping and control the entropy of the annotation distributions (<xref rid="Sec25" ref-type="sec">Methods</xref>). By default, TACCO uses Bhattacharyya coefficients as a similarity metric (<xref rid="Sec25" ref-type="sec">Methods</xref>), which are formally equivalent to the overlaps of probability amplitudes in quantum mechanics and closely related to expectation values of measurements.</p>
      <p id="Par8">To address concrete biological perturbations and experimental variations between the new and reference data, TACCO provides a set of generic boosters (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>), including (1) platform normalization (as in robust cell type decomposition (RCTD)<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>), which introduces scaling factors in the transformation between experimental platforms (for example, Drop-seq<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> to Slide-seq<sup><xref ref-type="bibr" rid="CR5">5</xref></sup>); (2) subclustering with multiple centers to capture within-class heterogeneity and (3) bisectioning for recursive annotation, assigning only part of the annotation in each step and working with the residual in the next step to increase sensitivity to subdominant annotation contributions (<xref rid="Sec25" ref-type="sec">Methods</xref>).</p>
      <p id="Par9">TACCO is also equipped with different analysis tools that leverage the obtained compositional annotations (Fig. <xref rid="Fig1" ref-type="fig">1d</xref>). It adapts categorical annotation analyses to be applicable to mixture annotations across multiple samples, such as the quantification of spatial co-occurrence<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> of annotations to analyze long- and short-range spatial structure, and calculates enrichments of annotations. For spatial data, TACCO can combine spatial and annotation information to define regions with similar annotation compositions across samples. Moreover, TACCO can split compositionally annotated expression data (for example, cell-type annotated Slide-seq beads) into categorically annotated expression data (for example, split beads per cell type) using a matrix scaling algorithm, yielding data that are amenable to standard downstream single-cell analysis workflows.</p>
      <p id="Par10">We evaluated TACCO on the following four different use cases: (1) decomposing cell-type fractions from spatially convoluted gene expression (in silico mixed scRNA-seq profiles for benchmarking and decomposing colon Slide-seq<sup><xref ref-type="bibr" rid="CR6">6</xref></sup> bead measurements); (2) inferring the source cell types of imaged single molecules (without requiring segmentation of cell boundaries from images) for the somatosensory cortex imaged with osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>; (3) recovering cell type for scRNA-seq data with harsh dropout and with ambient RNA contamination (on simulated data) and (4) predicting differentiation fates of early hematopoietic progenitor cells<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. As we show below, TACCO consistently achieved performance comparable to or better than other benchmarked methods and excelled especially in speed and memory consumption.</p>
    </sec>
    <sec id="Sec4">
      <title>Accurate decomposition of in silico mixed expression</title>
      <p id="Par11">We first validated TACCO on simulated Slide-seq data that were generated from an annotated (real) scRNA-seq atlas of the mouse colon<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>) as weighted mixtures of cells drawn from the reference atlas with Gaussian weights parameterized by bead size (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>, <xref rid="Sec25" ref-type="sec">Methods</xref>). We measured the L2 error between the ground-truth weights and the cell-type fractions inferred by TACCO for varying bead sizes. TACCO matched in reconstruction accuracy with RCTD<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> and consistent with this outperformed all other tested state-of-the-art methods (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). Moreover, TACCO was much faster and had lower memory consumption than RCTD because RCTD fits a detailed model dense in parameters. For example, at bead size 1.0 (that is, bead and cells are of comparable size), the L2 errors were 0.081, 0.26 and 0.084 for TACCO, NMFreg<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> and RCTD, while TACCO and RCTD runtimes were 84 s and 1469 s, and memory consumption was 2.7 GB and 10.4 GB, respectively. After annotation, TACCO uses the mean reference profiles and the compositional annotation to distribute the actual counts per gene and observation between the cell types and thereby generates separate observations per cell type, keeping the full gene space intact. A subsequent dimensionality reduction then recovers the low-dimensional structure of the reference data (Fig. <xref rid="Fig2" ref-type="fig">2a</xref> and Extended Data Fig. <xref rid="Fig6" ref-type="fig">2</xref>).<fig id="Fig2"><label>Fig. 2</label><caption><title>TACCO compositional annotation, cell segmentation and analysis of spatial expression data.</title><p><bold>a</bold>, Analysis of in silico mixtures. UMAP embedding of scRNA-seq profiles of mouse colon (1)<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> and of in silico mixed scRNA-seq data before (2) and after (4) applying TACCOs splitting procedure into pure contributions. (3) L2 error (<italic>y</italic> axis) of cell-type annotations for each simulated bead size (<italic>x</italic> axis). Dashed lines: categorical annotation methods. <bold>b</bold>, A Slide-seq puck of normal mouse colon<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> colored by TACCO cell-type annotations (1, colors are weighted and summed per bead) or by TACCO-defined regions (2) (<xref rid="Sec25" ref-type="sec">Methods</xref>; Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>); (3) short-range (up to 20 µm) neighborship enrichment <italic>z</italic> scores over randomly permuted annotation assignments; (4) long-range (up to 500 µm) dependence of the composition of cell types around beads (log<sub>2</sub>(<italic>p</italic>(annotations|center)); <italic>y</italic> axis) at different distances from region 2 (muscularis; <italic>x</italic> axis) for each cell-type annotation (color). <bold>c</bold>, Comparison of TACCO and Baysor for single-molecule cell-type-of-origin annotation performance based on the single-molecule FISH: (1–3) Entire section profiled by osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> (left) and zoom-in on a small region (right) colored by (1) the published annotation of cells from watershed-based segmentation of the poly(A) signal or (2,3) the segmentation-free single-molecule annotation for cell-type-of-origin by TACCO (2) or Baysor (3) (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6a</xref>); (4) measured astrocyte marker gene expression on the zoom-in as ground truth for the astrocyte annotation in (1–3). Gray molecules are unannotated. <bold>d</bold>, Effective cell segmentation of osmFISH data by TACCO. tSNE embeddings of RNA profiles in cell-like objects from the published watershed-based segmentation colored by the published cell-type annotation (1), from TACCOs annotation-based segmentation (using the annotations in c (2)) (2, 3), colored by either TACCOs single-molecule annotations summed per cell (2) or by the published segmented cell annotation pulled back to single molecules (as in c(1)) and summed per cell (3) (<xref rid="Sec25" ref-type="sec">Methods</xref>; Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). <bold>e</bold>, Recovery of layered tissue structure in osmFISH data. Long-range (up to 2,000 µm) dependence of the composition of cell types (<italic>p</italic>(annotations|center = hippocampus), <italic>y</italic> axis) recovered by TACCO for TACCO-segmented objects at different distances from the hippocampus region annotation for each cell-type annotation (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6c</xref>).</p></caption><graphic xlink:href="41587_2023_1657_Fig2_HTML" id="d32e758"/></fig></p>
    </sec>
    <sec id="Sec5">
      <title>Decomposition and structural analysis of Slide-seq data</title>
      <p id="Par12">We next applied TACCO to the annotation of real Slide-seq data from mouse colon with matching scRNA-seq<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>). The different characteristics of scRNA-seq and Slide-seq data present annotation challenges. For example, cell composition can vary substantially, due to selection bias (much larger region assayed for scRNA-seq than Slide-seq) or because of differential capture efficiencies (for example, lower capture of fibroblasts by scRNA-seq<sup><xref ref-type="bibr" rid="CR30">30</xref></sup> compared to their true tissue prevalence). Moreover, Slide-seq’s low RNA capture rate yields much sparser data than scRNA-seq. Despite these challenges, TACCO recovered the expected layered structure of the colon along the muscularis–apical axis, short-range neighborship relations (closeness of stromal and immune cells with segregating epithelial cells) and long-range gradients on tissue structure scale from muscularis to apical plasma membrane (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>).</p>
      <p id="Par13">TACCO scales to real-world applications, such as annotating a large dataset of 40 Slide-seq pucks of the mouse olfactory bulb<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>. Using mean expression profiles of different cell types from scRNA-seq dataset from the same tissue<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, TACCO annotated the full dataset of &gt;1.4 million spatial observations on 8 CPU cores in under 12 min, yielding consistent results between consecutive pucks and two replicates (Extended Data Fig. <xref rid="Fig8" ref-type="fig">4a</xref>). As an alternative to cell-type mean profiles, TACCO can also use every individual cell profile as reference, similar to spatial reconstruction<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR13">13</xref></sup> (Extended Data Fig. <xref rid="Fig8" ref-type="fig">4b</xref>) and infer the cells’ spatial arrangement, by either a compositional annotation of beads with all single cells or by annotating the single cells with the most likely position in the puck. Each of the three approaches implemented with TACCO (using mean expression profiles, compositional annotation with cells or mapping cells to most likely position) gave qualitatively similar spatial distributions of cell type; however, using mean profiles was more efficient computationally, while annotating cells with unique positions introduced additional noise in the spatial cell-type distribution.</p>
    </sec>
    <sec id="Sec6">
      <title>Single-molecule cell-type assignment and segmentation</title>
      <p id="Par14">Next, for single-molecule, high-resolution spatial imaging data (for example, MERFISH<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> or osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>), TACCO includes a wrapper for annotating individual, spatially imaged molecules with cell types, without prior cell segmentation. Standard procedures first segment the captured molecules either based on an image of the cells<sup><xref ref-type="bibr" rid="CR27">27</xref>,<xref ref-type="bibr" rid="CR33">33</xref>–<xref ref-type="bibr" rid="CR35">35</xref></sup> or by finding local maxima in spatially blurred expression fields<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. Both can be challenging due to high cellular density, irregular cell shapes and misplaced molecules<sup><xref ref-type="bibr" rid="CR37">37</xref>,<xref ref-type="bibr" rid="CR38">38</xref></sup>. TACCO circumvents these limitations by annotating each molecule. To this end, TACCO bins molecules using a Cartesian grid into spatial neighborhoods, computes cell-type annotations for each neighborhood using the reference profiles (as for Slide-seq above) and assigns each molecule an annotation in a manner that recapitulates the neighborhood’s annotation fractions (<xref rid="Sec25" ref-type="sec">Methods</xref>). Applied to a mouse brain osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> dataset, TACCO successfully accounted for each molecule (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>), compared to only 36% of molecules annotated following cell segmentation and cell-type classification<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>). Moreover, TACCO matched 59% of the molecular annotations in the original study, substantially better than Baysor<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, a recent single-molecule annotation method based on Bayesian mixture models (Fig. <xref rid="Fig2" ref-type="fig">2c</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>) (35% matched) and comparable to SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>, which annotates kernel density estimates of the expression on a Cartesian grid (<xref rid="Sec25" ref-type="sec">Methods</xref>) (57% matched). Notably, TACCO was much faster than both methods (TACCO: 2 min; Baysor: 27 min and SSAM: 68 min; Extended Data Fig. <xref rid="Fig10" ref-type="fig">6a</xref>) with robust success over a wide range of parameter choices (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6b</xref>). For cells with nonspheroid shapes, such as astrocytes, single-molecule annotation is especially advantageous; while TACCO, Baysor and SSAM annotate all molecules, the baseline segmentation and classification approach only accounts for 17% of astrocyte marker molecules (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>).</p>
      <p id="Par15">Subsequent image-free segmentation to cell-like objects based on spatial and annotation information allowed TACCO to recover expression profiles with cell-type annotations, thus utilizing more of the available data and better representing distinct cell types than the baseline as indicated by a higher silhouette score for TACCO than the baseline (0.24 compared to 0.06; <xref rid="Sec25" ref-type="sec">Methods</xref>; Fig. <xref rid="Fig2" ref-type="fig">2d</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). Applying TACCO’s segmentation on Baysor’s annotation yields an even higher silhouette score (0.45) but at the cost of missing three categories in the annotation (Hippocampus, Inhibitory IC and Inhibitory Pthlh) and a large fraction of molecules in very small segmented objects (28.7% of molecules in objects with less than 20 molecules, compared to 8.3% for TACCO) resulting from a less spatially homogeneous single-molecule annotation of Baysor compared to TACCO (Fig. <xref rid="Fig2" ref-type="fig">2c</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). Using Baysor’s built-in segmentation instead resulted in a silhouette score (0.03) that was worse than baseline and a longer runtime (50 min versus 3–5 min for TACCO segmentations). Replacing TACCO’s annotation with SSAM’s in the TACCO segmentation yielded a comparable silhouette score (0.22).</p>
      <p id="Par16">TACCO’s downstream analyses can use this image-free segmented single-molecule dataset to evaluate short- and long-range spatial patterns by computing the cell-type composition as a function of the distance to specific annotated cells. For example, we demonstrate this by recovering the layered structure of the mouse brain by calculating the distance to annotated hippocampal cells (Fig. <xref rid="Fig2" ref-type="fig">2e</xref>). Thus, TACCO’s spatial analyses efficiently bridge spatial scales from single-molecule data to tissue scale. TACCO’s downstream analysis is generic and can be applied to the annotations and segmentation derived from other methods as well. For example, TACCO- and SSAM-based analyses reproduce the layered structure, but the TACCO-based analysis yielded clearer cell-type density peaks than the SSAM-based one, while Baysor-based analyses were less conclusive (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6c</xref>).</p>
    </sec>
    <sec id="Sec7">
      <title>Classifying cell types in the presence of technical artifacts</title>
      <p id="Par17">While TACCO is primarily a compositional annotation algorithm, it can be used as a cell-type classifier by interpreting the compositional annotation as probabilities and quoting the class with maximum probability as the classification result. Indeed, TACCO performed well in recovering the ground-truth cell-type classification of simulated data with either high dropout rates or high levels of ambient RNAs, as compared to bona fide classifiers, SingleR<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> and SVM, and other compositional annotation methods turned into classifiers (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>). Specifically, for data with high dropout rates, we simulated a reference dataset of distinct cell types using scsim<sup><xref ref-type="bibr" rid="CR40">40</xref>,<xref ref-type="bibr" rid="CR41">41</xref></sup>, where the probability of dropout is a function of log mean expression<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>. Although each cell’s type is preserved, increasing this technical noise leads to increasingly ‘fuzzy’ cell-type-specific signals. Based on the fraction of correctly labeled cells, TACCO outperformed both the classification methods and other compositional methods used as classifiers, with larger performance margins in TACCO’s favor for higher dropout rates. In particular, SVM, a top-performing cell-type classification method<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>, performed poorly when the test data shifted in gene expression. For example, on the same in silico dataset with mild dropout rate (dropmidpoint = −1), TACCO correctly assigned 99.9% of cells, whereas SVM only captured 44.7% correctly. For ambient RNA contributions (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>), we simulated a reference dataset of distinct cell types using scsim<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> with the ambient RNA model from CellBender<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>. TACCO outperformed all other baseline methods, based on the fraction of correctly labeled cells (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>).<fig id="Fig3"><label>Fig. 3</label><caption><title>TACCO addresses dropouts, ambient RNA and continuous annotations.</title><p><bold>a</bold>, Dropout task. (1) UMAP embedding of the simulated scRNA-seq profiles without dropout; (2) schematic of the probability of dropout (<italic>y</italic> axis) for genes with different mean expressions (<italic>x</italic> axis); (3) UMAP embedding of the simulated data from (1) but with dropout; (4) fraction of correctly annotated cells (<italic>y</italic> axis, defined by the agreement of annotated type with maximal probability and the cell’s true annotation) at different dropout rate (<italic>x</italic> axis) for different methods (colors). Dashed lines: categorical annotation methods. <bold>b</bold>, Ambient RNA task: (1) UMAP embedding of simulated scRNA-seq profiles without ambient contribution; (2) schematic of test data generation, where ambient RNA is added to the cell’s expression profile; (3) UMAP embedding of simulated scRNA-seq profiles from (1) but with additional ambient contribution; (4) fraction of correctly annotated cells (<italic>y</italic> axis, defined by agreement of annotated type with maximal probability and the cell’s true annotation) at different levels of ambient RNA contamination (<italic>x</italic> axis) for different methods (colors). Dashed lines: categorical annotation methods. <bold>c</bold>, Differentiation task: (1–3) Spring plot of scRNA-seq profiles from hematopoiesis<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> colored by cell types at day 4 and 6 (1); eventual clonal fate of day 2 cells (2), TACCO-predicted clonal fate of day 2 cells (3); (4) Pearson correlation coefficient (<italic>y</italic> axis) of predicted and actual fate (as evaluated in ref. <sup><xref ref-type="bibr" rid="CR28">28</xref></sup>) for each method (colors).</p></caption><graphic xlink:href="41587_2023_1657_Fig3_HTML" id="d32e1006"/></fig></p>
    </sec>
    <sec id="Sec8">
      <title>TACCO-based prediction of cell fate decisions from scRNA-seq</title>
      <p id="Par18">TACCO also resolved continuous biological variability in the context of cell differentiation. To this end, we used a recent dataset<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> based on the LARRY method, where hematopoietic stem and progenitor cells were clonally barcoded and clones were followed through subsequent cell division and differentiation, for cells profiled by scRNA-seq at day 2, 4 and 6. Most early cells (day 2) (96%) were undifferentiated<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>, while day 4 and 6 cells were mostly (61%) differentiated with distinct profiles; thus, for early progenitor cells, we construct a proxy of their fate identities based on the distribution of the annotations of their clonal relatives (linked via a shared barcode; Fig. <xref rid="Fig3" ref-type="fig">3c</xref>). We then challenged TACCO to predict the fates of early day 2 cells (test data) from the cell-type labeled expression of later, more differentiated cells (reference data). TACCO’s predictions are most correlated with the proxy clonal fates (Pearson’s <italic>r</italic> = 0.73), outperforming five other available methods (<italic>r</italic> = 0.19–0.62; Fig. <xref rid="Fig3" ref-type="fig">3c</xref>).</p>
      <p id="Par19">This difference in prediction accuracy impacted the biological features visible from the analysis. TACCO highlighted the uncertainty of early fate decisions and the correct commitment of cells from late stages, along with differentiation ‘watersheds’ at appropriate points, such as between basophils and neutrophils and between neutrophils and monocytes. Conversely, other methods either did not reproduce the watersheds (for example, WOT), did not reflect fate uncertainty at early stages (for example, SingleR), or did not capture the commitment of later stages (for example, NMFreg) (Extended Data Fig. <xref rid="Fig11" ref-type="fig">7</xref>).</p>
    </sec>
    <sec id="Sec9">
      <title>Benchmark of accuracy, runtime and memory requirements</title>
      <p id="Par20">We designed TACCO with a focus on practical usability. In addition to its broad applicability to many use cases, TACCO has a modest resource footprint in terms of computing time, memory requirements and specialized hardware needs. We benchmarked TACCO’s computational requirements relative to those of baseline methods on standard x86 hardware on the ‘dropout’, ‘mixture’ and ‘differentiation’ tasks with a range of datasets sizes (10<sup>3</sup>–10<sup>6</sup> observations; Fig. <xref rid="Fig4" ref-type="fig">4</xref>). Among all compositional annotation methods in the comparison, TACCO has the lowest runtime and memory requirements, often outperforming the other methods by an order of magnitude or more. Only plain SVM, a categorical annotation method, achieved comparable or better runtime and memory requirements depending on the problem size. However, for categorical annotation, TACCO can also run without the bisectioning booster which improves TACCO’s runtime even further. TACCO achieves all that while maintaining a stable and very competitive L2 error of the annotated compositions with respect to the ground truth across tasks and dataset sizes. While TACCO is very flexible and can be tuned to perform particularly well for specific use cases, a single configuration generally gives a decent performance in terms of runtime, memory and accuracy across various use cases (Extended Data Fig. <xref rid="Fig12" ref-type="fig">8</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>). Additionally, runtime and memory usage are also optimized in TACCO’s downstream analysis tools. For example, similar statistics of co-occurrence and neighborhood-enrichment testing are computed via Squidpy<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> and TACCO, but faster to compute with TACCO (Extended Data Fig. <xref rid="Fig13" ref-type="fig">9</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>).<fig id="Fig4"><label>Fig. 4</label><caption><title>Benchmarking TACCO’s runtime, memory requirement and accuracy of annotation transfer.</title><p>Runtime (top), memory (middle) and L2 error (bottom) of each method (colors) in the ‘mixture’ (left; with bead size = 1.0), ‘dropout’ (middle; with drop midpoint = −1.0) and ‘differentiation’ (right) use cases, at different numbers of observations (cells or beads, <italic>x</italic> axis), ranging from 2<sup>10</sup> ~ 1 k to 2<sup>20</sup> ~ 1 M, which are up/down sampled from the datasets in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. Reference size is fixed at 2<sup>14</sup> ~ 16 k. The maximum compute resources per run are 8 CPU cores for 8 h with 8 GB memory each. Missing data points indicate that either compute time or memory was insufficient to complete the annotation. Methods with an asterisk do not natively return (fractional) annotations of spatial measurements, which leaves the total annotation fractions in the spatial measurement as degrees of freedom. The wrapper fills that using the reference type fractions. Categorical annotation methods are dashed.</p></caption><graphic xlink:href="41587_2023_1657_Fig4_HTML" id="d32e1094"/></fig></p>
    </sec>
  </sec>
  <sec id="Sec10" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par21">In conclusion, TACCO is a compositional annotation approach and broader analysis package rooted in the realization that multiple tasks in high-dimensional biological representations rely on successfully resolving continuous mixtures over cells or molecules, either due to biological or technical reasons. To leverage annotations of a reference dataset to annotate another dataset, TACCO integrates core, interpretable annotation methods, such as OT, and computational manipulations addressing concrete data perturbations. Together, these yield a top-performing framework in terms of accuracy, scalability, speed and memory requirements, making TACCO applicable for a wide range of annotation tasks.</p>
    <p id="Par22">However, the flexibility and efficiency of TACCO’s OT-based annotation come at a price. It cannot incorporate diverse detailed knowledge about the data-generating process as methods from the (deep) variational inference class do. While certain applications may benefit from creating a specialized annotation method instead of TACCO, this often requires substantial manual effort, detailed knowledge of the system and computing resources.</p>
    <p id="Par23">A further limitation is the requirement of overlapping feature spaces for reference and target data. Therefore, to use TACCO’s annotation for the transfer of annotations between modalities (for example, RNA–protein, DNA accessibility/methylation–RNA), a translation between the modalities needs to be performed externally to TACCO.</p>
    <p id="Par24">TACCO could be further extended by modeling continuous reference annotations (for example, interpolating/extrapolating along a linear reference), by integrating additional priors such as spatial smoothness for annotating spatial transcriptomic data and by integrating manifold learning techniques to better approximate expression distances from reference profiles.</p>
    <p id="Par25">The analytical form of interpretable methods like OT also opens the door to theoretical work on the limitations and guarantees of projecting annotations from one data to another, leading to more informed method selection.</p>
    <p id="Par26">TACCO’s computational efficiency places it as a potential building block for the development of new ‘meta’ analysis tools which perform different tasks. A prominent example for this is already implemented within TACCO: TACCO’s single-molecule annotation relies on repeatedly performing compositional annotations, which is feasible due to its underlying efficiency.</p>
    <p id="Par27">While showing here several examples of compositional and categorical annotations, we anticipate that TACCO will help in deciphering many other datasets, such as in decomposing expression of overloaded scRNA-seq experiments (for example, MIRACL-seq<sup><xref ref-type="bibr" rid="CR45">45</xref></sup>, which overloads single nuclei to capture more rare cells) and in deciphering cells with complex continuous states, such as T cell spectra.</p>
  </sec>
  <sec id="Sec11">
    <title>Datasets</title>
    <sec id="Sec12">
      <title>Mouse colon scRNA-seq and in silico spatial mixing</title>
      <p id="Par28">Mouse colon scRNA-seq data<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, as available from <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link> in raw counts format after basic quality filtering, with the provided cell-type annotations, was used to simulate spatial mixing by sampling uniformly spatial coordinates for cells and for simulated beads on a square. To make boundary effects smaller, periodic boundary conditions were employed. On the resulting torus, the minimal Euclidean distance was taken between cells and beads. To factor in the ‘shape’ of the beads, that distance was plugged into a kernel to compute the weights of contributions of each cell to a bead. From these weights, expression counts of cells and cell-type annotation of cells, expression counts of beads, cell-type fractions and count fractions belonging to each type were computed.</p>
      <p id="Par29">A Gaussian kernel was used to determine the weight of cell <italic>c</italic> in bead <italic>b</italic> as follows:<disp-formula id="Equa"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left( {w_{{\mathrm{gauss}}}} \right)_{cb} = r\,{\mathrm{exp}}\left( { - 1/2\left( {d_{cb}/l} \right)^2} \right)$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:msub><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>w</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">gauss</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>r</mml:mi><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>/</mml:mo><mml:mn>2</mml:mn><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equa.gif" position="anchor"/></alternatives></disp-formula>where <italic>d</italic><sub><italic>cb</italic></sub> is the Euclidean distance between the centers of cell <italic>c</italic> and bead <italic>b</italic>, <italic>l</italic> = 1/2 bead_size √<italic>1/n</italic>, and <italic>n</italic> cells. To capture the higher sparsity of the spatial data, the weight was scaled by a capture rate parameter <italic>r</italic> such that a cell contributes a fraction of <italic>r</italic> of its counts to a bead with distance <italic>0</italic>. <italic>r</italic> = 1.0 was used everywhere except where explicitly stated.</p>
    </sec>
    <sec id="Sec13">
      <title>Mouse colon scRNA-seq and Slide-seq data</title>
      <p id="Par30">scRNA-seq (as in the section above) and Slide-seq data of normal mouse colon were obtained from ref. <sup><xref ref-type="bibr" rid="CR29">29</xref></sup>. Raw counts reported for Puck 2020-09-14_Puck_200701_21 were used as available from <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link>.</p>
    </sec>
    <sec id="Sec14">
      <title>Mouse olfactory bulb scRNA-seq and Slide-seq data</title>
      <p id="Par31">scRNA-seq of mouse olfactory bulb was obtained from <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR32">32</xref></sup>), and Slide-seq data of the same tissue from <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR31">31</xref></sup>). Raw counts were used for both datasets.</p>
    </sec>
    <sec id="Sec15">
      <title>Single-molecule osmFISH of the mouse cortex</title>
      <p id="Par32">osmFISH data were obtained from <ext-link ext-link-type="uri" xlink:href="http://linnarssonlab.org/osmFISH/availability/">http://linnarssonlab.org/osmFISH/availability/</ext-link> ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. Reference expression profiles and their corresponding annotations were obtained from osmFISH-segmented cell profiles provided in ‘osmFISH_SScortex_mouse_all_cells.loom’.</p>
      <p id="Par33">Raw mRNA locations were obtained from ‘mRNA_coords_raw_counting.hdf5’.</p>
      <p id="Par34">Preprocessing was performed using the procedure in <ext-link ext-link-type="uri" xlink:href="https://github.com/HiDiHlabs/ssam_example/blob/master/osmFISH_SSp.ipynb">https://github.com/HiDiHlabs/ssam_example/blob/master/osmFISH_SSp.ipynb</ext-link>. This includes (1) shifting and rescaling cell/RNA coordinates to match each other (with an RNA coordinate system); (2) removing RNA molecules of bad quality; (3) correcting incorrect gene names and (4) removing molecules outside the intended imaged frame.</p>
      <p id="Par35">‘polyT_seg.pkl’, which contains a mapping of osmFISH’s segmented cell to molecule, was used to project osmFISH’s cell annotation onto individual molecules (approximating the ground truth). To visualize annotations at single-molecule level (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>), a window of x range (1,150, 1,400) and y range (1,000, 1,600) was used.</p>
    </sec>
    <sec id="Sec16">
      <title>scRNA-seq simulations with scsim with enhanced dropout</title>
      <p id="Par36">Scsim<sup><xref ref-type="bibr" rid="CR41">41</xref></sup> with its corresponding default parameters (set in notebook ‘Step1_Simulate.ipynb’, with changing deloc to 5.0) was used to simulate scRNA-seq data. The dropout step described in Splatter<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> was implemented in Python, by fitting a sigmoid curve through genes’ log mean count and their cell fraction with zero reads, where the sigmoid is characterized by shape and midpoint parameters. To enhance dropout, the sigmoid was shifted (decrease its midpoint) and the adjusted dropout probability was computed. This probability was then used to binomially sample the observed counts.</p>
    </sec>
    <sec id="Sec17">
      <title>scRNA-seq simulations with scsim with ambient RNA</title>
      <p id="Par37">To simulate expression profiles with ambient RNA, scsim’s<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> simulation of mean expression per cells and genes (termed ‘updatedmean’ in scsim and denoted in Splatter<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> as <italic>λ</italic>, a matrix of the means for each gene and each cell) was combined with CellBender’s<sup><xref ref-type="bibr" rid="CR44">44</xref></sup> model of ambient RNA contamination and downstream sampling of counts.</p>
      <p id="Par38">Specifically, the mean expression of gene <italic>g</italic> and cell <italic>n</italic> (or here, the cell in drop <italic>n</italic>) was obtained from scsim as <italic>λ</italic><sub><italic>ng</italic></sub>. For CellBender’s probabilistic model, the probability of having a cell in the drop <italic>y</italic><sub><italic>n</italic></sub> is set to 1 (because empty drops are not considered), and <italic>ρ</italic><sub><italic>n</italic></sub> is set to 0 because 0 reads are exogenous to the drop as we account only for ambient RNA (pumped into the drop) and not for barcode swapping. Thus, the CellBender model simplifies to<disp-formula id="Equb"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_{ng}\sim {{{\mathrm{NB}}}}\left( {d_n^{{\mathrm{cell}}}\chi _{ng} + d_n^{{\mathrm{drop}}}\chi ^a_g,{\Phi}} \right)$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>~</mml:mo><mml:mi mathvariant="normal">NB</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Φ</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equb.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par39">The two models were combined as follows:</p>
      <p id="Par40"><inline-formula id="IEq1"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda _{ng} = d_n^{{\mathrm{cell}}}\chi _{ng}$$\end{document}</tex-math><mml:math id="M6"><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq1.gif"/></alternatives></inline-formula> is the mean expression (similar to CellBender, scsim also uses a log-normal distribution of cell size)</p>
      <p id="Par41"><inline-formula id="IEq2"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda' _g = {\mathrm{avg}}_n\lambda _{ng} = \chi _g^a$$\end{document}</tex-math><mml:math id="M8"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">avg</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq2.gif"/></alternatives></inline-formula> is the mean true count of gene <italic>g</italic>, that is, the ambient contribution of the gene</p>
      <p id="Par42">Given the fraction of ambient RNA, <italic>f</italic>
<sup>drop</sup>, and the library size, <inline-formula id="IEq3"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M10"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq3.gif"/></alternatives></inline-formula>, and scale, <inline-formula id="IEq4"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\sigma ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M12"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq4.gif"/></alternatives></inline-formula>, used for sampling the cell size, <inline-formula id="IEq5"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_n^{{\mathrm{cell}}},d_n^{{\mathrm{drop}}}$$\end{document}</tex-math><mml:math id="M14"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq5.gif"/></alternatives></inline-formula> ~ logNormal(<inline-formula id="IEq6"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M16"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq6.gif"/></alternatives></inline-formula> + log(<italic>f</italic><sup>drop</sup>), <inline-formula id="IEq7"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\sigma ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M18"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq7.gif"/></alternatives></inline-formula>) is sampled (that is, the same variance is employed as used for sampling the cell content and the mean is set to log(exp(<inline-formula id="IEq8"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M20"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq8.gif"/></alternatives></inline-formula>) <italic>f</italic>
<sup>drop</sup>).</p>
      <p id="Par43"><italic>Φ</italic> is sampled as defined in CellBender</p>
      <p id="Par44">Thus, we sample<disp-formula id="Equc"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_{ng}\sim {{{\mathrm{NB}}}}( {\lambda _{ng} + d_n^{{\mathrm{drop}}}\lambda' _g,{{{\Phi}}}} )$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>~</mml:mo><mml:mi mathvariant="normal">NB</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Φ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equc.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par45">For comparability, the reference is generated in the same way (using negative binomial sampling instead of scsim’s Poisson sampling) but without adding ambient RNA.</p>
    </sec>
    <sec id="Sec18">
      <title>scRNA-seq of clone-labeled hematopoiesis cells</title>
      <p id="Par46">Normalized counts (‘stateFate_inVitro_normed_counts.mtx’, together with the corresponding gene names and cell metadata) and cells’ clone matrix (‘stateFate_inVitro_clone_matrix.mtx’) were obtained from the GitHub repository <ext-link ext-link-type="uri" xlink:href="https://github.com/AllonKleinLab/paper-data/blob/master/">https://github.com/AllonKleinLab/paper-data/blob/master/</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR28">28</xref></sup>). Cells were filtered to those belonging to clones with cells on day 2 and on days 4 or 6. The fate bias for each cell on day 2 was computed from the fates of its clone on days 4 and 6 (normalized to 1). Differentiated cells captured on days 4 and 6 were then used as a reference for annotating cells of differentiated fate from day 2.</p>
    </sec>
    <sec id="Sec19">
      <title>TACCO configuration</title>
      <p id="Par47">With the exception of the analyses mentioned below, TACCO was generally applied with an identical parameter set across all analyses in this manuscript: core annotation method OT (default TACCO setting), basic platform normalization (default TACCO setting for OT), entropy regularization parameter epsilon 0.005 (default TACCO setting for OT), marginal relaxation parameter lambda of 0.1 (default TACCO setting for OT), four iterations of boosting with a divisor of three (default TACCO setting for OT) and multi_center = 10 (10 representing means for each type to account for variability with an annotation category). Aside from parameter stability analyses, the exceptions are as follows: (1) for Fig. <xref rid="Fig4" ref-type="fig">4</xref>, in addition to running TACCO with the default parameter values as described above, TACCO was also applied without boosting, using only the maximum annotation per observation as categorical annotation, and all other parameters identical as an optimized categorical annotation method ‘TACCO (cat)’. (2) For Extended Data Fig. <xref rid="Fig8" ref-type="fig">4</xref>, TACCO was used with TACCO’s default settings only, that is, all parameters identical to above but not using the multi_center booster. (3) For the single-molecule annotation of the osmFISH data, default parameters were used again, but no platform normalization was used because the reference shares identical platform effects with the data to annotate. The additional parameters specific to single-molecule annotation were set to bin_size = 10, reflecting the expected size of features, that is cells, of about 10 µm, and n_shifts = 3, as a tradeoff between speed and reduction of artifacts.</p>
    </sec>
    <sec id="Sec20">
      <title>Baysor configuration</title>
      <p id="Par48">Running Baysor on the osmFISH example with the osmFISH-specific configurations available in the github repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor">https://github.com/kharchenkolab/Baysor</ext-link>) and adapting the Baysor code (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>) to accept cell-type means achieved only 25% match with osmFISH’s annotations. Therefore, we adapted code and used parameters from the segmentation-free annotation transfer described in the BaysorAnalysis repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/BaysorAnalysis/blob/master/notebooks/segmentation_free/segmentation_free_allen_smfish.md">https://github.com/kharchenkolab/BaysorAnalysis/blob/master/notebooks/segmentation_free/segmentation_free_allen_smfish.md</ext-link>) and increased Baysor performance to achieve 35% match with osmFISH original annotations. These parameters are mainly default parameters: we used the functions build_molecule_graph() with filter = false, append_confidence() with nn_id = 16, and cluster_molecules_on_mrf() with do_maximize = false, max_iters = 1,000, and n_iters_without_update = 20.</p>
      <p id="Par49">For the segmentation we followed the Baysor code (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>) and used the specialized values for the osmFISH data from the repository, where available, and default values from the repository otherwise. Specifically, we used scale-std = ‘25%’ and prior-segmentation-confidence = 0.2 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>, iters = 500 and num-cells-init = 30,000 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/examples/osm-FISH/README.md">https://github.com/kharchenkolab/Baysor/blob/master/examples/osm-FISH/README.md</ext-link>, scale = 70.0 and min-molecules-per-cell = 30 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/configs/osm_fish.toml">https://github.com/kharchenkolab/Baysor/blob/master/configs/osm_fish.toml</ext-link> and new-component-fraction = 0.3 and new-component-weight = 0.2 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/common.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/common.jl</ext-link>.</p>
    </sec>
    <sec id="Sec21">
      <title>SSAM configuration</title>
      <p id="Par50">For SSAM, we followed the SSAM user guide and used default parameters except for find_local_max() for which we supplied the parameters recommended in the user guide: search_size = 3, min_norm = 0.027, min_expression = 0.2.</p>
      <p id="Par51">To map the SSAM annotations of the generated Cartesian grid back to individual molecules and to compare them with the single-molecule annotations from TACCO and Baysor, we assigned to every molecule the annotation of the grid point closest to it.</p>
    </sec>
    <sec id="Sec22">
      <title>RCTD configuration</title>
      <p id="Par52">For RCTD, we adapted the default parameters to work in the framework of TACCO such that all clusters in the reference are used (CELL_MIN_INSTANCE = 0), all cells end up with an annotation (UMI_min = 0), RCTD does not throw an exception for lowly covered types in the reference (UMI_min_sigma = min(300,median<sub>observations</sub>(total_counts_per_observation)-1)), and every observation gets a compositional annotation over all available types (doublet_mode = ‘full’).</p>
    </sec>
    <sec id="Sec23">
      <title>NovoSpaRc configuration</title>
      <p id="Par53">For NovoSpaRc, we used alpha = 1.0 and adapted the default parameters to use all available genes.</p>
    </sec>
    <sec id="Sec24">
      <title>Configuration of other annotation methods</title>
      <p id="Par54">For all other annotation methods (SVM, SingleR, NMFreg, WOT, Tangram), we used default parameters.</p>
    </sec>
  </sec>
  <sec id="Sec25">
    <title>Methods</title>
    <sec id="Sec26">
      <title>Overview of TACCO framework</title>
      <p id="Par55">TACCO is based on three guiding principles: modularity, interpretability and efficiency. TACCOs compositional annotation algorithm is built from a single fast core method, which is then supplemented by a diverse set of wrappers and ‘boosters’, each providing additional functionality and features. The framework is completed by a set of downstream analysis tools, some of which are especially optimized for analysis involving compositional annotations. TACCO relies on Anndata and seamlessly integrates with the Scanpy<sup><xref ref-type="bibr" rid="CR46">46</xref></sup> ecosystem.</p>
    </sec>
    <sec id="Sec27">
      <title>Compositional annotation</title>
      <p id="Par56">TACCO aims to annotate single cells and cell-like objects, like Slide-seq beads or Visium spots, with compositional annotations. In cases with discrete ground truth (for example, a B cell versus a fibroblast), we interpret the compositional annotation as probabilities of belonging to a category. Both objects <italic>b</italic> and categories <italic>t</italic> are in a common high-dimensional data space, for example, expression space. Generally, objects that are close to a category in that space should have a high contribution of that category in the compositional annotation.</p>
      <p id="Par57">The goal of the annotation is to find a matrix <italic>ρ</italic><sub><italic>tb</italic></sub> which gives the distribution of annotation over objects <italic>b</italic> and categories <italic>t</italic>. Some applications imply certain natural choices for the ‘units’ of <italic>ρ</italic><sub><italic>tb</italic></sub>. For example, in the case of count data, the natural units are counts as well, such that <italic>ρ</italic><sub><italic>tb</italic></sub> gives the counts in object <italic>b</italic> which are attributed to category <italic>t</italic>. The marginal distribution over categories is just the total number of counts Σ<sub><italic>t</italic></sub>
<italic>ρ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>b</italic></sub> per object <italic>b</italic> and is known. The marginal distribution over objects Σ<sub><italic>b</italic></sub>
<italic>ρ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>t</italic></sub> is not known beforehand and is an output of the annotation process. As the marginals per object are known in general, it is equivalent to cite only the normalized distributions <italic>ρ</italic>′<sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>tb</italic></sub>/<italic>ρ</italic><sub><italic>b</italic></sub> with Σ<sub><italic>t</italic></sub>
<italic>ρ</italic>′<sub><italic>tb</italic></sub> = 1 as an annotation result.</p>
    </sec>
    <sec id="Sec28">
      <title>Core annotation method by OT</title>
      <p id="Par58">TACCO’s core method is entropically regularized, partially balanced OT (an intrinsically fast variant of OT). Balanced OT solves the optimization problem <italic>γ</italic><sub>tb</sub> = argmin<sub><italic>γtb</italic></sub> Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub>
<italic>M</italic><sub><italic>tb</italic></sub> under the positivity constraint <italic>γ</italic><sub><italic>tb</italic></sub> ≥ <italic>0</italic> and the marginal constraints Σ<sub><italic>t</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> = <italic>c</italic><sub><italic>b</italic></sub> and Σ<sub><italic>b</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> = <italic>c</italic><sub><italic>t</italic></sub> with the transport cost Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub>
<italic>M</italic><sub><italic>tb</italic></sub> = <italic>&lt;</italic> <italic>γ</italic>, <italic>M</italic> &gt; <sub>F</sub> given by the Frobenius inner product of a mapping matrix <italic>γ</italic><sub><italic>tb</italic></sub> and a constant matrix <italic>M</italic><sub><italic>tb</italic></sub>. <italic>M</italic><sub><italic>tb</italic></sub> encodes the cost of ‘transporting’ or mapping an object <italic>b</italic> to an annotation <italic>t</italic> and must be chosen sensibly to yield a ‘good’ mapping <italic>γ</italic><sub><italic>tb</italic></sub>. The annotation problem is solved if the marginals <italic>c</italic><sub><italic>b</italic></sub> and <italic>c</italic><sub><italic>t</italic></sub> and the cost <italic>M</italic><sub><italic>tb</italic></sub> can be tuned such that <italic>γ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>tb</italic></sub>.</p>
      <p id="Par59">The marginal over annotations is known from the data <italic>c</italic><sub><italic>b</italic></sub> = <italic>ρ</italic><sub><italic>b</italic></sub>, while <italic>c</italic><sub><italic>t</italic></sub> = <italic>ρ</italic><sub><italic>t</italic></sub> is not. This can be used to encode prior knowledge about the data, for example, from a reference distribution. To support the general case when such a reference distribution is not available, partially balanced OT is used: instead of fixing the type marginal exactly, a Kullback–Leibler divergence penalty is imposed scaled with a parameter <italic>λ</italic>. This can be used to tune the amount of trust put in the prior distribution.</p>
      <p id="Par60">Choosing a well-performing cost function is more ambiguous. The cost function uses the information in data space and assigns a dissimilarity to each object-category combination. A straightforward choice is the cosine distance, or, for expression count data, the cosine distance on normalized and log1p-transformed data. In our benchmarks, the cosine distance on transformed data led to better results (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>), but the transformation is rather specific for count data. Inspired by the overlap of states in quantum mechanics, a different measure, the Bhattacharyya coefficients, is generally used, with similar performance and without direct reference to counts. Bhattacharyya coefficients are a general measure of the overlap of probability distributions and are defined as BC(<italic>p</italic>,<italic>q</italic>) <italic>=</italic> Σ<sub><italic>g</italic></sub>√<italic>p</italic><sub><italic>g</italic></sub><italic>q</italic><sub><italic>g</italic></sub> for two probability distributions <italic>p</italic> and <italic>q</italic> in the data space. To allow the user to adapt the method according to the needs of their particular application, TACCO implements several other metrics, as well as making all scipy metrics available.</p>
      <p id="Par61">OT’s optimization problem is in general nonconvex and numerically expensive. However, using entropic regularization makes it strictly convex and efficiently solvable by using the Sinkhorn–Knopp matrix scaling algorithm<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. For entropic regularization, the tunable entropy regularization term <italic>εΩ</italic>(<italic>γ</italic><sub><italic>tb</italic></sub>) <italic>=</italic> <italic>ε</italic> Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> log(<italic>γ</italic><sub><italic>tb</italic></sub>) is added to the objective function. This term favors mappings that do not map a given object to a single annotation.</p>
    </sec>
    <sec id="Sec29">
      <title>Alternative annotation methods</title>
      <p id="Par62">The core, OT-based annotation method can be swapped by a number of other built-in methods, including nonnegative least squares or support vector machine (SVM) or by wrapped external methods from both Python and R, including NMFreg<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> or RCTD<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. Custom core methods can also be added using a functional interface. The wrapped external and custom functions may already include ‘booster’ functionality (below). For example, RCTD already contains platform normalization. Many of the simple built-in methods are amenable to hand optimization, for example, by supporting data sparsity consistently, which makes them even faster. All the built-in methods are generally optimized for standard x86 hardware, but wrapped external methods may use GPU acceleration (for example, Tangram<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>).</p>
    </sec>
    <sec id="Sec30">
      <title>Overview of boosters</title>
      <p id="Par63">Boosters can improve the performance of the core method or provide support for ‘missing features’ for example, for platform normalization, for using subtype variability to enhance the type representation in single-cell data, for creating a deconvolution method from a categorical annotation method and the other way round (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>). They can be combined flexibly to adapt to special requirements for specific applications. The modularity introduced by boosters makes it straightforward to ‘unbox’ TACCO and understand what each part does. While most boosters do have some overhead in runtime, in the end, they all do the heavy lifting by calling the fast core method one or several times and transforming its inputs and/or outputs.</p>
    </sec>
    <sec id="Sec31">
      <title>Platform normalization</title>
      <p id="Par64">Dramatic differences in datasets can arise solely from differences in the experimental technique that impact the profiled cellular compartments (for example, single cell versus single nucleus), cellular compositions (due to differential capture of cells of different types) or gene biases. Annotation of data from one platform using a reference of another platform is much more difficult without accounting for these platform-dependent biases<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. This booster can be safely disabled if no platform effects are expected.</p>
      <p id="Par65">A platform normalization step mitigates platform-specific effects by rescaling data from one platform to make it comparable to data from a different platform, separately in each dimension <italic>g</italic> of the data space, for example, separately per gene. The necessary rescaling factors are estimated from data. A related but simpler approach compared to that given in ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup> is pursued, making less assumptions and therefore usable across a broader range of applications.</p>
      <p id="Par66">The representations of the categories <italic>t</italic> as sets of vectors in data space <inline-formula id="IEq9"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\pi ^A_{gt}\,{{{\mathrm{and}}}}\,\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M24"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">and</mml:mi><mml:mspace width="0.25em"/><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq9.gif"/></alternatives></inline-formula> on the two platforms <italic>A</italic> and <italic>B</italic> are linked to each other via the platform normalization factors <inline-formula id="IEq10"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g\,{{{\mathrm{as}}}}\,\pi ^A_{gt} = f^{AB}_g\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M26"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">as</mml:mi><mml:mspace width="0.25em"/><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq10.gif"/></alternatives></inline-formula>. If the category representations <inline-formula id="IEq11"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M28"><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq11.gif"/></alternatives></inline-formula> for platform <italic>B</italic> and the (pseudo-bulk) category marginals <inline-formula id="IEq12"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_t$$\end{document}</tex-math><mml:math id="M30"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq12.gif"/></alternatives></inline-formula> for platform <italic>A</italic> are known, the data space marginals <inline-formula id="IEq13"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_g$$\end{document}</tex-math><mml:math id="M32"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq13.gif"/></alternatives></inline-formula> can be written as <inline-formula id="IEq14"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rho^A_{g}} = {\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^A_{gt}\rho ^A_t}} = {f^{AB}_g}{\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^B_{gt}\rho ^A_t}}$$\end{document}</tex-math><mml:math id="M34"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq14.gif"/></alternatives></inline-formula>, and therefore <inline-formula id="IEq15"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g = \rho ^A_g/\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^B_{gt}\rho ^A_t}$$\end{document}</tex-math><mml:math id="M36"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>/</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq15.gif"/></alternatives></inline-formula>. The category marginals <inline-formula id="IEq16"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_t$$\end{document}</tex-math><mml:math id="M38"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq16.gif"/></alternatives></inline-formula> are themselves usually a result of the annotation procedure and used here as input to a preprocessing step for the procedure. However, an iterative scheme can also be used. Starting with the assumption that the annotation marginals are identical to the reference (which is reasonable for example, if matched spatial and single-cell data are available), most of the gene-wise platform effect can be already captured. Next, platform normalization is rerun after a first round of cell typing using improved type fractions, and the process is iterated until the normalization factors are stable. In practice, this procedure converges very rapidly with the initial step being by far the most relevant one.</p>
      <p id="Par67">After determining the gene-wise platform normalization factors <inline-formula id="IEq17"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g$$\end{document}</tex-math><mml:math id="M40"><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq17.gif"/></alternatives></inline-formula>, they are used to rescale the data space in either the reference or the test data or equivalently to work in the units of the test or the reference data. As the probabilities and the resulting annotation distribution are given in terms of these units, choosing test data units or reference data units can lead to quite different results. Which option should be preferred depends on the use case and downstream analyses. Here, test data units are chosen to retain integer count data for object splitting.</p>
    </sec>
    <sec id="Sec32">
      <title>Multicenter</title>
      <p id="Par68">In many cases, there are multiple observations per annotation category in the reference dataset, as is the case in single-cell data. To integrate the variability of these observations while maintaining speed, the observations per category are subclustered with <italic>k</italic>-means clustering to get multiple mean profiles per category. The annotation function is then called with this subannotation, and its result is summed over the subannotations to give an annotation in terms of the original categories. When the reference is already finely annotated, no improvement is expected from this booster, which could then lead to worse performance, because less data are available per subannotation to average noise and the reference gets overfitted.</p>
    </sec>
    <sec id="Sec33">
      <title>Bisectioning</title>
      <p id="Par69">Some annotation methods can be biased toward low-entropy annotations such that they may overweigh dominant categories in mixtures (the extreme case is a categorical classifier). Such methods can be adapted to compositional annotation by running the annotation method iteratively. In each iteration, the annotation is not used as the final result, but instead, a certain fraction of it is used to subtract a reconstructed approximation of the data from the original data. The residual is again subjected to the annotation method, while a fraction of the annotation result is added to the final annotation result. This procedure is very similar to gradient boosting. Bisectioning is useful when the objects are additive mixtures of the annotations in the data space. If the data consist (mainly) of objects which are best described by a single annotation, this booster can decrease performance, for example, by resolving the ambient contribution in single-cell data.</p>
    </sec>
    <sec id="Sec34">
      <title>Choosing parameters</title>
      <p id="Par70">While a single configuration of TACCO generally gives decent performance for a wide variety of use cases (Extended Data Fig. <xref rid="Fig12" ref-type="fig">8</xref>), it can be tuned to perform particularly well for certain use cases. Relevant parameters for the tuning include the following components.</p>
      <sec id="Sec35">
        <title>Boosting/bisectioning</title>
        <p id="Par71">TACCO’s default depends on the core annotation method. As OT itself lacks support for additive compositional annotations, TACCO activates this booster for OT by default. Higher values for the number of bisections and the bisection divisor generally lead to more precise compositional annotations but at the cost of increased runtime, which scales roughly linearly with the sum iterations+divisor. A divisor smaller than 3 can lead to sizable artifacts, and so a divisor equal to or greater than 3 is recommended.</p>
      </sec>
      <sec id="Sec36">
        <title>Multicenter</title>
        <p id="Par72">By default, TACCO does not use the multicenter booster (setting a number of representing means for each annotation category), as it is useful only in cases where the annotation categories have a large within-category variation. However, as many reference datasets come with coarse annotation categories, the multicenter booster is activated for most analyses in this study. This booster is not recommended if the categories already cover the full biologically significant heterogeneity in the data or if the dataset has only a single representing observation per category. A value of 5 or 10 is recommended in other cases (as this generally captures the heterogeneity in many datasets). Larger values are generally not recommended as they lead to an increase in runtime and have the potential for overfitting, by using irrelevant variability in the data for the annotation process.</p>
      </sec>
      <sec id="Sec37">
        <title>Platform_iterations</title>
        <p id="Par73">TACCO’s default depends on the core annotation method. As OT itself does not have built-in platform normalization and most pairs of reference and target data have nontrivial platform effects, basic platform normalization is the default for OT. It is generally recommended not to disable platform normalization, except for specific cases, for example, if part of the dataset of a single batch was manually annotated and the annotation should be transferred to the rest of the data.</p>
      </sec>
      <sec id="Sec38">
        <title>Max_annotation</title>
        <p id="Par74">TACCO’s default is a compositional annotation with nonzero values simultaneously possible for all annotation categories per observation. Max_annotation can be used to set the number of nonzero values per observation. For categorical annotation, one might want to restrict this to a single nonzero value per observation, corresponding to setting max_annotation to 1, while for data with very few contributing cells per observation (for example, Slide-seq or scRNA-Seq data with doublets) a suitable value could be 2 or 3.</p>
      </sec>
      <sec id="Sec39">
        <title>Marginal relaxation parameter lambda (OT-specific)</title>
        <p id="Par75">TACCO’s default value is chosen as a compromise between using prior information from the reference pseudobulk annotation composition (for example, cell-type proportions) and annotating in a fully data-driven manner. While larger values (larger cost of having a pseudobulk annotation composition different from the reference) can stabilize the annotation in cases of low correspondence between reference and target data, smaller values can give more precise pseudobulk annotation compositions if the two datasets are highly corresponding and do not exhibit batch effects that are not accounted for by platform normalization.</p>
      </sec>
      <sec id="Sec40">
        <title>Entropy regularization parameter epsilon (OT-specific)</title>
        <p id="Par76">TACCO’s default is chosen such that the regularization’s effect on the results is minimized: it biases the results toward high entropy configurations, that is, every observation (for example, spatial observation) is assigned a compositional annotation with large contributions from different categories (for example, cell types). This parameter must be nonzero, as the efficient regularized OT solver breaks down at zero epsilon (and numerically already at epsilon much smaller than 0.005). Except for specific settings (that is, prior information external to the dataset itself) in which it is beneficial to bias the result toward significant contributions of many annotation categories in the result, this parameter should only be changed in rare cases of numerical instability—which we did not observe with TACCO’s default.</p>
      </sec>
    </sec>
    <sec id="Sec41">
      <title>Object splitting</title>
      <p id="Par77">The annotation method generates an assignment of a composition of annotation categories for every observation. Generally, each observation is associated with more than one category with nonzero contribution. When the categories are cell types, this can be problematic for downstream applications that require the expression profiles of single cells as input, that is, pure profiles that can be attributed to a single cell. For example, as cell-type-related expression constitutes a strong signal, analysis of expression programs is easier across cells of shared type. Thus, it is desirable to derive several ‘virtual’ observations for every real observation, which correspond to the pure contribution of each annotation category.</p>
      <p id="Par78">A similar idea was proposed in ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, where the expected contribution of each cell type to the expression of one Slide-seq bead is approximated. In that approach, cell-type fractions that were reconstructed for every bead are taken as input in a Bayesian analysis, along with type-specific expression profiles and the bead-count matrix to yield expected reads per gene, bead and cell type. The result, however, lacks consistency with the annotation and the measured count matrix in the sense that the marginal over genes is not recovered. Here, we follow a similar strategy, but we directly integrate marginals as constraints of a matrix equivalence scaling problem in a data-driven frequentist approach.</p>
      <p id="Par79">In this approach, data generation is modeled as drawing single molecules labeled with gene <italic>g</italic>, cell type <italic>t</italic> and observation/bead <italic>b</italic> from the sample, which constitutes the central object—the joint probability <italic>p</italic>(<italic>gtb</italic>) for a given molecule to be of gene <italic>g</italic>, cell type <italic>t</italic> and bead <italic>b</italic>. In the actual experiment, only <italic>g</italic> and <italic>b</italic> are measured, yielding <italic>p</italic>(<italic>gb</italic>) <italic>=</italic> Σ<sub>t</sub>
<italic>p</italic>(<italic>gtb</italic>), the ‘t-marginal’. From the reference data, the reference profiles <italic>p</italic>(<italic>g</italic>|<italic>t</italic>) <italic>=</italic> Σ<sub><italic>b</italic></sub>
<italic>p</italic>(<italic>gtb</italic>)/<italic>p</italic>(<italic>t</italic>) are available, and from the annotation process the annotation result <italic>p</italic>(<italic>tb</italic>) = Σ<sub><italic>g</italic></sub>
<italic>p</italic>(<italic>gtb</italic>), the ‘g-marginal’ is obtained. Further, <italic>p</italic>(<italic>gtb</italic>) is modeled with a Bayesian-inspired product ansatz: <italic>p</italic>(<italic>gtb</italic>) = <italic>p</italic>(<italic>gt</italic>) <italic>n</italic>(<italic>gb</italic>) <italic>n</italic>(<italic>tb</italic>), with free parameters <italic>n</italic>(<italic>gb</italic>) and <italic>n</italic>(<italic>tb</italic>). These are fixed by enforcing the <italic>t</italic>- and <italic>g</italic>-marginals. The ansatz can be interpreted as adjusting the cell-type profiles and pseudobulk annotation with object-wise scaling factors per data dimension <italic>g</italic> and annotation category <italic>t</italic> such that the measurement and the annotations are reproduced exactly. To determine the parameters from the marginals, we have to solve a separate matrix equivalence scaling problem per object <italic>b</italic>.</p>
      <p id="Par80">Matrix equivalence scaling problems are guaranteed to have a solution if the matrix to be scaled, that is <italic>p</italic>(<italic>gt</italic>), has only positive entries. Therefore, a small positive number is added to all the elements of <italic>p</italic>(gt) to make the problem well defined. These problems can be solved by iterative normalization of the columns and rows of <italic>p</italic>(<italic>gt</italic>). This simple algorithm is known under many names, for example, the RAS algorithm<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> or for doubly stochastic matrices as the Sinkhorn–Knopp algorithm<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>, and it is also the algorithm used to solve OT efficiently<sup><xref ref-type="bibr" rid="CR49">49</xref></sup>. In contrast to OT, where there is a single matrix scaling problem, here a separate problem is solved for every object. Although this initially seems like a practical performance problem, these problems can be solved in parallel and use the same data, leading to speedups by reducing memory accesses. Moreover, we use the sparsity of the count frequency matrix <italic>p</italic>(bg) to implement the RAS algorithm very efficiently for the problem at hand.</p>
      <p id="Par81">By rescaling the resulting <italic>p</italic>(<italic>gtb</italic>) with the total weight per object (for example, total counts per cell for sequencing data), a consistent annotation-resolved split of the measurement is obtained, consisting of floating-point numbers. For expression count data, this split generally includes many values much smaller than 1. To optimize sparsity and obtain integer counts, an option is available to round this result by flooring and redistributing the remaining reads (via multinomial sampling from the remainders). The resulting split count matrix retains biological signal and can be used in standard downstream analyses (Extended Data Fig. <xref rid="Fig6" ref-type="fig">2</xref>).</p>
    </sec>
    <sec id="Sec42">
      <title>Single-molecule annotation</title>
      <p id="Par82">To annotate single molecules by cell-type assignment, TACCO first bins the single-molecule data in space to generate aggregate cell-like objects. TACCO then annotates them either using internal or wrapped external methods. Subsequently, TACCO maps the resulting compositional annotation back to the single molecules, as follows. First, object splitting is used to distribute molecules to annotations, resulting in a probability for every molecule species in the bin to have a certain annotation. This annotation is then distributed randomly among the molecules of that molecular species such that each molecule has only a single annotation and the population of molecules reproduce the annotation probability. Because spatial binning can introduce arbitrary boundary artifacts in the definition of local neighborhoods for molecules, TACCO repeats the binning and annotation for <italic>N</italic> (usually 2–3) spatial shifts of the Cartesian grid in steps of 1/<italic>N</italic> of the grid spacing per spatial dimension. For <italic>d</italic> spatial dimensions, this results in <italic>N</italic><sup><italic>d</italic></sup> annotations per molecule. The final annotation of each molecule is then determined by a majority vote. This simple single-molecule annotation is only feasible with fast annotation methods, which can be run multiple times on differently binned data in a reasonable amount of time.</p>
      <p id="Par83">In addition to the parameters for compositional annotation, the single-molecule annotation introduces extra parameters. We evaluated the annotation’s sensitivity to parameter value changes with respect to the baseline single-molecule TACCO configuration (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6b</xref>). Sizable changes in most parameters conserved about 80% of the single-molecule annotations relative to the baseline and were consistent with the reference annotation of the osmFISH-recovered cells at about 0.6, with one notable exception as follows: increasing OT’s entropic regularization parameter epsilon leads to significant reductions in accuracy and stability as it drives the annotation to be homogeneous regardless of the data. As for compositional annotation, we therefore recommend keeping the small default value which is just large enough to make OT numerically stable in practice.</p>
    </sec>
    <sec id="Sec43">
      <title>Image-free segmentation</title>
      <p id="Par84">An image-free, density-based cell segmentation approach uses the per-molecule annotation to determine molecule assignments at critical cross-category boundaries. We assume that the exact assignment of boundaries within a category is not very important as long as it gives rise to a reasonable size of the segmented objects. The segmentation is implemented as graph-based hierarchical spectral clustering.</p>
      <p id="Par85">As the number of single molecules can easily be of the order of 10<sup>9</sup>, an efficient Euclidean sparse distance matrix computation is required. As scipy’s sparse distance matrix calculation is serial and too slow for this application, a custom, fast, parallel and still generally applicable algorithm was developed and implemented. After calculating the distances <inline-formula id="IEq18"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{spatial}}}$$\end{document}</tex-math><mml:math id="M42"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">spatial</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq18.gif"/></alternatives></inline-formula> between molecules <italic>i</italic> and <italic>j</italic> in position space, a distance contribution is added in quadrature which is derived from the single-molecule annotation <inline-formula id="IEq19"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{annotation}}}$$\end{document}</tex-math><mml:math id="M44"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">annotation</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq19.gif"/></alternatives></inline-formula> to get a combined distance: <inline-formula id="IEq20"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{total}}} = \surd \left( {d_{ij}^{{\mathrm{spatial}}}} \right)^2 + \left( {d_{ij}^{{\mathrm{annotation}}}} \right)^2$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">total</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>√</mml:mi><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">spatial</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">annotation</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq20.gif"/></alternatives></inline-formula>. The annotation contribution can be either zero within an annotation and infinity between annotations, automatically derived using distances between the expression profiles of the annotations or manually specified. As the clustering works on affinities and not on distances, the distances have to be transformed into affinities, which is done by a Gaussian kernel with a subcellular distance scale.</p>
      <p id="Par86">As the number of molecules is so large, the clustering algorithm has to be fast and scalable, work entirely on sparse matrices and cut the neighborship graph at sensible places to generate reasonable cells-like objects. For this, a hierarchical clustering scheme was developed based on the spectral clustering implementation of scikit-learn as follows: it can handle sparse matrices, can use algebraic multigrid solvers for speed and, for only two clusters, solve the normalized graph cut problem<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. The best cuts are found iteratively in top-down fashion (binary splitting the data at each iteration). To keep the dataset tractable for the initial cuts, the spatial structure of the data is used to generate supernodes in the graph before clustering. When the clustering comes down into the size regime of a few single cells, several heuristics are employed to determine whether to accept a proposed cut based on the shape and size of the clusters, and on comparing the affinity loss of the proposed cut to the expected cost for cutting a homogeneous bulk graph of corresponding size and dimension. The final result is another column of annotation for the molecules containing unique object ids.</p>
      <p id="Par87">For visualization, these objects are filtered to include at least 20 molecules, and the associated expression profiles are normalized as in ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup> and embedded by a tSNE. To evaluate the self-consistency of annotation and segmentation, the silhouette score of the cell-type annotations is evaluated on identically filtered and normalized profiles using the silhouette_score function from scikit-learn.</p>
    </sec>
    <sec id="Sec44">
      <title>Region definition</title>
      <p id="Par88">For spatially convoluted expression data, such as in spatial transcriptomics methods including Slide-seq and Visium, clustering (of beads or spots) in expression space is less meaningful as individual cells are mixed. ‘Regions’ which are defined both in position and expression or annotation space can be a meaningful alternative. TACCO implements a method to define such regions (Extended Data Fig. <xref rid="Fig7" ref-type="fig">3a</xref>), consisting of the following two steps: (1) construction of one <italic>k</italic>-nearest neighbors graph based on expression (or annotation) distances and another <italic>k</italic>-nearest neighbors graph based on physical distances; and (2) combination of the two graphs as a weighted sum of the graphs’ adjacencies. Putting more weight on the position space adjacency gives contiguous regions in position space, while more weight on the expression adjacency leads to separated islands of similar expression being annotated with the same region and can connect regions across different spatial samples (for example, Slide-seq pucks). To account for the missing links from the position graph between samples, the cross-sample adjacency is scaled up by a balancing weight factor. The combined adjacency matrix is then subjected to standard Leiden clustering<sup><xref ref-type="bibr" rid="CR51">51</xref></sup> which assigns consistent region annotation across samples.</p>
    </sec>
    <sec id="Sec45">
      <title>Colocalization and neighborhood analysis</title>
      <p id="Par89">To score colocalization or co-occurrence of annotations<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>, TACCO calculates <italic>p</italic>(anno|center;<italic>x</italic>)/<italic>p</italic>(anno), the probability to find an annotation ‘anno’ at a distance <italic>x</italic> from a center annotation ‘center’ normalized by the probability to find ‘anno’ regardless of a ‘center’. This is well defined also for noncategorical annotations, which are commonplace for the compositional annotations created with TACCO and for pairs of unrelated annotations.</p>
      <p id="Par90">As the most time-consuming computations for co-occurrence are the same as for neighborhood-enrichment analyses, TACCO also calculates neighborhood-enrichment <italic>z</italic>-scores<sup><xref ref-type="bibr" rid="CR52">52</xref></sup> for a set of distance bins (as opposed to the set of direct neighbors on a graph) and again supports noncategorical annotation, pairs of unrelated annotations for ‘anno’ and ‘center’, and multiple samples while being competitive performance-wise (Extended Data Fig. <xref rid="Fig13" ref-type="fig">9</xref>).</p>
    </sec>
    <sec id="Sec46">
      <title>Annotation coordinates</title>
      <p id="Par91">To analyze a given annotation (for example, cell-type composition) with respect to its spatial distance from a reference annotation (for example, histological annotation; Extended Data Fig. <xref rid="Fig7" ref-type="fig">3b,c</xref>), TACCO implements an algorithm that determines a stable ‘annotation coordinate’ in position space by regularizing the minimum distance by a critical neighborhood size determined at the weights level and afterward correcting for the regularization bias. (This is required because for noisy spatial data and/or noncategorical reference annotations, simply taking the minimal distance between objects of certain annotations is unstable and/or not well defined.)</p>
      <p id="Par92">Specifically, TACCO first generates a matrix <italic>n</italic><sub><italic>A,x</italic></sub>(<italic>d</italic>) of occurrence histograms versus spatial distance <italic>d</italic> for every annotation category <italic>A</italic> and spatial position <italic>x</italic>, counting fractional annotations as fractional occurrence counts. The distance <inline-formula id="IEq21"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M48"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq21.gif"/></alternatives></inline-formula> where its cumulative sum over distance <inline-formula id="IEq22"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N_{A,x}\left( d \right) = \mathop {\sum}\nolimits_{{{{\mathrm{d}}}}^{\prime} = 0}^{{{\mathrm{d}}}} {n_{A,x}\left( {d^{\prime} } \right)}$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="normal">d</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">d</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq22.gif"/></alternatives></inline-formula> will be over a certain threshold <italic>N</italic><sub><italic>l</italic></sub> is a robust measure for the radius of the sphere centered at <italic>x</italic> and containing a total of <italic>N</italic><sub><italic>l</italic></sub> occurrences of annotation <italic>A</italic>. Even for data homogeneously annotated with <italic>A</italic>, the minimal possible value of <inline-formula id="IEq23"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M52"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq23.gif"/></alternatives></inline-formula> is however larger than 0 as the threshold <italic>N</italic><sub><italic>l</italic></sub> will in general be larger than <italic>l</italic> to have a stabilizing effect. To allow for a minimum value of 0 and obtain a measure for the distance from <italic>x</italic> to a significant amount of category <italic>A</italic>, <inline-formula id="IEq24"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M54"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq24.gif"/></alternatives></inline-formula> is corrected using a fictitious homogeneous annotation category <italic>H</italic> and the value of <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq25"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M56"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq25.gif"/></alternatives></inline-formula>) is found, followed by solving for the distance <inline-formula id="IEq26"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M58"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq26.gif"/></alternatives></inline-formula> at which <italic>N</italic><sub><italic>l</italic></sub> less occurrences appeared: <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq27"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M60"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq27.gif"/></alternatives></inline-formula>) = <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq28"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M62"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq28.gif"/></alternatives></inline-formula>) – <italic>N</italic><sub><italic>l</italic></sub>. <inline-formula id="IEq29"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M64"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq29.gif"/></alternatives></inline-formula> is now consistent with the regular minimum distance for noise-free categorical annotations, stable against noise and well defined for compositional annotations.</p>
    </sec>
    <sec id="Sec47">
      <title>Enrichments</title>
      <p id="Par93">TACCO supports various approaches to visualize compositional differences in the spatial structure of a sample and estimate the statistical significance of these differences/enrichments (Extended Data Fig. <xref rid="Fig7" ref-type="fig">3d–g</xref>). In particular, TACCO uses sample information to calculate enrichments not across observations (single cells/spatial beads, which are no independent observations and can lead to <italic>P</italic> value inflation), but across multiple samples, which gives meaningful and reasonable <italic>P</italic> values.</p>
      <p id="Par94">When there is just a single (or few) spatial sample(s) but with considerable size, different parts of that sample are treated as semi-independent biological replicates, by splitting the sample along a selection of coordinate axes to create a statistical ensemble for enrichment analysis. Increasing the number of splits to parts that cannot be regarded as independent replicates interpolates smoothly to where every observation is considered independent.</p>
    </sec>
    <sec id="Sec48">
      <title>Reporting summary</title>
      <p id="Par95">Further information on research design is available in the <xref rid="MOESM1" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec id="Sec49" sec-type="materials|methods">
    <title>Online content</title>
    <p id="Par96">Any methods, additional references, Nature Portfolio reporting summaries, source data, extended data, supplementary information, acknowledgements, peer review information; details of author contributions and competing interests; and statements of data and code availability are available at 10.1038/s41587-023-01657-3.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <sec id="Sec51">
      <title>Supplementary information</title>
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41587_2023_1657_MOESM1_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <app-group>
    <app id="App1">
      <sec id="Sec50">
        <title>Extended data</title>
        <p id="Par101">
          <fig id="Fig5">
            <label>Extended Data Fig. 1</label>
            <caption>
              <title>Effect of choice of cost matrix metric in OT and several booster options (platform normalization, multicenter, bisection) on annotation quality.</title>
              <p>L2 error (y axis, top; relevant for mixture annotations) and fraction of objects where the maximum annotation disagrees with the reference (y axis, bottom; relevant for classification problems) for different methods (colors) on different use cases (x axis). Baseline TACCO used the Bhattacharyya metric, platform normalization, multicenter, and bisection. Single cell: annotation of mouse colon scRNA-seq with itself as reference; Mixture: Gaussian mixtures of mouse colon scRNA-seq (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>); Dropout: simulated Dropout dataset (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>); Ambient: simulated ambient dataset (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>), Differentiation: hematopoiesis scRNA-seq (Fig. <xref rid="Fig3" ref-type="fig">3c</xref>).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig5_ESM" id="d32e3633"/>
          </fig>
        </p>
        <p id="Par102">
          <fig id="Fig6">
            <label>Extended Data Fig. 2</label>
            <caption>
              <title>TACCO splitting of mixed expression profiles into pure constituents.</title>
              <p>UMAP embeddings of in-silico mixed mouse colon scRNA-seq profiles (top four rows: real or balanced type composition and with and without downscaling the count-yield per cell by a factor of 10) or Slide-seq beads (bottom row), based on ground truth (far left, where available), TACCO annotation (second left), reference data (second right) and mixed expression data split using TACCO’s annotation as input embedded in a joint UMAP of the concatenated reference-split dataset (rightmost). The in silico mix uses a beadsize of 1.0. For the joint embedding data was filtered to include only observations with at least 30 counts in genes which were annotated highly variable in the reference dataset, except for capture_rate = 1.0 where a threshold of 100 is used.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig6_ESM" id="d32e3647"/>
          </fig>
        </p>
        <p id="Par103">
          <fig id="Fig7">
            <label>Extended Data Fig. 3</label>
            <caption>
              <title>Example workflow and visualizations for spatial data analysis in TACCO for the mouse colon dataset from the ‘Spatial mixture’ task (Fig. <xref rid="Fig2" ref-type="fig">2b</xref>).</title>
              <p>(<bold>a</bold>) Slide-seq puck with beads colored by regions defined by joint expression space and position space clustering. (<bold>b</bold>) Fraction of cells (y axis) of each type (color) in each region (x axis). (<bold>c</bold>) Slide-seq puck colored by the effective distance of each bead from each region. (<bold>d</bold>) Density (y axis) of cell type annotations at different effective distance from region 2 (x axis). (<bold>e</bold>) Slide-seq puck colored by spatial split of the puck along a selected coordinate axis into multiple biological replicates for statistical enrichment analysis. (<bold>f</bold>) Geometric mean normalized cell type fractions (y axis) for each cell type (x axis) from each region (1–4) and subregion (per spatial split as in e; individual bars). (<bold>g</bold>) Enrichment p-values (colors) of the normalized cell fractions in (f) (Benjamini-Hochberg-corrected one-sided Mann-Whitney-U test across spatial splits).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig7_ESM" id="d32e3686"/>
          </fig>
        </p>
        <p id="Par104">
          <fig id="Fig8">
            <label>Extended Data Fig. 4</label>
            <caption>
              <title>Annotating mouse olfactory bulb Slide-seq data<sup><xref ref-type="bibr" rid="CR31">31</xref></sup> using an scRNA-seq data<sup><xref ref-type="bibr" rid="CR32">32</xref></sup> with TACCO.</title>
              <p>(a) Compositional cell type annotation. Annotations (color legend) from a single TACCO run on 40 Slide-seq pucks across 2 replicates (replicate 1 in 1st and 3rd columns, replicate 2 in 2nd and 4th columns); (<bold>b</bold>) Comparison of different annotation strategies. Compositional cell type annotation (first row, color legend) and normalized cell type weights (remaining rows, color bar) from either direct compositional annotation of the spatial data (left column; default TACCO workflow, as in (a)); compositional single cell annotation of the spatial data, and deriving the cell type annotation from the single cell cell-type annotation (middle column); or positional annotation of the single cells in the reference with plotting the categorical cell type annotation at the positions of the beads with the maximum weight per cell (right column).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig8_ESM" id="d32e3711"/>
          </fig>
        </p>
        <p id="Par105">
          <fig id="Fig9">
            <label>Extended Data Fig. 5</label>
            <caption>
              <title>Comparisons of single-molecule annotations for osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>.</title>
              <p><bold>(a)</bold> tSNE of the expression profiles for objects (dots) resulting from different combinations of annotation (TACCO, Baysor<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>) and segmentation (TACCO, Baysor) methods (columns), colored by the aggregated single-molecule annotation from TACCO, Baysor, and SSAM (rows); <bold>(b)</bold> Distribution of annotations from the reference, Baysor and SSAM over the TACCO single molecule annotations; <bold>(c,d)</bold> Distributions of TACCO’s single-molecule annotations with respect to Baysor (c) and SSAM (d) single-molecule annotations.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig9_ESM" id="d32e3745"/>
          </fig>
        </p>
        <p id="Par106">
          <fig id="Fig10">
            <label>Extended Data Fig. 6</label>
            <caption>
              <title>Analysis of single-molecule annotations for osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>.</title>
              <p><bold>(a)</bold> SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup> pixel-based annotation mapped to single molecules (presented like TACCO’s and Baysor’s<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> single-molecule annotations in Fig. <xref rid="Fig2" ref-type="fig">2c</xref> (2,3)): Entire section profiled by osmFISH (left) and zoom-in on a small region (right) with the positions and mapped cell-type annotation of each measured molecule. <bold>(b)</bold> Impact of different choices (x axis) for different parameter categories (color) on TACCO’s single molecule annotation, based on consistency with annotation from osmFISH-recovered cells (y axis, top) or with the base configuration of the annotation, which is used in all other single molecule analyses with TACCO (y axis, bottom). <bold>(c)</bold> Comparison of cell type composition analysis (p(annotations|center = hippocampus), y axis) at different distances from the hippocampus region annotation (x axis) for each cell type annotation (color) from different methods (label top), all using a single cell type per segmented object; unlike in Fig. <xref rid="Fig2" ref-type="fig">2e</xref>), the hippocampus region annotation from osmFISH-recovered cells is used for all panels, as Baysor did not recover any hippocampus annotation.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig10_ESM" id="d32e3786"/>
          </fig>
        </p>
        <p id="Par107">
          <fig id="Fig11">
            <label>Extended Data Fig. 7</label>
            <caption>
              <title>Comparison of methods performance on the differentiation task.</title>
              <p>scRNA-seq profiles (dots) from a hematopoiesis dataset<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> colored by the eventual clonal fate of day 2 cells (leftmost) and by the predicted clonal fates of day 2 cells, for each method from Fig. <xref rid="Fig3" ref-type="fig">3c</xref> (4)). Reference profiles from differentiated cells (day 4 and 6) are in gray.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig11_ESM" id="d32e3807"/>
          </fig>
        </p>
        <p id="Par108">
          <fig id="Fig12">
            <label>Extended Data Fig. 8</label>
            <caption>
              <title>Impact of parameter variations on TACCO’s runtime, memory requirement and accuracy of annotation transfer.</title>
              <p>Runtime (y axis, top), memory requirement (y axis, middle) and L2 error (y axis, bottom) of each parameter choice (colors) in the ‘Mixture’ (left; with beadsize = 1.0), ‘Dropout’ (middle; with dropmidpoint = −1.00) and ‘Differentiation’ (right) use cases, at different numbers of observations (cells or beads, x axis), ranging from <inline-formula id="IEq30"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{10} \approx 1k$$\end{document}</tex-math><mml:math id="M66"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mi>k</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq30.gif"/></alternatives></inline-formula> to <inline-formula id="IEq31"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{20} \approx 1M$$\end{document}</tex-math><mml:math id="M68"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>20</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mi>M</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq31.gif"/></alternatives></inline-formula>, which are up/down sampled from the datasets in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. Reference size is fixed at <inline-formula id="IEq32"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{14} \approx 16k$$\end{document}</tex-math><mml:math id="M70"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>14</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>16</mml:mn><mml:mi>k</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq32.gif"/></alternatives></inline-formula>. The maximum compute resources per run are 8 CPU cores for 8 hours with 8 GB memory each.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig12_ESM" id="d32e3890"/>
          </fig>
        </p>
        <p id="Par109">
          <fig id="Fig13">
            <label>Extended Data Fig. 9</label>
            <caption>
              <title>Runtime comparison of TACCO and Squidpy<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>.</title>
              <p>Run time (y axis) co-occurrence (a) and neighborhood enrichment (b) analyses for TACCO (blue) and Squidpy (orange). Datasets ‘imc’ and ‘seqfish’ are example datasets provided with Squidpy.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig13_ESM" id="d32e3908"/>
          </fig>
        </p>
      </sec>
    </app>
  </app-group>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
    <fn>
      <p>These authors contributed equally: Simon Mages, Noa Moriel and Inbal Avraham-Davidi.</p>
    </fn>
  </fn-group>
  <sec>
    <sec id="FPar1">
      <title>Extended data</title>
      <p id="Par97">is available for this paper at 10.1038/s41587-023-01657-3.</p>
    </sec>
    <sec id="FPar2" sec-type="supplementary-material">
      <title>Supplementary information</title>
      <p id="Par98">The online version contains supplementary material available at 10.1038/s41587-023-01657-3.</p>
    </sec>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank L. Gaffney for help with figure preparation. S.M. was supported by a DFG research fellowship (MA 9108/1-1), N.M. was supported by the Israeli Council for Higher Education PhD fellowship, J.K. was supported by a HFSP long-term fellowship (LT000452/2019-L), A.R. was a Howard Hughes Medical Institute (HHMI) Investigator when conducting this work. The work was supported by the Klarman Cell Observatory, a CEGS grant (5RM1HG006193-09) from the NHGRI, the NIH/NIAID (grants 1U24 CA180922, 1U19 MH114821, 1RC2 DK114784), the MIT Ludwig Center, the Manton Family Foundation, and HHMI (A.R.); Azrieli Foundation Early Career Faculty Fellowship, Google Research Scholar program, an Israel Science Foundation research grant (1079/21), the European Union (ERC, DecodeSC, 101040660) (M.N.) and the Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem (N.M. and M.N.). Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or the European Research Council. Neither the European Union nor the granting authority can be held responsible for them. This publication is part of the Human Cell Atlas (<ext-link ext-link-type="uri" xlink:href="http://www.humancellatlas.org/publications/">www.humancellatlas.org/publications/</ext-link>).</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>N.M., I.A.-D., M.N. and A.R. conceived the study; S.M., N.M., J.K. and M.N. developed the algorithms and framework, with input from I.A.-D. and guidance from A.R.; S.M. and N.M. implemented the software and performed the analyses and benchmarks, with contributions from J.W.; I.A.-D., E.M. and F.C. provided mouse colon Slide-Seq data; I.A.-D., O.R.-R. and A.R. provided mouse colon single-cell RNA-seq data; I.A.-D., J.K. and A.R. assessed and interpreted biological applications; J.K., A.R. and M.N. supervised the research; S.M., N.M., I.A.-D., J.K., A.R. and M.N. wrote the manuscript.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar3">
      <title>Peer review information</title>
      <p id="Par99"><italic>Nature Biotechnology</italic> thanks the anonymous reviewers for their contribution to the peer review of this work.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The datasets analyzed during the current study are available from <ext-link ext-link-type="uri" xlink:href="http://linnarssonlab.org/osmFISH/availability/">http://linnarssonlab.org/osmFISH/availability/</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://github.com/AllonKleinLab/paper-data/tree/master/Lineage_tracing_on_transcriptional_landscapes_links_state_to_fate_during_differentiation">https://github.com/AllonKleinLab/paper-data/tree/master/Lineage_tracing_on_transcriptional_landscapes_links_state_to_fate_during_differentiation</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link>.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>TACCO is available as the open-source python package tacco, with source code freely available at <ext-link ext-link-type="uri" xlink:href="https://github.com/simonwm/tacco">https://github.com/simonwm/tacco</ext-link> and corresponding documentation at <ext-link ext-link-type="uri" xlink:href="https://simonwm.github.io/tacco/">https://simonwm.github.io/tacco/</ext-link>.</p>
  </notes>
  <notes id="FPar4" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par100">A.R. is a cofounder and equity holder of Celsius Therapeutics, an equity holder in Immunitas, and was a SAB member of ThermoFisher Scientific, Syros Pharmaceuticals, Neogene Therapeutics and Asimov until 31 July 2020. From 1 August 2020, A.R. is an employee of Genentech and has equity in Roche. F.C. is a founder and holds equity in Curio Biosciences. A.R. and O.R.-R. are co-inventors on patent applications filed by the Broad Institute for inventions related to single-cell genomics. O.R.-R. has given numerous lectures on the subject of single-cell genomics to a wide variety of audiences, and in some cases, she has received remuneration to cover time and costs. O.R.-R. is an employee of Genentech since October 19, 2020, and has equity in Roche. The remaining authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Integrative single-cell analysis</article-title>
        <source>Nat. Rev. Genet.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>257</fpage>
        <lpage>272</lpage>
        <?supplied-pmid 30696980?>
        <pub-id pub-id-type="pmid">30696980</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xing</surname>
            <given-names>QR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Unraveling heterogeneity in transcriptome and its regulation through single-cell multi-omics technologies</article-title>
        <source>Front. Genet.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>662</fpage>
        <?supplied-pmid 32765578?>
        <pub-id pub-id-type="pmid">32765578</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wagner</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Revealing the vectors of cellular identity with single-cell genomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2016</year>
        <volume>34</volume>
        <fpage>1145</fpage>
        <lpage>1160</lpage>
        <?supplied-pmid 27824854?>
        <pub-id pub-id-type="pmid">27824854</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lähnemann</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Eleven grand challenges in single-cell data science</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>31</fpage>
        <?supplied-pmid 32033589?>
        <pub-id pub-id-type="pmid">32033589</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rodriques</surname>
            <given-names>SG</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Slide-seq: a scalable technology for measuring genome-wide expression at high spatial resolution</article-title>
        <source>Science</source>
        <year>2019</year>
        <volume>363</volume>
        <fpage>1463</fpage>
        <lpage>1467</lpage>
        <?supplied-pmid 30923225?>
        <pub-id pub-id-type="pmid">30923225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stickels</surname>
            <given-names>RR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly sensitive spatial transcriptomics at near-cellular resolution with Slide-seqV2</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>39</volume>
        <fpage>313</fpage>
        <lpage>319</lpage>
        <?supplied-pmid 33288904?>
        <pub-id pub-id-type="pmid">33288904</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatially resolved single-cell genomics and transcriptomics by imaging</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>18</fpage>
        <lpage>22</lpage>
        <?supplied-pmid 33408406?>
        <pub-id pub-id-type="pmid">33408406</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cable</surname>
            <given-names>DM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Robust decomposition of cell type mixtures in spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>517</fpage>
        <lpage>526</lpage>
        <?supplied-pmid 33603203?>
        <pub-id pub-id-type="pmid">33603203</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Achim</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-throughput spatial mapping of single-cell RNA-seq data to tissue of origin</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>503</fpage>
        <lpage>509</lpage>
        <?supplied-pmid 25867922?>
        <pub-id pub-id-type="pmid">25867922</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Farrell</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Gennert</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Schier</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Spatial reconstruction of single-cell gene expression data</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>495</fpage>
        <lpage>502</lpage>
        <?supplied-pmid 25867923?>
        <pub-id pub-id-type="pmid">25867923</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Elosua-Bayes</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Nieto</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Mereu</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Gut</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Heyn</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>SPOTlight: seeded NMF regression to deconvolute spatial transcriptomics spots with single-cell transcriptomes</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2021</year>
        <volume>49</volume>
        <fpage>9</fpage>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Biancalani</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Deep learning and alignment of spatially resolved single-cell transcriptomes with Tangram</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>1352</fpage>
        <lpage>1362</lpage>
        <?supplied-pmid 34711971?>
        <pub-id pub-id-type="pmid">34711971</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nitzan</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Karaiskos</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Friedman</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Rajewsky</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Gene expression cartography</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>576</volume>
        <fpage>132</fpage>
        <lpage>137</lpage>
        <?supplied-pmid 31748748?>
        <pub-id pub-id-type="pmid">31748748</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Halpern</surname>
            <given-names>KB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell spatial reconstruction reveals global division of labour in the mammalian liver</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>542</volume>
        <fpage>352</fpage>
        <lpage>356</lpage>
        <?supplied-pmid 28166538?>
        <pub-id pub-id-type="pmid">28166538</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>SW</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>CoSpar identifies early cell fate biases from single-cell transcriptomic and lineage information</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>1066</fpage>
        <lpage>1074</lpage>
        <?supplied-pmid 35190690?>
        <pub-id pub-id-type="pmid">35190690</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schiebinger</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Optimal-transport analysis of single-cell gene expression identifies developmental trajectories in reprogramming</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>176</volume>
        <fpage>928</fpage>
        <lpage>943</lpage>
        <?supplied-pmid 30712874?>
        <pub-id pub-id-type="pmid">30712874</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Aran</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Reference-based analysis of lung single-cell sequencing reveals a transitional profibrotic macrophage</article-title>
        <source>Nat. Immunol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>163</fpage>
        <lpage>172</lpage>
        <?supplied-pmid 30643263?>
        <pub-id pub-id-type="pmid">30643263</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Herman</surname>
            <given-names>JS</given-names>
          </name>
          <name>
            <surname>Sagar</surname>
          </name>
          <name>
            <surname>Grün</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>FateID infers cell fate bias in multipotent progenitors from single-cell RNA-seq data</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>379</fpage>
        <lpage>386</lpage>
        <?supplied-pmid 29630061?>
        <pub-id pub-id-type="pmid">29630061</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Moriel</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>NovoSpaRc: flexible spatial reconstruction of single-cell gene expression with optimal transport</article-title>
        <source>Nat. Protoc.</source>
        <year>2021</year>
        <volume>16</volume>
        <fpage>4177</fpage>
        <lpage>4200</lpage>
        <?supplied-pmid 34349282?>
        <pub-id pub-id-type="pmid">34349282</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cang</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Nie</surname>
            <given-names>Q</given-names>
          </name>
        </person-group>
        <article-title>Inferring spatial and signaling relationships between cells from single cell transcriptomic data</article-title>
        <source>Nat. Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>2084</fpage>
        <?supplied-pmid 32350282?>
        <pub-id pub-id-type="pmid">32350282</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zeira</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Alignment and integration of spatial transcriptomics data</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>19</volume>
        <fpage>567</fpage>
        <lpage>575</lpage>
        <?supplied-pmid 35577957?>
        <pub-id pub-id-type="pmid">35577957</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Demetci</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Santorella</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Sandstede</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Noble</surname>
            <given-names>WS</given-names>
          </name>
          <name>
            <surname>Singh</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>SCOT: single-cell multi-omics alignment with optimal transport</article-title>
        <source>J. Comput. Biol.</source>
        <year>2022</year>
        <volume>29</volume>
        <fpage>3</fpage>
        <lpage>18</lpage>
        <?supplied-pmid 35050714?>
        <pub-id pub-id-type="pmid">35050714</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Hong</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Wan</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>Manifold alignment for heterogeneous single-cell multi-omics data integration using Pamona</article-title>
        <source>Bioinformatics</source>
        <year>2021</year>
        <volume>38</volume>
        <fpage>211</fpage>
        <lpage>219</lpage>
        <?supplied-pmid 34398192?>
        <pub-id pub-id-type="pmid">34398192</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <mixed-citation publication-type="other">Dover, K., Cang, Z., Ma, A., Nie, Q. &amp; Vershynin, R. AVIDA: alternating method for visualizing and integrating data. Preprint at <italic>arXiv</italic><ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/2206.00135">https://arxiv.org/abs/2206.00135</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly parallel genome-wide expression profiling of individual cells using nanoliter droplets</article-title>
        <source>Cell</source>
        <year>2015</year>
        <volume>161</volume>
        <fpage>1202</fpage>
        <lpage>1214</lpage>
        <?supplied-pmid 26000488?>
        <pub-id pub-id-type="pmid">26000488</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palla</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Squidpy: a scalable framework for spatial omics analysis</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>19</volume>
        <fpage>171</fpage>
        <lpage>178</lpage>
        <?supplied-pmid 35102346?>
        <pub-id pub-id-type="pmid">35102346</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Codeluppi</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatial organization of the somatosensory cortex revealed by osmFISH</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>932</fpage>
        <lpage>935</lpage>
        <?supplied-pmid 30377364?>
        <pub-id pub-id-type="pmid">30377364</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Weinreb</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Rodriguez-Fraticelli</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Camargo</surname>
            <given-names>FD</given-names>
          </name>
          <name>
            <surname>Klein</surname>
            <given-names>AM</given-names>
          </name>
        </person-group>
        <article-title>Lineage tracing on transcriptional landscapes links state to fate during differentiation</article-title>
        <source>Science</source>
        <year>2020</year>
        <volume>367</volume>
        <fpage>eaaw3381</fpage>
        <?supplied-pmid 31974159?>
        <pub-id pub-id-type="pmid">31974159</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Avraham-Davidi, I. et al. Integrative single cell and spatial transcriptomics of colorectal cancer reveals multicellular functional units that support tumor progression. Preprint at <italic>bioRxiv</italic><ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/2022.10.02.508492v1">https://www.biorxiv.org/content/10.1101/2022.10.02.508492v1</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Slyper</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell and single-nucleus RNA-Seq toolbox for fresh and frozen human tumors</article-title>
        <source>Nat. Med.</source>
        <year>2020</year>
        <volume>26</volume>
        <fpage>792</fpage>
        <lpage>802</lpage>
        <?supplied-pmid 32405060?>
        <pub-id pub-id-type="pmid">32405060</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>I-H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatial transcriptomic reconstruction of the mouse olfactory glomerular map suggests principles of odor processing</article-title>
        <source>Nat. Neurosci.</source>
        <year>2022</year>
        <volume>25</volume>
        <fpage>484</fpage>
        <lpage>492</lpage>
        <?supplied-pmid 35314823?>
        <pub-id pub-id-type="pmid">35314823</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tepe</surname>
            <given-names>B</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell RNA-seq of mouse olfactory bulb reveals cellular heterogeneity and activity-dependent molecular census of adult-born neurons</article-title>
        <source>Cell Rep.</source>
        <year>2018</year>
        <volume>25</volume>
        <fpage>2689</fpage>
        <lpage>2703</lpage>
        <?supplied-pmid 30517858?>
        <pub-id pub-id-type="pmid">30517858</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xia</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Fan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Emanuel</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatial transcriptome profiling by MERFISH reveals subcellular RNA compartmentalization and cell cycle-dependent gene expression</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2019</year>
        <volume>116</volume>
        <fpage>19490</fpage>
        <lpage>19499</lpage>
        <?supplied-pmid 31501331?>
        <pub-id pub-id-type="pmid">31501331</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eng</surname>
            <given-names>C-HL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale super-resolved imaging in tissues by RNA seqFISH</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>568</volume>
        <fpage>235</fpage>
        <lpage>239</lpage>
        <?supplied-pmid 30911168?>
        <pub-id pub-id-type="pmid">30911168</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Littman</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Joint cell segmentation and cell type annotation for spatial transcriptomics</article-title>
        <source>Mol. Syst. Biol.</source>
        <year>2021</year>
        <volume>17</volume>
        <fpage>e10108</fpage>
        <?supplied-pmid 34057817?>
        <pub-id pub-id-type="pmid">34057817</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Park</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell segmentation-free inference of cell types from in situ transcriptomics data</article-title>
        <source>Nat. Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <fpage>3545</fpage>
        <?supplied-pmid 34112806?>
        <pub-id pub-id-type="pmid">34112806</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palla</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Fischer</surname>
            <given-names>DS</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Spatial components of molecular tissue biology</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>308</fpage>
        <lpage>318</lpage>
        <?supplied-pmid 35132261?>
        <pub-id pub-id-type="pmid">35132261</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Prabhakaran</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Nawy</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Pe’er</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Sparcle: assigning transcripts to cells in multiplexed images</article-title>
        <source>Bioinforma. Adv.</source>
        <year>2022</year>
        <volume>2</volume>
        <fpage>vbac048</fpage>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Petukhov</surname>
            <given-names>V</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell segmentation in imaging-based spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>40</volume>
        <fpage>345</fpage>
        <lpage>354</lpage>
        <?supplied-pmid 34650268?>
        <pub-id pub-id-type="pmid">34650268</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <mixed-citation publication-type="other">Kotliar, D. scsim: simulate single-cell RNA-SEQ data using the Splatter statistical framework but implemented in python. <ext-link ext-link-type="uri" xlink:href="http://github.com/dylkot/scsim">github.com/dylkot/scsim</ext-link> (2021).</mixed-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kotliar</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Identifying gene expression programs of cell-type identity and cellular activity with single-cell RNA-seq</article-title>
        <source>eLife</source>
        <year>2019</year>
        <volume>8</volume>
        <fpage>e43803</fpage>
        <?supplied-pmid 31282856?>
        <pub-id pub-id-type="pmid">31282856</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zappia</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Splatter: simulation of single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2017</year>
        <volume>18</volume>
        <fpage>174</fpage>
        <?supplied-pmid 28899397?>
        <pub-id pub-id-type="pmid">28899397</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abdelaal</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A comparison of automatic cell identification methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>194</fpage>
        <?supplied-pmid 31500660?>
        <pub-id pub-id-type="pmid">31500660</pub-id>
      </element-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Fleming, S. J. et al. Unsupervised removal of systematic background noise from droplet-based single-cell experiments using CellBender. Preprint at <italic>bioRxiv</italic><ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/791699v2">https://www.biorxiv.org/content/10.1101/791699v2</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Drokhlyansky</surname>
            <given-names>E</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The human and mouse enteric nervous system at single-cell resolution</article-title>
        <source>Cell</source>
        <year>2020</year>
        <volume>182</volume>
        <fpage>1606</fpage>
        <lpage>1622</lpage>
        <?supplied-pmid 32888429?>
        <pub-id pub-id-type="pmid">32888429</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>15</fpage>
        <?supplied-pmid 29409532?>
        <pub-id pub-id-type="pmid">29409532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Knopp</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Sinkhorn</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Concerning nonnegative matrices and doubly stochastic matrices</article-title>
        <source>Pacific J. Math.</source>
        <year>1967</year>
        <volume>21</volume>
        <fpage>343</fpage>
        <lpage>348</lpage>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bacharach</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Estimating nonnegative matrices from marginal data</article-title>
        <source>Int. Econ. Rev.</source>
        <year>1965</year>
        <volume>6</volume>
        <fpage>294</fpage>
        <lpage>310</lpage>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Flamary</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>POT: Python optimal transport</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>1</fpage>
        <lpage>8</lpage>
      </element-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pedregosa</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Scikit-learn: machine learning in Python</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2011</year>
        <volume>12</volume>
        <fpage>2825</fpage>
        <lpage>2830</lpage>
      </element-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Traag</surname>
            <given-names>VA</given-names>
          </name>
          <name>
            <surname>Waltman</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>van Eck</surname>
            <given-names>NJ</given-names>
          </name>
        </person-group>
        <article-title>From Louvain to Leiden: guaranteeing well-connected communities</article-title>
        <source>Sci. Rep.</source>
        <year>2019</year>
        <volume>9</volume>
        <fpage>5233</fpage>
        <?supplied-pmid 30914743?>
        <pub-id pub-id-type="pmid">30914743</pub-id>
      </element-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Keren</surname>
            <given-names>L</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A structured tumor-immune microenvironment in triple negative breast cancer revealed by multiplexed ion beam imaging</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>174</volume>
        <fpage>1373</fpage>
        <lpage>1387</lpage>
        <?supplied-pmid 30193111?>
        <pub-id pub-id-type="pmid">30193111</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Biotechnol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Biotechnol</journal-id>
    <journal-title-group>
      <journal-title>Nature Biotechnology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1087-0156</issn>
    <issn pub-type="epub">1546-1696</issn>
    <publisher>
      <publisher-name>Nature Publishing Group US</publisher-name>
      <publisher-loc>New York</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10513360</article-id>
    <article-id pub-id-type="pmid">36797494</article-id>
    <article-id pub-id-type="publisher-id">1657</article-id>
    <article-id pub-id-type="doi">10.1038/s41587-023-01657-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>TACCO unifies annotation transfer and decomposition of cell identities for single-cell and spatial omics</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-1447-6811</contrib-id>
        <name>
          <surname>Mages</surname>
          <given-names>Simon</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <name>
          <surname>Moriel</surname>
          <given-names>Noa</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-7118-9179</contrib-id>
        <name>
          <surname>Avraham-Davidi</surname>
          <given-names>Inbal</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Murray</surname>
          <given-names>Evan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-7519-731X</contrib-id>
        <name>
          <surname>Watter</surname>
          <given-names>Jan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-2308-3649</contrib-id>
        <name>
          <surname>Chen</surname>
          <given-names>Fei</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-6313-3570</contrib-id>
        <name>
          <surname>Rozenblatt-Rosen</surname>
          <given-names>Orit</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff9">9</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3628-9278</contrib-id>
        <name>
          <surname>Klughammer</surname>
          <given-names>Johanna</given-names>
        </name>
        <address>
          <email>klughammer@genzentrum.lmu.de</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3293-3158</contrib-id>
        <name>
          <surname>Regev</surname>
          <given-names>Aviv</given-names>
        </name>
        <address>
          <email>aviv.regev.sc@gmail.com</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff6">6</xref>
        <xref ref-type="aff" rid="Aff9">9</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-0074-9196</contrib-id>
        <name>
          <surname>Nitzan</surname>
          <given-names>Mor</given-names>
        </name>
        <address>
          <email>mor.nitzan@mail.huji.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff7">7</xref>
        <xref ref-type="aff" rid="Aff8">8</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05a0ya142</institution-id><institution-id institution-id-type="GRID">grid.66859.34</institution-id><institution>Klarman Cell Observatory, Broad Institute of MIT and Harvard, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05591te55</institution-id><institution-id institution-id-type="GRID">grid.5252.0</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 973X</institution-id><institution>Gene Center and Department of Biochemistry, </institution><institution>Ludwig-Maximilians-University Munich, </institution></institution-wrap>Munich, Germany </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>School of Computer Science and Engineering, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/05a0ya142</institution-id><institution-id institution-id-type="GRID">grid.66859.34</institution-id><institution>Broad Institute of MIT and Harvard, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03vek6s52</institution-id><institution-id institution-id-type="GRID">grid.38142.3c</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 754X</institution-id><institution>Department of Stem Cell and Regenerative Biology, </institution><institution>Harvard University, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff6"><label>6</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/042nb2s44</institution-id><institution-id institution-id-type="GRID">grid.116068.8</institution-id><institution-id institution-id-type="ISNI">0000 0001 2341 2786</institution-id><institution>Massachusetts Institute of Technology, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff7"><label>7</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>Racah Institute of Physics, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff8"><label>8</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/03qxff017</institution-id><institution-id institution-id-type="GRID">grid.9619.7</institution-id><institution-id institution-id-type="ISNI">0000 0004 1937 0538</institution-id><institution>Faculty of Medicine, </institution><institution>The Hebrew University of Jerusalem, </institution></institution-wrap>Jerusalem, Israel </aff>
      <aff id="Aff9"><label>9</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/04gndp242</institution-id><institution-id institution-id-type="ISNI">0000 0004 5899 3818</institution-id><institution>Present Address: Genentech, </institution></institution-wrap>South San Francisco, CA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>16</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>16</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <year>2023</year>
    </pub-date>
    <volume>41</volume>
    <issue>10</issue>
    <fpage>1465</fpage>
    <lpage>1473</lpage>
    <history>
      <date date-type="received">
        <day>15</day>
        <month>6</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>2</day>
        <month>1</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Transferring annotations of single-cell-, spatial- and multi-omics data is often challenging owing both to technical limitations, such as low spatial resolution or high dropout fraction, and to biological variations, such as continuous spectra of cell states. Based on the concept that these data are often best described as continuous mixtures of cells or molecules, we present a computational framework for the transfer of annotations to cells and their combinations (TACCO), which consists of an optimal transport model extended with different wrappers to annotate a wide variety of data. We apply TACCO to identify cell types and states, decipher spatiomolecular tissue structure at the cell and molecular level and resolve differentiation trajectories using synthetic and biological datasets. While matching or exceeding the accuracy of specialized tools for the individual tasks, TACCO reduces the computational requirements by up to an order of magnitude and scales to larger datasets (for example, considering the runtime of annotation transfer for 1 M simulated dropout observations).</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">Annotation transfer from reference to new datasets is improved with a probabilistic approach.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Software</kwd>
      <kwd>Data integration</kwd>
      <kwd>Data processing</kwd>
      <kwd>Computational platforms and environments</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100001659</institution-id>
            <institution>Deutsche Forschungsgemeinschaft (German Research Foundation)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>MA 9108/1-1</award-id>
        <principal-award-recipient>
          <name>
            <surname>Mages</surname>
            <given-names>Simon</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100000854</institution-id>
            <institution>Human Frontier Science Program (HFSP)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>LT000452/2019-L</award-id>
        <principal-award-recipient>
          <name>
            <surname>Klughammer</surname>
            <given-names>Johanna</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000051</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Human Genome Research Institute (NHGRI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>5RM1HG006193-09</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000054</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Cancer Institute (NCI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1U24 CA180922</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100006955</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1U19 MH114821</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000062</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Institute of Diabetes and Digestive and Kidney Diseases (National Institute of Diabetes &amp; Digestive &amp; Kidney Diseases)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1RC2 DK114784</award-id>
        <principal-award-recipient>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000011</institution-id>
            <institution>Howard Hughes Medical Institute (HHMI)</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Klarman Cell Observatory MIT Ludwig Center Manton Family Foundation</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100003977</institution-id>
            <institution>Israel Science Foundation (ISF)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1079/21</award-id>
        <principal-award-recipient>
          <name>
            <surname>Nitzan</surname>
            <given-names>Mor</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100005155</institution-id>
            <institution>Azrieli Foundation</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100006785</institution-id>
            <institution>Google</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem Horizon Europe ERC Grant (101040660)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© Springer Nature America, Inc. 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Main</title>
    <p id="Par3">Single-cell and spatial genomics methods provide high-dimensional measurements of biological systems at unprecedented scale and resolution<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR2">2</xref></sup>. One of the key challenges is attaching meaningful and interpretable representations of the experimental measurements to denote cellular features, such as types, states, cell-cycle stages or position within tissues<sup><xref ref-type="bibr" rid="CR3">3</xref>,<xref ref-type="bibr" rid="CR4">4</xref></sup> to decipher cellular dynamics, communication and collective behavior. For several biological systems, annotated reference datasets exist that can be leveraged for annotating new, more complex and information-rich datasets.</p>
    <p id="Par4">However, when the new dataset varies substantially from the reference, transferring annotations is a challenging task. A prime example is the transfer of annotations from scRNA-seq to spatial transcriptomics with supracellular spatial resolution. For instance, Slide-seq<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR6">6</xref></sup> uses spatially scattered beads to measure the combined expression of multiple neighboring cells, possibly of different types. Transferred annotations, like cell type, thus become compositional annotations, such as cell-type fractions per bead (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). Similarly, for spatial data with subcellular or even single-molecule resolution<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, compositional annotations of local neighborhoods allow segmentation-free annotation and cell assignment of single molecules. Furthermore, compositional annotations can arise not only from cell mixtures but also from ambiguity of categorical annotations (Fig. <xref rid="Fig1" ref-type="fig">1b</xref>). For example, technical noise, caused by dropout or contamination of ambient RNA, can mask the true identity of an individual cell. Finally, biological continua as observed in cell differentiation or regulatory cellular spectra also require probabilistic cell-type assignments (Fig. <xref rid="Fig1" ref-type="fig">1b</xref>).<fig id="Fig1"><label>Fig. 1</label><caption><title>TACCO, a flexible framework for the annotation and analysis of cells and cell-like objects.</title><p><bold>a</bold>, TACCO generates annotations for new datasets of mixtures (top left) using an annotated single-cell reference (top right) and provides methods for downstream analysis of the resulting compositional annotations (bottom left). <bold>b</bold>, Compositional annotations. Illustrative embeddings of cells and cell-like objects annotated (left) for mixtures (pie charts) of idealized pure contributions (triangles); (middle) as ambiguous annotations (triangles with colored borders) for technical artifacts like high ambient contributions or dropout levels and (right) continuous annotations (circles) along biological continua. <bold>c</bold>, Annotation process. Far left: a labeled reference dataset (for example, scRNA-seq data and colored triangles) and a new dataset (for example, Slide-seq beads and circles) are first presented in a common high-dimensional space (for example, expression space) optionally using platform normalization to make the datasets comparable. Near left: TACCO represents the reference categories by one or multiple representative profiles (large colored triangles). Near right: TACCO uses semi-unbalanced entropic optimal transport to transfer annotations from the reference categories to the new dataset (arrows), generating compositional annotations for the new datapoints (colored pie charts). To improve the capture of subdominant contributions, this process is iterated. Far right: TACCO provides compositional annotations for the new dataset. <bold>d</bold>, TACCO analysis tools for compositional annotations, especially for spatial data. From left: spatial relationship analysis on long (tissue) and short (cellular neighborships) length scales; inferring spatial regions by both spatial and annotation information; enrichment of compositional annotations and splitting compositionally annotated count data into pure contributions for downstream analysis with single-cell analysis tools.</p></caption><graphic xlink:href="41587_2023_1657_Fig1_HTML" id="d32e524"/></fig></p>
    <p id="Par5">While different decomposition or mapping methods have been developed for specific use cases such as decomposition of spatial measurements<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR8">8</xref>–<xref ref-type="bibr" rid="CR11">11</xref></sup>, spatial single-cell mapping<sup><xref ref-type="bibr" rid="CR12">12</xref>–<xref ref-type="bibr" rid="CR14">14</xref></sup> or resolving trajectories<sup><xref ref-type="bibr" rid="CR15">15</xref>–<xref ref-type="bibr" rid="CR18">18</xref></sup>, they are in fact conceptually similar. In particular, in each of these cases, proximity in expression space translates to higher contributions in the annotation, suggesting that it should be possible to develop a general unifying framework across these tasks.</p>
    <p id="Par6">We implement this idea in a computational framework for the transfer of annotations to cells and their combinations (TACCO). TACCO is an optimal transport-based, flexible and efficient framework for annotation and analysis of single-cell and spatial omics data. We demonstrate TACCO’s applicability in various use cases, including identification of cell types and states, analysis of spatiomolecular tissue structure at different scales and single-cell differentiation fate prediction. Finally, we show that TACCO performs favorably in terms of accuracy and computing requirements when compared to other methods.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>TACCO: a framework for transferring annotations</title>
      <p id="Par7">We developed TACCO, a fast and flexible computational decomposition framework (Fig. <xref rid="Fig1" ref-type="fig">1c</xref>). TACCO takes as input an unannotated dataset consisting of observations (for example, the expression profiles of Slide-seq beads) and a corresponding reference dataset with annotations in a reference representation (for example, single-cell expression profiles with cell-type annotations) and computes a compositional annotation of the unannotated observations (for example, cell-type fractions of the Slide-seq beads). Working in a common high-dimensional space (for example, gene expression space), TACCO determines these compositions using a variation of the optimal transport (OT) algorithm (<xref rid="Sec25" ref-type="sec">Methods</xref>). At its core, OT creates a probabilistic map between the unannotated observations (for example, Slide-seq beads) and the means of the classes in the reference representation (for example, mean cell-type profiles) according to their relative similarity. This approach was previously used to map ancestor and descendant cells during differentiation<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>, recover the spatial organization of cells<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR19">19</xref>–<xref ref-type="bibr" rid="CR21">21</xref></sup> and associate measurements across modalities (for example, single-cell ATAC-seq and scRNA-seq)<sup><xref ref-type="bibr" rid="CR22">22</xref>–<xref ref-type="bibr" rid="CR24">24</xref></sup>. Through the OT framework, users can set the similarity metric, constrain or bias the marginals of the mapping and control the entropy of the annotation distributions (<xref rid="Sec25" ref-type="sec">Methods</xref>). By default, TACCO uses Bhattacharyya coefficients as a similarity metric (<xref rid="Sec25" ref-type="sec">Methods</xref>), which are formally equivalent to the overlaps of probability amplitudes in quantum mechanics and closely related to expectation values of measurements.</p>
      <p id="Par8">To address concrete biological perturbations and experimental variations between the new and reference data, TACCO provides a set of generic boosters (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>), including (1) platform normalization (as in robust cell type decomposition (RCTD)<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>), which introduces scaling factors in the transformation between experimental platforms (for example, Drop-seq<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> to Slide-seq<sup><xref ref-type="bibr" rid="CR5">5</xref></sup>); (2) subclustering with multiple centers to capture within-class heterogeneity and (3) bisectioning for recursive annotation, assigning only part of the annotation in each step and working with the residual in the next step to increase sensitivity to subdominant annotation contributions (<xref rid="Sec25" ref-type="sec">Methods</xref>).</p>
      <p id="Par9">TACCO is also equipped with different analysis tools that leverage the obtained compositional annotations (Fig. <xref rid="Fig1" ref-type="fig">1d</xref>). It adapts categorical annotation analyses to be applicable to mixture annotations across multiple samples, such as the quantification of spatial co-occurrence<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> of annotations to analyze long- and short-range spatial structure, and calculates enrichments of annotations. For spatial data, TACCO can combine spatial and annotation information to define regions with similar annotation compositions across samples. Moreover, TACCO can split compositionally annotated expression data (for example, cell-type annotated Slide-seq beads) into categorically annotated expression data (for example, split beads per cell type) using a matrix scaling algorithm, yielding data that are amenable to standard downstream single-cell analysis workflows.</p>
      <p id="Par10">We evaluated TACCO on the following four different use cases: (1) decomposing cell-type fractions from spatially convoluted gene expression (in silico mixed scRNA-seq profiles for benchmarking and decomposing colon Slide-seq<sup><xref ref-type="bibr" rid="CR6">6</xref></sup> bead measurements); (2) inferring the source cell types of imaged single molecules (without requiring segmentation of cell boundaries from images) for the somatosensory cortex imaged with osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>; (3) recovering cell type for scRNA-seq data with harsh dropout and with ambient RNA contamination (on simulated data) and (4) predicting differentiation fates of early hematopoietic progenitor cells<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. As we show below, TACCO consistently achieved performance comparable to or better than other benchmarked methods and excelled especially in speed and memory consumption.</p>
    </sec>
    <sec id="Sec4">
      <title>Accurate decomposition of in silico mixed expression</title>
      <p id="Par11">We first validated TACCO on simulated Slide-seq data that were generated from an annotated (real) scRNA-seq atlas of the mouse colon<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>) as weighted mixtures of cells drawn from the reference atlas with Gaussian weights parameterized by bead size (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>, <xref rid="Sec25" ref-type="sec">Methods</xref>). We measured the L2 error between the ground-truth weights and the cell-type fractions inferred by TACCO for varying bead sizes. TACCO matched in reconstruction accuracy with RCTD<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> and consistent with this outperformed all other tested state-of-the-art methods (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). Moreover, TACCO was much faster and had lower memory consumption than RCTD because RCTD fits a detailed model dense in parameters. For example, at bead size 1.0 (that is, bead and cells are of comparable size), the L2 errors were 0.081, 0.26 and 0.084 for TACCO, NMFreg<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> and RCTD, while TACCO and RCTD runtimes were 84 s and 1469 s, and memory consumption was 2.7 GB and 10.4 GB, respectively. After annotation, TACCO uses the mean reference profiles and the compositional annotation to distribute the actual counts per gene and observation between the cell types and thereby generates separate observations per cell type, keeping the full gene space intact. A subsequent dimensionality reduction then recovers the low-dimensional structure of the reference data (Fig. <xref rid="Fig2" ref-type="fig">2a</xref> and Extended Data Fig. <xref rid="Fig6" ref-type="fig">2</xref>).<fig id="Fig2"><label>Fig. 2</label><caption><title>TACCO compositional annotation, cell segmentation and analysis of spatial expression data.</title><p><bold>a</bold>, Analysis of in silico mixtures. UMAP embedding of scRNA-seq profiles of mouse colon (1)<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> and of in silico mixed scRNA-seq data before (2) and after (4) applying TACCOs splitting procedure into pure contributions. (3) L2 error (<italic>y</italic> axis) of cell-type annotations for each simulated bead size (<italic>x</italic> axis). Dashed lines: categorical annotation methods. <bold>b</bold>, A Slide-seq puck of normal mouse colon<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> colored by TACCO cell-type annotations (1, colors are weighted and summed per bead) or by TACCO-defined regions (2) (<xref rid="Sec25" ref-type="sec">Methods</xref>; Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>); (3) short-range (up to 20 µm) neighborship enrichment <italic>z</italic> scores over randomly permuted annotation assignments; (4) long-range (up to 500 µm) dependence of the composition of cell types around beads (log<sub>2</sub>(<italic>p</italic>(annotations|center)); <italic>y</italic> axis) at different distances from region 2 (muscularis; <italic>x</italic> axis) for each cell-type annotation (color). <bold>c</bold>, Comparison of TACCO and Baysor for single-molecule cell-type-of-origin annotation performance based on the single-molecule FISH: (1–3) Entire section profiled by osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> (left) and zoom-in on a small region (right) colored by (1) the published annotation of cells from watershed-based segmentation of the poly(A) signal or (2,3) the segmentation-free single-molecule annotation for cell-type-of-origin by TACCO (2) or Baysor (3) (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6a</xref>); (4) measured astrocyte marker gene expression on the zoom-in as ground truth for the astrocyte annotation in (1–3). Gray molecules are unannotated. <bold>d</bold>, Effective cell segmentation of osmFISH data by TACCO. tSNE embeddings of RNA profiles in cell-like objects from the published watershed-based segmentation colored by the published cell-type annotation (1), from TACCOs annotation-based segmentation (using the annotations in c (2)) (2, 3), colored by either TACCOs single-molecule annotations summed per cell (2) or by the published segmented cell annotation pulled back to single molecules (as in c(1)) and summed per cell (3) (<xref rid="Sec25" ref-type="sec">Methods</xref>; Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). <bold>e</bold>, Recovery of layered tissue structure in osmFISH data. Long-range (up to 2,000 µm) dependence of the composition of cell types (<italic>p</italic>(annotations|center = hippocampus), <italic>y</italic> axis) recovered by TACCO for TACCO-segmented objects at different distances from the hippocampus region annotation for each cell-type annotation (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6c</xref>).</p></caption><graphic xlink:href="41587_2023_1657_Fig2_HTML" id="d32e758"/></fig></p>
    </sec>
    <sec id="Sec5">
      <title>Decomposition and structural analysis of Slide-seq data</title>
      <p id="Par12">We next applied TACCO to the annotation of real Slide-seq data from mouse colon with matching scRNA-seq<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>). The different characteristics of scRNA-seq and Slide-seq data present annotation challenges. For example, cell composition can vary substantially, due to selection bias (much larger region assayed for scRNA-seq than Slide-seq) or because of differential capture efficiencies (for example, lower capture of fibroblasts by scRNA-seq<sup><xref ref-type="bibr" rid="CR30">30</xref></sup> compared to their true tissue prevalence). Moreover, Slide-seq’s low RNA capture rate yields much sparser data than scRNA-seq. Despite these challenges, TACCO recovered the expected layered structure of the colon along the muscularis–apical axis, short-range neighborship relations (closeness of stromal and immune cells with segregating epithelial cells) and long-range gradients on tissue structure scale from muscularis to apical plasma membrane (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">3</xref>).</p>
      <p id="Par13">TACCO scales to real-world applications, such as annotating a large dataset of 40 Slide-seq pucks of the mouse olfactory bulb<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>. Using mean expression profiles of different cell types from scRNA-seq dataset from the same tissue<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, TACCO annotated the full dataset of &gt;1.4 million spatial observations on 8 CPU cores in under 12 min, yielding consistent results between consecutive pucks and two replicates (Extended Data Fig. <xref rid="Fig8" ref-type="fig">4a</xref>). As an alternative to cell-type mean profiles, TACCO can also use every individual cell profile as reference, similar to spatial reconstruction<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR13">13</xref></sup> (Extended Data Fig. <xref rid="Fig8" ref-type="fig">4b</xref>) and infer the cells’ spatial arrangement, by either a compositional annotation of beads with all single cells or by annotating the single cells with the most likely position in the puck. Each of the three approaches implemented with TACCO (using mean expression profiles, compositional annotation with cells or mapping cells to most likely position) gave qualitatively similar spatial distributions of cell type; however, using mean profiles was more efficient computationally, while annotating cells with unique positions introduced additional noise in the spatial cell-type distribution.</p>
    </sec>
    <sec id="Sec6">
      <title>Single-molecule cell-type assignment and segmentation</title>
      <p id="Par14">Next, for single-molecule, high-resolution spatial imaging data (for example, MERFISH<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> or osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>), TACCO includes a wrapper for annotating individual, spatially imaged molecules with cell types, without prior cell segmentation. Standard procedures first segment the captured molecules either based on an image of the cells<sup><xref ref-type="bibr" rid="CR27">27</xref>,<xref ref-type="bibr" rid="CR33">33</xref>–<xref ref-type="bibr" rid="CR35">35</xref></sup> or by finding local maxima in spatially blurred expression fields<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. Both can be challenging due to high cellular density, irregular cell shapes and misplaced molecules<sup><xref ref-type="bibr" rid="CR37">37</xref>,<xref ref-type="bibr" rid="CR38">38</xref></sup>. TACCO circumvents these limitations by annotating each molecule. To this end, TACCO bins molecules using a Cartesian grid into spatial neighborhoods, computes cell-type annotations for each neighborhood using the reference profiles (as for Slide-seq above) and assigns each molecule an annotation in a manner that recapitulates the neighborhood’s annotation fractions (<xref rid="Sec25" ref-type="sec">Methods</xref>). Applied to a mouse brain osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> dataset, TACCO successfully accounted for each molecule (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>), compared to only 36% of molecules annotated following cell segmentation and cell-type classification<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>). Moreover, TACCO matched 59% of the molecular annotations in the original study, substantially better than Baysor<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, a recent single-molecule annotation method based on Bayesian mixture models (Fig. <xref rid="Fig2" ref-type="fig">2c</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>) (35% matched) and comparable to SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>, which annotates kernel density estimates of the expression on a Cartesian grid (<xref rid="Sec25" ref-type="sec">Methods</xref>) (57% matched). Notably, TACCO was much faster than both methods (TACCO: 2 min; Baysor: 27 min and SSAM: 68 min; Extended Data Fig. <xref rid="Fig10" ref-type="fig">6a</xref>) with robust success over a wide range of parameter choices (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6b</xref>). For cells with nonspheroid shapes, such as astrocytes, single-molecule annotation is especially advantageous; while TACCO, Baysor and SSAM annotate all molecules, the baseline segmentation and classification approach only accounts for 17% of astrocyte marker molecules (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>).</p>
      <p id="Par15">Subsequent image-free segmentation to cell-like objects based on spatial and annotation information allowed TACCO to recover expression profiles with cell-type annotations, thus utilizing more of the available data and better representing distinct cell types than the baseline as indicated by a higher silhouette score for TACCO than the baseline (0.24 compared to 0.06; <xref rid="Sec25" ref-type="sec">Methods</xref>; Fig. <xref rid="Fig2" ref-type="fig">2d</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). Applying TACCO’s segmentation on Baysor’s annotation yields an even higher silhouette score (0.45) but at the cost of missing three categories in the annotation (Hippocampus, Inhibitory IC and Inhibitory Pthlh) and a large fraction of molecules in very small segmented objects (28.7% of molecules in objects with less than 20 molecules, compared to 8.3% for TACCO) resulting from a less spatially homogeneous single-molecule annotation of Baysor compared to TACCO (Fig. <xref rid="Fig2" ref-type="fig">2c</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">5</xref>). Using Baysor’s built-in segmentation instead resulted in a silhouette score (0.03) that was worse than baseline and a longer runtime (50 min versus 3–5 min for TACCO segmentations). Replacing TACCO’s annotation with SSAM’s in the TACCO segmentation yielded a comparable silhouette score (0.22).</p>
      <p id="Par16">TACCO’s downstream analyses can use this image-free segmented single-molecule dataset to evaluate short- and long-range spatial patterns by computing the cell-type composition as a function of the distance to specific annotated cells. For example, we demonstrate this by recovering the layered structure of the mouse brain by calculating the distance to annotated hippocampal cells (Fig. <xref rid="Fig2" ref-type="fig">2e</xref>). Thus, TACCO’s spatial analyses efficiently bridge spatial scales from single-molecule data to tissue scale. TACCO’s downstream analysis is generic and can be applied to the annotations and segmentation derived from other methods as well. For example, TACCO- and SSAM-based analyses reproduce the layered structure, but the TACCO-based analysis yielded clearer cell-type density peaks than the SSAM-based one, while Baysor-based analyses were less conclusive (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6c</xref>).</p>
    </sec>
    <sec id="Sec7">
      <title>Classifying cell types in the presence of technical artifacts</title>
      <p id="Par17">While TACCO is primarily a compositional annotation algorithm, it can be used as a cell-type classifier by interpreting the compositional annotation as probabilities and quoting the class with maximum probability as the classification result. Indeed, TACCO performed well in recovering the ground-truth cell-type classification of simulated data with either high dropout rates or high levels of ambient RNAs, as compared to bona fide classifiers, SingleR<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> and SVM, and other compositional annotation methods turned into classifiers (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>). Specifically, for data with high dropout rates, we simulated a reference dataset of distinct cell types using scsim<sup><xref ref-type="bibr" rid="CR40">40</xref>,<xref ref-type="bibr" rid="CR41">41</xref></sup>, where the probability of dropout is a function of log mean expression<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>. Although each cell’s type is preserved, increasing this technical noise leads to increasingly ‘fuzzy’ cell-type-specific signals. Based on the fraction of correctly labeled cells, TACCO outperformed both the classification methods and other compositional methods used as classifiers, with larger performance margins in TACCO’s favor for higher dropout rates. In particular, SVM, a top-performing cell-type classification method<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>, performed poorly when the test data shifted in gene expression. For example, on the same in silico dataset with mild dropout rate (dropmidpoint = −1), TACCO correctly assigned 99.9% of cells, whereas SVM only captured 44.7% correctly. For ambient RNA contributions (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>), we simulated a reference dataset of distinct cell types using scsim<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> with the ambient RNA model from CellBender<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>. TACCO outperformed all other baseline methods, based on the fraction of correctly labeled cells (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>).<fig id="Fig3"><label>Fig. 3</label><caption><title>TACCO addresses dropouts, ambient RNA and continuous annotations.</title><p><bold>a</bold>, Dropout task. (1) UMAP embedding of the simulated scRNA-seq profiles without dropout; (2) schematic of the probability of dropout (<italic>y</italic> axis) for genes with different mean expressions (<italic>x</italic> axis); (3) UMAP embedding of the simulated data from (1) but with dropout; (4) fraction of correctly annotated cells (<italic>y</italic> axis, defined by the agreement of annotated type with maximal probability and the cell’s true annotation) at different dropout rate (<italic>x</italic> axis) for different methods (colors). Dashed lines: categorical annotation methods. <bold>b</bold>, Ambient RNA task: (1) UMAP embedding of simulated scRNA-seq profiles without ambient contribution; (2) schematic of test data generation, where ambient RNA is added to the cell’s expression profile; (3) UMAP embedding of simulated scRNA-seq profiles from (1) but with additional ambient contribution; (4) fraction of correctly annotated cells (<italic>y</italic> axis, defined by agreement of annotated type with maximal probability and the cell’s true annotation) at different levels of ambient RNA contamination (<italic>x</italic> axis) for different methods (colors). Dashed lines: categorical annotation methods. <bold>c</bold>, Differentiation task: (1–3) Spring plot of scRNA-seq profiles from hematopoiesis<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> colored by cell types at day 4 and 6 (1); eventual clonal fate of day 2 cells (2), TACCO-predicted clonal fate of day 2 cells (3); (4) Pearson correlation coefficient (<italic>y</italic> axis) of predicted and actual fate (as evaluated in ref. <sup><xref ref-type="bibr" rid="CR28">28</xref></sup>) for each method (colors).</p></caption><graphic xlink:href="41587_2023_1657_Fig3_HTML" id="d32e1006"/></fig></p>
    </sec>
    <sec id="Sec8">
      <title>TACCO-based prediction of cell fate decisions from scRNA-seq</title>
      <p id="Par18">TACCO also resolved continuous biological variability in the context of cell differentiation. To this end, we used a recent dataset<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> based on the LARRY method, where hematopoietic stem and progenitor cells were clonally barcoded and clones were followed through subsequent cell division and differentiation, for cells profiled by scRNA-seq at day 2, 4 and 6. Most early cells (day 2) (96%) were undifferentiated<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>, while day 4 and 6 cells were mostly (61%) differentiated with distinct profiles; thus, for early progenitor cells, we construct a proxy of their fate identities based on the distribution of the annotations of their clonal relatives (linked via a shared barcode; Fig. <xref rid="Fig3" ref-type="fig">3c</xref>). We then challenged TACCO to predict the fates of early day 2 cells (test data) from the cell-type labeled expression of later, more differentiated cells (reference data). TACCO’s predictions are most correlated with the proxy clonal fates (Pearson’s <italic>r</italic> = 0.73), outperforming five other available methods (<italic>r</italic> = 0.19–0.62; Fig. <xref rid="Fig3" ref-type="fig">3c</xref>).</p>
      <p id="Par19">This difference in prediction accuracy impacted the biological features visible from the analysis. TACCO highlighted the uncertainty of early fate decisions and the correct commitment of cells from late stages, along with differentiation ‘watersheds’ at appropriate points, such as between basophils and neutrophils and between neutrophils and monocytes. Conversely, other methods either did not reproduce the watersheds (for example, WOT), did not reflect fate uncertainty at early stages (for example, SingleR), or did not capture the commitment of later stages (for example, NMFreg) (Extended Data Fig. <xref rid="Fig11" ref-type="fig">7</xref>).</p>
    </sec>
    <sec id="Sec9">
      <title>Benchmark of accuracy, runtime and memory requirements</title>
      <p id="Par20">We designed TACCO with a focus on practical usability. In addition to its broad applicability to many use cases, TACCO has a modest resource footprint in terms of computing time, memory requirements and specialized hardware needs. We benchmarked TACCO’s computational requirements relative to those of baseline methods on standard x86 hardware on the ‘dropout’, ‘mixture’ and ‘differentiation’ tasks with a range of datasets sizes (10<sup>3</sup>–10<sup>6</sup> observations; Fig. <xref rid="Fig4" ref-type="fig">4</xref>). Among all compositional annotation methods in the comparison, TACCO has the lowest runtime and memory requirements, often outperforming the other methods by an order of magnitude or more. Only plain SVM, a categorical annotation method, achieved comparable or better runtime and memory requirements depending on the problem size. However, for categorical annotation, TACCO can also run without the bisectioning booster which improves TACCO’s runtime even further. TACCO achieves all that while maintaining a stable and very competitive L2 error of the annotated compositions with respect to the ground truth across tasks and dataset sizes. While TACCO is very flexible and can be tuned to perform particularly well for specific use cases, a single configuration generally gives a decent performance in terms of runtime, memory and accuracy across various use cases (Extended Data Fig. <xref rid="Fig12" ref-type="fig">8</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>). Additionally, runtime and memory usage are also optimized in TACCO’s downstream analysis tools. For example, similar statistics of co-occurrence and neighborhood-enrichment testing are computed via Squidpy<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> and TACCO, but faster to compute with TACCO (Extended Data Fig. <xref rid="Fig13" ref-type="fig">9</xref>; <xref rid="Sec25" ref-type="sec">Methods</xref>).<fig id="Fig4"><label>Fig. 4</label><caption><title>Benchmarking TACCO’s runtime, memory requirement and accuracy of annotation transfer.</title><p>Runtime (top), memory (middle) and L2 error (bottom) of each method (colors) in the ‘mixture’ (left; with bead size = 1.0), ‘dropout’ (middle; with drop midpoint = −1.0) and ‘differentiation’ (right) use cases, at different numbers of observations (cells or beads, <italic>x</italic> axis), ranging from 2<sup>10</sup> ~ 1 k to 2<sup>20</sup> ~ 1 M, which are up/down sampled from the datasets in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. Reference size is fixed at 2<sup>14</sup> ~ 16 k. The maximum compute resources per run are 8 CPU cores for 8 h with 8 GB memory each. Missing data points indicate that either compute time or memory was insufficient to complete the annotation. Methods with an asterisk do not natively return (fractional) annotations of spatial measurements, which leaves the total annotation fractions in the spatial measurement as degrees of freedom. The wrapper fills that using the reference type fractions. Categorical annotation methods are dashed.</p></caption><graphic xlink:href="41587_2023_1657_Fig4_HTML" id="d32e1094"/></fig></p>
    </sec>
  </sec>
  <sec id="Sec10" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par21">In conclusion, TACCO is a compositional annotation approach and broader analysis package rooted in the realization that multiple tasks in high-dimensional biological representations rely on successfully resolving continuous mixtures over cells or molecules, either due to biological or technical reasons. To leverage annotations of a reference dataset to annotate another dataset, TACCO integrates core, interpretable annotation methods, such as OT, and computational manipulations addressing concrete data perturbations. Together, these yield a top-performing framework in terms of accuracy, scalability, speed and memory requirements, making TACCO applicable for a wide range of annotation tasks.</p>
    <p id="Par22">However, the flexibility and efficiency of TACCO’s OT-based annotation come at a price. It cannot incorporate diverse detailed knowledge about the data-generating process as methods from the (deep) variational inference class do. While certain applications may benefit from creating a specialized annotation method instead of TACCO, this often requires substantial manual effort, detailed knowledge of the system and computing resources.</p>
    <p id="Par23">A further limitation is the requirement of overlapping feature spaces for reference and target data. Therefore, to use TACCO’s annotation for the transfer of annotations between modalities (for example, RNA–protein, DNA accessibility/methylation–RNA), a translation between the modalities needs to be performed externally to TACCO.</p>
    <p id="Par24">TACCO could be further extended by modeling continuous reference annotations (for example, interpolating/extrapolating along a linear reference), by integrating additional priors such as spatial smoothness for annotating spatial transcriptomic data and by integrating manifold learning techniques to better approximate expression distances from reference profiles.</p>
    <p id="Par25">The analytical form of interpretable methods like OT also opens the door to theoretical work on the limitations and guarantees of projecting annotations from one data to another, leading to more informed method selection.</p>
    <p id="Par26">TACCO’s computational efficiency places it as a potential building block for the development of new ‘meta’ analysis tools which perform different tasks. A prominent example for this is already implemented within TACCO: TACCO’s single-molecule annotation relies on repeatedly performing compositional annotations, which is feasible due to its underlying efficiency.</p>
    <p id="Par27">While showing here several examples of compositional and categorical annotations, we anticipate that TACCO will help in deciphering many other datasets, such as in decomposing expression of overloaded scRNA-seq experiments (for example, MIRACL-seq<sup><xref ref-type="bibr" rid="CR45">45</xref></sup>, which overloads single nuclei to capture more rare cells) and in deciphering cells with complex continuous states, such as T cell spectra.</p>
  </sec>
  <sec id="Sec11">
    <title>Datasets</title>
    <sec id="Sec12">
      <title>Mouse colon scRNA-seq and in silico spatial mixing</title>
      <p id="Par28">Mouse colon scRNA-seq data<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, as available from <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link> in raw counts format after basic quality filtering, with the provided cell-type annotations, was used to simulate spatial mixing by sampling uniformly spatial coordinates for cells and for simulated beads on a square. To make boundary effects smaller, periodic boundary conditions were employed. On the resulting torus, the minimal Euclidean distance was taken between cells and beads. To factor in the ‘shape’ of the beads, that distance was plugged into a kernel to compute the weights of contributions of each cell to a bead. From these weights, expression counts of cells and cell-type annotation of cells, expression counts of beads, cell-type fractions and count fractions belonging to each type were computed.</p>
      <p id="Par29">A Gaussian kernel was used to determine the weight of cell <italic>c</italic> in bead <italic>b</italic> as follows:<disp-formula id="Equa"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left( {w_{{\mathrm{gauss}}}} \right)_{cb} = r\,{\mathrm{exp}}\left( { - 1/2\left( {d_{cb}/l} \right)^2} \right)$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:msub><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>w</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">gauss</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>r</mml:mi><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>/</mml:mo><mml:mn>2</mml:mn><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equa.gif" position="anchor"/></alternatives></disp-formula>where <italic>d</italic><sub><italic>cb</italic></sub> is the Euclidean distance between the centers of cell <italic>c</italic> and bead <italic>b</italic>, <italic>l</italic> = 1/2 bead_size √<italic>1/n</italic>, and <italic>n</italic> cells. To capture the higher sparsity of the spatial data, the weight was scaled by a capture rate parameter <italic>r</italic> such that a cell contributes a fraction of <italic>r</italic> of its counts to a bead with distance <italic>0</italic>. <italic>r</italic> = 1.0 was used everywhere except where explicitly stated.</p>
    </sec>
    <sec id="Sec13">
      <title>Mouse colon scRNA-seq and Slide-seq data</title>
      <p id="Par30">scRNA-seq (as in the section above) and Slide-seq data of normal mouse colon were obtained from ref. <sup><xref ref-type="bibr" rid="CR29">29</xref></sup>. Raw counts reported for Puck 2020-09-14_Puck_200701_21 were used as available from <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link>.</p>
    </sec>
    <sec id="Sec14">
      <title>Mouse olfactory bulb scRNA-seq and Slide-seq data</title>
      <p id="Par31">scRNA-seq of mouse olfactory bulb was obtained from <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR32">32</xref></sup>), and Slide-seq data of the same tissue from <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR31">31</xref></sup>). Raw counts were used for both datasets.</p>
    </sec>
    <sec id="Sec15">
      <title>Single-molecule osmFISH of the mouse cortex</title>
      <p id="Par32">osmFISH data were obtained from <ext-link ext-link-type="uri" xlink:href="http://linnarssonlab.org/osmFISH/availability/">http://linnarssonlab.org/osmFISH/availability/</ext-link> ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. Reference expression profiles and their corresponding annotations were obtained from osmFISH-segmented cell profiles provided in ‘osmFISH_SScortex_mouse_all_cells.loom’.</p>
      <p id="Par33">Raw mRNA locations were obtained from ‘mRNA_coords_raw_counting.hdf5’.</p>
      <p id="Par34">Preprocessing was performed using the procedure in <ext-link ext-link-type="uri" xlink:href="https://github.com/HiDiHlabs/ssam_example/blob/master/osmFISH_SSp.ipynb">https://github.com/HiDiHlabs/ssam_example/blob/master/osmFISH_SSp.ipynb</ext-link>. This includes (1) shifting and rescaling cell/RNA coordinates to match each other (with an RNA coordinate system); (2) removing RNA molecules of bad quality; (3) correcting incorrect gene names and (4) removing molecules outside the intended imaged frame.</p>
      <p id="Par35">‘polyT_seg.pkl’, which contains a mapping of osmFISH’s segmented cell to molecule, was used to project osmFISH’s cell annotation onto individual molecules (approximating the ground truth). To visualize annotations at single-molecule level (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>), a window of x range (1,150, 1,400) and y range (1,000, 1,600) was used.</p>
    </sec>
    <sec id="Sec16">
      <title>scRNA-seq simulations with scsim with enhanced dropout</title>
      <p id="Par36">Scsim<sup><xref ref-type="bibr" rid="CR41">41</xref></sup> with its corresponding default parameters (set in notebook ‘Step1_Simulate.ipynb’, with changing deloc to 5.0) was used to simulate scRNA-seq data. The dropout step described in Splatter<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> was implemented in Python, by fitting a sigmoid curve through genes’ log mean count and their cell fraction with zero reads, where the sigmoid is characterized by shape and midpoint parameters. To enhance dropout, the sigmoid was shifted (decrease its midpoint) and the adjusted dropout probability was computed. This probability was then used to binomially sample the observed counts.</p>
    </sec>
    <sec id="Sec17">
      <title>scRNA-seq simulations with scsim with ambient RNA</title>
      <p id="Par37">To simulate expression profiles with ambient RNA, scsim’s<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> simulation of mean expression per cells and genes (termed ‘updatedmean’ in scsim and denoted in Splatter<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> as <italic>λ</italic>, a matrix of the means for each gene and each cell) was combined with CellBender’s<sup><xref ref-type="bibr" rid="CR44">44</xref></sup> model of ambient RNA contamination and downstream sampling of counts.</p>
      <p id="Par38">Specifically, the mean expression of gene <italic>g</italic> and cell <italic>n</italic> (or here, the cell in drop <italic>n</italic>) was obtained from scsim as <italic>λ</italic><sub><italic>ng</italic></sub>. For CellBender’s probabilistic model, the probability of having a cell in the drop <italic>y</italic><sub><italic>n</italic></sub> is set to 1 (because empty drops are not considered), and <italic>ρ</italic><sub><italic>n</italic></sub> is set to 0 because 0 reads are exogenous to the drop as we account only for ambient RNA (pumped into the drop) and not for barcode swapping. Thus, the CellBender model simplifies to<disp-formula id="Equb"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_{ng}\sim {{{\mathrm{NB}}}}\left( {d_n^{{\mathrm{cell}}}\chi _{ng} + d_n^{{\mathrm{drop}}}\chi ^a_g,{\Phi}} \right)$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>~</mml:mo><mml:mi mathvariant="normal">NB</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Φ</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equb.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par39">The two models were combined as follows:</p>
      <p id="Par40"><inline-formula id="IEq1"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda _{ng} = d_n^{{\mathrm{cell}}}\chi _{ng}$$\end{document}</tex-math><mml:math id="M6"><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq1.gif"/></alternatives></inline-formula> is the mean expression (similar to CellBender, scsim also uses a log-normal distribution of cell size)</p>
      <p id="Par41"><inline-formula id="IEq2"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda' _g = {\mathrm{avg}}_n\lambda _{ng} = \chi _g^a$$\end{document}</tex-math><mml:math id="M8"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">avg</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq2.gif"/></alternatives></inline-formula> is the mean true count of gene <italic>g</italic>, that is, the ambient contribution of the gene</p>
      <p id="Par42">Given the fraction of ambient RNA, <italic>f</italic>
<sup>drop</sup>, and the library size, <inline-formula id="IEq3"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M10"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq3.gif"/></alternatives></inline-formula>, and scale, <inline-formula id="IEq4"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\sigma ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M12"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq4.gif"/></alternatives></inline-formula>, used for sampling the cell size, <inline-formula id="IEq5"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_n^{{\mathrm{cell}}},d_n^{{\mathrm{drop}}}$$\end{document}</tex-math><mml:math id="M14"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq5.gif"/></alternatives></inline-formula> ~ logNormal(<inline-formula id="IEq6"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M16"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq6.gif"/></alternatives></inline-formula> + log(<italic>f</italic><sup>drop</sup>), <inline-formula id="IEq7"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\sigma ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M18"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq7.gif"/></alternatives></inline-formula>) is sampled (that is, the same variance is employed as used for sampling the cell content and the mean is set to log(exp(<inline-formula id="IEq8"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_\mu ^{{\mathrm{cell}}}$$\end{document}</tex-math><mml:math id="M20"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">cell</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq8.gif"/></alternatives></inline-formula>) <italic>f</italic>
<sup>drop</sup>).</p>
      <p id="Par43"><italic>Φ</italic> is sampled as defined in CellBender</p>
      <p id="Par44">Thus, we sample<disp-formula id="Equc"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_{ng}\sim {{{\mathrm{NB}}}}( {\lambda _{ng} + d_n^{{\mathrm{drop}}}\lambda' _g,{{{\Phi}}}} )$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>~</mml:mo><mml:mi mathvariant="normal">NB</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">drop</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Φ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math><graphic xlink:href="41587_2023_1657_Article_Equc.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par45">For comparability, the reference is generated in the same way (using negative binomial sampling instead of scsim’s Poisson sampling) but without adding ambient RNA.</p>
    </sec>
    <sec id="Sec18">
      <title>scRNA-seq of clone-labeled hematopoiesis cells</title>
      <p id="Par46">Normalized counts (‘stateFate_inVitro_normed_counts.mtx’, together with the corresponding gene names and cell metadata) and cells’ clone matrix (‘stateFate_inVitro_clone_matrix.mtx’) were obtained from the GitHub repository <ext-link ext-link-type="uri" xlink:href="https://github.com/AllonKleinLab/paper-data/blob/master/">https://github.com/AllonKleinLab/paper-data/blob/master/</ext-link> (ref. <sup><xref ref-type="bibr" rid="CR28">28</xref></sup>). Cells were filtered to those belonging to clones with cells on day 2 and on days 4 or 6. The fate bias for each cell on day 2 was computed from the fates of its clone on days 4 and 6 (normalized to 1). Differentiated cells captured on days 4 and 6 were then used as a reference for annotating cells of differentiated fate from day 2.</p>
    </sec>
    <sec id="Sec19">
      <title>TACCO configuration</title>
      <p id="Par47">With the exception of the analyses mentioned below, TACCO was generally applied with an identical parameter set across all analyses in this manuscript: core annotation method OT (default TACCO setting), basic platform normalization (default TACCO setting for OT), entropy regularization parameter epsilon 0.005 (default TACCO setting for OT), marginal relaxation parameter lambda of 0.1 (default TACCO setting for OT), four iterations of boosting with a divisor of three (default TACCO setting for OT) and multi_center = 10 (10 representing means for each type to account for variability with an annotation category). Aside from parameter stability analyses, the exceptions are as follows: (1) for Fig. <xref rid="Fig4" ref-type="fig">4</xref>, in addition to running TACCO with the default parameter values as described above, TACCO was also applied without boosting, using only the maximum annotation per observation as categorical annotation, and all other parameters identical as an optimized categorical annotation method ‘TACCO (cat)’. (2) For Extended Data Fig. <xref rid="Fig8" ref-type="fig">4</xref>, TACCO was used with TACCO’s default settings only, that is, all parameters identical to above but not using the multi_center booster. (3) For the single-molecule annotation of the osmFISH data, default parameters were used again, but no platform normalization was used because the reference shares identical platform effects with the data to annotate. The additional parameters specific to single-molecule annotation were set to bin_size = 10, reflecting the expected size of features, that is cells, of about 10 µm, and n_shifts = 3, as a tradeoff between speed and reduction of artifacts.</p>
    </sec>
    <sec id="Sec20">
      <title>Baysor configuration</title>
      <p id="Par48">Running Baysor on the osmFISH example with the osmFISH-specific configurations available in the github repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor">https://github.com/kharchenkolab/Baysor</ext-link>) and adapting the Baysor code (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>) to accept cell-type means achieved only 25% match with osmFISH’s annotations. Therefore, we adapted code and used parameters from the segmentation-free annotation transfer described in the BaysorAnalysis repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/BaysorAnalysis/blob/master/notebooks/segmentation_free/segmentation_free_allen_smfish.md">https://github.com/kharchenkolab/BaysorAnalysis/blob/master/notebooks/segmentation_free/segmentation_free_allen_smfish.md</ext-link>) and increased Baysor performance to achieve 35% match with osmFISH original annotations. These parameters are mainly default parameters: we used the functions build_molecule_graph() with filter = false, append_confidence() with nn_id = 16, and cluster_molecules_on_mrf() with do_maximize = false, max_iters = 1,000, and n_iters_without_update = 20.</p>
      <p id="Par49">For the segmentation we followed the Baysor code (<ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>) and used the specialized values for the osmFISH data from the repository, where available, and default values from the repository otherwise. Specifically, we used scale-std = ‘25%’ and prior-segmentation-confidence = 0.2 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/main.jl</ext-link>, iters = 500 and num-cells-init = 30,000 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/examples/osm-FISH/README.md">https://github.com/kharchenkolab/Baysor/blob/master/examples/osm-FISH/README.md</ext-link>, scale = 70.0 and min-molecules-per-cell = 30 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/configs/osm_fish.toml">https://github.com/kharchenkolab/Baysor/blob/master/configs/osm_fish.toml</ext-link> and new-component-fraction = 0.3 and new-component-weight = 0.2 from <ext-link ext-link-type="uri" xlink:href="https://github.com/kharchenkolab/Baysor/blob/master/src/cli/common.jl">https://github.com/kharchenkolab/Baysor/blob/master/src/cli/common.jl</ext-link>.</p>
    </sec>
    <sec id="Sec21">
      <title>SSAM configuration</title>
      <p id="Par50">For SSAM, we followed the SSAM user guide and used default parameters except for find_local_max() for which we supplied the parameters recommended in the user guide: search_size = 3, min_norm = 0.027, min_expression = 0.2.</p>
      <p id="Par51">To map the SSAM annotations of the generated Cartesian grid back to individual molecules and to compare them with the single-molecule annotations from TACCO and Baysor, we assigned to every molecule the annotation of the grid point closest to it.</p>
    </sec>
    <sec id="Sec22">
      <title>RCTD configuration</title>
      <p id="Par52">For RCTD, we adapted the default parameters to work in the framework of TACCO such that all clusters in the reference are used (CELL_MIN_INSTANCE = 0), all cells end up with an annotation (UMI_min = 0), RCTD does not throw an exception for lowly covered types in the reference (UMI_min_sigma = min(300,median<sub>observations</sub>(total_counts_per_observation)-1)), and every observation gets a compositional annotation over all available types (doublet_mode = ‘full’).</p>
    </sec>
    <sec id="Sec23">
      <title>NovoSpaRc configuration</title>
      <p id="Par53">For NovoSpaRc, we used alpha = 1.0 and adapted the default parameters to use all available genes.</p>
    </sec>
    <sec id="Sec24">
      <title>Configuration of other annotation methods</title>
      <p id="Par54">For all other annotation methods (SVM, SingleR, NMFreg, WOT, Tangram), we used default parameters.</p>
    </sec>
  </sec>
  <sec id="Sec25">
    <title>Methods</title>
    <sec id="Sec26">
      <title>Overview of TACCO framework</title>
      <p id="Par55">TACCO is based on three guiding principles: modularity, interpretability and efficiency. TACCOs compositional annotation algorithm is built from a single fast core method, which is then supplemented by a diverse set of wrappers and ‘boosters’, each providing additional functionality and features. The framework is completed by a set of downstream analysis tools, some of which are especially optimized for analysis involving compositional annotations. TACCO relies on Anndata and seamlessly integrates with the Scanpy<sup><xref ref-type="bibr" rid="CR46">46</xref></sup> ecosystem.</p>
    </sec>
    <sec id="Sec27">
      <title>Compositional annotation</title>
      <p id="Par56">TACCO aims to annotate single cells and cell-like objects, like Slide-seq beads or Visium spots, with compositional annotations. In cases with discrete ground truth (for example, a B cell versus a fibroblast), we interpret the compositional annotation as probabilities of belonging to a category. Both objects <italic>b</italic> and categories <italic>t</italic> are in a common high-dimensional data space, for example, expression space. Generally, objects that are close to a category in that space should have a high contribution of that category in the compositional annotation.</p>
      <p id="Par57">The goal of the annotation is to find a matrix <italic>ρ</italic><sub><italic>tb</italic></sub> which gives the distribution of annotation over objects <italic>b</italic> and categories <italic>t</italic>. Some applications imply certain natural choices for the ‘units’ of <italic>ρ</italic><sub><italic>tb</italic></sub>. For example, in the case of count data, the natural units are counts as well, such that <italic>ρ</italic><sub><italic>tb</italic></sub> gives the counts in object <italic>b</italic> which are attributed to category <italic>t</italic>. The marginal distribution over categories is just the total number of counts Σ<sub><italic>t</italic></sub>
<italic>ρ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>b</italic></sub> per object <italic>b</italic> and is known. The marginal distribution over objects Σ<sub><italic>b</italic></sub>
<italic>ρ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>t</italic></sub> is not known beforehand and is an output of the annotation process. As the marginals per object are known in general, it is equivalent to cite only the normalized distributions <italic>ρ</italic>′<sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>tb</italic></sub>/<italic>ρ</italic><sub><italic>b</italic></sub> with Σ<sub><italic>t</italic></sub>
<italic>ρ</italic>′<sub><italic>tb</italic></sub> = 1 as an annotation result.</p>
    </sec>
    <sec id="Sec28">
      <title>Core annotation method by OT</title>
      <p id="Par58">TACCO’s core method is entropically regularized, partially balanced OT (an intrinsically fast variant of OT). Balanced OT solves the optimization problem <italic>γ</italic><sub>tb</sub> = argmin<sub><italic>γtb</italic></sub> Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub>
<italic>M</italic><sub><italic>tb</italic></sub> under the positivity constraint <italic>γ</italic><sub><italic>tb</italic></sub> ≥ <italic>0</italic> and the marginal constraints Σ<sub><italic>t</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> = <italic>c</italic><sub><italic>b</italic></sub> and Σ<sub><italic>b</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> = <italic>c</italic><sub><italic>t</italic></sub> with the transport cost Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub>
<italic>M</italic><sub><italic>tb</italic></sub> = <italic>&lt;</italic> <italic>γ</italic>, <italic>M</italic> &gt; <sub>F</sub> given by the Frobenius inner product of a mapping matrix <italic>γ</italic><sub><italic>tb</italic></sub> and a constant matrix <italic>M</italic><sub><italic>tb</italic></sub>. <italic>M</italic><sub><italic>tb</italic></sub> encodes the cost of ‘transporting’ or mapping an object <italic>b</italic> to an annotation <italic>t</italic> and must be chosen sensibly to yield a ‘good’ mapping <italic>γ</italic><sub><italic>tb</italic></sub>. The annotation problem is solved if the marginals <italic>c</italic><sub><italic>b</italic></sub> and <italic>c</italic><sub><italic>t</italic></sub> and the cost <italic>M</italic><sub><italic>tb</italic></sub> can be tuned such that <italic>γ</italic><sub><italic>tb</italic></sub> = <italic>ρ</italic><sub><italic>tb</italic></sub>.</p>
      <p id="Par59">The marginal over annotations is known from the data <italic>c</italic><sub><italic>b</italic></sub> = <italic>ρ</italic><sub><italic>b</italic></sub>, while <italic>c</italic><sub><italic>t</italic></sub> = <italic>ρ</italic><sub><italic>t</italic></sub> is not. This can be used to encode prior knowledge about the data, for example, from a reference distribution. To support the general case when such a reference distribution is not available, partially balanced OT is used: instead of fixing the type marginal exactly, a Kullback–Leibler divergence penalty is imposed scaled with a parameter <italic>λ</italic>. This can be used to tune the amount of trust put in the prior distribution.</p>
      <p id="Par60">Choosing a well-performing cost function is more ambiguous. The cost function uses the information in data space and assigns a dissimilarity to each object-category combination. A straightforward choice is the cosine distance, or, for expression count data, the cosine distance on normalized and log1p-transformed data. In our benchmarks, the cosine distance on transformed data led to better results (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>), but the transformation is rather specific for count data. Inspired by the overlap of states in quantum mechanics, a different measure, the Bhattacharyya coefficients, is generally used, with similar performance and without direct reference to counts. Bhattacharyya coefficients are a general measure of the overlap of probability distributions and are defined as BC(<italic>p</italic>,<italic>q</italic>) <italic>=</italic> Σ<sub><italic>g</italic></sub>√<italic>p</italic><sub><italic>g</italic></sub><italic>q</italic><sub><italic>g</italic></sub> for two probability distributions <italic>p</italic> and <italic>q</italic> in the data space. To allow the user to adapt the method according to the needs of their particular application, TACCO implements several other metrics, as well as making all scipy metrics available.</p>
      <p id="Par61">OT’s optimization problem is in general nonconvex and numerically expensive. However, using entropic regularization makes it strictly convex and efficiently solvable by using the Sinkhorn–Knopp matrix scaling algorithm<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. For entropic regularization, the tunable entropy regularization term <italic>εΩ</italic>(<italic>γ</italic><sub><italic>tb</italic></sub>) <italic>=</italic> <italic>ε</italic> Σ<sub><italic>tb</italic></sub>
<italic>γ</italic><sub><italic>tb</italic></sub> log(<italic>γ</italic><sub><italic>tb</italic></sub>) is added to the objective function. This term favors mappings that do not map a given object to a single annotation.</p>
    </sec>
    <sec id="Sec29">
      <title>Alternative annotation methods</title>
      <p id="Par62">The core, OT-based annotation method can be swapped by a number of other built-in methods, including nonnegative least squares or support vector machine (SVM) or by wrapped external methods from both Python and R, including NMFreg<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> or RCTD<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. Custom core methods can also be added using a functional interface. The wrapped external and custom functions may already include ‘booster’ functionality (below). For example, RCTD already contains platform normalization. Many of the simple built-in methods are amenable to hand optimization, for example, by supporting data sparsity consistently, which makes them even faster. All the built-in methods are generally optimized for standard x86 hardware, but wrapped external methods may use GPU acceleration (for example, Tangram<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>).</p>
    </sec>
    <sec id="Sec30">
      <title>Overview of boosters</title>
      <p id="Par63">Boosters can improve the performance of the core method or provide support for ‘missing features’ for example, for platform normalization, for using subtype variability to enhance the type representation in single-cell data, for creating a deconvolution method from a categorical annotation method and the other way round (Extended Data Fig. <xref rid="Fig5" ref-type="fig">1</xref>). They can be combined flexibly to adapt to special requirements for specific applications. The modularity introduced by boosters makes it straightforward to ‘unbox’ TACCO and understand what each part does. While most boosters do have some overhead in runtime, in the end, they all do the heavy lifting by calling the fast core method one or several times and transforming its inputs and/or outputs.</p>
    </sec>
    <sec id="Sec31">
      <title>Platform normalization</title>
      <p id="Par64">Dramatic differences in datasets can arise solely from differences in the experimental technique that impact the profiled cellular compartments (for example, single cell versus single nucleus), cellular compositions (due to differential capture of cells of different types) or gene biases. Annotation of data from one platform using a reference of another platform is much more difficult without accounting for these platform-dependent biases<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. This booster can be safely disabled if no platform effects are expected.</p>
      <p id="Par65">A platform normalization step mitigates platform-specific effects by rescaling data from one platform to make it comparable to data from a different platform, separately in each dimension <italic>g</italic> of the data space, for example, separately per gene. The necessary rescaling factors are estimated from data. A related but simpler approach compared to that given in ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup> is pursued, making less assumptions and therefore usable across a broader range of applications.</p>
      <p id="Par66">The representations of the categories <italic>t</italic> as sets of vectors in data space <inline-formula id="IEq9"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\pi ^A_{gt}\,{{{\mathrm{and}}}}\,\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M24"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">and</mml:mi><mml:mspace width="0.25em"/><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq9.gif"/></alternatives></inline-formula> on the two platforms <italic>A</italic> and <italic>B</italic> are linked to each other via the platform normalization factors <inline-formula id="IEq10"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g\,{{{\mathrm{as}}}}\,\pi ^A_{gt} = f^{AB}_g\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M26"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">as</mml:mi><mml:mspace width="0.25em"/><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq10.gif"/></alternatives></inline-formula>. If the category representations <inline-formula id="IEq11"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\pi ^B_{gt}$$\end{document}</tex-math><mml:math id="M28"><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq11.gif"/></alternatives></inline-formula> for platform <italic>B</italic> and the (pseudo-bulk) category marginals <inline-formula id="IEq12"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_t$$\end{document}</tex-math><mml:math id="M30"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq12.gif"/></alternatives></inline-formula> for platform <italic>A</italic> are known, the data space marginals <inline-formula id="IEq13"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_g$$\end{document}</tex-math><mml:math id="M32"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq13.gif"/></alternatives></inline-formula> can be written as <inline-formula id="IEq14"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rho^A_{g}} = {\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^A_{gt}\rho ^A_t}} = {f^{AB}_g}{\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^B_{gt}\rho ^A_t}}$$\end{document}</tex-math><mml:math id="M34"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq14.gif"/></alternatives></inline-formula>, and therefore <inline-formula id="IEq15"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g = \rho ^A_g/\mathop {\sum}\nolimits_{{{\mathrm{t}}}} {\pi ^B_{gt}\rho ^A_t}$$\end{document}</tex-math><mml:math id="M36"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup><mml:mo>/</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq15.gif"/></alternatives></inline-formula>. The category marginals <inline-formula id="IEq16"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho ^A_t$$\end{document}</tex-math><mml:math id="M38"><mml:msubsup><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq16.gif"/></alternatives></inline-formula> are themselves usually a result of the annotation procedure and used here as input to a preprocessing step for the procedure. However, an iterative scheme can also be used. Starting with the assumption that the annotation marginals are identical to the reference (which is reasonable for example, if matched spatial and single-cell data are available), most of the gene-wise platform effect can be already captured. Next, platform normalization is rerun after a first round of cell typing using improved type fractions, and the process is iterated until the normalization factors are stable. In practice, this procedure converges very rapidly with the initial step being by far the most relevant one.</p>
      <p id="Par67">After determining the gene-wise platform normalization factors <inline-formula id="IEq17"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f^{AB}_g$$\end{document}</tex-math><mml:math id="M40"><mml:msubsup><mml:mrow><mml:mi>f</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mi>B</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq17.gif"/></alternatives></inline-formula>, they are used to rescale the data space in either the reference or the test data or equivalently to work in the units of the test or the reference data. As the probabilities and the resulting annotation distribution are given in terms of these units, choosing test data units or reference data units can lead to quite different results. Which option should be preferred depends on the use case and downstream analyses. Here, test data units are chosen to retain integer count data for object splitting.</p>
    </sec>
    <sec id="Sec32">
      <title>Multicenter</title>
      <p id="Par68">In many cases, there are multiple observations per annotation category in the reference dataset, as is the case in single-cell data. To integrate the variability of these observations while maintaining speed, the observations per category are subclustered with <italic>k</italic>-means clustering to get multiple mean profiles per category. The annotation function is then called with this subannotation, and its result is summed over the subannotations to give an annotation in terms of the original categories. When the reference is already finely annotated, no improvement is expected from this booster, which could then lead to worse performance, because less data are available per subannotation to average noise and the reference gets overfitted.</p>
    </sec>
    <sec id="Sec33">
      <title>Bisectioning</title>
      <p id="Par69">Some annotation methods can be biased toward low-entropy annotations such that they may overweigh dominant categories in mixtures (the extreme case is a categorical classifier). Such methods can be adapted to compositional annotation by running the annotation method iteratively. In each iteration, the annotation is not used as the final result, but instead, a certain fraction of it is used to subtract a reconstructed approximation of the data from the original data. The residual is again subjected to the annotation method, while a fraction of the annotation result is added to the final annotation result. This procedure is very similar to gradient boosting. Bisectioning is useful when the objects are additive mixtures of the annotations in the data space. If the data consist (mainly) of objects which are best described by a single annotation, this booster can decrease performance, for example, by resolving the ambient contribution in single-cell data.</p>
    </sec>
    <sec id="Sec34">
      <title>Choosing parameters</title>
      <p id="Par70">While a single configuration of TACCO generally gives decent performance for a wide variety of use cases (Extended Data Fig. <xref rid="Fig12" ref-type="fig">8</xref>), it can be tuned to perform particularly well for certain use cases. Relevant parameters for the tuning include the following components.</p>
      <sec id="Sec35">
        <title>Boosting/bisectioning</title>
        <p id="Par71">TACCO’s default depends on the core annotation method. As OT itself lacks support for additive compositional annotations, TACCO activates this booster for OT by default. Higher values for the number of bisections and the bisection divisor generally lead to more precise compositional annotations but at the cost of increased runtime, which scales roughly linearly with the sum iterations+divisor. A divisor smaller than 3 can lead to sizable artifacts, and so a divisor equal to or greater than 3 is recommended.</p>
      </sec>
      <sec id="Sec36">
        <title>Multicenter</title>
        <p id="Par72">By default, TACCO does not use the multicenter booster (setting a number of representing means for each annotation category), as it is useful only in cases where the annotation categories have a large within-category variation. However, as many reference datasets come with coarse annotation categories, the multicenter booster is activated for most analyses in this study. This booster is not recommended if the categories already cover the full biologically significant heterogeneity in the data or if the dataset has only a single representing observation per category. A value of 5 or 10 is recommended in other cases (as this generally captures the heterogeneity in many datasets). Larger values are generally not recommended as they lead to an increase in runtime and have the potential for overfitting, by using irrelevant variability in the data for the annotation process.</p>
      </sec>
      <sec id="Sec37">
        <title>Platform_iterations</title>
        <p id="Par73">TACCO’s default depends on the core annotation method. As OT itself does not have built-in platform normalization and most pairs of reference and target data have nontrivial platform effects, basic platform normalization is the default for OT. It is generally recommended not to disable platform normalization, except for specific cases, for example, if part of the dataset of a single batch was manually annotated and the annotation should be transferred to the rest of the data.</p>
      </sec>
      <sec id="Sec38">
        <title>Max_annotation</title>
        <p id="Par74">TACCO’s default is a compositional annotation with nonzero values simultaneously possible for all annotation categories per observation. Max_annotation can be used to set the number of nonzero values per observation. For categorical annotation, one might want to restrict this to a single nonzero value per observation, corresponding to setting max_annotation to 1, while for data with very few contributing cells per observation (for example, Slide-seq or scRNA-Seq data with doublets) a suitable value could be 2 or 3.</p>
      </sec>
      <sec id="Sec39">
        <title>Marginal relaxation parameter lambda (OT-specific)</title>
        <p id="Par75">TACCO’s default value is chosen as a compromise between using prior information from the reference pseudobulk annotation composition (for example, cell-type proportions) and annotating in a fully data-driven manner. While larger values (larger cost of having a pseudobulk annotation composition different from the reference) can stabilize the annotation in cases of low correspondence between reference and target data, smaller values can give more precise pseudobulk annotation compositions if the two datasets are highly corresponding and do not exhibit batch effects that are not accounted for by platform normalization.</p>
      </sec>
      <sec id="Sec40">
        <title>Entropy regularization parameter epsilon (OT-specific)</title>
        <p id="Par76">TACCO’s default is chosen such that the regularization’s effect on the results is minimized: it biases the results toward high entropy configurations, that is, every observation (for example, spatial observation) is assigned a compositional annotation with large contributions from different categories (for example, cell types). This parameter must be nonzero, as the efficient regularized OT solver breaks down at zero epsilon (and numerically already at epsilon much smaller than 0.005). Except for specific settings (that is, prior information external to the dataset itself) in which it is beneficial to bias the result toward significant contributions of many annotation categories in the result, this parameter should only be changed in rare cases of numerical instability—which we did not observe with TACCO’s default.</p>
      </sec>
    </sec>
    <sec id="Sec41">
      <title>Object splitting</title>
      <p id="Par77">The annotation method generates an assignment of a composition of annotation categories for every observation. Generally, each observation is associated with more than one category with nonzero contribution. When the categories are cell types, this can be problematic for downstream applications that require the expression profiles of single cells as input, that is, pure profiles that can be attributed to a single cell. For example, as cell-type-related expression constitutes a strong signal, analysis of expression programs is easier across cells of shared type. Thus, it is desirable to derive several ‘virtual’ observations for every real observation, which correspond to the pure contribution of each annotation category.</p>
      <p id="Par78">A similar idea was proposed in ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, where the expected contribution of each cell type to the expression of one Slide-seq bead is approximated. In that approach, cell-type fractions that were reconstructed for every bead are taken as input in a Bayesian analysis, along with type-specific expression profiles and the bead-count matrix to yield expected reads per gene, bead and cell type. The result, however, lacks consistency with the annotation and the measured count matrix in the sense that the marginal over genes is not recovered. Here, we follow a similar strategy, but we directly integrate marginals as constraints of a matrix equivalence scaling problem in a data-driven frequentist approach.</p>
      <p id="Par79">In this approach, data generation is modeled as drawing single molecules labeled with gene <italic>g</italic>, cell type <italic>t</italic> and observation/bead <italic>b</italic> from the sample, which constitutes the central object—the joint probability <italic>p</italic>(<italic>gtb</italic>) for a given molecule to be of gene <italic>g</italic>, cell type <italic>t</italic> and bead <italic>b</italic>. In the actual experiment, only <italic>g</italic> and <italic>b</italic> are measured, yielding <italic>p</italic>(<italic>gb</italic>) <italic>=</italic> Σ<sub>t</sub>
<italic>p</italic>(<italic>gtb</italic>), the ‘t-marginal’. From the reference data, the reference profiles <italic>p</italic>(<italic>g</italic>|<italic>t</italic>) <italic>=</italic> Σ<sub><italic>b</italic></sub>
<italic>p</italic>(<italic>gtb</italic>)/<italic>p</italic>(<italic>t</italic>) are available, and from the annotation process the annotation result <italic>p</italic>(<italic>tb</italic>) = Σ<sub><italic>g</italic></sub>
<italic>p</italic>(<italic>gtb</italic>), the ‘g-marginal’ is obtained. Further, <italic>p</italic>(<italic>gtb</italic>) is modeled with a Bayesian-inspired product ansatz: <italic>p</italic>(<italic>gtb</italic>) = <italic>p</italic>(<italic>gt</italic>) <italic>n</italic>(<italic>gb</italic>) <italic>n</italic>(<italic>tb</italic>), with free parameters <italic>n</italic>(<italic>gb</italic>) and <italic>n</italic>(<italic>tb</italic>). These are fixed by enforcing the <italic>t</italic>- and <italic>g</italic>-marginals. The ansatz can be interpreted as adjusting the cell-type profiles and pseudobulk annotation with object-wise scaling factors per data dimension <italic>g</italic> and annotation category <italic>t</italic> such that the measurement and the annotations are reproduced exactly. To determine the parameters from the marginals, we have to solve a separate matrix equivalence scaling problem per object <italic>b</italic>.</p>
      <p id="Par80">Matrix equivalence scaling problems are guaranteed to have a solution if the matrix to be scaled, that is <italic>p</italic>(<italic>gt</italic>), has only positive entries. Therefore, a small positive number is added to all the elements of <italic>p</italic>(gt) to make the problem well defined. These problems can be solved by iterative normalization of the columns and rows of <italic>p</italic>(<italic>gt</italic>). This simple algorithm is known under many names, for example, the RAS algorithm<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> or for doubly stochastic matrices as the Sinkhorn–Knopp algorithm<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>, and it is also the algorithm used to solve OT efficiently<sup><xref ref-type="bibr" rid="CR49">49</xref></sup>. In contrast to OT, where there is a single matrix scaling problem, here a separate problem is solved for every object. Although this initially seems like a practical performance problem, these problems can be solved in parallel and use the same data, leading to speedups by reducing memory accesses. Moreover, we use the sparsity of the count frequency matrix <italic>p</italic>(bg) to implement the RAS algorithm very efficiently for the problem at hand.</p>
      <p id="Par81">By rescaling the resulting <italic>p</italic>(<italic>gtb</italic>) with the total weight per object (for example, total counts per cell for sequencing data), a consistent annotation-resolved split of the measurement is obtained, consisting of floating-point numbers. For expression count data, this split generally includes many values much smaller than 1. To optimize sparsity and obtain integer counts, an option is available to round this result by flooring and redistributing the remaining reads (via multinomial sampling from the remainders). The resulting split count matrix retains biological signal and can be used in standard downstream analyses (Extended Data Fig. <xref rid="Fig6" ref-type="fig">2</xref>).</p>
    </sec>
    <sec id="Sec42">
      <title>Single-molecule annotation</title>
      <p id="Par82">To annotate single molecules by cell-type assignment, TACCO first bins the single-molecule data in space to generate aggregate cell-like objects. TACCO then annotates them either using internal or wrapped external methods. Subsequently, TACCO maps the resulting compositional annotation back to the single molecules, as follows. First, object splitting is used to distribute molecules to annotations, resulting in a probability for every molecule species in the bin to have a certain annotation. This annotation is then distributed randomly among the molecules of that molecular species such that each molecule has only a single annotation and the population of molecules reproduce the annotation probability. Because spatial binning can introduce arbitrary boundary artifacts in the definition of local neighborhoods for molecules, TACCO repeats the binning and annotation for <italic>N</italic> (usually 2–3) spatial shifts of the Cartesian grid in steps of 1/<italic>N</italic> of the grid spacing per spatial dimension. For <italic>d</italic> spatial dimensions, this results in <italic>N</italic><sup><italic>d</italic></sup> annotations per molecule. The final annotation of each molecule is then determined by a majority vote. This simple single-molecule annotation is only feasible with fast annotation methods, which can be run multiple times on differently binned data in a reasonable amount of time.</p>
      <p id="Par83">In addition to the parameters for compositional annotation, the single-molecule annotation introduces extra parameters. We evaluated the annotation’s sensitivity to parameter value changes with respect to the baseline single-molecule TACCO configuration (Extended Data Fig. <xref rid="Fig10" ref-type="fig">6b</xref>). Sizable changes in most parameters conserved about 80% of the single-molecule annotations relative to the baseline and were consistent with the reference annotation of the osmFISH-recovered cells at about 0.6, with one notable exception as follows: increasing OT’s entropic regularization parameter epsilon leads to significant reductions in accuracy and stability as it drives the annotation to be homogeneous regardless of the data. As for compositional annotation, we therefore recommend keeping the small default value which is just large enough to make OT numerically stable in practice.</p>
    </sec>
    <sec id="Sec43">
      <title>Image-free segmentation</title>
      <p id="Par84">An image-free, density-based cell segmentation approach uses the per-molecule annotation to determine molecule assignments at critical cross-category boundaries. We assume that the exact assignment of boundaries within a category is not very important as long as it gives rise to a reasonable size of the segmented objects. The segmentation is implemented as graph-based hierarchical spectral clustering.</p>
      <p id="Par85">As the number of single molecules can easily be of the order of 10<sup>9</sup>, an efficient Euclidean sparse distance matrix computation is required. As scipy’s sparse distance matrix calculation is serial and too slow for this application, a custom, fast, parallel and still generally applicable algorithm was developed and implemented. After calculating the distances <inline-formula id="IEq18"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{spatial}}}$$\end{document}</tex-math><mml:math id="M42"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">spatial</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq18.gif"/></alternatives></inline-formula> between molecules <italic>i</italic> and <italic>j</italic> in position space, a distance contribution is added in quadrature which is derived from the single-molecule annotation <inline-formula id="IEq19"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{annotation}}}$$\end{document}</tex-math><mml:math id="M44"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">annotation</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq19.gif"/></alternatives></inline-formula> to get a combined distance: <inline-formula id="IEq20"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij}^{{\mathrm{total}}} = \surd \left( {d_{ij}^{{\mathrm{spatial}}}} \right)^2 + \left( {d_{ij}^{{\mathrm{annotation}}}} \right)^2$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">total</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>√</mml:mi><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">spatial</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">annotation</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq20.gif"/></alternatives></inline-formula>. The annotation contribution can be either zero within an annotation and infinity between annotations, automatically derived using distances between the expression profiles of the annotations or manually specified. As the clustering works on affinities and not on distances, the distances have to be transformed into affinities, which is done by a Gaussian kernel with a subcellular distance scale.</p>
      <p id="Par86">As the number of molecules is so large, the clustering algorithm has to be fast and scalable, work entirely on sparse matrices and cut the neighborship graph at sensible places to generate reasonable cells-like objects. For this, a hierarchical clustering scheme was developed based on the spectral clustering implementation of scikit-learn as follows: it can handle sparse matrices, can use algebraic multigrid solvers for speed and, for only two clusters, solve the normalized graph cut problem<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. The best cuts are found iteratively in top-down fashion (binary splitting the data at each iteration). To keep the dataset tractable for the initial cuts, the spatial structure of the data is used to generate supernodes in the graph before clustering. When the clustering comes down into the size regime of a few single cells, several heuristics are employed to determine whether to accept a proposed cut based on the shape and size of the clusters, and on comparing the affinity loss of the proposed cut to the expected cost for cutting a homogeneous bulk graph of corresponding size and dimension. The final result is another column of annotation for the molecules containing unique object ids.</p>
      <p id="Par87">For visualization, these objects are filtered to include at least 20 molecules, and the associated expression profiles are normalized as in ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup> and embedded by a tSNE. To evaluate the self-consistency of annotation and segmentation, the silhouette score of the cell-type annotations is evaluated on identically filtered and normalized profiles using the silhouette_score function from scikit-learn.</p>
    </sec>
    <sec id="Sec44">
      <title>Region definition</title>
      <p id="Par88">For spatially convoluted expression data, such as in spatial transcriptomics methods including Slide-seq and Visium, clustering (of beads or spots) in expression space is less meaningful as individual cells are mixed. ‘Regions’ which are defined both in position and expression or annotation space can be a meaningful alternative. TACCO implements a method to define such regions (Extended Data Fig. <xref rid="Fig7" ref-type="fig">3a</xref>), consisting of the following two steps: (1) construction of one <italic>k</italic>-nearest neighbors graph based on expression (or annotation) distances and another <italic>k</italic>-nearest neighbors graph based on physical distances; and (2) combination of the two graphs as a weighted sum of the graphs’ adjacencies. Putting more weight on the position space adjacency gives contiguous regions in position space, while more weight on the expression adjacency leads to separated islands of similar expression being annotated with the same region and can connect regions across different spatial samples (for example, Slide-seq pucks). To account for the missing links from the position graph between samples, the cross-sample adjacency is scaled up by a balancing weight factor. The combined adjacency matrix is then subjected to standard Leiden clustering<sup><xref ref-type="bibr" rid="CR51">51</xref></sup> which assigns consistent region annotation across samples.</p>
    </sec>
    <sec id="Sec45">
      <title>Colocalization and neighborhood analysis</title>
      <p id="Par89">To score colocalization or co-occurrence of annotations<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>, TACCO calculates <italic>p</italic>(anno|center;<italic>x</italic>)/<italic>p</italic>(anno), the probability to find an annotation ‘anno’ at a distance <italic>x</italic> from a center annotation ‘center’ normalized by the probability to find ‘anno’ regardless of a ‘center’. This is well defined also for noncategorical annotations, which are commonplace for the compositional annotations created with TACCO and for pairs of unrelated annotations.</p>
      <p id="Par90">As the most time-consuming computations for co-occurrence are the same as for neighborhood-enrichment analyses, TACCO also calculates neighborhood-enrichment <italic>z</italic>-scores<sup><xref ref-type="bibr" rid="CR52">52</xref></sup> for a set of distance bins (as opposed to the set of direct neighbors on a graph) and again supports noncategorical annotation, pairs of unrelated annotations for ‘anno’ and ‘center’, and multiple samples while being competitive performance-wise (Extended Data Fig. <xref rid="Fig13" ref-type="fig">9</xref>).</p>
    </sec>
    <sec id="Sec46">
      <title>Annotation coordinates</title>
      <p id="Par91">To analyze a given annotation (for example, cell-type composition) with respect to its spatial distance from a reference annotation (for example, histological annotation; Extended Data Fig. <xref rid="Fig7" ref-type="fig">3b,c</xref>), TACCO implements an algorithm that determines a stable ‘annotation coordinate’ in position space by regularizing the minimum distance by a critical neighborhood size determined at the weights level and afterward correcting for the regularization bias. (This is required because for noisy spatial data and/or noncategorical reference annotations, simply taking the minimal distance between objects of certain annotations is unstable and/or not well defined.)</p>
      <p id="Par92">Specifically, TACCO first generates a matrix <italic>n</italic><sub><italic>A,x</italic></sub>(<italic>d</italic>) of occurrence histograms versus spatial distance <italic>d</italic> for every annotation category <italic>A</italic> and spatial position <italic>x</italic>, counting fractional annotations as fractional occurrence counts. The distance <inline-formula id="IEq21"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M48"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq21.gif"/></alternatives></inline-formula> where its cumulative sum over distance <inline-formula id="IEq22"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N_{A,x}\left( d \right) = \mathop {\sum}\nolimits_{{{{\mathrm{d}}}}^{\prime} = 0}^{{{\mathrm{d}}}} {n_{A,x}\left( {d^{\prime} } \right)}$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="normal">d</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">d</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq22.gif"/></alternatives></inline-formula> will be over a certain threshold <italic>N</italic><sub><italic>l</italic></sub> is a robust measure for the radius of the sphere centered at <italic>x</italic> and containing a total of <italic>N</italic><sub><italic>l</italic></sub> occurrences of annotation <italic>A</italic>. Even for data homogeneously annotated with <italic>A</italic>, the minimal possible value of <inline-formula id="IEq23"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M52"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq23.gif"/></alternatives></inline-formula> is however larger than 0 as the threshold <italic>N</italic><sub><italic>l</italic></sub> will in general be larger than <italic>l</italic> to have a stabilizing effect. To allow for a minimum value of 0 and obtain a measure for the distance from <italic>x</italic> to a significant amount of category <italic>A</italic>, <inline-formula id="IEq24"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M54"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq24.gif"/></alternatives></inline-formula> is corrected using a fictitious homogeneous annotation category <italic>H</italic> and the value of <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq25"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M56"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq25.gif"/></alternatives></inline-formula>) is found, followed by solving for the distance <inline-formula id="IEq26"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M58"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq26.gif"/></alternatives></inline-formula> at which <italic>N</italic><sub><italic>l</italic></sub> less occurrences appeared: <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq27"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M60"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq27.gif"/></alternatives></inline-formula>) = <italic>N</italic><sub><italic>H,x</italic></sub>(<inline-formula id="IEq28"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^l$$\end{document}</tex-math><mml:math id="M62"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq28.gif"/></alternatives></inline-formula>) – <italic>N</italic><sub><italic>l</italic></sub>. <inline-formula id="IEq29"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{A,x}^0$$\end{document}</tex-math><mml:math id="M64"><mml:msubsup><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq29.gif"/></alternatives></inline-formula> is now consistent with the regular minimum distance for noise-free categorical annotations, stable against noise and well defined for compositional annotations.</p>
    </sec>
    <sec id="Sec47">
      <title>Enrichments</title>
      <p id="Par93">TACCO supports various approaches to visualize compositional differences in the spatial structure of a sample and estimate the statistical significance of these differences/enrichments (Extended Data Fig. <xref rid="Fig7" ref-type="fig">3d–g</xref>). In particular, TACCO uses sample information to calculate enrichments not across observations (single cells/spatial beads, which are no independent observations and can lead to <italic>P</italic> value inflation), but across multiple samples, which gives meaningful and reasonable <italic>P</italic> values.</p>
      <p id="Par94">When there is just a single (or few) spatial sample(s) but with considerable size, different parts of that sample are treated as semi-independent biological replicates, by splitting the sample along a selection of coordinate axes to create a statistical ensemble for enrichment analysis. Increasing the number of splits to parts that cannot be regarded as independent replicates interpolates smoothly to where every observation is considered independent.</p>
    </sec>
    <sec id="Sec48">
      <title>Reporting summary</title>
      <p id="Par95">Further information on research design is available in the <xref rid="MOESM1" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec id="Sec49" sec-type="materials|methods">
    <title>Online content</title>
    <p id="Par96">Any methods, additional references, Nature Portfolio reporting summaries, source data, extended data, supplementary information, acknowledgements, peer review information; details of author contributions and competing interests; and statements of data and code availability are available at 10.1038/s41587-023-01657-3.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <sec id="Sec51">
      <title>Supplementary information</title>
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41587_2023_1657_MOESM1_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <app-group>
    <app id="App1">
      <sec id="Sec50">
        <title>Extended data</title>
        <p id="Par101">
          <fig id="Fig5">
            <label>Extended Data Fig. 1</label>
            <caption>
              <title>Effect of choice of cost matrix metric in OT and several booster options (platform normalization, multicenter, bisection) on annotation quality.</title>
              <p>L2 error (y axis, top; relevant for mixture annotations) and fraction of objects where the maximum annotation disagrees with the reference (y axis, bottom; relevant for classification problems) for different methods (colors) on different use cases (x axis). Baseline TACCO used the Bhattacharyya metric, platform normalization, multicenter, and bisection. Single cell: annotation of mouse colon scRNA-seq with itself as reference; Mixture: Gaussian mixtures of mouse colon scRNA-seq (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>); Dropout: simulated Dropout dataset (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>); Ambient: simulated ambient dataset (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>), Differentiation: hematopoiesis scRNA-seq (Fig. <xref rid="Fig3" ref-type="fig">3c</xref>).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig5_ESM" id="d32e3633"/>
          </fig>
        </p>
        <p id="Par102">
          <fig id="Fig6">
            <label>Extended Data Fig. 2</label>
            <caption>
              <title>TACCO splitting of mixed expression profiles into pure constituents.</title>
              <p>UMAP embeddings of in-silico mixed mouse colon scRNA-seq profiles (top four rows: real or balanced type composition and with and without downscaling the count-yield per cell by a factor of 10) or Slide-seq beads (bottom row), based on ground truth (far left, where available), TACCO annotation (second left), reference data (second right) and mixed expression data split using TACCO’s annotation as input embedded in a joint UMAP of the concatenated reference-split dataset (rightmost). The in silico mix uses a beadsize of 1.0. For the joint embedding data was filtered to include only observations with at least 30 counts in genes which were annotated highly variable in the reference dataset, except for capture_rate = 1.0 where a threshold of 100 is used.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig6_ESM" id="d32e3647"/>
          </fig>
        </p>
        <p id="Par103">
          <fig id="Fig7">
            <label>Extended Data Fig. 3</label>
            <caption>
              <title>Example workflow and visualizations for spatial data analysis in TACCO for the mouse colon dataset from the ‘Spatial mixture’ task (Fig. <xref rid="Fig2" ref-type="fig">2b</xref>).</title>
              <p>(<bold>a</bold>) Slide-seq puck with beads colored by regions defined by joint expression space and position space clustering. (<bold>b</bold>) Fraction of cells (y axis) of each type (color) in each region (x axis). (<bold>c</bold>) Slide-seq puck colored by the effective distance of each bead from each region. (<bold>d</bold>) Density (y axis) of cell type annotations at different effective distance from region 2 (x axis). (<bold>e</bold>) Slide-seq puck colored by spatial split of the puck along a selected coordinate axis into multiple biological replicates for statistical enrichment analysis. (<bold>f</bold>) Geometric mean normalized cell type fractions (y axis) for each cell type (x axis) from each region (1–4) and subregion (per spatial split as in e; individual bars). (<bold>g</bold>) Enrichment p-values (colors) of the normalized cell fractions in (f) (Benjamini-Hochberg-corrected one-sided Mann-Whitney-U test across spatial splits).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig7_ESM" id="d32e3686"/>
          </fig>
        </p>
        <p id="Par104">
          <fig id="Fig8">
            <label>Extended Data Fig. 4</label>
            <caption>
              <title>Annotating mouse olfactory bulb Slide-seq data<sup><xref ref-type="bibr" rid="CR31">31</xref></sup> using an scRNA-seq data<sup><xref ref-type="bibr" rid="CR32">32</xref></sup> with TACCO.</title>
              <p>(a) Compositional cell type annotation. Annotations (color legend) from a single TACCO run on 40 Slide-seq pucks across 2 replicates (replicate 1 in 1st and 3rd columns, replicate 2 in 2nd and 4th columns); (<bold>b</bold>) Comparison of different annotation strategies. Compositional cell type annotation (first row, color legend) and normalized cell type weights (remaining rows, color bar) from either direct compositional annotation of the spatial data (left column; default TACCO workflow, as in (a)); compositional single cell annotation of the spatial data, and deriving the cell type annotation from the single cell cell-type annotation (middle column); or positional annotation of the single cells in the reference with plotting the categorical cell type annotation at the positions of the beads with the maximum weight per cell (right column).</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig8_ESM" id="d32e3711"/>
          </fig>
        </p>
        <p id="Par105">
          <fig id="Fig9">
            <label>Extended Data Fig. 5</label>
            <caption>
              <title>Comparisons of single-molecule annotations for osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>.</title>
              <p><bold>(a)</bold> tSNE of the expression profiles for objects (dots) resulting from different combinations of annotation (TACCO, Baysor<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>) and segmentation (TACCO, Baysor) methods (columns), colored by the aggregated single-molecule annotation from TACCO, Baysor, and SSAM (rows); <bold>(b)</bold> Distribution of annotations from the reference, Baysor and SSAM over the TACCO single molecule annotations; <bold>(c,d)</bold> Distributions of TACCO’s single-molecule annotations with respect to Baysor (c) and SSAM (d) single-molecule annotations.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig9_ESM" id="d32e3745"/>
          </fig>
        </p>
        <p id="Par106">
          <fig id="Fig10">
            <label>Extended Data Fig. 6</label>
            <caption>
              <title>Analysis of single-molecule annotations for osmFISH<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>.</title>
              <p><bold>(a)</bold> SSAM<sup><xref ref-type="bibr" rid="CR36">36</xref></sup> pixel-based annotation mapped to single molecules (presented like TACCO’s and Baysor’s<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> single-molecule annotations in Fig. <xref rid="Fig2" ref-type="fig">2c</xref> (2,3)): Entire section profiled by osmFISH (left) and zoom-in on a small region (right) with the positions and mapped cell-type annotation of each measured molecule. <bold>(b)</bold> Impact of different choices (x axis) for different parameter categories (color) on TACCO’s single molecule annotation, based on consistency with annotation from osmFISH-recovered cells (y axis, top) or with the base configuration of the annotation, which is used in all other single molecule analyses with TACCO (y axis, bottom). <bold>(c)</bold> Comparison of cell type composition analysis (p(annotations|center = hippocampus), y axis) at different distances from the hippocampus region annotation (x axis) for each cell type annotation (color) from different methods (label top), all using a single cell type per segmented object; unlike in Fig. <xref rid="Fig2" ref-type="fig">2e</xref>), the hippocampus region annotation from osmFISH-recovered cells is used for all panels, as Baysor did not recover any hippocampus annotation.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig10_ESM" id="d32e3786"/>
          </fig>
        </p>
        <p id="Par107">
          <fig id="Fig11">
            <label>Extended Data Fig. 7</label>
            <caption>
              <title>Comparison of methods performance on the differentiation task.</title>
              <p>scRNA-seq profiles (dots) from a hematopoiesis dataset<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> colored by the eventual clonal fate of day 2 cells (leftmost) and by the predicted clonal fates of day 2 cells, for each method from Fig. <xref rid="Fig3" ref-type="fig">3c</xref> (4)). Reference profiles from differentiated cells (day 4 and 6) are in gray.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig11_ESM" id="d32e3807"/>
          </fig>
        </p>
        <p id="Par108">
          <fig id="Fig12">
            <label>Extended Data Fig. 8</label>
            <caption>
              <title>Impact of parameter variations on TACCO’s runtime, memory requirement and accuracy of annotation transfer.</title>
              <p>Runtime (y axis, top), memory requirement (y axis, middle) and L2 error (y axis, bottom) of each parameter choice (colors) in the ‘Mixture’ (left; with beadsize = 1.0), ‘Dropout’ (middle; with dropmidpoint = −1.00) and ‘Differentiation’ (right) use cases, at different numbers of observations (cells or beads, x axis), ranging from <inline-formula id="IEq30"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{10} \approx 1k$$\end{document}</tex-math><mml:math id="M66"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mi>k</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq30.gif"/></alternatives></inline-formula> to <inline-formula id="IEq31"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{20} \approx 1M$$\end{document}</tex-math><mml:math id="M68"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>20</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mi>M</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq31.gif"/></alternatives></inline-formula>, which are up/down sampled from the datasets in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. Reference size is fixed at <inline-formula id="IEq32"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2^{14} \approx 16k$$\end{document}</tex-math><mml:math id="M70"><mml:mrow><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>14</mml:mn></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>16</mml:mn><mml:mi>k</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41587_2023_1657_Article_IEq32.gif"/></alternatives></inline-formula>. The maximum compute resources per run are 8 CPU cores for 8 hours with 8 GB memory each.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig12_ESM" id="d32e3890"/>
          </fig>
        </p>
        <p id="Par109">
          <fig id="Fig13">
            <label>Extended Data Fig. 9</label>
            <caption>
              <title>Runtime comparison of TACCO and Squidpy<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>.</title>
              <p>Run time (y axis) co-occurrence (a) and neighborhood enrichment (b) analyses for TACCO (blue) and Squidpy (orange). Datasets ‘imc’ and ‘seqfish’ are example datasets provided with Squidpy.</p>
            </caption>
            <graphic position="anchor" xlink:href="41587_2023_1657_Fig13_ESM" id="d32e3908"/>
          </fig>
        </p>
      </sec>
    </app>
  </app-group>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
    <fn>
      <p>These authors contributed equally: Simon Mages, Noa Moriel and Inbal Avraham-Davidi.</p>
    </fn>
  </fn-group>
  <sec>
    <sec id="FPar1">
      <title>Extended data</title>
      <p id="Par97">is available for this paper at 10.1038/s41587-023-01657-3.</p>
    </sec>
    <sec id="FPar2" sec-type="supplementary-material">
      <title>Supplementary information</title>
      <p id="Par98">The online version contains supplementary material available at 10.1038/s41587-023-01657-3.</p>
    </sec>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank L. Gaffney for help with figure preparation. S.M. was supported by a DFG research fellowship (MA 9108/1-1), N.M. was supported by the Israeli Council for Higher Education PhD fellowship, J.K. was supported by a HFSP long-term fellowship (LT000452/2019-L), A.R. was a Howard Hughes Medical Institute (HHMI) Investigator when conducting this work. The work was supported by the Klarman Cell Observatory, a CEGS grant (5RM1HG006193-09) from the NHGRI, the NIH/NIAID (grants 1U24 CA180922, 1U19 MH114821, 1RC2 DK114784), the MIT Ludwig Center, the Manton Family Foundation, and HHMI (A.R.); Azrieli Foundation Early Career Faculty Fellowship, Google Research Scholar program, an Israel Science Foundation research grant (1079/21), the European Union (ERC, DecodeSC, 101040660) (M.N.) and the Center for Interdisciplinary Data Science Research at the Hebrew University of Jerusalem (N.M. and M.N.). Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or the European Research Council. Neither the European Union nor the granting authority can be held responsible for them. This publication is part of the Human Cell Atlas (<ext-link ext-link-type="uri" xlink:href="http://www.humancellatlas.org/publications/">www.humancellatlas.org/publications/</ext-link>).</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>N.M., I.A.-D., M.N. and A.R. conceived the study; S.M., N.M., J.K. and M.N. developed the algorithms and framework, with input from I.A.-D. and guidance from A.R.; S.M. and N.M. implemented the software and performed the analyses and benchmarks, with contributions from J.W.; I.A.-D., E.M. and F.C. provided mouse colon Slide-Seq data; I.A.-D., O.R.-R. and A.R. provided mouse colon single-cell RNA-seq data; I.A.-D., J.K. and A.R. assessed and interpreted biological applications; J.K., A.R. and M.N. supervised the research; S.M., N.M., I.A.-D., J.K., A.R. and M.N. wrote the manuscript.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar3">
      <title>Peer review information</title>
      <p id="Par99"><italic>Nature Biotechnology</italic> thanks the anonymous reviewers for their contribution to the peer review of this work.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The datasets analyzed during the current study are available from <ext-link ext-link-type="uri" xlink:href="http://linnarssonlab.org/osmFISH/availability/">http://linnarssonlab.org/osmFISH/availability/</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE121891</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE169012</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://github.com/AllonKleinLab/paper-data/tree/master/Lineage_tracing_on_transcriptional_landscapes_links_state_to_fate_during_differentiation">https://github.com/AllonKleinLab/paper-data/tree/master/Lineage_tracing_on_transcriptional_landscapes_links_state_to_fate_during_differentiation</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP2038">https://singlecell.broadinstitute.org/single_cell/study/SCP2038</ext-link>.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>TACCO is available as the open-source python package tacco, with source code freely available at <ext-link ext-link-type="uri" xlink:href="https://github.com/simonwm/tacco">https://github.com/simonwm/tacco</ext-link> and corresponding documentation at <ext-link ext-link-type="uri" xlink:href="https://simonwm.github.io/tacco/">https://simonwm.github.io/tacco/</ext-link>.</p>
  </notes>
  <notes id="FPar4" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par100">A.R. is a cofounder and equity holder of Celsius Therapeutics, an equity holder in Immunitas, and was a SAB member of ThermoFisher Scientific, Syros Pharmaceuticals, Neogene Therapeutics and Asimov until 31 July 2020. From 1 August 2020, A.R. is an employee of Genentech and has equity in Roche. F.C. is a founder and holds equity in Curio Biosciences. A.R. and O.R.-R. are co-inventors on patent applications filed by the Broad Institute for inventions related to single-cell genomics. O.R.-R. has given numerous lectures on the subject of single-cell genomics to a wide variety of audiences, and in some cases, she has received remuneration to cover time and costs. O.R.-R. is an employee of Genentech since October 19, 2020, and has equity in Roche. The remaining authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Integrative single-cell analysis</article-title>
        <source>Nat. Rev. Genet.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>257</fpage>
        <lpage>272</lpage>
        <?supplied-pmid 30696980?>
        <pub-id pub-id-type="pmid">30696980</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xing</surname>
            <given-names>QR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Unraveling heterogeneity in transcriptome and its regulation through single-cell multi-omics technologies</article-title>
        <source>Front. Genet.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>662</fpage>
        <?supplied-pmid 32765578?>
        <pub-id pub-id-type="pmid">32765578</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wagner</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Revealing the vectors of cellular identity with single-cell genomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2016</year>
        <volume>34</volume>
        <fpage>1145</fpage>
        <lpage>1160</lpage>
        <?supplied-pmid 27824854?>
        <pub-id pub-id-type="pmid">27824854</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lähnemann</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Eleven grand challenges in single-cell data science</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>31</fpage>
        <?supplied-pmid 32033589?>
        <pub-id pub-id-type="pmid">32033589</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rodriques</surname>
            <given-names>SG</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Slide-seq: a scalable technology for measuring genome-wide expression at high spatial resolution</article-title>
        <source>Science</source>
        <year>2019</year>
        <volume>363</volume>
        <fpage>1463</fpage>
        <lpage>1467</lpage>
        <?supplied-pmid 30923225?>
        <pub-id pub-id-type="pmid">30923225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stickels</surname>
            <given-names>RR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly sensitive spatial transcriptomics at near-cellular resolution with Slide-seqV2</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>39</volume>
        <fpage>313</fpage>
        <lpage>319</lpage>
        <?supplied-pmid 33288904?>
        <pub-id pub-id-type="pmid">33288904</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatially resolved single-cell genomics and transcriptomics by imaging</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>18</fpage>
        <lpage>22</lpage>
        <?supplied-pmid 33408406?>
        <pub-id pub-id-type="pmid">33408406</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cable</surname>
            <given-names>DM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Robust decomposition of cell type mixtures in spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>517</fpage>
        <lpage>526</lpage>
        <?supplied-pmid 33603203?>
        <pub-id pub-id-type="pmid">33603203</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Achim</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-throughput spatial mapping of single-cell RNA-seq data to tissue of origin</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>503</fpage>
        <lpage>509</lpage>
        <?supplied-pmid 25867922?>
        <pub-id pub-id-type="pmid">25867922</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Farrell</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Gennert</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Schier</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Spatial reconstruction of single-cell gene expression data</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>495</fpage>
        <lpage>502</lpage>
        <?supplied-pmid 25867923?>
        <pub-id pub-id-type="pmid">25867923</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Elosua-Bayes</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Nieto</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Mereu</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Gut</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Heyn</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>SPOTlight: seeded NMF regression to deconvolute spatial transcriptomics spots with single-cell transcriptomes</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2021</year>
        <volume>49</volume>
        <fpage>9</fpage>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Biancalani</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Deep learning and alignment of spatially resolved single-cell transcriptomes with Tangram</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>1352</fpage>
        <lpage>1362</lpage>
        <?supplied-pmid 34711971?>
        <pub-id pub-id-type="pmid">34711971</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nitzan</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Karaiskos</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Friedman</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Rajewsky</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Gene expression cartography</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>576</volume>
        <fpage>132</fpage>
        <lpage>137</lpage>
        <?supplied-pmid 31748748?>
        <pub-id pub-id-type="pmid">31748748</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Halpern</surname>
            <given-names>KB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell spatial reconstruction reveals global division of labour in the mammalian liver</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>542</volume>
        <fpage>352</fpage>
        <lpage>356</lpage>
        <?supplied-pmid 28166538?>
        <pub-id pub-id-type="pmid">28166538</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>SW</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>CoSpar identifies early cell fate biases from single-cell transcriptomic and lineage information</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>1066</fpage>
        <lpage>1074</lpage>
        <?supplied-pmid 35190690?>
        <pub-id pub-id-type="pmid">35190690</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schiebinger</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Optimal-transport analysis of single-cell gene expression identifies developmental trajectories in reprogramming</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>176</volume>
        <fpage>928</fpage>
        <lpage>943</lpage>
        <?supplied-pmid 30712874?>
        <pub-id pub-id-type="pmid">30712874</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Aran</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Reference-based analysis of lung single-cell sequencing reveals a transitional profibrotic macrophage</article-title>
        <source>Nat. Immunol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>163</fpage>
        <lpage>172</lpage>
        <?supplied-pmid 30643263?>
        <pub-id pub-id-type="pmid">30643263</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Herman</surname>
            <given-names>JS</given-names>
          </name>
          <name>
            <surname>Sagar</surname>
          </name>
          <name>
            <surname>Grün</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>FateID infers cell fate bias in multipotent progenitors from single-cell RNA-seq data</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>379</fpage>
        <lpage>386</lpage>
        <?supplied-pmid 29630061?>
        <pub-id pub-id-type="pmid">29630061</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Moriel</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>NovoSpaRc: flexible spatial reconstruction of single-cell gene expression with optimal transport</article-title>
        <source>Nat. Protoc.</source>
        <year>2021</year>
        <volume>16</volume>
        <fpage>4177</fpage>
        <lpage>4200</lpage>
        <?supplied-pmid 34349282?>
        <pub-id pub-id-type="pmid">34349282</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cang</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Nie</surname>
            <given-names>Q</given-names>
          </name>
        </person-group>
        <article-title>Inferring spatial and signaling relationships between cells from single cell transcriptomic data</article-title>
        <source>Nat. Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>2084</fpage>
        <?supplied-pmid 32350282?>
        <pub-id pub-id-type="pmid">32350282</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zeira</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Alignment and integration of spatial transcriptomics data</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>19</volume>
        <fpage>567</fpage>
        <lpage>575</lpage>
        <?supplied-pmid 35577957?>
        <pub-id pub-id-type="pmid">35577957</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Demetci</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Santorella</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Sandstede</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Noble</surname>
            <given-names>WS</given-names>
          </name>
          <name>
            <surname>Singh</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>SCOT: single-cell multi-omics alignment with optimal transport</article-title>
        <source>J. Comput. Biol.</source>
        <year>2022</year>
        <volume>29</volume>
        <fpage>3</fpage>
        <lpage>18</lpage>
        <?supplied-pmid 35050714?>
        <pub-id pub-id-type="pmid">35050714</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Hong</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Wan</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>Manifold alignment for heterogeneous single-cell multi-omics data integration using Pamona</article-title>
        <source>Bioinformatics</source>
        <year>2021</year>
        <volume>38</volume>
        <fpage>211</fpage>
        <lpage>219</lpage>
        <?supplied-pmid 34398192?>
        <pub-id pub-id-type="pmid">34398192</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <mixed-citation publication-type="other">Dover, K., Cang, Z., Ma, A., Nie, Q. &amp; Vershynin, R. AVIDA: alternating method for visualizing and integrating data. Preprint at <italic>arXiv</italic><ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/2206.00135">https://arxiv.org/abs/2206.00135</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly parallel genome-wide expression profiling of individual cells using nanoliter droplets</article-title>
        <source>Cell</source>
        <year>2015</year>
        <volume>161</volume>
        <fpage>1202</fpage>
        <lpage>1214</lpage>
        <?supplied-pmid 26000488?>
        <pub-id pub-id-type="pmid">26000488</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palla</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Squidpy: a scalable framework for spatial omics analysis</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>19</volume>
        <fpage>171</fpage>
        <lpage>178</lpage>
        <?supplied-pmid 35102346?>
        <pub-id pub-id-type="pmid">35102346</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Codeluppi</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatial organization of the somatosensory cortex revealed by osmFISH</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>932</fpage>
        <lpage>935</lpage>
        <?supplied-pmid 30377364?>
        <pub-id pub-id-type="pmid">30377364</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Weinreb</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Rodriguez-Fraticelli</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Camargo</surname>
            <given-names>FD</given-names>
          </name>
          <name>
            <surname>Klein</surname>
            <given-names>AM</given-names>
          </name>
        </person-group>
        <article-title>Lineage tracing on transcriptional landscapes links state to fate during differentiation</article-title>
        <source>Science</source>
        <year>2020</year>
        <volume>367</volume>
        <fpage>eaaw3381</fpage>
        <?supplied-pmid 31974159?>
        <pub-id pub-id-type="pmid">31974159</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Avraham-Davidi, I. et al. Integrative single cell and spatial transcriptomics of colorectal cancer reveals multicellular functional units that support tumor progression. Preprint at <italic>bioRxiv</italic><ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/2022.10.02.508492v1">https://www.biorxiv.org/content/10.1101/2022.10.02.508492v1</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Slyper</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell and single-nucleus RNA-Seq toolbox for fresh and frozen human tumors</article-title>
        <source>Nat. Med.</source>
        <year>2020</year>
        <volume>26</volume>
        <fpage>792</fpage>
        <lpage>802</lpage>
        <?supplied-pmid 32405060?>
        <pub-id pub-id-type="pmid">32405060</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>I-H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatial transcriptomic reconstruction of the mouse olfactory glomerular map suggests principles of odor processing</article-title>
        <source>Nat. Neurosci.</source>
        <year>2022</year>
        <volume>25</volume>
        <fpage>484</fpage>
        <lpage>492</lpage>
        <?supplied-pmid 35314823?>
        <pub-id pub-id-type="pmid">35314823</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tepe</surname>
            <given-names>B</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell RNA-seq of mouse olfactory bulb reveals cellular heterogeneity and activity-dependent molecular census of adult-born neurons</article-title>
        <source>Cell Rep.</source>
        <year>2018</year>
        <volume>25</volume>
        <fpage>2689</fpage>
        <lpage>2703</lpage>
        <?supplied-pmid 30517858?>
        <pub-id pub-id-type="pmid">30517858</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xia</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Fan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Emanuel</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatial transcriptome profiling by MERFISH reveals subcellular RNA compartmentalization and cell cycle-dependent gene expression</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2019</year>
        <volume>116</volume>
        <fpage>19490</fpage>
        <lpage>19499</lpage>
        <?supplied-pmid 31501331?>
        <pub-id pub-id-type="pmid">31501331</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eng</surname>
            <given-names>C-HL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale super-resolved imaging in tissues by RNA seqFISH</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>568</volume>
        <fpage>235</fpage>
        <lpage>239</lpage>
        <?supplied-pmid 30911168?>
        <pub-id pub-id-type="pmid">30911168</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Littman</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Joint cell segmentation and cell type annotation for spatial transcriptomics</article-title>
        <source>Mol. Syst. Biol.</source>
        <year>2021</year>
        <volume>17</volume>
        <fpage>e10108</fpage>
        <?supplied-pmid 34057817?>
        <pub-id pub-id-type="pmid">34057817</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Park</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell segmentation-free inference of cell types from in situ transcriptomics data</article-title>
        <source>Nat. Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <fpage>3545</fpage>
        <?supplied-pmid 34112806?>
        <pub-id pub-id-type="pmid">34112806</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Palla</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Fischer</surname>
            <given-names>DS</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Spatial components of molecular tissue biology</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>308</fpage>
        <lpage>318</lpage>
        <?supplied-pmid 35132261?>
        <pub-id pub-id-type="pmid">35132261</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Prabhakaran</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Nawy</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Pe’er</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Sparcle: assigning transcripts to cells in multiplexed images</article-title>
        <source>Bioinforma. Adv.</source>
        <year>2022</year>
        <volume>2</volume>
        <fpage>vbac048</fpage>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Petukhov</surname>
            <given-names>V</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell segmentation in imaging-based spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>40</volume>
        <fpage>345</fpage>
        <lpage>354</lpage>
        <?supplied-pmid 34650268?>
        <pub-id pub-id-type="pmid">34650268</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <mixed-citation publication-type="other">Kotliar, D. scsim: simulate single-cell RNA-SEQ data using the Splatter statistical framework but implemented in python. <ext-link ext-link-type="uri" xlink:href="http://github.com/dylkot/scsim">github.com/dylkot/scsim</ext-link> (2021).</mixed-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kotliar</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Identifying gene expression programs of cell-type identity and cellular activity with single-cell RNA-seq</article-title>
        <source>eLife</source>
        <year>2019</year>
        <volume>8</volume>
        <fpage>e43803</fpage>
        <?supplied-pmid 31282856?>
        <pub-id pub-id-type="pmid">31282856</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zappia</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Splatter: simulation of single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2017</year>
        <volume>18</volume>
        <fpage>174</fpage>
        <?supplied-pmid 28899397?>
        <pub-id pub-id-type="pmid">28899397</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abdelaal</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A comparison of automatic cell identification methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>194</fpage>
        <?supplied-pmid 31500660?>
        <pub-id pub-id-type="pmid">31500660</pub-id>
      </element-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Fleming, S. J. et al. Unsupervised removal of systematic background noise from droplet-based single-cell experiments using CellBender. Preprint at <italic>bioRxiv</italic><ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/791699v2">https://www.biorxiv.org/content/10.1101/791699v2</ext-link> (2022).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Drokhlyansky</surname>
            <given-names>E</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The human and mouse enteric nervous system at single-cell resolution</article-title>
        <source>Cell</source>
        <year>2020</year>
        <volume>182</volume>
        <fpage>1606</fpage>
        <lpage>1622</lpage>
        <?supplied-pmid 32888429?>
        <pub-id pub-id-type="pmid">32888429</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>15</fpage>
        <?supplied-pmid 29409532?>
        <pub-id pub-id-type="pmid">29409532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Knopp</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Sinkhorn</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Concerning nonnegative matrices and doubly stochastic matrices</article-title>
        <source>Pacific J. Math.</source>
        <year>1967</year>
        <volume>21</volume>
        <fpage>343</fpage>
        <lpage>348</lpage>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bacharach</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Estimating nonnegative matrices from marginal data</article-title>
        <source>Int. Econ. Rev.</source>
        <year>1965</year>
        <volume>6</volume>
        <fpage>294</fpage>
        <lpage>310</lpage>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Flamary</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>POT: Python optimal transport</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>1</fpage>
        <lpage>8</lpage>
      </element-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pedregosa</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Scikit-learn: machine learning in Python</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2011</year>
        <volume>12</volume>
        <fpage>2825</fpage>
        <lpage>2830</lpage>
      </element-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Traag</surname>
            <given-names>VA</given-names>
          </name>
          <name>
            <surname>Waltman</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>van Eck</surname>
            <given-names>NJ</given-names>
          </name>
        </person-group>
        <article-title>From Louvain to Leiden: guaranteeing well-connected communities</article-title>
        <source>Sci. Rep.</source>
        <year>2019</year>
        <volume>9</volume>
        <fpage>5233</fpage>
        <?supplied-pmid 30914743?>
        <pub-id pub-id-type="pmid">30914743</pub-id>
      </element-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Keren</surname>
            <given-names>L</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A structured tumor-immune microenvironment in triple negative breast cancer revealed by multiplexed ion beam imaging</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>174</volume>
        <fpage>1373</fpage>
        <lpage>1387</lpage>
        <?supplied-pmid 30193111?>
        <pub-id pub-id-type="pmid">30193111</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
