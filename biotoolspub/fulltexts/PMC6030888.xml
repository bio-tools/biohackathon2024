<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6030888</article-id>
    <article-id pub-id-type="pmid">29096012</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btx699</article-id>
    <article-id pub-id-type="publisher-id">btx699</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Applications Notes</subject>
        <subj-group subj-group-type="category-toc-heading">
          <subject>Genome Analysis</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Mosdepth: quick coverage calculation for genomes and exomes</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Pedersen</surname>
          <given-names>Brent S</given-names>
        </name>
        <xref ref-type="aff" rid="btx699-aff1">1</xref>
        <xref ref-type="aff" rid="btx699-aff2">2</xref>
        <xref ref-type="aff" rid="btx699-aff3">3</xref>
        <xref ref-type="corresp" rid="btx699-cor1"/>
        <!--<email>bpederse@gmail.com</email>-->
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Quinlan</surname>
          <given-names>Aaron R</given-names>
        </name>
        <xref ref-type="aff" rid="btx699-aff1">1</xref>
        <xref ref-type="aff" rid="btx699-aff2">2</xref>
        <xref ref-type="aff" rid="btx699-aff3">3</xref>
        <xref ref-type="corresp" rid="btx699-cor1"/>
      </contrib>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Hancock</surname>
          <given-names>John</given-names>
        </name>
        <role>Associate Editor</role>
      </contrib>
    </contrib-group>
    <aff id="btx699-aff1"><label>1</label>Department of Human Genetics, University of Utah, Salt Lake City, UT, USA</aff>
    <aff id="btx699-aff2"><label>2</label>Department of Biomedical Informatics, University of Utah, Salt Lake City, UT, USA</aff>
    <aff id="btx699-aff3"><label>3</label>USTAR Center for Genetic Discovery, University of Utah, Salt Lake City, UT, USA</aff>
    <author-notes>
      <corresp id="btx699-cor1">To whom correspondence should be addressed. Email: <email>bpederse@gmail.com</email></corresp>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>01</day>
      <month>3</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2017-10-31">
      <day>31</day>
      <month>10</month>
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>31</day>
      <month>10</month>
      <year>2017</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <!-- oupReleaseDelayRemoved from OA Article (10.1093/bioinformatics/btx699btx699APPLICATIONS NOTESGENOME ANALYSISMosdepth: quick coverage calculation for genomes and exomesPedersenBrent Sbpederse@gmail.comQuinlanAaron RHancockJohnAssociate EditorDepartment of Human Genetics, University of Utah, Salt Lake City, UT, USADepartment of Biomedical Informatics, University of Utah, Salt Lake City, UT, USAUSTAR Center for Genetic Discovery, University of Utah, Salt Lake City, UT, USATo whom correspondence should be addressed. Email: bpederse@gmail.com01March20180103201831102017345867868Supplementary Data070920170910201730102017&#x000a9; The Author 2017. Published by Oxford University Press.2017This is an Open Access article distributed under the terms of the Creative Commons Attribution Non-Commercial License (http://creativecommons.org/licenses/by-nc/4.0/), which permits non-commercial re-use, distribution, and reproduction in any medium, provided the original work is properly cited. For commercial re-use, please contact journals.permissions@oup.comAbstractSummary
            Mosdepth is a new command-line tool for rapidly calculating genome-wide sequencing coverage. It measures depth from BAM or CRAM files at either each nucleotide position in a genome or for sets of genomic regions. Genomic regions may be specified as either a BED file to evaluate coverage across capture regions, or as a fixed-size window as required for copy-number calling. Mosdepth uses a simple algorithm that is computationally efficient and enables it to quickly produce coverage summaries. We demonstrate that mosdepth is faster than existing tools and provides flexibility in the types of coverage profiles produced.Availability and implementation
            mosdepth is available from https://github.com/brentp/mosdepth under the MIT license.Supplementary information
            Supplementary data are available at Bioinformatics online.National Human Genome Research Institute10.13039/100000051NIH10.13039/100000002R01HG006693R01HG009141R01GM124355U24CA209999National Institute of General Medical Sciences10.13039/100000057National Cancer Institute10.13039/100000054) -->
    <volume>34</volume>
    <issue>5</issue>
    <fpage>867</fpage>
    <lpage>868</lpage>
    <history>
      <date date-type="received">
        <day>07</day>
        <month>9</month>
        <year>2017</year>
      </date>
      <date date-type="rev-recd">
        <day>09</day>
        <month>10</month>
        <year>2017</year>
      </date>
      <date date-type="accepted">
        <day>30</day>
        <month>10</month>
        <year>2017</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author 2017. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2017</copyright-year>
      <license license-type="cc-by-nc" xlink:href="http://creativecommons.org/licenses/by-nc/4.0/">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution Non-Commercial License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by-nc/4.0/">http://creativecommons.org/licenses/by-nc/4.0/</ext-link>), which permits non-commercial re-use, distribution, and reproduction in any medium, provided the original work is properly cited. For commercial re-use, please contact journals.permissions@oup.com</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="btx699.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Summary</title>
        <p><italic>Mosdepth</italic> is a new command-line tool for rapidly calculating genome-wide sequencing coverage. It measures depth from BAM or CRAM files at either each nucleotide position in a genome or for sets of genomic regions. Genomic regions may be specified as either a BED file to evaluate coverage across capture regions, or as a fixed-size window as required for copy-number calling. Mosdepth uses a simple algorithm that is computationally efficient and enables it to quickly produce coverage summaries. We demonstrate that <italic>mosdepth</italic> is faster than existing tools and provides flexibility in the types of coverage profiles produced.</p>
      </sec>
      <sec id="s2">
        <title>Availability and implementation</title>
        <p><italic>mosdepth</italic> is available from <ext-link ext-link-type="uri" xlink:href="https://github.com/brentp/mosdepth">https://github.com/brentp/mosdepth</ext-link> under the MIT license.</p>
      </sec>
      <sec id="s4">
        <title>Supplementary information</title>
        <p><xref ref-type="supplementary-material" rid="sup1">Supplementary data</xref> are available at <italic>Bioinformatics</italic> online.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Human Genome Research Institute</named-content>
          <named-content content-type="funder-identifier">10.13039/100000051</named-content>
          <?release-delay 12|0?>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">NIH</named-content>
          <named-content content-type="funder-identifier">10.13039/100000002</named-content>
          <?release-delay 12|0?>
        </funding-source>
        <award-id>R01HG006693</award-id>
        <award-id>R01HG009141</award-id>
        <award-id>R01GM124355</award-id>
        <award-id>U24CA209999</award-id>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute of General Medical Sciences</named-content>
          <named-content content-type="funder-identifier">10.13039/100000057</named-content>
          <?release-delay 12|0?>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Cancer Institute</named-content>
          <named-content content-type="funder-identifier">10.13039/100000054</named-content>
          <?release-delay 12|0?>
        </funding-source>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="2"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 Introduction</title>
    <p>Measuring the depth of sequencing coverage is critical for genomic analyses such as calling copy-number variation (CNV), e.g. by <italic>cn.mops</italic> (<xref rid="btx699-B1" ref-type="bibr">Klambauer <italic>et al.</italic>, 2012</xref>), quality control (<xref rid="btx699-B5" ref-type="bibr">Pedersen <italic>et al.</italic>, 2017</xref>), and determining which genomic regions have too low, or too high (<xref rid="btx699-B2" ref-type="bibr">Li, 2014</xref>) coverage for reliable variant calling. Given the scope of applications for coverage profiles, there are several existing tools that calculate genome-wide coverage. Samtools depth (<xref rid="btx699-B3" ref-type="bibr">Li <italic>et al.</italic>, 2009</xref>) outputs per-base coverage; BEDTools genomecov (<xref rid="btx699-B7" ref-type="bibr">Quinlan and Hall, 2010</xref>; <xref rid="btx699-B6" ref-type="bibr">Quinlan, 2014</xref>) can output per-region or per-base coverage; Sambamba (<xref rid="btx699-B8" ref-type="bibr">Tarasov <italic>et al.</italic>, 2015</xref>) also provides per-base and per-window depth calculations. The need for efficient coverage calculation increases with the number and depth of whole genome sequences, and existing methods require roughly an hour or more of computation for a typical human genome with 30× coverage. Here, we introduce <italic>mosdepth</italic> and show that it is faster than existing methods and has additional utility.</p>
  </sec>
  <sec>
    <title>2 Materials and methods</title>
    <p><italic>Mosdepth</italic> uses HTSLib (<ext-link ext-link-type="uri" xlink:href="http://www.htslib.org/">http://www.htslib.org/</ext-link>) via the nim programming language (<ext-link ext-link-type="uri" xlink:href="https://nim-lang.org">https://nim-lang.org</ext-link>); it expects the input BAM or CRAM file to be sorted by position. In contrast to samtools, which uses a ‘pileup’ engine that tracks each nucleotide in every read, <italic>mosdepth</italic> only tracks chunks of read alignments. Only the start and end position of each chunk of an alignment (each alignment may have multiple chunks if it is split by a deletion or other event) are tracked in an array (of 32 bit integers) whose size is the length of the chromosome. For each chunk of an alignment to the reference genome, <italic>mosdepth</italic> increments the start and decrements the end for the the value at the index in the array corresponding to that chromosomal position (<xref ref-type="fig" rid="btx699-F1">Fig. 1</xref>). It avoids double-counting coverage when the ends of a paired-end sequencing fragment have overlapping alignments (<xref ref-type="fig" rid="btx699-F1">Fig. 1</xref>, black alignment). Once the coverage array has tracked all alignment starts and ends in a BAM or CRAM file, the depth at a particular position is calculated as the cumulative sum of all array positions preceding it (a similar algorithm is used in BEDTools which track starts and ends separately).
</p>
    <fig id="btx699-F1" orientation="portrait" position="float">
      <label>Fig. 1</label>
      <caption>
        <p><italic>Mosdepth</italic> coverage calculation algorithm. An array the size of the current chromosome is allocated. As each alignment is read from a position-sorted BAM or CRAM file, the value at each start is incremented and the value at each stop is decremented. As illustrated by the alignment with a deletion (D) CIGAR operation, each alignment may have multiple starts and ends. If the leftmost read (the one seen first) of a paired-end alignment has an end that overlaps the position of its mate (which is given as a field in the BAM record) then it is stored in a hash-table until its mate is seen. At that time, the overlap between the mates is calculated, the regions of overlap are decremented and the item is removed from the hash. This prevents double counting coverage from two ends of the same paired-end DNA fragment (black alignment, ‘*’ operation means no coverage increment or decrement is made). Once all reads for a chromosome are consumed, the per-base coverage is simply the cumulative sum of the preceding positions</p>
      </caption>
      <graphic xlink:href="btx699f1"/>
    </fig>
    <p>The coverage along a chromosome is calculated in place by replacing the composite start and end counts with the cumulative sum up to each element in the array. Once complete, the coverage of a region is simply the mean of the elements in the array spanning from start to end. This makes it possible to calculate coverage extremely quickly, even for millions of small regions. This setup is also amenable to rapid calculation of a genome’s coverage distribution: that is, the number of bases covered by a given number of reads across the genome or in the given regions. The distribution calculation requires an extra iteration through the array that counts the occurrence of each coverage value. The <italic>mosdepth</italic> method does require more memory–for the 249 megabase chromosome 1 in the human genome, it will require about 1GB of memory, however, that number is not dependent on the depth of coverage or number of alignments. Despite its flexibility, <italic>mosdepth</italic> is easy to use and understand (see <xref ref-type="supplementary-material" rid="sup1">Supplementary Material</xref> for example uses).</p>
  </sec>
  <sec>
    <title>3 Results</title>
    <p>We compared the time and memory requirements of <italic>mosdepth</italic> (v0.1.6) to samtools (v1.5), BEDTools (v2.26.0) and sambamba (v0.6.6) on a BAM with about 30× coverage from the Simons Genome Diversity Panel (<xref rid="btx699-B4" ref-type="bibr">Mallick <italic>et al.</italic>, 2016</xref>) (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material</xref>). With a single CPU, mosdepth is faster than existing tools, and can be even faster with multiple decompression threads (<xref rid="btx699-T1" ref-type="table">Table 1</xref>). Results for CRAM and for other options such as window-based depth calculations are shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Table S1</xref>. At four threads, there is no additional benefit to adding more decompression threads as shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Figure S1</xref>.
<table-wrap id="btx699-T1" orientation="portrait" position="float"><label>Table 1.</label><caption><p>Comparison of depth tools for time and memory use on a 30× BAM</p></caption><table frame="hsides" rules="groups"><colgroup span="1"><col valign="top" align="left" span="1"/><col valign="top" align="char" char="." span="1"/><col valign="top" align="char" char="." span="1"/><col valign="top" align="left" span="1"/><col valign="top" align="char" char="." span="1"/></colgroup><thead><tr><th rowspan="1" colspan="1">Tool</th><th rowspan="1" colspan="1">Threads</th><th rowspan="1" colspan="1">Relative time</th><th rowspan="1" colspan="1">Time (hh:mm:ss)</th><th rowspan="1" colspan="1">Memory (MiB)</th></tr></thead><tbody><tr><td rowspan="1" colspan="1">Mosdepth</td><td rowspan="1" colspan="1">1</td><td rowspan="1" colspan="1">1</td><td rowspan="1" colspan="1">25:23</td><td rowspan="1" colspan="1">1196</td></tr><tr><td rowspan="1" colspan="1">Mosdepth</td><td rowspan="1" colspan="1">3</td><td rowspan="1" colspan="1">0.57</td><td rowspan="1" colspan="1">14:27</td><td rowspan="1" colspan="1">1196</td></tr><tr><td rowspan="1" colspan="1">Samtools</td><td rowspan="1" colspan="1">1</td><td rowspan="1" colspan="1">1.98</td><td rowspan="1" colspan="1">50:12</td><td rowspan="1" colspan="1">27</td></tr><tr><td rowspan="1" colspan="1">Sambamba</td><td rowspan="1" colspan="1">1</td><td rowspan="1" colspan="1">5.71</td><td rowspan="1" colspan="1">2:24:53</td><td rowspan="1" colspan="1">166</td></tr><tr><td rowspan="1" colspan="1">BEDtools</td><td rowspan="1" colspan="1">1</td><td rowspan="1" colspan="1">5.31</td><td rowspan="1" colspan="1">2:14:44</td><td rowspan="1" colspan="1">1908</td></tr></tbody></table><table-wrap-foot><fn id="tblfn1"><p><italic>Note</italic>: <italic>Mosdepth</italic> and BEDTools use much more memory, but <italic>mosdepth</italic> is nearly twice as fast as the next fastest tool, samtools. The threads column reflects the number of threads for BAM/CRAM decompression.</p></fn></table-wrap-foot></table-wrap></p>
    <p>To evaluate consistency between the tools, we compared the output to samtools depth. <italic>Mosdepth</italic> cannot include or exclude individual bases because of low base-quality (BQ) as can samtools depth. In contrast, samtools depth cannot avoid double-counting overlapping regions unless the BQ cutoff is set to a value &gt; 0. Therefore, we compared <italic>mosdepth</italic> without mate overlap correction to samtools depth with a BQ cutoff of 0 for chromosome 22 of the dataset used for <xref rid="btx699-T1" ref-type="table">Table 1</xref>. With this comparison set up to evaluate differences, we found no discrepancies in reported depth among the tools for the entire chromosome.</p>
  </sec>
  <sec>
    <title>4 Discussion</title>
    <p><italic>Mosdepth</italic> is a quick, convenient tool for genome-wide depth calculation. The optional coverage distribution is useful for quality control and the depth output is applicable without further processing as input to many CNV detection tools. While the method it employs requires greater memory use, it makes the implementation simple and fast, enables a straightforward coverage distribution calculation, and expedites the depth calculations for even millions of regions. <italic>Mosdepth</italic> is useful for exome, whole-genome, and targeted sequencing projects. It is available from source-code, as a binary, and from bioconda (<ext-link ext-link-type="uri" xlink:href="https://bioconda.github.io/">https://bioconda.github.io/</ext-link>).</p>
  </sec>
  <sec>
    <title>Funding</title>
    <p>This research was supported by awards to A.R.Q. from the US National Human Genome Research Institute (NIH R01HG006693 and NIH R01HG009141), the US National Institute of General Medical Sciences (NIH R01GM124355) and the US National Cancer Institute (NIH U24CA209999).</p>
    <p><italic>Conflict of Interest</italic>: none declared.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sup1">
      <label>Supplementary Data</label>
      <media xlink:href="btx699_mosdepth-supplement.docx">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ref-list>
    <title>References</title>
    <ref id="btx699-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Klambauer</surname><given-names>G.</given-names></name></person-group><etal>et al</etal> (<year>2012</year>) 
<article-title>cn.MOPS: mixture of poissons for discovering copy number variations in next-generation sequencing data with a low false discovery rate</article-title>. <source>Nucleic Acids Res</source>., <volume>40</volume>, <fpage>e69</fpage>.<pub-id pub-id-type="pmid">22302147</pub-id></mixed-citation>
    </ref>
    <ref id="btx699-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Li</surname><given-names>H.</given-names></name></person-group> (<year>2014</year>) 
<article-title>Toward better understanding of artifacts in variant calling from high-coverage samples</article-title>. <source>Bioinformatics</source>, <volume>30</volume>, <fpage>2843</fpage>–<lpage>2851</lpage>.<pub-id pub-id-type="pmid">24974202</pub-id></mixed-citation>
    </ref>
    <ref id="btx699-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Li</surname><given-names>H.</given-names></name></person-group><etal>et al</etal> (<year>2009</year>) 
<article-title>The sequence alignment/map format and samtools</article-title>. <source>Bioinformatics</source>, <volume>25</volume>, <fpage>2078</fpage>–<lpage>2079</lpage>.<pub-id pub-id-type="pmid">19505943</pub-id></mixed-citation>
    </ref>
    <ref id="btx699-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Mallick</surname><given-names>S.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>The simons genome diversity project: 300 genomes from 142 diverse populations</article-title>. <source>Nature</source>, <volume>538</volume>, <fpage>201</fpage>–<lpage>206</lpage>.<pub-id pub-id-type="pmid">27654912</pub-id></mixed-citation>
    </ref>
    <ref id="btx699-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Pedersen</surname><given-names>B.S.</given-names></name></person-group><etal>et al</etal> (<year>2017</year>) 
<article-title>Indexcov: fast coverage quality control for whole-genome sequencing</article-title>. <italic>Gigascience</italic>, <volume>11</volume>, <fpage>1</fpage>–<lpage>6</lpage>.</mixed-citation>
    </ref>
    <ref id="btx699-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Quinlan</surname><given-names>A.R.</given-names></name></person-group> (<year>2014</year>) 
<article-title>Bedtools: the swiss-army tool for genome feature analysis</article-title>. <source>Curr. Protoc. Bioinformatics</source>, <volume>47</volume>. doi:10.1002/0471250953.bi1112s47.</mixed-citation>
    </ref>
    <ref id="btx699-B7">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Quinlan</surname><given-names>A.R.</given-names></name>, <name name-style="western"><surname>Hall</surname><given-names>I.M.</given-names></name></person-group> (<year>2010</year>) 
<article-title>Bedtools: a flexible suite of utilities for comparing genomic features</article-title>. <source>Bioinformatics</source>, <volume>26</volume>, <fpage>841</fpage>–<lpage>842</lpage>.<pub-id pub-id-type="pmid">20110278</pub-id></mixed-citation>
    </ref>
    <ref id="btx699-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Tarasov</surname><given-names>A.</given-names></name></person-group><etal>et al</etal> (<year>2015</year>) 
<article-title>Sambamba: fast processing of ngs alignment formats</article-title>. <source>Bioinformatics</source>, <volume>31</volume>, <fpage>2032</fpage>–<lpage>2034</lpage>.<pub-id pub-id-type="pmid">25697820</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
