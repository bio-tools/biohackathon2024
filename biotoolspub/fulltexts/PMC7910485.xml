<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7910485</article-id>
    <article-id pub-id-type="publisher-id">21583</article-id>
    <article-id pub-id-type="doi">10.1038/s41467-021-21583-9</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Comprehensive analysis of single cell ATAC-seq data with SnapATAC</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Fang</surname>
          <given-names>Rongxin</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-8971-5616</contrib-id>
        <name>
          <surname>Preissl</surname>
          <given-names>Sebastian</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Li</surname>
          <given-names>Yang</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Hou</surname>
          <given-names>Xiaomeng</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Lucero</surname>
          <given-names>Jacinta</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-6393-2276</contrib-id>
        <name>
          <surname>Wang</surname>
          <given-names>Xinxin</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Motamedi</surname>
          <given-names>Amir</given-names>
        </name>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Shiau</surname>
          <given-names>Andrew K.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Zhou</surname>
          <given-names>Xinzhu</given-names>
        </name>
        <xref ref-type="aff" rid="Aff6">6</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Xie</surname>
          <given-names>Fangming</given-names>
        </name>
        <xref ref-type="aff" rid="Aff7">7</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3203-9535</contrib-id>
        <name>
          <surname>Mukamel</surname>
          <given-names>Eran A.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff7">7</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3454-7357</contrib-id>
        <name>
          <surname>Zhang</surname>
          <given-names>Kai</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-9618-637X</contrib-id>
        <name>
          <surname>Zhang</surname>
          <given-names>Yanxiao</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-7168-8186</contrib-id>
        <name>
          <surname>Behrens</surname>
          <given-names>M. Margarita</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-5799-5895</contrib-id>
        <name>
          <surname>Ecker</surname>
          <given-names>Joseph R.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff8">8</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-5435-1127</contrib-id>
        <name>
          <surname>Ren</surname>
          <given-names>Bing</given-names>
        </name>
        <address>
          <email>biren@ucsd.edu</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff9">9</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.1052.6</institution-id><institution-id institution-id-type="ISNI">0000000097371625</institution-id><institution>Ludwig Institute for Cancer Research, </institution></institution-wrap>La Jolla, CA USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.38142.3c</institution-id><institution-id institution-id-type="ISNI">000000041936754X</institution-id><institution>Department of Chemistry and Chemical Biology, </institution><institution>Harvard University, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.266100.3</institution-id><institution-id institution-id-type="ISNI">0000 0001 2107 4242</institution-id><institution>Center for Epigenomics, Department of Cellular and Molecular Medicine, </institution><institution>University of California, San Diego, </institution></institution-wrap>La Jolla, CA USA </aff>
      <aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="GRID">grid.250671.7</institution-id><institution-id institution-id-type="ISNI">0000 0001 0662 7144</institution-id><institution>The Salk Institute for Biological Studies, </institution></institution-wrap>La Jolla, CA USA </aff>
      <aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="GRID">grid.1052.6</institution-id><institution-id institution-id-type="ISNI">0000000097371625</institution-id><institution>Small Molecule Discovery Program, </institution><institution>Ludwig Institute for Cancer Research, </institution></institution-wrap>La Jolla, CA USA </aff>
      <aff id="Aff6"><label>6</label><institution-wrap><institution-id institution-id-type="GRID">grid.266100.3</institution-id><institution-id institution-id-type="ISNI">0000 0001 2107 4242</institution-id><institution>Biomedical Science Graduate Program, </institution><institution>University of California San Diego, </institution></institution-wrap>La Jolla, CA USA </aff>
      <aff id="Aff7"><label>7</label><institution-wrap><institution-id institution-id-type="GRID">grid.266100.3</institution-id><institution-id institution-id-type="ISNI">0000 0001 2107 4242</institution-id><institution>Department of Physics, </institution><institution>University of California, San Diego, </institution></institution-wrap>La Jolla, CA USA </aff>
      <aff id="Aff8"><label>8</label><institution-wrap><institution-id institution-id-type="GRID">grid.250671.7</institution-id><institution-id institution-id-type="ISNI">0000 0001 0662 7144</institution-id><institution>Howard Hughes Medical Institute, </institution><institution>The Salk Institute for Biological Studies, </institution></institution-wrap>La Jolla, CA USA </aff>
      <aff id="Aff9"><label>9</label><institution-wrap><institution-id institution-id-type="GRID">grid.266100.3</institution-id><institution-id institution-id-type="ISNI">0000 0001 2107 4242</institution-id><institution>Department of Cellular and Molecular Medicine, </institution><institution>Institute of Genomic Medicine, UCSD Moores Cancer Center, </institution></institution-wrap>La Jolla, CA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>26</day>
      <month>2</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>26</day>
      <month>2</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2021</year>
    </pub-date>
    <volume>12</volume>
    <elocation-id>1337</elocation-id>
    <history>
      <date date-type="received">
        <day>15</day>
        <month>6</month>
        <year>2020</year>
      </date>
      <date date-type="accepted">
        <day>1</day>
        <month>2</month>
        <year>2021</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2021</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Identification of the cis-regulatory elements controlling cell-type specific gene expression patterns is essential for understanding the origin of cellular diversity. Conventional assays to map regulatory elements via open chromatin analysis of primary tissues is hindered by sample heterogeneity. Single cell analysis of accessible chromatin (scATAC-seq) can overcome this limitation. However, the high-level noise of each single cell profile and the large volume of data pose unique computational challenges. Here, we introduce SnapATAC, a software package for analyzing scATAC-seq datasets. SnapATAC dissects cellular heterogeneity in an unbiased manner and map the trajectories of cellular states. Using the Nyström method, SnapATAC can process data from up to a million cells. Furthermore, SnapATAC incorporates existing tools into a comprehensive package for analyzing single cell ATAC-seq dataset. As demonstration of its utility, SnapATAC is applied to 55,592 single-nucleus ATAC-seq profiles from the mouse secondary motor cortex. The analysis reveals ~370,000 candidate regulatory elements in 31 distinct cell populations in this brain region and inferred candidate cell-type specific transcriptional regulators.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">Single cell analysis of transposase-accessible chromatin is deepening our understanding on the origins of cellular diversity, yet methods are limited by data sparsity. Here, the authors introduce SnapATAC, a pipeline to resolve cellular heterogeneity and reveal candidate regulatory elements across different cell populations.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Bioinformatics</kwd>
      <kwd>Computational biology and bioinformatics</kwd>
      <kwd>Epigenomics</kwd>
      <kwd>Sequencing</kwd>
    </kwd-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2021</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1" sec-type="introduction">
    <title>Introduction</title>
    <p id="Par3">A multicellular organism comprises diverse cell types, each highly specialized to carry out unique functions. Each cell lineage is established during development as a result of tightly regulated spatiotemporal gene expression programs<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, which are driven in part by sequence-specific transcription factors that interact with <italic>cis</italic>-regulatory sequences in a cell-type specific manner<sup><xref ref-type="bibr" rid="CR2">2</xref></sup>. Thus, identifying the <italic>cis</italic>-elements in the genome and their cellular specificity during development  is an essential step towards understanding the developmental programs encoded in the linear genome sequence.</p>
    <p id="Par4">Since the <italic>cis</italic>-regulatory elements are often marked by hypersensitivity to nucleases or transposases when they are active or poised to act, approaches to detect chromatin accessibility, such as ATAC-seq (Assay for Transposase-Accessible Chromatin using sequencing)<sup><xref ref-type="bibr" rid="CR3">3</xref></sup> and DNase-seq (DNase I hypersensitive sites sequencing)<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> have been widely used to map candidate <italic>cis</italic>-regulatory sequences. However, conventional assays that use bulk tissue samples as input cannot resolve cell-type-specific usage of <italic>cis</italic>-elements and lacks the resolution to study their temporal dynamics. To overcome these limitations, a number of methods have been developed for measuring chromatin accessibility in single cells. One approach involves combinatorial indexing to simultaneously analyze tens of thousands of cells<sup><xref ref-type="bibr" rid="CR5">5</xref></sup>. This strategy has been successfully applied to embryonic tissues in D. melanogaster<sup><xref ref-type="bibr" rid="CR6">6</xref></sup>, developing mouse forebrains<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> and adult mouse tissues<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. A related method, scTHS-seq (single-cell transposome hypersensitive site sequencing), has also been used to study chromatin landscapes at single-cell resolution in the adult human brains<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>. A third approach relies on isolation of individual cells using microfluidic devices (Fluidigm, C1)<sup><xref ref-type="bibr" rid="CR10">10</xref></sup> or within individually indexable wells of a nano-well array (Takara Bio, ICELL8)<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>. More recently, single-cell ATAC-seq analysis has been demonstrated on droplet-based platforms<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR13">13</xref></sup>, enabling profiling of chromatin accessibility from hundreds of thousands cells in a single experiment<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>. Hereafter, these methods are referred to collectively as single-cell ATAC-seq (scATAC-seq).</p>
    <p id="Par5">The growing volume of scATAC-seq datasets coupled with the sparsity of signals in each individual profile due to low detection efficiency (5–15% of peaks detected per cell)<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> present a unique computational challenge. To address this challenge, a number of unsupervised algorithms have been developed<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>. One approach, chromVAR<sup><xref ref-type="bibr" rid="CR15">15</xref></sup>, groups similar cells together by dissecting the variability of transcription factor (TF) motif occurrence in the open chromatin regions in each cell. Another approach employs the natural language processing techniques such as Latent Semantic Analysis (LSA)<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> and Latent Dirichlet Allocation (LDA)<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> to group cells together based on the similarity of chromatin accessibility. A third approach analyzes the variability of chromatin accessibility in cells based on the k-mer composition of the sequencing reads from each cell<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR17">17</xref></sup>. A fourth approach, Cicero<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, infers cell-to-cell similarities based on the gene activity scores predicted from their putative regulatory elements in each cell.</p>
    <p id="Par6">Because the current methods often require performing linear dimensionality reduction such as singular value decomposition (SVD) on a cell matrix of hundreds of thousands of dimensions, scaling the analysis to millions of cells remains very challenging or nearly impossible. In addition, the unsupervised identification of cell types or states in complex tissues using scATAC-seq dataset does not have the same degree of sensitivity as that from scRNA-seq<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>. One possibility is that the current methods rely on the use of predefined accessibility peaks based on the aggregate signals. There are several limitations to this choice. First, the cell-type identification could be biased toward the most abundant cell types in the tissues, and consequently lack the ability to reveal regulatory elements in the rare cell populations that could be underrepresented in the aggregate dataset. Second, a sufficient number of single-cell profiles would be required to create robust aggregate signal for creating the peak reference.</p>
    <p id="Par7">To overcome these limitations, we introduce a software package, Single Nucleus Analysis Pipeline for ATAC-seq—SnapATAC (<ext-link ext-link-type="uri" xlink:href="https://github.com/r3fang/SnapATAC">https://github.com/r3fang/SnapATAC</ext-link>)—that does not require population-level peak annotation prior to clustering. Instead, it resolves cellular heterogeneity by directly comparing the similarity in genome-wide accessibility profiles between cells. We also adopt a technique, ensemble Nyström method<sup><xref ref-type="bibr" rid="CR20">20</xref>,<xref ref-type="bibr" rid="CR21">21</xref></sup>, that improves the computational efficiency and enables the analysis of scATAC-seq from up to a million cells on typical hardware. SnapATAC also incorporates many existing tools, such as integration of scATAC-seq and scRNA-seq dataset<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>, prediction of enhancer–promoter interaction, discovery of key transcription factors<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>, identification of differentially accessible elements<sup><xref ref-type="bibr" rid="CR23">23</xref></sup>, construction of trajectories during cellular differentiation, correction of batch effect<sup><xref ref-type="bibr" rid="CR24">24</xref></sup> and classification of new dataset based on existing cell atlas<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>, into one single package to maximize its utility and functionalities. Thus, SnapATAC represents a comprehensive solution for scATAC-seq analysis.</p>
    <p id="Par8">Through extensive benchmarking using both simulated and empirical datasets from diverse tissues and species, we show that SnapATAC outperforms current methods in accuracy, sensitivity, scalability and reproducibility for cell-type identification from complex tissues. Furthermore, we demonstrate the utility of SnapATAC by building a high-resolution single-cell atlas of the mouse secondary motor cortex. This atlas comprises of ~370,000 candidate <italic>cis</italic>-regulatory elements across 31 distinct cell types, including rare neuronal cell types that account for less than 0.1% of the total population analyzed. Through motif enrichment analysis, we further infer potential key transcriptional regulators that control cell-type specific gene expression programs in the mouse brain.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Overview of SnapATAC workflow</title>
      <p id="Par9">A schematic overview of SnapATAC workflow is displayed in Fig. <xref rid="Fig1" ref-type="fig">1</xref>. SnapATAC first performs preprocessing of sequencing reads including demultiplexing, reads alignments and filtering, duplicate removal and barcode selection using SnapTools (<ext-link ext-link-type="uri" xlink:href="https://github.com/r3fang/SnapTools">https://github.com/r3fang/SnapTools</ext-link>) (Methods section). The output of this preprocessing step is a snap (Single-Nucleus Accessibility Profiles) file specially formatted for storing single-cell ATAC-seq datasets (Supplementary Fig. <xref rid="MOESM1" ref-type="media">1a</xref>). A snap file contains numerous quality control metrics and users could select high-quality single-cell profiles for subsequent analysis based on metrics such as the number of unique fragments detected from the cell and percentage of promoter-overlapping fragments<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>.<fig id="Fig1"><label>Fig. 1</label><caption><title>Schematic overview of SnapATAC analysis workflow.</title><p>See Methods section for details of each step.</p></caption><graphic xlink:href="41467_2021_21583_Fig1_HTML" id="d32e625"/></fig></p>
      <p id="Par10">Next, SnapATAC resolves the heterogeneity of cell population by assessing the similarity of chromatin accessibility between cells. To achieve this goal, each single-cell chromatin accessibility profile is represented as a binary vector, the length of which corresponds to the number of uniform-sized bins that segment the genome. Through systematic benchmarking, a bin size of 5 kb is chosen in this study (Supplementary Fig. <xref rid="MOESM1" ref-type="media">2b</xref>). A bin with value “1” indicates that one or more reads fall within that bin, and the value “0” indicates otherwise. The set of binary vectors from all the cells are converted into a Jaccard similarity matrix, with the value of each element calculated from the fraction of overlapping bins between every pair of cells. Because the value of Jaccard Index could be influenced by sequencing depth of a cell, a regression-based normalization method is developed to remove such confounding factor (Supplementary Figs. <xref rid="MOESM1" ref-type="media">3</xref>–<xref rid="MOESM1" ref-type="media">4</xref>). Using the normalized similarity matrix, eigenvector decomposition is performed for dimensionality reduction. Finally, in the reduced dimension, SnapATAC uses Harmony<sup><xref ref-type="bibr" rid="CR24">24</xref></sup> to remove potential batch effect between samples introduced by technical variability (Methods section).</p>
      <p id="Par11">The computational cost of the algorithm scales quadratically with the number of cells. To improve the scalability of SnapATAC, an efficient technique to generate low-rank matrix approximations—the Nyström method<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>—is used to generate the low-rank embedding for large-scale datasets (Methods section). Nyström method contains two major steps: (1) it computes the low-dimension embedding for a subset of selected cells (also known as landmarks); (2) it projects the remaining cells to the embedding structure learned from the landmarks. This achieves significant speedup considering that the number of landmarks could be substantially smaller than the total number of cells. Through benchmarking, we further demonstrate that this approach will not sacrifice the performance once the landmarks are chosen appropriately (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5a–c</xref> and Methods section) as reported before<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>.</p>
      <p id="Par12">Nyström method is stochastic and could yield different clustering results in each sampling. To overcome this limitation, a consensus approach is used that combines a mixture of low-dimensional manifolds learned from different sets of sampling (Methods section). Through benchmarking, we demonstrate that the ensemble approach can significantly improve the reproducibility of clustering outcome compared to the standard Nyström method (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5d</xref>). In addition, this consensus algorithm naturally fits within the distributed computing environments where their computational costs are roughly the same as that of the standard single sampling method.</p>
      <p id="Par13">As a standalone software package, SnapATAC also provides a number of commonly used functions for scATAC-seq analysis by incorporating many existing useful tools, as described below:</p>
      <p id="Par14">First, to facilitate the annotation of resulting cell clusters, SnapATAC provides three different approaches: (i) SnapATAC annotates the clusters based on the accessibility score at the canonical marker genes (Methods section); (ii) it infers cell-type labels by integrating with corresponding single-cell RNA-seq datasets<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> (Methods section); (iii) it allows supervised annotation of new single-cell ATAC-seq dataset based on an existing cell atlas (Methods section).</p>
      <p id="Par15">Second, SnapATAC allows identification of the candidate regulatory elements in each cluster by applying peak-calling algorithm<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> to the aggregate chromatin profiles. Differential analysis is then performed to identify cell-type-specific regulatory elements<sup><xref ref-type="bibr" rid="CR23">23</xref></sup>. Candidate master transcription factors in each cell cluster are discovered through motif enrichment analysis of the differentially accessible regions in each cluster<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>. SnapATAC further conducts Genomic Regions Enrichment of Annotation Tool (GREAT)<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> analysis to identify the biological pathways active in each cell type.</p>
      <p id="Par16">Third, SnapATAC incorporates an approach to link candidate regulatory elements to their putative target genes. In contrast to previous method<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> that relies on analysis of coaccessibility of putative enhancers and promoters, SnapATAC infers the linkage based on the association between gene expression and chromatin accessibility in single cells where scRNA-seq data is available (Methods section). First, SnapATAC integrates scATAC-seq and scRNA-seq<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>. Second, for each scATAC-seq profile, a corresponding gene expression profile is imputed based on the weighted average of its <italic>k</italic>-nearest neighboring cells (i.e., k = 15) in the scRNA-seq dataset. A “pseudo” multiomics cell is created that contains the information of both chromatin accessibility and gene expression. Finally, logistic regression is used to quantify the association between the gene expression and binarized accessibility state at putative enhancers (Methods section). This approach is used to integrate ~15 K peripheral blood mononuclear cells (PBMC) chromatin profiles and ~10 K PBMC transcriptomic profiles (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). These two datasets are represented in a joint t-SNE embedding space (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>) with 98% of the single-cell ATAC-seq cells can be confidently assigned to a cell type defined in the scRNA-seq dataset (Supplementary Fig. <xref rid="MOESM1" ref-type="media">6a</xref>). Enhancer-gene pairs are predicted for 3000 genes differentially expressed between cell types in PBMC as determined by scRNA-seq. The validity of the prediction is supported by two lines of evidence. First, the association score exhibits a distance decay from the TSS, consistent with the distance decay of interaction frequency observed in chromatin conformation study<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">6b</xref>). Second, the predictions match well with the expression quantitative trait loci (<italic>cis</italic>-eQTLs) derived from interferon-γ and lipopolysaccharide stimulation of monocytes<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> with reasonable prediction power (AUROC = 0.66, AUPRC = 0.68; Supplementary Fig. <xref rid="MOESM1" ref-type="media">6c–d</xref> and Methods section). It is important to note that while statistical association between scATAC-seq and scRNA-seq provides another approach to symmetrically link enhancers to their putative target genes, the predictions would require further experimental validation.<fig id="Fig2"><label>Fig. 2</label><caption><title>SnapATAC facilitates integration of single-cell ATAC-seq and RNA-seq data to link enhancers to putative target genes.</title><p><bold>a</bold> Joint t-SNE visualization of scATAC-seq and scRNA-seq datasets from peripheral blood mononuclear cells (PBMC). Cells are colored by modality (left) and predicted cell types (right). <bold>b</bold> Cell-type-specific chromatin landscapes are shown together with the association score between gene expression of C3AR1 and accessibility at its putative enhancers (logistic regression coefficient <italic>p</italic>-value; Methods section). Dash lines highlight the significant enhancer–promoter pairs. Yellow line represents the SNP (rs2072449) that is previously identified to be associated with C3AR1 expression.</p></caption><graphic xlink:href="41467_2021_21583_Fig2_HTML" id="d32e744"/></fig></p>
      <p id="Par17">Fourth, SnapATAC has incorporated a function to construct cellular trajectories from single-cell ATAC-seq. As a demonstration of this feature, SnapATAC is used to analyze a dataset that contains 4259 cells from the hippocampus in the fetal mouse brain (E18) (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). Immature granule cells originating in the dentate gyrus give rise to both mature granule cells (DG) and pyramidal neurons (CA3)<sup><xref ref-type="bibr" rid="CR30">30</xref></sup>. Analysis of 4259 cells reveals a clear branching structure in the first two dimensions (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>), the pattern of which is similar to the result previously obtained from single-cell transcriptomic analysis<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>. For instance, the DG-specific transcription factor Prox1 is exclusively accessible in one branch whereas Neurod6 that is known to be specific to CA3 are accessible in the other branch. Markers of progenitors such as Hes5 and Mki67, however, are differentially accessible before the branching point (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>). Further using lineage inference tool such as Slingshot<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, SnapATAC defines the trajectories of cell states for pseudo-time analysis (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>). These results demonstrate that SnapATAC can also reveal lineage trajectories with high accuracy.<fig id="Fig3"><label>Fig. 3</label><caption><title>SnapATAC constructs cellular trajectories for the developing mouse brain.</title><p><bold>a</bold> Two-dimensional visualization of a dataset that contains 4259 single-cell chromatin profiles from the hippocampus and ventricular zone in embryonic mouse brain (E18) reveals two-branch differentiation trajectories from progenitor cells to Granule Cells (DG) and Pyramidal Neurons (CA3) (left). Data source is listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>. The cellular trajectory is determined using Slingshot. <bold>b</bold> Gene accessibility score (Methods section) of canonical marker genes is projected onto the 2D embedding.</p></caption><graphic xlink:href="41467_2021_21583_Fig3_HTML" id="d32e790"/></fig></p>
    </sec>
    <sec id="Sec4">
      <title>Performance evaluation</title>
      <p id="Par18">To compare the accuracy of cell clustering between SnapATAC and published scATAC-seq analysis methods, a simulated dataset of scATAC-seq profiles is generated with varying coverages, from 10,000 (high coverage) to 1000 reads per cell (low coverage) by down sampling from 10 previously published bulk ATAC-seq datasets<sup><xref ref-type="bibr" rid="CR22">22</xref></sup> (Supplementary Table <xref rid="MOESM1" ref-type="media">2</xref> and Methods section). Based on a recent summary of single-cell ATAC-seq methods<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>, LSA<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> and <italic>cis</italic>-Topic<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> outperforms the other methods in separating cell populations of different coverages and noise levels in both synthetic and real datasets. Therefore, we choose to compare SnapATAC with these two methods.</p>
      <p id="Par19">The performance of each method in identifying the original cell types is measured by both Adjusted Rank Index (ARI) and Normalized Mutual Index (NMI). The comparison shows that SnapATAC is the most robust and accurate method across all ranges of data sparsity (Wilcoxon signed-rank test, <italic>p</italic> &lt; 0.01; Fig. <xref rid="Fig4" ref-type="fig">4a</xref>; Supplementary Fig. <xref rid="MOESM1" ref-type="media">7</xref>). Next, a set of 1423 human cells corresponding to 10 distinct cell types generated using C1 Fluidigm platform, where the ground truth is known<sup><xref ref-type="bibr" rid="CR15">15</xref></sup>, is analyzed by SnapATAC and other methods. Again, SnapATAC correctly identifies the cell types with high accuracy (Supplementary Fig. <xref rid="MOESM1" ref-type="media">8</xref>).<fig id="Fig4"><label>Fig. 4</label><caption><title>SnapATAC outperforms current methods in accuracy, sensitivity, scalability, and stability of identifying cell types in complex tissues.</title><p><bold>a</bold> A set of simulated datasets are generated with varying coverage ranging from 1000 to 10,000 reads per cell cells (Methods section). For each coverage, <italic>n</italic> = 10 random replicates are simulated, and clustering accuracy measurement is based on Adjusted Rank Index (ARI). Data are presented as median values ± 25% percentile. <bold>b</bold> T-SNE representation of PBMC single-cell ATAC-seq profiles analyzed by three methods. The cell-type identification was predicted by 10X PBMC single-cell RNA-seq (CI = connectivity index; Methods section). <bold>c</bold> A mouse dataset<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>) is sampled to different number of cells ranging from 20k to 1 M. For each sampling, we compared the CPU running time of different methods for dimensionality reduction. <bold>d</bold> A set of perturbations (<italic>n</italic> = 5) are introduced to the mouse atlas dataset by down sampling to 90% of the original sequencing depth. Clustering outcomes are compared between different downsampled datasets (<italic>n</italic> = 10) to estimate the reproducibility. One-tailed <italic>t</italic>-test was performed to estimate the significance level between SnapATAC and each of the other methods (*<italic>p</italic> &lt; 0.05 and **<italic>p</italic> &lt; 0.01).</p></caption><graphic xlink:href="41467_2021_21583_Fig4_HTML" id="d32e885"/></fig></p>
      <p id="Par20">To compare the sensitivity of SnapATAC on detecting cell types to that of previously published methods, we analyzed two scATAC-seq datasets representing different types of bio-samples. First, to quantify the clustering sensitivity, we applied an existing integration method to predict the cell type of 4792 PBMC cells using corresponding 10× single-cell RNA-seq by following the tutorial (<ext-link ext-link-type="uri" xlink:href="https://satijalab.org/seurat/v3.1/atacseq_integration_vignette.html">https://satijalab.org/seurat/v3.1/atacseq_integration_vignette.html</ext-link>). To obtain the most confident prediction, we only kept single-cell ATAC-seq profiles whose cell-type prediction score is greater than 0.9. Using the remaining cells, we calculated the connectivity index (CI; Methods section) in the low-dimension manifold for each of the methods (LSA, <italic>cis</italic>-Topic, and SnapATAC). Connectivity index estimates the degree of separation between clusters in an unbiased manner and a lower connectivity index represents a higher degree of separation between clusters. SnapATAC exhibits substantially higher sensitivity in distinguishing different cell types compared to the other two methods (Fig. <xref rid="Fig4" ref-type="fig">4b</xref>). The second is a newly produced dataset that contains 9529 single-nucleus open chromatin profiles generated from the mouse secondary motor cortex. Based on the gene accessibility score at canonical marker genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">9</xref>), SnapATAC uncovers 22 distinct cell populations (Supplementary Fig. <xref rid="MOESM1" ref-type="media">10</xref>) whereas alternative methods fail to distinguish the rare neuronal subtypes including Sst (Gad2+ and Sst+), Vip (Gad2+ and Vip+), L6b (Sulf1− and Tl4e+), and L6.CT (Sulf1+ and Foxp2+). These results suggest that SnapATAC outperforms existing methods in sensitivity of separating different cell types in both synthetic and real datasets.</p>
      <p id="Par21">To compare the scalability of SnapATAC to that of existing methods, a previous scATAC-seq dataset that contains over 80k cells from 13 different mouse tissues<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> is used (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). This dataset is downsampled to different number of cells, ranging from 20,000 to 80,000 cells. For each sampling, SnapATAC and other methods are performed, and the CPU running time of dimensionality reduction is monitored (Methods section). The running time of SnapATAC scales linearly and increases at a significantly lower slope than alternative methods (Fig. <xref rid="Fig4" ref-type="fig">4c</xref>). Using the same computing resource, when applied to 100k cells, SnapATAC is much faster than existing methods (Fig. <xref rid="Fig4" ref-type="fig">4c</xref>). For instance, when applied to 100k cells, SnapATAC is nearly 10 times faster than LSA and more than 100 times faster than <italic>cis</italic>-Topic. More importantly, because SnapATAC avoids the loading of the full cell matrix in the memory and can naturally fit within the distributed computing environments (Methods section), the running time and memory usage for SnapATAC plateau after 20,000 cells, making it possible for analyzing datasets of even greater volumes. To test this, we simulate 1 million cells of the same coverage with the above dataset (Methods section) and process it with SnapATAC, LSA, and <italic>cis</italic>-Topic. Using the same computing resource, SnapATAC is able to process up to one million cells with regular hardwire configuration (Fig. <xref rid="Fig4" ref-type="fig">4c</xref> and Methods section). These results demonstrate that SnapATAC provides a highly scalable approach for analyzing large-scale scATAC-seq dataset.</p>
      <p id="Par22">To evaluate the clustering reproducibility, the above mouse scATAC-seq dataset is downsampled to 90% of the original sequencing depth in five different iterations. Each downsampled dataset is clustered using SnapATAC and other methods. Clustering results are compared between sampled datasets to estimate the stability. SnapATAC has a substantially higher reproducibility of clustering results between different downsampled datasets than other methods (Fig. <xref rid="Fig4" ref-type="fig">4d</xref>).</p>
      <p id="Par23">The improved performance of SnapATAC likely results from the fact that it considers all reads from each cell, not just the fraction of reads within the peaks defined in the population. To test this hypothesis, clustering is performed after removing the reads overlapping the predefined peak regions. Although the outcome is worse than the full dataset as expected, it still recapitulates the major cell types obtained from the full dataset (Supplementary Fig. <xref rid="MOESM1" ref-type="media">11</xref>). This holds true for all three datasets tested (Supplementary Fig. <xref rid="MOESM1" ref-type="media">11a–c</xref>). One possibility is that the off-peak reads may be enriched for the euchromatin (or compartment A) that strongly correlates with active genes<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> and varies considerably between cell types<sup><xref ref-type="bibr" rid="CR34">34</xref>,<xref ref-type="bibr" rid="CR35">35</xref></sup>. Consistent with this hypothesis, the density of the nonpeak reads in scATAC-seq library is highly enriched for the euchromatin (compartment A) as defined using genome-wide chromatin conformation capture analysis (i.e., Hi–C) in the same cell type<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">12</xref>). These observations suggest that the nonpeak reads discarded by existing methods can actually contribute to distinguish different cell types.</p>
      <p id="Par24">Including the off-peak reads, however, raises a concern regarding whether SnapATAC is sensitive to technical variations (also known as batch effect). To test this, SnapATAC is applied to four datasets generated using different technologies (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). Each dataset contains at least two biological replicates produced by the same technology. In all cases, the biological replicates are well mixed in the t-SNE embedding space showing no obvious batch effect (Supplementary Fig. <xref rid="MOESM1" ref-type="media">13</xref>), suggesting that SnapATAC is robust to the technical variations.</p>
      <p id="Par25">To test whether SnapATAC is robust to technical variation introduced by different technological platforms, it is used to integrate two mouse brain datasets generated using plate and droplet-based scATAC-seq technologies (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). In the joint t-TSNE embedding space, these two datasets are separated based on the technologies (Supplementary Fig. <xref rid="MOESM1" ref-type="media">14a</xref>). To remove the platform-to-platform variations, Harmony<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>, a single-cell batch effect correction tool, is incorporated into the SnapATAC pipeline (Methods section). After correction by Harmony<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>, these two datasets are well mixed in the joint t-SNE embedding (Supplementary Fig. <xref rid="MOESM1" ref-type="media">14b</xref>) and clusters are fairly represented by both datasets (Supplementary Fig. <xref rid="MOESM1" ref-type="media">14c</xref>).</p>
    </sec>
    <sec id="Sec5">
      <title>A high-resolution <italic>cis</italic>-regulatory atlas of the mouse secondary motor cortex</title>
      <p id="Par26">To demonstrate the utility of SnapATAC in resolving cellular heterogeneity of complex tissues and identify candidate <italic>cis</italic>-regulatory elements in diverse cell type, it is applied to a new single-nucleus ATAC-seq dataset generated from the secondary mouse motor cortex in the adult mouse brain as part of the BRAIN Initiative Cell Census Consortium<sup><xref ref-type="bibr" rid="CR36">36</xref></sup> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">15a</xref>). This dataset includes two biological replicates, each pooled from 15 mice to minimize potential batch effects. The aggregate signals show high reproducibility between biological replicates (Pearson correlation = 0.99; Supplementary Fig. <xref rid="MOESM1" ref-type="media">15b–d</xref>), a significant enrichment for transcription start sites (TSS) and less than 1% of mitochondria DNA (3), indicating a high signal-to-noise ratio (Supplementary Fig. <xref rid="MOESM1" ref-type="media">15e</xref>). After filtering out the low-quality nuclei (Supplementary Fig. <xref rid="MOESM1" ref-type="media">16a</xref>) and removing putative doublets using Scrublet<sup><xref ref-type="bibr" rid="CR37">37</xref></sup> (Methods section; Supplementary Fig. <xref rid="MOESM1" ref-type="media">16b</xref>), a total of 55,592 nuclear profiles with an average of ~5000 unique fragments per nucleus remain and are used for further analysis (Supplementary Data <xref rid="MOESM2" ref-type="media">1</xref>).</p>
      <p id="Par27">SnapATAC identifies initially a total of 20 major clusters using the consensus clustering approach (Supplementary Fig. <xref rid="MOESM1" ref-type="media">17</xref>). The clustering result is highly reproducible between biological replicates (Pearson correlation = 0.99; Supplementary Fig. <xref rid="MOESM1" ref-type="media">18a</xref>) and is resistant to sequencing depth effect (Supplementary Fig. <xref rid="MOESM1" ref-type="media">18b</xref>). Based on the gene accessibility score at the canonical marker genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">19</xref>), these clusters are classified into 10 excitatory neuronal subpopulations (Snap25+, Slc17a7+, Gad2−; 52% of total nuclei), three inhibitory neuronal subpopulations (Snap25+, Gad2+; 10% of total nuclei), one oligodendrocyte subpopulation (Mog+; 8% of total nuclei), one oligodendrocyte precursor subpopulation (Pdgfra+; 4% of total nuclei), one microglia subpopulation (C1qb+; 5% of total nuclei), one astrocyte subpopulation (Apoe+; 12% of total nuclei), and additional populations of endothelial, and smooth muscle cells accounting for 6% of total nuclei (Fig. <xref rid="Fig5" ref-type="fig">5a</xref>).<fig id="Fig5"><label>Fig. 5</label><caption><title>A high-resolution <italic>cis</italic>-regulatory atlas of mouse secondary motor cortex (MOs).</title><p><bold>a</bold> T-SNE visualization of 20 major cell types in MOs identified using SnapATAC. <bold>b</bold> Fourteen GABAergic subtypes revealed by iterative clustering of 5940 GABAergic neurons (Sst, Pv, and CGE in <bold>a</bold>). <bold>c</bold> Gene accessibility score of canonical marker genes for GABAergic subtypes is projected onto the t-SNE embedding. <bold>d</bold>
<italic>k</italic>-means clustering of 294,304 differentially accessible elements based on chromatin accessibility. <bold>e</bold> Gene ontology analysis of each cell-type predicted by GREAT analysis<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. <bold>f</bold> Transcription factor motif enriched in each cell group identified using Homer<sup><xref ref-type="bibr" rid="CR22">22</xref></sup> (Poisson <italic>p</italic>-value).</p></caption><graphic xlink:href="41467_2021_21583_Fig5_HTML" id="d32e1097"/></fig></p>
      <p id="Par28">In mammalian brain, GABAergic interneurons exhibit spectacular diversity that shapes the spatiotemporal dynamics of neural circuits underlying cognition<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>. To examine whether iterative analysis could help tease out various subtypes of GABAergic neurons, SnapATAC is applied to the 5940 GABAergic nuclei (CGE, Sst, and Vip) identified above, finding 17 distinct subpopulations (Supplementary Fig. <xref rid="MOESM1" ref-type="media">20a</xref>) that are highly reproducible between biological replicates (Pearson correlation = 0.99; Supplementary Fig. <xref rid="MOESM1" ref-type="media">20b</xref>). Based on the chromatin accessibility at the marker genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">21</xref>), these 17 clusters are classified into five Sst subtypes (Chodl+, Cbln4+, Igfbp6+, Myh8+, and C1ql3+), two Pv subtypes (Tac1+ and Ntf3+), two Lamp5 subtypes (Smad3+ and Ndnf+), four Vip subtypes (Mybpc1+, Chat+, Gpc3+, Crhr2+), Sncg and putative doublets (Fig. <xref rid="Fig5" ref-type="fig">5b</xref>). These clusters include a rare type Sst-Chodl (0.1%) previously identified in single-cell RNA<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> and single-cell ATAC-seq analysis<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>. While the identity and function of these subtypes require further experimental validation, our results demonstrate the exquisite sensitivity of SnapATAC in resolving distinct neuronal subtypes with only subtle differences in the chromatin landscape.</p>
      <p id="Par29">A key utility of single-cell chromatin accessibility analysis is to identify regulatory sequences in the genome. By pooling reads from nuclei in each major cluster (Fig. <xref rid="Fig5" ref-type="fig">5a</xref>), cell-type-specific chromatin landscapes can be obtained (Supplementary Fig. <xref rid="MOESM1" ref-type="media">22</xref> and Methods section). Peaks are determined in each cell type, resulting in a total of 373,583 unique candidate <italic>cis</italic>-regulatory elements. Most notably, 56% (212,730/373,583) of these open chromatin regions cannot be detected from bulk ATAC-seq data of the same brain region (Methods section). The validity of these additional open chromatin regions identified from scATAC-seq data are supported by several lines of evidence. First, these open chromatin regions are only accessible in minor cell populations (Supplementary Fig. <xref rid="MOESM1" ref-type="media">23a</xref>) that are undetectable in the bulk ATAC-seq signal. Second, these sequences show significantly higher conservation than randomly selected genomic sequences with comparable mappability scores (Supplementary Fig. <xref rid="MOESM1" ref-type="media">23c</xref>). Third, these open chromatin regions display an enrichment for transcription factor (TF) binding motifs corresponding to the TFs that play important regulatory roles in the corresponding cell types. For example, the binding motif for Mef2c is highly enriched in novel candidate <italic>cis</italic>-elements identified from Pvalb neuronal subtype (<italic>P</italic>-value = 1e-363; Supplementary Fig. <xref rid="MOESM1" ref-type="media">23d</xref>), consistent with previous report that Mef2c is upregulated in embryonic precursors of Pv interneurons<sup><xref ref-type="bibr" rid="CR41">41</xref></sup>. Finally, the new open chromatin regions tend to test positive in transgenic reporter assays. Comparison to the VISTA enhancer database<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> shows that enhancer activities of 256 of the newly identified open chromatin regions have been previously tested using transgenic reporter assays in e11.5 mouse embryos. Sixty five percent (167/256; 65%) of them drive reproducible reporter expression in at least one embryonic tissue, which was substantially higher than background rates (9.7%) estimated from regions in the VISTA database that lack canonical enhancer mark<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>. Four examples are displayed (Supplementary Fig. <xref rid="MOESM1" ref-type="media">23e</xref>).</p>
      <p id="Par30">SnapATAC identifies 294,304 differentially accessible elements between cell types (Methods section; Fig. <xref rid="Fig5" ref-type="fig">5d</xref>). GREAT analysis (Fig. <xref rid="Fig5" ref-type="fig">5e</xref>) and motif inference (Fig. <xref rid="Fig5" ref-type="fig">5f</xref>) identify the master regulators and transcriptional pathways active in each of the cell types. For instance, the binding motif for ETS-factor PU.1 is highly enriched in microglia-specific candidate CREs, motifs for SOX proteins are enriched in Ogc-specific elements, and bHLH motifs are enriched in excitatory neurons-specific CREs (Fig. <xref rid="Fig5" ref-type="fig">5f</xref>). Interestingly, motifs for candidate transcriptional regulators, including NUCLEAR FACTOR 1 (NF1), are also enriched in candidate CREs detected in two inhibitory neuron subtypes (Lamp5.Ndnf and Lamp5.Smad3). Motif for CTCF, a multifunctional protein in genome organization and gene regulation<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>, is highly enriched in Sst-Chodl. Finally, motifs for different basic-helix-loop-helix (bHLH) family transcription factors, known determinants of neural differentiation<sup><xref ref-type="bibr" rid="CR45">45</xref></sup>, show enrichment for distinct Sst subtypes. For instance, E2A motif is enriched in candidate CREs found in Sst.Myh8 whereas AP4 motif is specifically enriched in peaks found in Sst.Cbln4, suggesting specific role that different bHLH factors might play in different neuronal subtypes.</p>
    </sec>
    <sec id="Sec6">
      <title>SnapATAC enables reference-based annotation of new scATAC-seq datasets</title>
      <p id="Par31">Unsupervised clustering of scATAC-seq datasets frequently requires manual annotation, which is labor-intensive and limited to prior knowledge. To overcome this limitation, SnapATAC provides a function to project new single-cell ATAC-seq datasets to an existing cell atlas to allow for supervised annotation of cells. First, the Nyström method is used to project the query cells to the low-dimension manifold precomputed from the reference cells (Methods section). In the joint manifold, a neighborhood-based classifier is used to determine the cell type of each query cell based on the label of its <italic>k</italic>-nearest neighboring cells in the reference dataset (Methods section). The accuracy of this method is determined by five-fold cross validation using the mouse motor cortex atlas. On average, 98% (±1%) of the cells can be correctly classified, suggesting a high accuracy of the method (Fig. <xref rid="Fig6" ref-type="fig">6a</xref>).<fig id="Fig6"><label>Fig. 6</label><caption><title>SnapATAC enables supervised annotation of new scATAC-seq dataset using reference cell atlas.</title><p><bold>a</bold> MOs snATAC-seq dataset is split into 80% and 20% as training and test dataset. A predictive model learned from the training dataset predicts cell types on the test dataset of high accuracy (left) as compared to the original cell-type labels (right). <bold>b</bold> A predictive model learned from the reference dataset—MOs (snATAC)—accurately predicts the cell types on a query dataset from mouse brain generated using a different technological platform, the 10× scATAC-seq. The t-SNE embedding is inferred from the reference cell atlas (left) or generated by SnapATAC in an unbiased manner from 10× mouse brain dataset (middle and right). Cells are visualized using t-SNE and are colored by the cell types predicted by supervised classification (middle) compared to the cluster labels defined using unsupervised clustering (right).</p></caption><graphic xlink:href="41467_2021_21583_Fig6_HTML" id="d32e1217"/></fig></p>
      <p id="Par32">To demonstrate that SnapATAC could be applied to datasets generated from distinct technical platforms, it is used to annotate 4,098 scATAC-seq profiles from mouse brain cells generated using a droplet-based platform (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). After removing batch effect introduced by different platforms using Harmony<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>, the query cells are well mixed with the reference cells in the joint embedding space (Supplementary Fig. <xref rid="MOESM1" ref-type="media">24</xref>). The predicted cluster labels are also consistent with the cell types defined using unbiased clustering analysis (NMI = 0.85, ARI = 0.68; Fig. <xref rid="Fig6" ref-type="fig">6b</xref>).</p>
      <p id="Par33">To investigate whether SnapATAC could recognize cell types in the query dataset that are not present in the reference atlas, multiple query datasets are sampled from the above mouse motor cortex dataset and a perturbation is introduced to each sampling by randomly dropping a cell cluster. When this resulting query dataset is analyzed by SnapATAC against the original cell atlas, the majority of the cells that are left out from the original atlas are filtered out due to the low prediction score (Supplementary Fig. <xref rid="MOESM1" ref-type="media">25</xref>), again suggesting that our method is not only accurate but also robust to the novel cell types in the query dataset.</p>
    </sec>
  </sec>
  <sec id="Sec7" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par34">In summary, SnapATAC is a comprehensive bioinformatic solution for single-cell ATAC-seq analysis. The open-source software runs on standard hardware, making it accessible to a broad spectrum of researchers. Through extensive benchmarking, we have demonstrated that SnapATAC outperforms existing tools in sensitivity, accuracy, scalability, and robustness of identifying cell types in complex tissues.</p>
    <p id="Par35">SnapATAC differs from previous methods in at least seven aspects. First, SnapATAC incorporates many useful tools and represents the most comprehensive solution for single-cell ATAC-seq data analysis to date. In addition to clustering analysis, SnapATAC provides preprocessing, annotation, trajectory analysis, peak calling<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>, differential analysis<sup><xref ref-type="bibr" rid="CR23">23</xref></sup>, batch effect correction<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>, and motif discovery<sup><xref ref-type="bibr" rid="CR22">22</xref></sup> all in one package. Second, SnapATAC identifies cell types in an unbiased manner without the need for population-level peak annotation, leading to superior sensitivity for identifying rare cell types in complex tissues. Third, with Nyström method<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>, SnapATAC significantly reduces both CPU and memory usage, enabling analysis of large-scale dataset of a million cells or more. Fourth, SnapATAC not only incorporates existing method to integrate scATAC-seq with scRNA-seq dataset<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> but also provides a new method to predict promoter–enhancer pairing relations based on the statistical association between gene expression and chromatin accessibility in single cells. Fifth, our method achieves high clustering reproducibility using a consensus clustering approach. Finally, SnapATAC also enables supervised annotation of a new scATAC-seq dataset based on an existing reference cell atlas.</p>
    <p id="Par36">It is important to note that a different strategy has been used to overcome the bias introduced by population-based peak annotation<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. This approach involves iterative clustering, with the first round defining the crude clusters in complex tissues followed by identifying peaks in these clusters, which are then used in subsequent round(s) of clustering. However, several limitations still exist. First, the strategy of iterative clustering requires multiple rounds of clustering, aggregation, and peak calling, thus hindering its application to large-scale datasets. Second, the crude clusters represent the most dominant cell types in the tissues; therefore, peaks in the rare populations may still be underrepresented. Finally, peak-based methods hinder multi-sample integrative analysis where each sample has its own unique peak reference.</p>
    <p id="Par37">Finally, SnapATAC is applied to a newly generated scATAC-seq dataset including 55,592 high-quality single-nucleus ATAC-seq profiles from the mouse secondary motor cortex, resulting in a single-cell atlas consisting of &gt;370,000 candidate <italic>cis</italic>-regulatory elements across 31 cell types in this mouse brain region. The cellular diversity identified by chromatin accessibility is at a high resolution and is consistent with mouse neurogenesis and taxonomy revealed by single-cell transcriptome data<sup><xref ref-type="bibr" rid="CR39">39</xref>,<xref ref-type="bibr" rid="CR47">47</xref></sup>. Besides characterizing the constituent cell types, SnapATAC identifies candidate <italic>cis</italic>-regulatory sequences in each of the major cell types and infers the likely transcription factors that regulate cell-type specific gene expression programs. Importantly, a large fraction (56%) of the candidate <italic>cis</italic>-elements identified from the scATAC-seq data are not detected in bulk analysis. While further experiments to thoroughly validate the function of these additional open chromatin regions are needed, the ability for SnapATAC to uncover <italic>cis</italic>-elements from rare cell types of a complex tissue will certainly help expand the catalog of <italic>cis</italic>-regulatory sequences in the genome.</p>
  </sec>
  <sec id="Sec8">
    <title>Methods</title>
    <sec id="Sec9">
      <title>SnapATAC pipeline workflow</title>
      <sec id="Sec10">
        <title>Fastq file demultiplexing</title>
        <p id="Par38">Using a custom python script, we first perform FASTQ file demulticomplexing by integrating the cell barcode into the read name in the following format: @+barcode+:+original_read_name.</p>
      </sec>
      <sec id="Sec11">
        <title>Sequencing reads alignment</title>
        <p id="Par39">Demultiplexed sequencing reads are aligned to the corresponding reference genome (i.e., mm10 or hg19) using bwa (0.7.13-r1126) in pair-end mode with default parameter settings. Aligned reads are then sorted based on the read name using samtools (v1.9) to group together reads originating from the same barcodes.</p>
      </sec>
      <sec id="Sec12">
        <title>Quality control and reads filtering</title>
        <p id="Par40">Pair-end reads are converted into fragments and only those that meet the following criteria are kept: (1) properly paired (according to SMA flag value); (2) uniquely mapped (MAPQ &gt; 30); (3) insert distance within [50–1000 bp]. PCR duplicates (fragments sharing the same genomic coordinates) are removed for each cell separately. Given that Tn5 introduces a 9 bp staggered, reads mapping to the positive and negative strand were shifted by +4/−5 bp, respectively<sup><xref ref-type="bibr" rid="CR48">48</xref></sup>.</p>
      </sec>
      <sec id="Sec13">
        <title>Barcode filtering</title>
        <p id="Par41">We identify the high-quality cells based on two criteria: (1) total number of unique fragment count [&gt;1000]; (2) fragments in promoter ratio—the percentage of fragments overlapping with annotated promoter regions [0.2–0.8]. The promoter regions used in this study are downloaded from 10× genomics for hg19 and mm10.</p>
      </sec>
      <sec id="Sec14">
        <title>Snap-file generation</title>
        <p id="Par42">Using the remaining fragments, we next generate a snap-format (Single-Nucleus Accessibility Profiles) file using snaptools (<ext-link ext-link-type="uri" xlink:href="https://github.com/r3fang/SnapTools">https://github.com/r3fang/SnapTools</ext-link>). A snap file is a hierarchically structured hdf5 file that contains the following sections: header (HD), cell-by-bin matrix (BM), cell-by-peak matrix (PM), cell-by-gene matrix (GM), barcode (BD), and fragment (FM). HD session contains snap-file version, date, alignment and reference genome information. BD session contains all unique barcodes and corresponding meta data. BM session contains cell-by-bin matrices of different bin sizes. PM session contains cell-by-peak count matrix. GM session contains cell-by-gene count matrix. FM session contains all usable fragments for each cell. Fragments are indexed based on barcodes that enables fast retrieval of reads belonging to the same barcodes. Detailed information about snap file can be found here: <ext-link ext-link-type="uri" xlink:href="https://github.com/r3fang/SnapTools/blob/master/docs/snap_format.docx">https://github.com/r3fang/SnapTools/blob/master/docs/snap_format.docx</ext-link>.</p>
      </sec>
      <sec id="Sec15">
        <title>Creating cell-by-bin count matrix</title>
        <p id="Par43">Using the resulting snap file, we next create cell-by-bin count matrix. The genome is segmented into uniform-sized bins and single-cell ATAC-seq profiles are represented as cell-by-bin matrix with each element indicating number of sequencing fragments overlapping with a given bin in a certain cell.</p>
      </sec>
      <sec id="Sec16">
        <title>Choosing bin size</title>
        <p id="Par44">To evaluate the effect of bin size to clustering performance, we apply SnapATAC to three datasets namely 5 K PBMC (10×), Mouse Brain (10×), and MOs-M1 (snATAC) (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). These datasets are generated by both plate and droplet platforms using either cell or nuclei with considerably different depth, allowing us to systematically evaluate the effect of bin size.</p>
        <p id="Par45">For each dataset, we define the “landmark” cell types in a supervised manner. First, we perform <italic>cis</italic>-Topic<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> for dimensionality reduction and identify cell clusters using graph-based algorithm Louvain<sup><xref ref-type="bibr" rid="CR49">49</xref></sup> with k = 15. Second, we manually define the major cell types in each dataset by examining the gene accessibility score at the canonical marker genes (see Supplementary Fig. <xref rid="MOESM1" ref-type="media">9</xref> as an example for MOs-M1). Third, clusters sharing the same marker genes are manually merged and those failing to show unique signatures are discarded. In total, we define nine most convincing cell types in PBMC 5 K (10×), 14 types in Mouse Brain 5 K (10×) and 14 types in MOs-M1 (snATAC). Among these cell types, 14 cell populations that account for less than 2% of the total population are considered as rare cell populations (Supplementary Fig. <xref rid="MOESM1" ref-type="media">2a</xref>).</p>
        <p id="Par46">We next evaluate the performance of each bin size selection using three metrics: (1) cluster connectivity index (CI), which estimate the degree of connectedness of the landmark cell types; a lower CI represents a better separation. The connectivity index is computed in the following manner. For each cell <italic>i</italic>, the <italic>K</italic> (<italic>K</italic> = 15) nearest neighbors are found and sorted from the closest to furthest. The algorithm checks if those neighbors are assigned to the same cluster with cell <italic>i</italic>. At the beginning, connectivity value equals 0 and increases with value 1/<italic>i</italic> when the <italic>i</italic>th nearest neighbors is not assigned to the same cluster with cell <italic>i</italic>. This procedure is repeated for all cells in the dataset. In general, the higher the connectivity index is, the less separated the defined landmark cell types are. The connectivity index is computed using “connectivity” function implemented in R package clv. (2) coverage bias, which estimates the read depth distribution in the two-dimensional embedding space; (3) sensitivity to identify rare populations. Through systematic benchmarking, we found that bin size in the range from 1 to 10 kb appeared to work well on the three benchmarks, we selected 5 kb as the default bin width for all the analysis in this work (Supplementary Fig. <xref rid="MOESM1" ref-type="media">2</xref> and Methods section).</p>
      </sec>
      <sec id="Sec17">
        <title>Matrix binarization</title>
        <p id="Par47">We found that the vast majority of the elements in the cell-by-bin count matrix is “0”, indicating either closed chromatin or missing value. Among the non-zero elements, some has abnormally high coverage (&gt;200) perhaps due to the alignment errors or other unknown reasons. These items usually account for less than 0.1% of total non-zero items in the matrix. Thus, we change the top 0.1% elements in the matrix to “0” to eliminate potential alignment errors. We next convert the remaining non-zero elements to “1”.</p>
      </sec>
      <sec id="Sec18">
        <title>Bin filtering</title>
        <p id="Par48">We next filter out any bins overlapping with the ENCODE blacklist downloaded from <ext-link ext-link-type="uri" xlink:href="http://mitra.stanford.edu/kundaje/akundaje/release/blacklists/">http://mitra.stanford.edu/kundaje/akundaje/release/blacklists/</ext-link> for corresponding reference genome. Second, we remove reads mapped to the X/Y chromosomes to eliminate sex effect. Third, we remove mitochondrial DNA to get rid of potential contamination. We next sort the bins based on the coverage and filter out the top 5% to remove the invariant features. Please note that we do not perform coverage-based bin filtering for a dataset that has low coverage (average fragment number less than 5000) where the ranking of bin may be fluctuated by the noise.</p>
      </sec>
      <sec id="Sec19">
        <title>Dimensionality reduction</title>
        <p id="Par49">We next apply the following dimensionality reduction procedure to project the high-dimension data to a low-dimension manifold for clustering and visualization. Let <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{X}} \in {\mathbf{{\cal{R}}}}^{n \times m}$$\end{document}</tex-math><mml:math id="M2"><mml:mi mathvariant="bold">X</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq1.gif"/></alternatives></inline-formula> be a dataset with <italic>n</italic> cells and <italic>m</italic> bins and <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{X}} = \{ 0,1\}$$\end{document}</tex-math><mml:math id="M4"><mml:mi mathvariant="bold">X</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq2.gif"/></alternatives></inline-formula>. The first step is to compute a similarity matrix between the <italic>m</italic> high-dimensional data points to construct the <italic>n</italic>-by-<italic>n</italic> pairwise similarity matrix using a kernel function kn that is an appropriate similarity metric. A popular choice is gaussian kernel:<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{kn}}\left( {{\mathbf{x}}_{\mathbf{i}},{\mathbf{x}}_{\mathbf{j}}} \right) = {\mathrm{exp}}( { - \frac{{{\mathrm{d}}({\mathbf{x}}_{\mathbf{i}},{\mathbf{x}}_{\mathbf{j}})^2}}{{\it{\epsilon }}}})$$\end{document}</tex-math><mml:math id="M6"><mml:mi mathvariant="normal">kn</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi mathvariant="normal">exp</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">d</mml:mi><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mi>ϵ</mml:mi></mml:mrow></mml:mfrac></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq3"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{d}}({\mathbf{x}}_{\mathbf{i}},{\mathbf{x}}_{\mathbf{j}})$$\end{document}</tex-math><mml:math id="M8"><mml:mi mathvariant="normal">d</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq3.gif"/></alternatives></inline-formula> is the Euclidean distance between observations <italic>i</italic> and <italic>j</italic>.</p>
        <p id="Par50">Due the binarization nature of single-cell ATAC-seq dataset, in this case, we replace the Gaussian kernel with Jaccard coefficient, which estimates the similarity between cells simply based on ratio of overlap over the total union:<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{jaccard}}( {{\mathbf{x}}_{\mathbf{i}},{\mathbf{x}}_{\mathbf{j}}}) = \frac{{\left| {{\mathbf{x}}_{\mathbf{i}} \,{\cap}\, {\mathbf{x}}_{\mathbf{j}}} \right|}}{{\left| {{\mathbf{x}}_{\mathbf{i}}{\cup} {\mathbf{x}}_{\mathbf{j}}} \right|}}$$\end{document}</tex-math><mml:math id="M10"><mml:mi mathvariant="normal">jaccard</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mfenced close="∣" open="∣"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mo>∩</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mfenced close="∣" open="∣"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>∪</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par51">The Jaccard coefficient, which is symmetric and positivity preserving meets the requirement of being a kernel function.</p>
        <p id="Par52">Using jaccard as a kernel function, we next form a symmetric kernel matrix <inline-formula id="IEq4"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{J}} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M12"><mml:mi mathvariant="bold">J</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq4.gif"/></alternatives></inline-formula> where each entry is obtained as <inline-formula id="IEq5"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$J_{i,j} = {\mathrm{jaccard}}({\mathbf{x}}_{\mathbf{i}},{\mathbf{x}}_{\mathbf{j}})$$\end{document}</tex-math><mml:math id="M14"><mml:msub><mml:mrow><mml:mi>J</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="normal">jaccard</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq5.gif"/></alternatives></inline-formula>.</p>
        <p id="Par53">Theoretically, the similarity <italic>J</italic><sub><italic>i,j</italic></sub> would reflect the true similarity between cell <bold>x</bold><sub><bold><italic>i</italic></bold></sub> and <bold>x</bold><sub><bold><italic>j</italic></bold></sub>, but unfortunately, due to the high-dropout rate, this is not the case. If there is a high sequencing depth for cell <bold>x</bold><sub><bold>i</bold></sub> or <bold>x</bold><sub><bold>j</bold></sub>, then <italic>J</italic><sub><italic>i,j</italic></sub> tend to have higher values, regardless whether cell <bold>x</bold><sub><bold>i</bold></sub> and <bold>x</bold><sub><bold>j</bold></sub> is actually similar or not.</p>
        <p id="Par54">This can be proved theoretically. Given 2 cells <bold>x</bold><sub><bold>i</bold></sub> and <bold>x</bold><sub><bold>j</bold></sub> and corresponding coverage (number of “1”s) <inline-formula id="IEq6"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_i = \mathop {\sum }\nolimits_k^m x_{ik}$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq6.gif"/></alternatives></inline-formula> and <inline-formula id="IEq7"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_j = \mathop {\sum }\nolimits_k^m x_{jk}$$\end{document}</tex-math><mml:math id="M18"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq7.gif"/></alternatives></inline-formula>, let <inline-formula id="IEq8"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P_i = C_i/m$$\end{document}</tex-math><mml:math id="M20"><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mi>m</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq8.gif"/></alternatives></inline-formula> and <inline-formula id="IEq9"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${P_j = C_j/m}$$\end{document}</tex-math><mml:math id="M22"><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mi>m</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq9.gif"/></alternatives></inline-formula> be the probability of observing a signal in cell <bold>x</bold><sub><bold>i</bold></sub> and <bold>x</bold><sub><bold>j</bold></sub> where <italic>m</italic> is the length of the vector. Assuming <bold>x</bold><sub><bold>i</bold></sub> and <bold>x</bold><sub><bold>j</bold></sub> are two “random” cells without any biological relevance, in another word, the “1”s in <bold>x</bold><sub><bold>i</bold></sub> and <bold>x</bold><sub><bold>j</bold></sub> are randomly distributed, then the ratio of expectation between cell <bold>x</bold><sub><bold>i</bold></sub> and <bold>x</bold><sub><bold>j</bold></sub> can be calculated as:<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$E_{ij} = \frac{{P_iP_j}}{{P_i + P_j - P_iP_j}}$$\end{document}</tex-math><mml:math id="M24"><mml:msub><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par55">Although the ratio of expectations does not in general equal the expectation of the ratio, the two are approximately equal in this case because the coefficient of variation is much less than 1 for both the numerator and the denominator. The increase of either <italic>P</italic><sub><italic>i</italic></sub> or <italic>P</italic><sub><italic>j</italic></sub> will result in an increase of <italic>E</italic><sub><italic>ij</italic></sub>, which suggests the Jaccard similarity between cells is highly affected by the read depth. Such observation prompts us to develop an ad hoc normalization method to eliminate the read depth effect.</p>
        <p id="Par56">To learn the relationship between the <italic>E</italic><sub><italic>ij</italic></sub> and <italic>J</italic><sub><italic>ij</italic></sub> from the data, we next fit a curve to predict the observed Jaccard coefficient <italic>J</italic><sub><italic>ij</italic></sub> as a function of its expected value <italic>E</italic><sub><italic>ij</italic></sub> by fitting a polynomials regression of degree 2 using R function lm. Theoretically, <italic>E</italic><sub><italic>ij</italic></sub> should be linear with <italic>J</italic><sub><italic>ij</italic></sub> if cells are completely random, but in real dataset, we have observed a nonlinearity between <italic>E</italic><sub><italic>ij</italic></sub> and <italic>J</italic><sub><italic>ij</italic></sub> especially among the high-coverage cells. We suspect, to some extent, the degree of randomness of fragment distribution in a single cell is associated with the coverage. To better model the nonlinearity, we include a second order polynomial in our model:<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$J_{ij} = \beta _0 + \beta _1E_{ij} + \beta _2E_{ij}^2$$\end{document}</tex-math><mml:math id="M26"><mml:msub><mml:mrow><mml:mi>J</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par57">This fitting provided estimators of parameters <inline-formula id="IEq10"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\{ \widehat {\beta _0},\,\widehat {\beta _1},\,\widehat {\beta _2}\}$$\end{document}</tex-math><mml:math id="M28"><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mspace width="0.25em"/><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mspace width="0.25em"/><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mo>^</mml:mo></mml:mover></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq10.gif"/></alternatives></inline-formula>. As such, we next use it to normalize the observed Jaccard coefficient by:<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N_{ij} = J_{ij}/(\widehat {\beta _0} + \widehat {\beta _1}E_{ij} + \widehat {\beta _2}E_{ij}^2)$$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>J</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mo>^</mml:mo></mml:mover><mml:mo>+</mml:mo><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mo>^</mml:mo></mml:mover><mml:msub><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mo>^</mml:mo></mml:mover><mml:msubsup><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par58">The fitting of the linear regression, however, can be time consuming with a large matrix. Here we test the possibility of performing this step on a random subset of <italic>y</italic> cells in lieu of the full matrix. When selecting a subset of <italic>y</italic> cells to speed up the first step, we do not select cells at random with a uniform sampling probability. Instead, we set the probability of selecting a cell <italic>i</italic> to<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\frac{1}{{d({\mathrm{log}}_{10}(C_i))}}$$\end{document}</tex-math><mml:math id="M32"><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">log</mml:mi></mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula>where d is the density estimate of all log10-transformed cell fragment count and <italic>C</italic><sub><italic>i</italic></sub> is the number of fragments in cell <italic>i</italic> and <inline-formula id="IEq11"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_i = \mathop {\sum }\nolimits_k^m x_{ik}$$\end{document}</tex-math><mml:math id="M34"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq11.gif"/></alternatives></inline-formula>. Similar approach was first introduced in SCTranscform<sup><xref ref-type="bibr" rid="CR50">50</xref></sup> to speed up the normalization of single-cell RNA-seq.</p>
        <p id="Par59">We then proceed to normalize the full Jaccard coefficient matrix <inline-formula id="IEq12"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{J}} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M36"><mml:mi mathvariant="bold">J</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq12.gif"/></alternatives></inline-formula> using the regression model learned from <italic>y</italic> cells and compared the results to the case where all cells are used in the initial estimation step as well. We use the correlation of normalized Jaccard coefficient to compare this partial analysis to the full analysis. We observe that using as few as 2000 cells in the estimation gave rise to virtually identical estimates. We therefore use 2000 cells in the initial model-fitting step. To remove outliers in the normalized similarity, we use the 0.99 quantile to cap the maximum value of the normalized matrix.</p>
        <p id="Par60">Next, using normalized Jaccard coefficient matrix <bold>N</bold>, we normalize the matrix by:<disp-formula id="Equ7"><label>7</label><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{A}} = {\mathbf{D}}^{ - 1/2}{\mathbf{ND}}^{ - 1/2}$$\end{document}</tex-math><mml:math id="M38"><mml:mi mathvariant="bold">A</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">ND</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ7.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq13"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{D}} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M40"><mml:mi mathvariant="bold">D</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq13.gif"/></alternatives></inline-formula> is a diagonal matrix, which is composed as <inline-formula id="IEq14"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D_{i,i} = \mathop {\sum }\nolimits_j N_{i,j}$$\end{document}</tex-math><mml:math id="M42"><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq14.gif"/></alternatives></inline-formula>. We next perform eigenvector decomposition against <bold>A</bold>.<disp-formula id="Equ8"><label>8</label><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{A}} = {\mathbf{U}}{\mathbf{\Lambda }}{\mathbf{U}}^{\mathrm{T}}$$\end{document}</tex-math><mml:math id="M44"><mml:mi mathvariant="bold">A</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">U</mml:mi><mml:mi mathvariant="bold">Λ</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ8.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par61">The columns <inline-formula id="IEq15"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{\varphi }}_{\mathbf{i}} \in {\mathbf{{\cal{R}}}}^n$$\end{document}</tex-math><mml:math id="M46"><mml:msub><mml:mrow><mml:mi mathvariant="bold">φ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq15.gif"/></alternatives></inline-formula> of <inline-formula id="IEq16"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M48"><mml:mi mathvariant="bold">U</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq16.gif"/></alternatives></inline-formula> are the eigenvectors. The diagonal matrix <inline-formula id="IEq17"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{\Lambda }} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M50"><mml:mi mathvariant="bold">Λ</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq17.gif"/></alternatives></inline-formula> has the eigenvalues <inline-formula id="IEq18"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda _1 \ge \lambda _2 \ge \ldots \ge 0$$\end{document}</tex-math><mml:math id="M52"><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:mo>…</mml:mo><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq18.gif"/></alternatives></inline-formula> in descending order as its entries. Finally, we report the first <italic>r</italic> eigenvectors as the final low-dimension manifold.</p>
      </sec>
      <sec id="Sec20">
        <title>Evaluation of ad hoc normalization method</title>
        <p id="Par62">To assess the performance of normalization of SnapATAC we processed three datasets. As shown in Supplementary Fig. <xref rid="MOESM1" ref-type="media">3</xref>, before normalization, SnapATAC exhibits a strong gradient that is correlated with sequencing depth within the cluster (Supplementary Fig. <xref rid="MOESM1" ref-type="media">3a</xref>). Although the sequencing depth effect is still observed in some of the small clusters, it is clear that the normalization has largely eliminated the read depth effect as compared to the unnormalized ones (Supplementary Fig. <xref rid="MOESM1" ref-type="media">3b</xref>).</p>
        <p id="Par63">To better quantify the coverage bias, we next computed the Shannon entropy that estimates the “uniformness” of the distribution of cell coverage in the UMAP embedding space. In detail, we first chose the top 10% cells of the highest coverage as “high-coverage” cells. Second, in the 2D UMAP embedding space, we discretize “high-coverage” cells from a continuous random coordinate (umap1, umap2) into bins (<italic>n</italic> = 50) and returns the corresponding vector of counts. This is done using a function called “discretize2d” in the “entropy” R package. Third, we estimated the Shannon entropy of the random variable from the corresponding observed counts. This is done using function “entropy” in the “entropy” R package. A higher entropy indicates that the “high-coverage” cells are more uniformly distributed in the UMAP embedding space, overall suggesting a better normalization performance.</p>
        <p id="Par64">We next examine another eight possible sources of biases by projecting to the UMAP embedding space, some metrics show cluster specificity for all three methods perhaps due to biological relevance, but all three methods can reveal significant biological heterogeneity without exhibiting substantial intracluster bias for any metrics examined (Supplementary Fig. <xref rid="MOESM1" ref-type="media">4</xref>).</p>
      </sec>
      <sec id="Sec21">
        <title>Removing batch effects using harmony</title>
        <p id="Par65">When the technical variability is at a larger scale than the biological variability, we apply batch effect corrector—Harmony<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>—to eliminate such confounding factor. Given two datasets generated using different technologies, we first calculate the joint low-dimension manifold as described above. We next apply Harmony to regress out the batch effect, resulting in a new harmonized coembedding. This is implemented as a function “runHarmony” in SnapATAC package.</p>
      </sec>
      <sec id="Sec22">
        <title>Selection of eigenvector and eigenvalues</title>
        <p id="Par66">We next determine how many eigenvectors to include for the downstream analysis. Here we use an ad hoc approach for choosing the optimal number of components. We look at the scatter plot between every two pairs of eigenvectors and choose the number of eigenvectors that start exhibiting “blob”-like structure in which no obvious biological structure is revealed.</p>
      </sec>
      <sec id="Sec23">
        <title>Nyström method</title>
        <p id="Par67">The computational cost of the dimensionality reduction scales quadratically with the increase of number of cells. For instance, calculating and normalizing the pairwise kernel Matrix <italic>N</italic> becomes computationally infeasible for large-scale dataset. To overcome this limitation, here we apply Nyström method<sup><xref ref-type="bibr" rid="CR21">21</xref>,<xref ref-type="bibr" rid="CR51">51</xref></sup> to calculate the low-dimensional embedding for large-scale dataset.</p>
        <p id="Par68">A Nyström algorithm can be divided into three major steps: (i) sampling: sample a subset of <italic>K</italic> (<inline-formula id="IEq19"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K \ll N$$\end{document}</tex-math><mml:math id="M54"><mml:mi>K</mml:mi><mml:mo>≪</mml:mo><mml:mi>N</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq19.gif"/></alternatives></inline-formula>) cells from <italic>N</italic> total cells as “landmarks”. Instead of random sampling, here we adopt a density-based sampling approach<sup><xref ref-type="bibr" rid="CR50">50</xref></sup> to preserve the density distribution of the <italic>N</italic> original points; (ii) embedding: compute the low-dimension embedding for <italic>K</italic> landmarks; (iii) extension: project the remaining <italic>N</italic>–<italic>K</italic> cells onto the low-dimensional embedding as learned from the landmarks to create a joint embedding space for all cells.</p>
        <p id="Par69">This approach significantly reduces the computational complexity and memory usage given that <italic>K</italic> is considerably smaller than <italic>N</italic>. The out-of-sample extension (step iii) further enables projection of new single-cell ATAC-seq datasets to the existing reference single-cell atlas. This allows us to further develop a supervised approach to predict cell types of a new single-cell ATAC-seq dataset based on an existing reference atlas.</p>
        <p id="Par70">A key aspect of this method is the procedure according to which cells are sampled as landmark cells, because different sampled landmark cells give different approximations of the original embedding using full matrix. Here we employ the density-based sampling as described above, which preserves the density distribution of the original points.</p>
        <p id="Par71">Let <inline-formula id="IEq20"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{X}} \in {\mathbf{{\cal{R}}}}^{n \times m}$$\end{document}</tex-math><mml:math id="M56"><mml:mi mathvariant="bold">X</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq20.gif"/></alternatives></inline-formula> be a dataset with <italic>n</italic> cells and <italic>m</italic> variables (bins) and <inline-formula id="IEq21"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M58"><mml:mi mathvariant="bold">N</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq21.gif"/></alternatives></inline-formula> be a symmetric kernel matrix calculated using normalized Jaccard coefficient. To avoid calculating the pairwise kernel matrix and performing eigen-decomposition against a big matrix <inline-formula id="IEq22"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M60"><mml:mi mathvariant="bold">N</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq22.gif"/></alternatives></inline-formula>, we first sample <inline-formula id="IEq23"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k\,(k \ll n)$$\end{document}</tex-math><mml:math id="M62"><mml:mi>k</mml:mi><mml:mspace width="0.25em"/><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>≪</mml:mo><mml:mi>n</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq23.gif"/></alternatives></inline-formula> landmarks without replacement. This breaks down the original kernel matrix <inline-formula id="IEq24"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}} \in {\mathbf{{\cal{R}}}}^{n \times n}$$\end{document}</tex-math><mml:math id="M64"><mml:mi mathvariant="bold">N</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq24.gif"/></alternatives></inline-formula> into four components.<disp-formula id="Equ9"><label>9</label><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}} = \left( {\begin{array}{*{20}{c}} {{\mathbf{N}}^{kk}} &amp; {{\mathbf{N}}^{kv}} \\ {{\mathbf{N}}^{vk}} &amp; {{\mathbf{N}}^{vv}} \end{array}} \right)$$\end{document}</tex-math><mml:math id="M66"><mml:mi mathvariant="bold">N</mml:mi><mml:mo>=</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mtd><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>v</mml:mi></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mtd><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>v</mml:mi></mml:mrow></mml:msup></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ9.gif" position="anchor"/></alternatives></disp-formula>in which <inline-formula id="IEq25"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}}^{kk} \in {\mathbf{{\cal{R}}}}^{k \times k}$$\end{document}</tex-math><mml:math id="M68"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq25.gif"/></alternatives></inline-formula> is the pairwise kernel matrix between <italic>k</italic> landmarks and <inline-formula id="IEq26"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}}^{vk} \in {\mathbf{{\cal{R}}}}^{(n - k) \times k}$$\end{document}</tex-math><mml:math id="M70"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq26.gif"/></alternatives></inline-formula> is the similarity matrix between <inline-formula id="IEq27"><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(n - k)$$\end{document}</tex-math><mml:math id="M72"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq27.gif"/></alternatives></inline-formula> cells and <italic>k</italic> landmarks. Using <bold>N</bold><sup><italic>kk</italic></sup>, we perform dimensionality reduction to obtain the <italic>r</italic>-rank manifold <inline-formula id="IEq28"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}}^{kk} \in {\mathbf{{\cal{R}}}}^{k \times r}$$\end{document}</tex-math><mml:math id="M74"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq28.gif"/></alternatives></inline-formula> as described above.</p>
        <p id="Par72">Using <bold>N</bold><sup>v<italic>k</italic></sup>, which estimates the similarity between <italic>n</italic>–<italic>k</italic> cells and <italic>k</italic> landmark cells, we project the rest of <italic>n</italic>–<italic>k</italic> cells to the embedding previously obtained using <italic>k</italic> landmark:<disp-formula id="Equ10"><label>10</label><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{A}}^{vk} = ({\mathbf{D}}^{vv})^{ - \frac{1}{2}}({\mathbf{N}}^{vk})({\mathbf{D}}^{kk})^{ - \frac{1}{2}}$$\end{document}</tex-math><mml:math id="M76"><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>v</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:mfrac></mml:mrow></mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:mfrac></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ10.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq29"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{D}}^{vv} \in {\mathbf{{\cal{R}}}}^{(n - k) \times (n - k)}$$\end{document}</tex-math><mml:math id="M78"><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>v</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq29.gif"/></alternatives></inline-formula> is a diagonal matrix which is composed as <inline-formula id="IEq30"><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D_{i,i}^{vk} = \mathop {\sum }\nolimits_j N_{i,j}^{vk}$$\end{document}</tex-math><mml:math id="M80"><mml:msubsup><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq30.gif"/></alternatives></inline-formula>. The projected coordinates of the new points onto the r-dimensional intrinsic manifold defined by the landmarks are then given by<disp-formula id="Equ11"><label>11</label><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}}^{vk} = {\mathbf{A}}^{vk}{\mathbf{U}}^{kk}/{\mathbf{\Lambda }}^{kk}$$\end{document}</tex-math><mml:math id="M82"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>/</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">Λ</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ11.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par73">The resulting <inline-formula id="IEq31"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}}^{vk} \in {\mathbf{{\cal{R}}}}^{(n - k) \times r}$$\end{document}</tex-math><mml:math id="M84"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq31.gif"/></alternatives></inline-formula> is the approximate <italic>r</italic>-rank low-dimension representation of the rest <italic>n</italic>–<italic>k</italic> cells. Combing <bold><italic>U</italic></bold><sup><italic>kk</italic></sup> and <bold><italic>U</italic></bold><sup>v<italic>k</italic></sup> creates a joint embedding space for all cells:<disp-formula id="Equ12"><label>12</label><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{U}}} = \left[ {\begin{array}{*{20}{c}} {{\mathbf{U}}^{kk}} \\ {{\mathbf{U}}^{vk}} \end{array}} \right]$$\end{document}</tex-math><mml:math id="M86"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>v</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ12.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par74">In the approximate joint <italic>r</italic>-rank embedding space <inline-formula id="IEq32"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{U}}}$$\end{document}</tex-math><mml:math id="M88"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq32.gif"/></alternatives></inline-formula>, we next create a <italic>k</italic>-nearest neighbor (KNN) graph in which every cell is represented as a node and edges are drawn between cells within <italic>k</italic>-nearest neighbors defined using Euclidean distance. Finally, we apply community finding algorithm such as Louvain (implemented by igraph package in R) to identify the ‘communities’ in the resulting graph, which represents groups of cells sharing similar profiles, potentially originating from the same cell type.</p>
      </sec>
      <sec id="Sec24">
        <title>Choosing the number of landmarks</title>
        <p id="Par75">To evaluate the effect of the number of landmarks, we apply our method to a complex dataset that contains over 80k cells from 13 different mouse tissues. We employ the following three metrics to evaluate the performance. First, using different number of landmarks (<italic>k</italic>) ranging from 1000 to 10,000, we compare the clustering outcome to the cell-type label defined in the original study. The goal of this is to identify the “elbow” point that performance drops abruptly. Second, for each sampling, we repeat for five times using different set of landmarks to evaluate stability between sampling. Third, we spiked-in 1% Patski cells to assess the sensitivity of identifying rare cell types. We choose Patski cells because these cells were profiled using the same protocol by the same group (Data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>) to minimize the batch effect.</p>
        <p id="Par76">We observe that using as few as 5000 landmarks can largely recapitulate the result obtained using 10,000 landmarks (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5a</xref>), and 10,000 landmarks can achieve highly robust embedding between sampling (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5b</xref>) and successfully recover spiked-in rare populations (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5c</xref>). To obtain a reliable low-dimensional embedding, we use 10,000 landmarks for all the analysis performed in this study.</p>
      </sec>
      <sec id="Sec25">
        <title>Ensemble Nyström method</title>
        <p id="Par77">Nyström is stochastic in its nature, different sampling will result in different embedding and clustering outcome. To improve the robustness of the clustering method, we next employ Ensemble Nyström Algorithm which combines a mixture of Nyström approximation to create an ensemble representation<sup><xref ref-type="bibr" rid="CR52">52</xref></sup>. Supported by theoretical analysis, this Ensemble approach has been demonstrated to guarantee a convergence and in a faster rate in comparison to standard Nyström method<sup><xref ref-type="bibr" rid="CR52">52</xref></sup>. Moreover, this ensemble algorithm naturally fits within distributed computing environments, where their computational costs are roughly the same as that of the standard Nyström single sampling method.</p>
        <p id="Par78">We treat each approximation generated by the Nyström method using <italic>k</italic> landmarks as an expert and combined <italic>p</italic> ≥ 1 such experts to derive an improved approximation, typically more accurate than any of the original experts<sup><xref ref-type="bibr" rid="CR52">52</xref></sup>.</p>
        <p id="Par79">The ensemble setup is defined as follows. Given a dataset <inline-formula id="IEq33"><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{X}} \in {\mathbf{{\cal{R}}}}^{n \times m}$$\end{document}</tex-math><mml:math id="M90"><mml:mi mathvariant="bold">X</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq33.gif"/></alternatives></inline-formula> of <italic>n</italic> cells. Each expert <italic>S</italic><sub><italic>j</italic></sub> receives <italic>k</italic> landmarks randomly selected from matrix <bold>X</bold> using density-based sampling approach without replacement. Each expert <italic>S</italic><sub><italic>r</italic></sub>, <inline-formula id="IEq34"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r \in [1,p]$$\end{document}</tex-math><mml:math id="M92"><mml:mi>r</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>p</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq34.gif"/></alternatives></inline-formula> is then used to define the low-dimension embedding <inline-formula id="IEq35"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{U}}}_{\mathbf{j}} \in {\mathbf{{\cal{R}}}}^{n \times r}$$\end{document}</tex-math><mml:math id="M94"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq35.gif"/></alternatives></inline-formula> as described above. For each low-dimension embedding <inline-formula id="IEq36"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{U}}}_{\mathbf{j}} \in {\mathbf{{\cal{R}}}}^{n \times r}$$\end{document}</tex-math><mml:math id="M96"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq36.gif"/></alternatives></inline-formula>, we create a KNN-graph as <inline-formula id="IEq37"><alternatives><tex-math id="M97">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{G}}}_{\mathbf{j}}$$\end{document}</tex-math><mml:math id="M98"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq37.gif"/></alternatives></inline-formula>. Thus, the general form of the approximation, <inline-formula id="IEq38"><alternatives><tex-math id="M99">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{G}}}^{{\mathbf{en}}}$$\end{document}</tex-math><mml:math id="M100"><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">en</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq38.gif"/></alternatives></inline-formula>, generated by the ensemble Nyström method is<disp-formula id="Equ13"><label>13</label><alternatives><tex-math id="M101">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{G}}}^{{\mathbf{en}}} = \mathop {\sum }\limits_{j = 1}^p \mu ^j{\tilde{\mathbf{G}}}^{\mathbf{j}}$$\end{document}</tex-math><mml:math id="M102"><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">en</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>p</mml:mi></mml:mrow></mml:munderover><mml:msup><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ13.gif" position="anchor"/></alternatives></disp-formula>Here we choose to use the most straightforward method by assigning an equal weight to each of the KNN-graph obtained from different samplings, <inline-formula id="IEq39"><alternatives><tex-math id="M103">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu ^j = 1/p,r \in [1,p]$$\end{document}</tex-math><mml:math id="M104"><mml:msup><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>/</mml:mo><mml:mi>p</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>p</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq39.gif"/></alternatives></inline-formula>. While this choice ignores the relative quality of each Nyström approximation, it is computational efficient and already generates a solution superior to any one of the approximations used in the combination. Using the ensemble weighted KNN-graph <inline-formula id="IEq40"><alternatives><tex-math id="M105">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{G}}}^{{\mathbf{en}}}$$\end{document}</tex-math><mml:math id="M106"><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">en</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq40.gif"/></alternatives></inline-formula>, we next apply community finding algorithm to identify cell clusters. By testing on the mouse atlas dataset<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, we demonstrate that the clustering stability of the ensemble approach is significantly higher than the standard Nyström method (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5d</xref>).</p>
      </sec>
      <sec id="Sec26">
        <title>Visualization</title>
        <p id="Par80">We use the t-SNE implemented by FI-tsne, Rtsne or UMAP (umap_0.2.0.0) to visualize and explore the dataset.</p>
      </sec>
      <sec id="Sec27">
        <title>Gene accessibility score</title>
        <p id="Par81">To annotate the identified clusters, SnapATAC calculated the gene-body accessibility matrix <bold>G</bold> using “calGmatFromMat” function in SnapATAC packge where <italic>G</italic><sub><italic>i,j</italic></sub> is the number of fragments overlapping with jth genes in i-th cell. <italic>G</italic><sub><italic>i,j</italic></sub> is then normalized to CPM (count-per-million reads) as <inline-formula id="IEq41"><alternatives><tex-math id="M107">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\tilde{\mathbf{G}}}$$\end{document}</tex-math><mml:math id="M108"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq41.gif"/></alternatives></inline-formula>. The normalized accessibility score is then smoothed using Markov affinity-graph-based method:<disp-formula id="Equ14"><label>14</label><alternatives><tex-math id="M109">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{\mathbf{G}}} = {\tilde{\mathbf{GA}}}^t$$\end{document}</tex-math><mml:math id="M110"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">GA</mml:mi></mml:mrow><mml:mrow><mml:mo>~</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ14.gif" position="anchor"/></alternatives></disp-formula>where <bold>A</bold> is the adjacent matrix obtained from <italic>K</italic>-nearest neighbor graph and <italic>t</italic> is number of steps taken for Markov diffusion process. We set <italic>t</italic> = 3 in this study. Please note that the gene accessibility score is only used to guide the annotation of cell clusters identified using cell-by-bin matrix. The clusters are identified using cell-by-bin matrix in prior.</p>
      </sec>
      <sec id="Sec28">
        <title>Read aggregation and peak calling</title>
        <p id="Par82">After annotation, cells from the same cluster are pooled to create aggregated signal for each of the identified cell types. This allows for identifying <italic>cis</italic>-elements from each cluster. MACS2 (version 2.1.2) is used for generating signal tracks and peak calling with the following parameters: “–nomodel–shift 100–ext 200–qval 1e-2 -B –SPMR”. This can be done by “runMACS” function in SnapATAC package.</p>
      </sec>
      <sec id="Sec29">
        <title>Motif analysis</title>
        <p id="Par83">SnapATAC incorporates chromVAR<sup><xref ref-type="bibr" rid="CR15">15</xref></sup> to estimate the motif variability and Homer<sup><xref ref-type="bibr" rid="CR22">22</xref></sup> for de novo motif discovery. This is implemented as function “runChromVAR” and “runHomer” in SnapATAC package.</p>
      </sec>
      <sec id="Sec30">
        <title>Identification of differentially accessible peaks</title>
        <p id="Par84">For a given group of cells <bold>C</bold><sub><bold>i</bold></sub>, we first look for their neighboring cells <bold>C</bold><sub><bold>j</bold></sub> (<inline-formula id="IEq42"><alternatives><tex-math id="M111">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$|{\mathbf{C}}_{\mathbf{i}}| = |{\mathbf{C}}_{\mathbf{j}}|$$\end{document}</tex-math><mml:math id="M112"><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">C</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo><mml:mo>=</mml:mo><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">C</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq42.gif"/></alternatives></inline-formula>) in the low-dimension manifold as “background” cells to compare to. If <bold>C</bold><sub><bold>i</bold></sub>accounts for more than half of the total cells, we use the remaining cells as local background. Next, we aggregate <bold>C</bold><sub><bold>i</bold></sub> and <bold>C</bold><sub><bold>j</bold></sub> to create two raw-count vectors as <bold>V</bold><sub><bold>ci</bold></sub> and <bold>V</bold><sub><bold>cj</bold></sub>. We then perform differential analysis between <italic>V</italic><sub><bold>ci</bold></sub> and <bold>V</bold><sub><bold>cj</bold></sub> using exact test as implemented in R package edgeR (v3.18.1) with BCV = 0.1. <italic>P</italic>-value is then adjusted into False Discovery Rate (FDR) using Benjamini–Hochberg correction. Peaks with FDR less than 0.05 are selected as significant DARs.</p>
      </sec>
      <sec id="Sec31">
        <title>GREAT analysis</title>
        <p id="Par85">SnapATAC incorporates GREAT analysis<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> to infer the candidate biological pathway active in each cell populations. This is implemented as function “runGREAT” SnapATAC package.</p>
      </sec>
    </sec>
    <sec id="Sec32">
      <title>Integration with single-cell RNA-seq</title>
      <p id="Par86">We use canonical correlation analysis (CCA) embedded in Seurat V3<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> to integrate single-cell RNA-seq and single-cell ATAC-seq. We first calculate the gene accessibility account at variable genes identified using single-cell RNA-seq dataset. This can be done using a function called “createGmatFromMat” in SnapATAC package. Next, SnapATAC converts the snap object to a Seurat v3 object using a function called “SnapToSeurat” in preparation for integration. Different from integration method in Seurat, we use the low-dimension manifold as the dimensionality reduction method in the Seurat object. We next follow the vignette in Seurat website (<ext-link ext-link-type="uri" xlink:href="https://satijalab.org/seurat/v3.0/atacseq_integration_vignette.html">https://satijalab.org/seurat/v3.0/atacseq_integration_vignette.html</ext-link>) to integrate these two modalities. The cell type for scATAC-seq is predicted using function “TransferData” in Seurat V3.</p>
      <p id="Par87">Finally, for each single-cell ATAC profile, we infer its gene expression profile by calculating the weighted average expression profile of its nearest neighboring cells in the single-cell RNA-seq dataset<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>. By doing so, we create pseudo-cells that contain information of both chromatin accessibility and gene expression profiles. The imputation of gene expression profile is done by “TransferData” function in Seurat V3.</p>
    </sec>
    <sec id="Sec33">
      <title>Linking enhancers to putative target genes</title>
      <p id="Par88">Using the “pseudo” cells, we next sought to predict the putative target genes for regulatory elements based on the association between expression of a gene and chromatin accessibility at its enhancer elements. Given a gene <italic>G</italic>, we first identify its surrounding regulatory elements within 1MB window flanking <italic>G</italic>. Let <bold>Y</bold><sup><bold>G</bold></sup> be the imputed gene expression value for gene <italic>G</italic> among <italic>n</italic> cells. We perform logistic regression using <bold>Y</bold><sup><bold>G</bold></sup> as variable to predict the binary state for each of peaks surrounding <italic>G</italic>. The idea behind using logistic regression is that if there is a relationship between the gene expression (continuous variable) and chromatin accessibility (categorical variable), we should be able to predict chromatin accessibility from the gene expression. Logistic regression does not make many of the key assumptions such as normality of the continuous variables. In addition, since we only have one variable (gene expression) for prediction every time, there is no problem of multicollinearity.</p>
      <p id="Par89">We next fit logistic regression between each of flanking peak and gene expression using “glm” function in R with binomial(link = ‘logit’) as the family function. By doing so, we obtain the regression coefficient <italic>β</italic><sub>1</sub> and its corresponding P-value for each peak separately. Here we used 5e-8, a standard <italic>P</italic>-value cutoff for human genome-wise association study to determine the significant association. While this cutoff is less sample or gene specific compared to more complicated methods such as permutation test, it is computational efficient and already generates a reasonable set of gene–enhancer pairings.</p>
      <p id="Par90">To evaluate the performance of our methods, we compare our prediction with <italic>cis</italic>-eQTL derived from interferon-γ and lipopolysaccharide stimulation of monocytes<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>. Significant <italic>cis</italic>-eQTL associations are downloaded from supplementary material in Fairfax (2014)<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>. We filter <italic>cis</italic>-eQTL based on two criteria: (1) only <italic>cis</italic>-eQTLs that overlap with the peaks identified in PBMC dataset are considered; (2) In addition, we only keep the <italic>cis</italic>-eQTLs whose genes overlap with the variable genes determined by scRNA-seq. This filtering reduced the <italic>cis</italic>-eQTL list to 456 candidates.</p>
      <p id="Par91">Next, we estimate the association for each of <italic>cis</italic>-eQTLs by preforming logistic regression test as described above. To make a comparison, we derive a set of negative pairs matched for the distance. The negative control pairs for <italic>cis</italic>-eQTL are chosen in the following manner to control for both distance and chromatin accessibility: for each positive eQTL pair <italic>p</italic><sub><italic>ij</italic></sub> which connects gene <italic>i</italic> and enhancer <italic>j</italic> with a distance of <italic>d</italic><sub><italic>ij</italic></sub>, we look for the enhancer <italic>k</italic> on the opposite direction of the gene <italic>i</italic> that minimizes | <inline-formula id="IEq43"><alternatives><tex-math id="M113">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{ij} - d_{iz}$$\end{document}</tex-math><mml:math id="M114"><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>z</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq43.gif"/></alternatives></inline-formula><italic>|</italic>. By doing so, the negative sets are controlled for distance, chromatin accessibility level and gene expression level.</p>
    </sec>
    <sec id="Sec34">
      <title>Simulation of scATAC-seq datasets</title>
      <p id="Par92">First, we download the alignment files (bam files) for ten bulk ATAC-seq experiment from ENCODE (data source listed in Supplementary Table <xref rid="MOESM1" ref-type="media">2</xref>). From each bam file, we simulate 1000 single-cell ATAC-seq datasets by randomly down sampling to a variety of coverages ranging from 1000 to 10,000 reads per cells. We next create a cell-by-bin matrix of 5 kb which is used for SnapATAC clustering. Merging peaks identified from each bulk experiment, we create cell-by-peak matrix used for LSA, <italic>Cis</italic>-Topic, Cicero, and chromVAR for clustering. We repeat the sampling for <italic>n</italic> = 10 times to estimate the variability of the clustering.</p>
    </sec>
    <sec id="Sec35">
      <title>Comparison of scalability</title>
      <p id="Par93">To compare the scalability between SnapATAC to other methods, we next simulate multiple datasets of different number of cells ranging from 20k to 1 M. These datasets are simulated in the following manner. Using the 80k mouse atlas dataset, we randomly sample this dataset to different number of cells ranging from 20k t0 1 M cells. For the sampling that has cells more than 80 K, we sample with replacement and introduce perturbation to each cell by randomly removing 1% of the “1”s in each of the cells. This removes the duplicate cells and largely maintains the density of the matrix.</p>
      <p id="Par94">For each sampling, we then perform dimensionality reduction using LSA and <italic>cis</italic>-Topic and compare their CPU running time. Specifically, we monitor the running time for (1) TF-IDF transformation and Singular Value Decomposition (SVD) for LSA, (2) function “runModels” with topics = c(2, 5, 10, 15, 20, 25, 30, 35, 40) and “selectModel” function in <italic>cis</italic>-Topic. The time for matrix loading is not counted.</p>
      <p id="Par95">All the comparisons were tested on a machine with 5 AMD Operon (TM) Processor 6276 CPUs.</p>
    </sec>
    <sec id="Sec36">
      <title>Doublets detection using scrublet</title>
      <p id="Par96">To identify doublets from secondary motor cortex single-nucleus ATAC-seq datasets, we use single-cell RNA-seq doublets detection algorithm Scrublet<sup><xref ref-type="bibr" rid="CR37">37</xref></sup>. Briefly, Scrublet identifies doublets in the following manner: (1) Scrublet performs normalization, gene filtering, and principal components analysis (PCA) to project the high-dimension data to a low-dimension space; (2) Scrublet simulates doublets by adding the unnormalized counts from randomly sampled observed transcriptomes; (3) the simulated doublets are projected to the low-dimension embedding computed in step 1. The more neighbors of a cell are the simulated doublets, the more likely this cell is a “doublet”. Based on this idea, a KNN classifier was then used to estimate the doublet score for each cell.</p>
      <p id="Par97">Since Scrublet was designed for detecting doublets in single-cell RNA-seq, it is unclear whether it can be used for single-cell ATAC-seq. To examine this, we applied Scrublet to a single-cell ATAC-seq dataset of mixed human and mouse cells where the “ground-truth” doublets can be identified based on the alignment ratio to human and mouse genome. Compared to the ground truth, Scrubet can identify over 90% of the doublets in this dataset with ~90% accuracy (Supplementary Fig. <xref rid="MOESM1" ref-type="media">26</xref>). This result suggests that although Scrubet was not developed for detecting doublets in single-cell ATAC-seq, it can find the doublets in scATAC-seq dataset with reasonable accuracy and sensitivity.</p>
    </sec>
    <sec id="Sec37">
      <title>Projection of single-cell ATAC-seq datasets to reference atlas</title>
      <p id="Par98">We reason that landmark-extension algorithm can provide a mean to project new single-cell ATAC-seq datasets to a reference atlas. Given a query dataset <inline-formula id="IEq44"><alternatives><tex-math id="M115">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{Y}} \in {\mathbf{{\cal{R}}}}^{l \times m}$$\end{document}</tex-math><mml:math id="M116"><mml:mi mathvariant="bold">Y</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq44.gif"/></alternatives></inline-formula> that contains <italic>l</italic> query cells with <italic>m</italic> bins and a reference dataset <inline-formula id="IEq45"><alternatives><tex-math id="M117">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{X}} \in {\mathbf{{\cal{R}}}}^{n \times m}$$\end{document}</tex-math><mml:math id="M118"><mml:mi mathvariant="bold">X</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq45.gif"/></alternatives></inline-formula> with <italic>n</italic> reference cells of <italic>m</italic> bins. We first randomly sample <italic>k</italic> = 10,000 landmarks from X as described above. Next, we compute the pairwise similarity using normalized Jaccard coefficient for <italic>k</italic> landmarks as <inline-formula id="IEq46"><alternatives><tex-math id="M119">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}}^{kk} \in {\mathbf{{\cal{R}}}}^{k \times k}$$\end{document}</tex-math><mml:math id="M120"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq46.gif"/></alternatives></inline-formula> and obtain the low-dimension manifold <inline-formula id="IEq47"><alternatives><tex-math id="M121">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}}^k \in {\mathbf{{\cal{R}}}}^{k \times r}$$\end{document}</tex-math><mml:math id="M122"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq47.gif"/></alternatives></inline-formula>. We then compute <inline-formula id="IEq48"><alternatives><tex-math id="M123">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{N}}^{lk} \in {\mathbf{{\cal{R}}}}^{l \times k}$$\end{document}</tex-math><mml:math id="M124"><mml:msup><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq48.gif"/></alternatives></inline-formula> which estimates the similarity between <italic>l</italic> query cells and <italic>k</italic> landmark cells, and then project the <italic>l</italic> query cells to the embedding precomputed for <italic>k</italic> landmark cells as following:<disp-formula id="Equ15"><label>15</label><alternatives><tex-math id="M125">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{A}}^l = ({\mathbf{D}}^l)^{ - \frac{1}{2}}({\mathbf{U}}^k)({\mathbf{D}}^k)^{ - \frac{1}{2}}$$\end{document}</tex-math><mml:math id="M126"><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:mfrac></mml:mrow></mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:mfrac></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ15.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq49"><alternatives><tex-math id="M127">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{D}}^l \in {\cal{R}}^{l \times l}$$\end{document}</tex-math><mml:math id="M128"><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>×</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq49.gif"/></alternatives></inline-formula> is a diagonal matrix, which is composed as <inline-formula id="IEq50"><alternatives><tex-math id="M129">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D_{i,i}^l = \mathop {\sum }\nolimits_j N_{i,j}^l$$\end{document}</tex-math><mml:math id="M130"><mml:msubsup><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq50.gif"/></alternatives></inline-formula> and <inline-formula id="IEq51"><alternatives><tex-math id="M131">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{D}}^k \in {\mathbf{{\cal{R}}}}^{k \times k}$$\end{document}</tex-math><mml:math id="M132"><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq51.gif"/></alternatives></inline-formula> is a diagonal matrix which is composed as <inline-formula id="IEq52"><alternatives><tex-math id="M133">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D_{i,i}^k = \mathop {\sum }\nolimits_j N_{i,j}^k$$\end{document}</tex-math><mml:math id="M134"><mml:msubsup><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq52.gif"/></alternatives></inline-formula><disp-formula id="Equ16"><label>16</label><alternatives><tex-math id="M135">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}}^l = {\mathbf{A}}^l{\mathbf{U}}^k/{\mathbf{\Lambda }}^k$$\end{document}</tex-math><mml:math id="M136"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>/</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">Λ</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ16.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par99">The resulting <inline-formula id="IEq53"><alternatives><tex-math id="M137">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}}^l \in {\mathbf{{\cal{R}}}}^{l \times r}$$\end{document}</tex-math><mml:math id="M138"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>×</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq53.gif"/></alternatives></inline-formula> is the predicted low-dimension manifold for <italic>l</italic> query cells.</p>
      <p id="Par100">In the joint embedding space [<inline-formula id="IEq54"><alternatives><tex-math id="M139">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{U}}^k,{\mathbf{U}}^l$$\end{document}</tex-math><mml:math id="M140"><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq54.gif"/></alternatives></inline-formula>], we next identify the mutual nearest neighbors between query and landmark cells. For each cell <inline-formula id="IEq55"><alternatives><tex-math id="M141">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$i_1 \in {\mathbf{X}}^k$$\end{document}</tex-math><mml:math id="M142"><mml:msub><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq55.gif"/></alternatives></inline-formula> belonging to the landmarks, we find the <italic>k.nearest</italic> (5) cells in the query dataset with the smallest distances to <italic>i</italic><sub>1</sub>. We do the same for each cell in query cell dataset to find its <italic>k.nearest</italic> (5) neighbors in the landmark dataset. If a pair of cells from each dataset is contained in each other’s nearest neighbors, those cells are considered to be mutual nearest neighbors or MNN pairs (or “anchors”). We interpret these pairs as containing cells that belong to the same cell type or state despite being generated in both landmark and query cells. Thus, any differences between cells in MNN pairs should theoretically represent the nonoverlapping cell types. Here we removed any query cells that failed to identify an MNN pair correspondence in the reference dataset.</p>
      <p id="Par101">To make a classification of the remaining query cells according to the reference dataset, we next apply the neighborhood-based classifier and wish to highlight the pioneering work by Seurat V3<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>. First, we score each anchor (or MNN pair) using shared nearest neighbor (SNN) graph by examining the consistency of edges between cells in the same local neighborhood as described in the original study<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>. Second, we define a weight matrix that estimates the strength of association between each query cell <bold><italic>c</italic></bold>, and each landmark <bold><italic>i</italic></bold>. For each query cell <bold><italic>c</italic></bold>, we identify the nearest <bold><italic>s</italic></bold> landmarks in the reference dataset in the joint embedding space. Nearest anchors are then weighted based on their distance to the cell <bold><italic>c</italic></bold> over the distance to the <italic>s</italic>-th anchor cell. For each cell <italic>c</italic> and anchor <italic>i</italic>, we compute the weighted similarities as:<disp-formula id="Equ17"><label>17</label><alternatives><tex-math id="M143">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D_{c,i} = \left( {1 - \frac{{{\mathrm{dist}}(c,\,a_i)}}{{{\mathrm{dist}}(c,\,a_s)}}} \right)S_{ai}$$\end{document}</tex-math><mml:math id="M144"><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">dist</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">dist</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ17.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq56"><alternatives><tex-math id="M145">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{dist}}(c,i)$$\end{document}</tex-math><mml:math id="M146"><mml:mi mathvariant="normal">dist</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq56.gif"/></alternatives></inline-formula> is the Euclidean distance in the joint embedding space and <italic>S</italic><sub><italic>ai</italic></sub> is the weight for the corresponding MNN pair (anchor). We then normalize the similarity using exponential function:<disp-formula id="Equ18"><label>18</label><alternatives><tex-math id="M147">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\widetilde {D_{c,i}} = 1 - e^{\frac{{ - D_{c,i}}}{{\left( {\frac{2}{{sd}}} \right)^2}}}$$\end{document}</tex-math><mml:math id="M148"><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ18.gif" position="anchor"/></alternatives></disp-formula>where sd is set to 1 by default. Finally, we normalize across all <bold><italic>s</italic></bold> anchors:<disp-formula id="Equ19"><label>19</label><alternatives><tex-math id="M149">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$W_{c,i} = \frac{{\widetilde {D_{c,i}}}}{{\mathop {\sum }\nolimits_1^{j = s} \widetilde {D_{c,j}}}}$$\end{document}</tex-math><mml:math id="M150"><mml:msub><mml:mrow><mml:mi>W</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mi>s</mml:mi></mml:mrow></mml:msubsup><mml:mover accent="true"><mml:mrow><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ19.gif" position="anchor"/></alternatives></disp-formula>Here we set s = 50. Please note that the similarity to cells beyond the <italic>s</italic>th anchor neighbor is set to be zero.</p>
      <p id="Par102">Let <inline-formula id="IEq57"><alternatives><tex-math id="M151">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{L}} \in {\mathbf{{\cal{R}}}}^{k \times t}$$\end{document}</tex-math><mml:math id="M152"><mml:mi mathvariant="bold">L</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="bold-script">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq57.gif"/></alternatives></inline-formula> be the binary label matrix for <italic>k</italic> landmarks with <italic>t</italic> clusters. <inline-formula id="IEq58"><alternatives><tex-math id="M153">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L_{i,j} = 1$$\end{document}</tex-math><mml:math id="M154"><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq58.gif"/></alternatives></inline-formula> indicates the class label for <italic>i</italic>th landmark cell is <italic>j</italic>-th cluster. The row sum of <bold>L</bold> must be 1, suggesting each landmark cell can only be assigned to one cluster label. We then compute label predictions for query cells as <bold><italic>P</italic></bold><sup><italic>l</italic></sup>:<disp-formula id="Equ20"><label>20</label><alternatives><tex-math id="M155">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathbf{P}}^l = {\mathbf{WL}}$$\end{document}</tex-math><mml:math id="M156"><mml:msup><mml:mrow><mml:mi mathvariant="bold">P</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mi mathvariant="bold">WL</mml:mi></mml:math><graphic xlink:href="41467_2021_21583_Article_Equ20.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par103">The resulting <bold><italic>P</italic></bold><sup><italic>l</italic></sup> is a probability matrix within 0 and 1, <inline-formula id="IEq59"><alternatives><tex-math id="M157">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P_{i,j}^l$$\end{document}</tex-math><mml:math id="M158"><mml:msubsup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_21583_Article_IEq59.gif"/></alternatives></inline-formula> indicates the probability of a cell <italic>i</italic> belong to <italic>j</italic> cluster. Similarly, we infer the t-SNE position of query cells by replacing <bold>L</bold> with t-SNE coordinates of reference points. It is important to note that the distance between cells in the inferred t-SNE coordinate does not neccessarily reflect the cell-to-cell relationship.</p>
    </sec>
    <sec id="Sec38">
      <title>Tissue collection and nuclei isolation</title>
      <p id="Par104">Adult C57BL/6 J male mice were purchased from Jackson Laboratories. Brains were extracted from P56-63 old mice and immediately sectioned into 0.6-mm coronal sections, starting at the frontal pole, in ice-cold dissection media. The secondary motor cortex (MOs) region was dissected from the first three slices along the anterior-posterior axis according to the Allen Brain reference Atlas (<ext-link ext-link-type="uri" xlink:href="http://mouse.brain-map.org/">http://mouse.brain-map.org/</ext-link>, see Supplementary Fig. <xref rid="MOESM1" ref-type="media">15a</xref> for depiction of posterior view of each coronal slice; dashed line highlights the MOs regions on each slice). Slices were kept in ice-cold dissection media during dissection and immediately frozen in dry ice for posterior pooling and nuclei production. For nuclei isolation, the MOs dissected regions from 15–23 animals were pooled, and two biological replicates were processed for each slice. Nuclei were isolated as described in previous studies<sup><xref ref-type="bibr" rid="CR53">53</xref>,<xref ref-type="bibr" rid="CR54">54</xref></sup>, except no sucrose gradient purification was performed. Flow cytometry analysis of brain nuclei was performed as described in Luo et al.<sup><xref ref-type="bibr" rid="CR53">53</xref></sup>. Animal protocols were approved by the Salk Institute Institutional Animal Care and Use Committee. Animal ethics approval has been obtained for the mouse study.</p>
    </sec>
    <sec id="Sec39">
      <title>Tn5 transposase purification and loading</title>
      <p id="Par105">Tn5 transposase was expressed as an intein chitin-binding domain fusion and purified using an improved version of the method first described by Picelli et al.<sup><xref ref-type="bibr" rid="CR55">55</xref></sup>. T7 Express lysY/I (C3013I, NEB) cells were transformed with the plasmid pTXB1-ecTn5 E54K L372P (#60240, Addgene)<sup><xref ref-type="bibr" rid="CR55">55</xref></sup>. An LB Ampicillin culture was inoculated with three colonies and grown overnight at 37 °C. The starter culture was diluted to an OD of 0.02 with fresh media and shaken at 37 °C until it reached an OD of 0.9. The culture was then immediately chilled on ice to 10 °C and expression was induced by adding 250 μM IPTG (Dioxane Free, CI8280-13, Denville Scientific). The culture was shaken for 4 h at 23 °C after which cells were harvested in 2 L batches by centrifugation, flash frozen in liquid nitrogen and stored at −80 °C. Cell pellets were resuspended in 20 ml of ice-cold lysis buffer (20 mM HEPES 7.2-KOH, 0.8 M NaCl, 1 mM EDTA, 10% Glycerol, 0.2% Triton X-100) with protease inhibitors (Complete, EDTA-free Protease Inhibitor Cocktail Tablets, 11873580001, Roche Diagnostics) and passed three times through a Microfluidizer (lining covered with ice water, Model 110 L, Microfluidics) with a 5 min cool down interval in between each pass. Any remaining sample was purged from the Microfluidizer with an additional 25 ml of ice-cold lysis buffer with protease inhibitors (total lysate volume ~50 ml). Samples were spun down for 20 min in an ultracentrifuge at 125K × <italic>g</italic> (L-80XP, 45 Ti Rotor, Beckman Coulter) at 4 °C. ~45 ml of supernatant was combined with 115 ml ice-cold lysis buffer with protease inhibitors in a cold beaker (total volume = 160 ml) and stirred at 4 °C. 4.2 ml of 10% neutralized polyethyleneimine-HCl (pH 7.0) was then added dropwise. Samples were spun down again for 20 min in an ultracentrifuge at 125K × <italic>g</italic> (L-80XP, 45 Ti Rotor, Beckman Coulter) at 4 °C. The pooled supernatant was loaded onto ~10 ml of fresh Chitin resin (S6651L, NEB) in a chromatography column (Econo-Column (1.5 × 15 cm), Flow Adapter: 7380015, Bio-Rad). The column was then washed with 50–100 ml lysis buffer. Cleavage of the fusion protein was initiated by flowing ~20 ml of freshly made elution buffer (20 mM HEPES 7.2-KOH, 0.5 M NaCl, 1 mM EDTA, 10% glycerol, 0.02% Triton X-100, 100 mM DTT) onto the column at a speed of 0.8 ml/min for 25 min. After the column was incubated for 63 h at 4 °C, the protein was recovered from the initial elution volume and a subsequent 30 ml wash with elution buffer. Protein-containing fractions were pooled and diluted 1:1 with buffer [20 mM HEPES 7.2-KOH,1 mM EDTA, 10% glycerol, 0.5 mM TCEP) to reduce the NaCl concentration to 250 mM. For cation exchange, the sample was loaded onto a 1 ml column HiTrap S HP (17115101, GE), washed with Buffer A (10 mM Tris 7.5, 280 mM NaCl, 10% glycerol, 0.5 mM TCEP) and then eluted using a gradient formed using Buffer A and Buffer B (10 mM Tris 7.5, 1 M NaCl, 10% glycerol, 0.5 mM TCEP) (0% Buffer B over 5 column volumes, 0–100% Buffer B over 50 column volumes, 100% Buffer B over 10 column volumes). Next, the protein-containing fractions were combined, concentrated via ultrafiltration to ~1.5 mg/mL and further purified via gel filtration (HiLoad 16/600 Superdex 75 pg column (28989333, GE)) in Buffer GF (100 mM HEPES-KOH at pH 7.2, 0.5 M NaCl, 0.2 mM EDTA, 2 mM DTT, 20% glycerol). The purest Tn5 transposase-containing fractions were pooled and 1 volume 100% glycerol was added to the preparation. Tn5 transposase was stored at −20 °C.</p>
      <p id="Par106">To generate Tn5 transposomes for combinatorial barcoding assisted single-nucleus ATAC-seq, barcoded oligos were first annealed to pMENTs oligos (95 °C for 5 min, cooled to 14 °C at a cooling rate of 0.1 °C/s) separately. Next, 1 µl barcoded transposon (50 µM) was mixed with 7 ul Tn5 (~7 µM). The mixture was incubated on the lab bench at room temperature for 30 min. Finally, T5 and T7 transposomes were mixed in a 1:1 ratio and diluted 1:10 with dilution buffer (50% Glycerol, 50 mM Tris-HCl (pH = 7.5), 100 mM NaCl, 0.1 mM EDTA, 0.1% Triton X-100, 1 mM DTT). For combinatorial barcoding, we used eight different T5 transposomes and 12 distinct T7 transposomes, which eventually resulted in 96 Tn5 barcode combinations per sample<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> (Supplementary Table <xref rid="MOESM1" ref-type="media">4</xref>). Library quality control for single-nucleus ATAC-seq can be found in Supplementary Table <xref rid="MOESM1" ref-type="media">3</xref>.</p>
    </sec>
    <sec id="Sec40">
      <title>Bulk ATAC-seq data generation and analysis</title>
      <p id="Par107">ATAC-seq was performed on 30,000–50,000 nuclei. Nuclei were thawed on ice and pelleted for 5 min at 500 × <italic>g</italic> at 4 °C. Nuclei pellets were resuspended in 30 µl tagmentation buffer (36.3 mM Tris-acetate (pH = 7.8), 72.6 mM K-acetate, 11 mM Mg-acetate, 17.6% DMF) and counted on a hemocytometer. 30,000–50,000 nuclei were used for tagmentation and the reaction volume was adjusted to 19 µl using tagmentation buffer. After addition of 1 µl TDE1 (Illumina FC-121-1030), tagmentation was performed at 37 °C for 60 min with shaking (500 rpm). Tagmented DNA was purified using MinElute columns (Qiagen), PCR-amplified for eight cycles with NEBNext® High-Fidelity 2X PCR Master Mix (NEB, 72 °C 5 min, 98 °C 30 s, [98 °C 10 s, 63 °C 30 s, 72 °C 60 s] × 8 cycles, 12 °C held). Amplified libraries were purified using MinElute columns (Qiagen) and SPRI Beads (Beckmann Coulter). Sequencing was carried out on a NextSeq500 using a 150-cycle kit (75 bp PE, Illumina).</p>
      <p id="Par108">Bulk ATAC-seq reads were mapped to reference genome mm10 using BWA and samtools version 1.2 to eliminate PCR duplicates and mitochondrial reads. The paired-end read ends were converted to fragments. Using fragments, MACS2<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> version 2.1.2 was used for generating signal tracks and peak calling with the following parameters:–nomodel–shift 100–ext 200–qval 1e-2 -B –SPMR. Library quality control for bulk ATAC-seq can be found in Supplementary Table <xref rid="MOESM1" ref-type="media">5</xref>.</p>
    </sec>
    <sec id="Sec41">
      <title>Single-nucleus ATAC-seq data generation</title>
      <p id="Par109">Combinatorial barcoding single nucleus ATAC-seq was performed as described previously with modifications<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR7">7</xref></sup>. In detail, for each sample two biological replicates were processed. Nuclei were pelleted with a swinging bucket centrifuge (500 × <italic>g</italic>, 5 min, 4 °C; 5920 R, Eppendorf). Nuclei pellets were resuspended in 1 ml nuclei permeabilization buffer (5% BSA, 0.2% IGEPAL-CA630, 1 mM DTT and cOmpleteTM, EDTA-free protease inhibitor cocktail (Roche) in PBS) and pelleted again (500 × <italic>g</italic>, 5 min, 4 °C; 5920 R, Eppendorf). Nuclei were resuspended in 500 µL high salt tagmentation buffer (36.3 mM Tris-acetate (pH = 7.8), 72.6 mM potassium-acetate, 11 mM Mg-acetate, 17.6% DMF) and counted using a hemocytometer. Concentration was adjusted to 4500 nuclei/9 µl, and 4500 nuclei were dispensed into each well of a 96-well plate. Glycerol was added to the leftover nuclei suspension for a final concentration of 25% and nuclei were stored at −80 °C. For tagmentation, 1 µL barcoded Tn5 transposomes<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR55">55</xref></sup> (Supplementary Table <xref rid="MOESM1" ref-type="media">4</xref>) were added using a BenchSmart™ 96 (Mettler Toledo), mixed five times and incubated for 60 min at 37 °C with shaking (500 rpm). To inhibit the Tn5 reaction, 10 µL of 40 mM EDTA were added to each well with a BenchSmart™ 96 (Mettler Toledo) and the plate was incubated at 37 °C for 15 min with shaking (500 rpm). Next, 20 µL 2 × sort buffer (2% BSA, 2 mM EDTA in PBS) were added using a BenchSmart™ 96 (Mettler Toledo). All wells were combined into a FACS tube and stained with 3 µM Draq7 (Cell Signaling) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">27</xref>). Using a SH800 (Sony), 20 nuclei were sorted per well into eight 96-well plates (total of 768 wells) containing 10.5 µL EB (25 pmol primer i7, 25 pmol primer i5, 200 ng BSA (Sigma)<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>. Preparation of sort plates and all downstream pipetting steps were performed on a Biomek i7 Automated Workstation (Beckman Coulter). After addition of 1 µL 0.2% SDS, samples were incubated at 55 °C for 7 min with shaking (500 rpm). We added 1 µL 12.5% Triton-X to each well to quench the SDS and 12.5 µL NEBNext High-Fidelity 2× PCR Master Mix (NEB). Samples were PCR-amplified (72 °C 5 min, 98 °C 30 s, (98 °C 10 s, 63 °C 30 s, 72 °C 60 s) × 12 cycles, held at 12 °C). After PCR, all wells were combined. Libraries were purified according to the MinElute PCR Purification Kit manual (Qiagen) using a vacuum manifold (QIAvac 24 plus, Qiagen) and size selection was performed with SPRI Beads (Beckmann Coulter, 0.55× and 1.5×). Libraries were purified one more time with SPRI Beads (Beckmann Coulter, 1.5×). Libraries were quantified using a Qubit fluorimeter (Life technologies) and the nucleosomal pattern was verified using a Tapestation (High Sensitivity D1000, Agilent). The library was sequenced on a HiSeq2500 sequencer (Illumina) using custom sequencing primers, 25% spike-in library and following read lengths: 50 + 43 + 40 + 50 (Read1 + Index1 + Index2 + Read2)<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>.</p>
    </sec>
    <sec id="Sec42">
      <title>Reporting summary</title>
      <p id="Par110">Further information on research design is available in the <xref rid="MOESM3" ref-type="media">Nature Research Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec43">
      <supplementary-material content-type="local-data" id="MOESM1">
        <media xlink:href="41467_2021_21583_MOESM1_ESM.pdf">
          <caption>
            <p>Supplementary Infomation</p>
          </caption>
        </media>
      </supplementary-material>
      <supplementary-material content-type="local-data" id="MOESM2">
        <media xlink:href="41467_2021_21583_MOESM2_ESM.xlsx">
          <caption>
            <p>Supplementary Data 1</p>
          </caption>
        </media>
      </supplementary-material>
      <supplementary-material content-type="local-data" id="MOESM3">
        <media xlink:href="41467_2021_21583_MOESM3_ESM.pdf">
          <caption>
            <p>Reporting Summary</p>
          </caption>
        </media>
      </supplementary-material>
    </sec>
  </sec>
</body>
<back>
  <app-group>
    <app id="App1">
      <sec id="Sec44">
        <title>Source data</title>
        <p id="Par113">
          <media position="anchor" xlink:href="41467_2021_21583_MOESM4_ESM.xlsx" id="MOESM4">
            <caption>
              <p>Source Data</p>
            </caption>
          </media>
        </p>
      </sec>
    </app>
  </app-group>
  <fn-group>
    <fn>
      <p><bold>Peer review information</bold><italic>Nature Communications</italic> thanks the anonymous reviewer(s) for their contribution to the peer review of this work. Peer reviewer reports are available.</p>
    </fn>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p>The online version contains supplementary material available at 10.1038/s41467-021-21583-9.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank David Gorkin, Ramya Raviram, and James Hocker for suggestions. We thank Samantha Kuan for sequencing support. We thank Bin Li for Bioinformatics support. We thank Carolyn O’Connor and Conor Fitzpatrick at Salk Institute Flow Cytometry Core for sorting of nuclei. R.F. is is a Howard Hughes Medical Institute Fellow of the Damon Runyon Cancer Research Foundation (DRG- 2433-21). Y.Z was supported by NIH grant no. 1K99CA252020-01. Work at the Center for Epigenomics was supported in part by the UCSD School of Medicine. This study was funded by U19MH114831 to J.R.E, M.M.B and B.R.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>This study was conceived and designed by R.F. and B.R.; This study was supervised by J.R.E. and B.R. Pipeline developed by R.F.; Data analysis performed by R.F., Y.L., X.F., K.Z., Y.Z., and E.A.M.; Tissue collection and nuclei preparation performed by J.L. and M.M.B.; Single-nucleus ATAC-seq experiment performed by S.P., X.H., and X.W.; Tn5 enzymes purified and provided by A.M. and A.K.S.; Manuscript written by R.F., X.Z., and B.R. with input from all authors.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>Raw and processed data generated in this study have been deposited to NCBI Gene Expression Omnibus with the accession number <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE126724">GSE126724</ext-link>. Any data that support the findings of this study beyond what is included in the Supplementary Information are available from the corresponding author upon request. Please note that the information on where previously published data used within this study can be found in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>. <xref rid="Sec44" ref-type="sec">Source data</xref> are provided with this paper.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>The scripts and pipeline for the analysis can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/r3fang/SnapATAC">https://github.com/r3fang/SnapATAC</ext-link>.</p>
  </notes>
  <notes id="FPar1" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par111">B.R. is a co-founder and consultant for Arima Genomics, Inc., and a co-founder of Epigenome Technologies, Inc. The remaining authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <collab>The ENCODE Project Consortium.</collab>
        </person-group>
        <article-title>An integrated encyclopedia of DNA elements in the human genome</article-title>
        <source>Nature</source>
        <year>2012</year>
        <volume>489</volume>
        <fpage>57</fpage>
        <lpage>74</lpage>
        <pub-id pub-id-type="doi">10.1038/nature11247</pub-id>
        <pub-id pub-id-type="pmid">22955616</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shen</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A map of the cis-regulatory sequences in the mouse genome</article-title>
        <source>Nature</source>
        <year>2012</year>
        <volume>488</volume>
        <fpage>116</fpage>
        <lpage>120</lpage>
        <pub-id pub-id-type="doi">10.1038/nature11243</pub-id>
        <?supplied-pmid 22763441?>
        <pub-id pub-id-type="pmid">22763441</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buenrostro</surname>
            <given-names>JD</given-names>
          </name>
          <name>
            <surname>Giresi</surname>
            <given-names>PG</given-names>
          </name>
          <name>
            <surname>Zaba</surname>
            <given-names>LC</given-names>
          </name>
          <name>
            <surname>Chang</surname>
            <given-names>HY</given-names>
          </name>
          <name>
            <surname>Greenleaf</surname>
            <given-names>WJ</given-names>
          </name>
        </person-group>
        <article-title>Transposition of native chromatin for fast and sensitive epigenomic profiling of open chromatin, DNA-binding proteins and nucleosome position</article-title>
        <source>Nat. Methods</source>
        <year>2013</year>
        <volume>10</volume>
        <fpage>1213</fpage>
        <lpage>1218</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.2688</pub-id>
        <?supplied-pmid 24097267?>
        <pub-id pub-id-type="pmid">24097267</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Boyle</surname>
            <given-names>AP</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-resolution mapping and characterization of open chromatin across the genome</article-title>
        <source>Cell</source>
        <year>2008</year>
        <volume>132</volume>
        <fpage>311</fpage>
        <lpage>322</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2007.12.014</pub-id>
        <?supplied-pmid 18243105?>
        <pub-id pub-id-type="pmid">18243105</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cusanovich</surname>
            <given-names>DA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Multiplex single-cell profiling of chromatin accessibility by combinatorial cellular indexing</article-title>
        <source>Science</source>
        <year>2015</year>
        <volume>348</volume>
        <fpage>910</fpage>
        <lpage>914</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aab1601</pub-id>
        <?supplied-pmid 25953818?>
        <pub-id pub-id-type="pmid">25953818</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cusanovich</surname>
            <given-names>DA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The cis-regulatory dynamics of embryonic development at single-cell resolution</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>555</volume>
        <fpage>538</fpage>
        <lpage>542</lpage>
        <pub-id pub-id-type="doi">10.1038/nature25981</pub-id>
        <?supplied-pmid 29539636?>
        <pub-id pub-id-type="pmid">29539636</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Preissl</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-nucleus analysis of accessible chromatin in developing mouse forebrain reveals cell-type-specific transcriptional regulation</article-title>
        <source>Nat. Neurosci.</source>
        <year>2018</year>
        <volume>21</volume>
        <fpage>432</fpage>
        <pub-id pub-id-type="doi">10.1038/s41593-018-0079-3</pub-id>
        <?supplied-pmid 29434377?>
        <pub-id pub-id-type="pmid">29434377</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cusanovich</surname>
            <given-names>DA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell atlas of in vivo mammalian chromatin accessibility</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>174</volume>
        <fpage>1309</fpage>
        <lpage>1324.e18</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.06.052</pub-id>
        <?supplied-pmid 6158300?>
        <pub-id pub-id-type="pmid">30078704</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lake</surname>
            <given-names>BB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integrative single-cell analysis of transcriptional and epigenetic states in the human adult brain</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2018</year>
        <volume>36</volume>
        <fpage>70</fpage>
        <lpage>80</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4038</pub-id>
        <?supplied-pmid 29227469?>
        <pub-id pub-id-type="pmid">29227469</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buenrostro</surname>
            <given-names>JD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell chromatin accessibility reveals principles of regulatory variation</article-title>
        <source>Nature</source>
        <year>2015</year>
        <volume>523</volume>
        <fpage>486</fpage>
        <lpage>490</lpage>
        <pub-id pub-id-type="doi">10.1038/nature14590</pub-id>
        <?supplied-pmid 26083756?>
        <pub-id pub-id-type="pmid">26083756</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mezger</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-throughput chromatin accessibility profiling at single-cell resolution</article-title>
        <source>Nat. Commun.</source>
        <year>2018</year>
        <volume>9</volume>
        <fpage>3647</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-018-05887-x</pub-id>
        <?supplied-pmid 30194434?>
        <pub-id pub-id-type="pmid">30194434</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <mixed-citation publication-type="other">Satpathy, A. T. et al. Massively parallel single-cell chromatin landscapes of human immune cell development and intratumoral T cell exhaustion. <italic>bioRxiv</italic>10.1101/610550 (2019).</mixed-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <mixed-citation publication-type="other">Lareau, C. A. et al. Droplet-based combinatorial indexing for massive-scale single-cell chromatin accessibility. <italic>Nat. Biotechnol</italic>. 10.1038/s41587-019-0147-6 (2019).</mixed-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <mixed-citation publication-type="other">Fang, R. et al. <italic>Single Cell Analysis of Chromatin Accessibility</italic>. PhD dissertation, University of California San Diego (2019).</mixed-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <mixed-citation publication-type="other">Schep, A. N., Wu, B., Buenrostro, J. D. &amp; Greenleaf, W. J. chromVAR: inferring transcription-factor-associated accessibility from single-cell epigenomic data. <italic>Nat. Methods</italic><bold>14</bold>, 975–978 (2017).</mixed-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bravo González-Blas</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>cisTopic: cis-regulatory topic modeling on single-cell ATAC-seq data</article-title>
        <source>Nat. Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>397</fpage>
        <lpage>400</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0367-1</pub-id>
        <?supplied-pmid 30962623?>
        <pub-id pub-id-type="pmid">30962623</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <mixed-citation publication-type="other">de Boer, C. G. &amp; Regev, A. BROCKMAN: deciphering variance in epigenomic regulators by k-mer factorization. <italic>BMC Bioinformatics</italic><bold>19</bold>, 253 (2018).</mixed-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pliner</surname>
            <given-names>HA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cicero predicts cis-regulatory DNA interactions from single-cell chromatin accessibility data</article-title>
        <source>Mol. Cell</source>
        <year>2018</year>
        <volume>71</volume>
        <fpage>858</fpage>
        <lpage>871.e8</lpage>
        <pub-id pub-id-type="doi">10.1016/j.molcel.2018.06.044</pub-id>
        <?supplied-pmid 30078726?>
        <pub-id pub-id-type="pmid">30078726</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comprehensive integration of single-cell data</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>177</volume>
        <fpage>1888</fpage>
        <lpage>1902.e21</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.05.031</pub-id>
        <?supplied-pmid 31178118?>
        <pub-id pub-id-type="pmid">31178118</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Long</surname>
            <given-names>AW</given-names>
          </name>
          <name>
            <surname>Ferguson</surname>
            <given-names>AL</given-names>
          </name>
        </person-group>
        <article-title>Landmark diffusion maps (L-dMaps): accelerated manifold learning out-of-sample extension</article-title>
        <source>Appl. Comput. Harmon. Anal.</source>
        <year>2019</year>
        <volume>47</volume>
        <fpage>190</fpage>
        <lpage>211</lpage>
        <pub-id pub-id-type="doi">10.1016/j.acha.2017.08.004</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kumar</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Mohri</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Talwalkar</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Sampling methods for the Nyström method</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2012</year>
        <volume>13</volume>
        <fpage>981</fpage>
        <lpage>1006</lpage>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Heinz</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Simple combinations of lineage-determining transcription factors prime cis-regulatory elements required for macrophage and B cell identities</article-title>
        <source>Mol. Cell</source>
        <year>2010</year>
        <volume>38</volume>
        <fpage>576</fpage>
        <lpage>589</lpage>
        <pub-id pub-id-type="doi">10.1016/j.molcel.2010.05.004</pub-id>
        <?supplied-pmid 20513432?>
        <pub-id pub-id-type="pmid">20513432</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Robinson</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Smyth</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>K. edgeR: a Bioconductor package for differential expression analysis of digital gene expression data</article-title>
        <source>Bioinformatics</source>
        <year>2010</year>
        <volume>26</volume>
        <fpage>139</fpage>
        <lpage>140</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btp616</pub-id>
        <pub-id pub-id-type="pmid">19910308</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Korsunsky</surname>
            <given-names>I</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Fast, sensitive and accurate integration of single-cell data with Harmony</article-title>
        <source>Nat. Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>1289</fpage>
        <lpage>1296</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0619-0</pub-id>
        <?supplied-pmid 31740819?>
        <pub-id pub-id-type="pmid">31740819</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rubin</surname>
            <given-names>AJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Coupled single-cell CRISPR screening and epigenomic profiling reveals causal gene regulatory networks</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>176</volume>
        <fpage>361</fpage>
        <lpage>376.e17</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.11.022</pub-id>
        <?supplied-pmid 30580963?>
        <pub-id pub-id-type="pmid">30580963</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Model-based analysis of ChIP-Seq (MACS)</article-title>
        <source>Genome Biol.</source>
        <year>2008</year>
        <volume>9</volume>
        <fpage>R137</fpage>
        <pub-id pub-id-type="doi">10.1186/gb-2008-9-9-r137</pub-id>
        <?supplied-pmid 2592715?>
        <pub-id pub-id-type="pmid">18798982</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>McLean</surname>
            <given-names>CY</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>GREAT improves functional interpretation of cis-regulatory regions</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2010</year>
        <volume>28</volume>
        <fpage>495</fpage>
        <lpage>501</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.1630</pub-id>
        <?supplied-pmid 20436461?>
        <pub-id pub-id-type="pmid">20436461</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lieberman-Aiden</surname>
            <given-names>E</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comprehensive mapping of long-range interactions reveals folding principles of the human genome</article-title>
        <source>Science</source>
        <year>2009</year>
        <volume>326</volume>
        <fpage>289</fpage>
        <lpage>293</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1181369</pub-id>
        <?supplied-pmid 19815776?>
        <pub-id pub-id-type="pmid">19815776</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fairfax</surname>
            <given-names>BP</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Innate immune activity conditions the effect of regulatory variants upon monocyte gene expression</article-title>
        <source>Science</source>
        <year>2014</year>
        <volume>343</volume>
        <fpage>1246949</fpage>
        <lpage>1246949</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1246949</pub-id>
        <?supplied-pmid 24604202?>
        <pub-id pub-id-type="pmid">24604202</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhao</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Deng</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Gage</surname>
            <given-names>FH</given-names>
          </name>
        </person-group>
        <article-title>Mechanisms and functional implications of adult neurogenesis</article-title>
        <source>Cell</source>
        <year>2008</year>
        <volume>132</volume>
        <fpage>645</fpage>
        <lpage>660</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2008.01.033</pub-id>
        <?supplied-pmid 18295581?>
        <pub-id pub-id-type="pmid">18295581</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rosenberg</surname>
            <given-names>AB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell profiling of the developing mouse brain and spinal cord with split-pool barcoding</article-title>
        <source>Science</source>
        <year>2018</year>
        <volume>360</volume>
        <fpage>176</fpage>
        <lpage>182</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aam8999</pub-id>
        <?supplied-pmid 29545511?>
        <pub-id pub-id-type="pmid">29545511</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <mixed-citation publication-type="other">Street, K. et al. Slingshot: cell lineage and pseudotime inference for single-cell transcriptomics. <italic>BMC Genomics</italic><bold>19</bold>, 477 (2018).</mixed-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Assessment of computational methods for the analysis of single-cell ATAC-seq data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>241</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1854-5</pub-id>
        <?supplied-pmid 31739806?>
        <pub-id pub-id-type="pmid">31739806</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wu</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The landscape of accessible chromatin in mammalian preimplantation embryos</article-title>
        <source>Nature</source>
        <year>2016</year>
        <volume>534</volume>
        <fpage>652</fpage>
        <lpage>657</lpage>
        <pub-id pub-id-type="doi">10.1038/nature18606</pub-id>
        <?supplied-pmid 27309802?>
        <pub-id pub-id-type="pmid">27309802</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rao</surname>
            <given-names>SSP</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A 3D map of the human genome at kilobase resolution reveals principles of chromatin looping</article-title>
        <source>Cell</source>
        <year>2014</year>
        <volume>159</volume>
        <fpage>1665</fpage>
        <lpage>1680</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2014.11.021</pub-id>
        <?supplied-pmid 25497547?>
        <pub-id pub-id-type="pmid">25497547</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ecker</surname>
            <given-names>JR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The BRAIN initiative cell census consortium: lessons learned toward generating a comprehensive brain cell atlas</article-title>
        <source>Neuron</source>
        <year>2017</year>
        <volume>96</volume>
        <fpage>542</fpage>
        <lpage>557</lpage>
        <pub-id pub-id-type="doi">10.1016/j.neuron.2017.10.007</pub-id>
        <?supplied-pmid 29096072?>
        <pub-id pub-id-type="pmid">29096072</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolock</surname>
            <given-names>SL</given-names>
          </name>
          <name>
            <surname>Lopez</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Klein</surname>
            <given-names>AM</given-names>
          </name>
        </person-group>
        <article-title>Scrublet: computational identification of cell doublets in single-cell transcriptomic data</article-title>
        <source>Cell Syst.</source>
        <year>2019</year>
        <volume>8</volume>
        <fpage>281</fpage>
        <lpage>291.e9</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2018.11.005</pub-id>
        <?supplied-pmid 30954476?>
        <pub-id pub-id-type="pmid">30954476</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <mixed-citation publication-type="other">Huang, Z. J. &amp; Paul, A. The diversity of GABAergic neurons and neural communication elements. <italic>Nat. Rev. Neurosci.</italic>10.1038/s41583-019-0195-4 (2019).</mixed-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tasic</surname>
            <given-names>B</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Adult mouse cortical cell taxonomy revealed by single cell transcriptomics</article-title>
        <source>Nat. Neurosci.</source>
        <year>2016</year>
        <volume>19</volume>
        <fpage>335</fpage>
        <lpage>346</lpage>
        <pub-id pub-id-type="doi">10.1038/nn.4216</pub-id>
        <?supplied-pmid 26727548?>
        <pub-id pub-id-type="pmid">26727548</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <mixed-citation publication-type="other">Graybuck, L. T. et al. <italic>Prospective, brain-wide labeling of neuronal subclasses with enhancer-driven AAVs.</italic><ext-link ext-link-type="uri" xlink:href="http://biorxiv.org/lookup/doi/10.1101/525014">http://biorxiv.org/lookup/doi/10.1101/525014</ext-link> (2019).</mixed-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mayer</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Developmental diversification of cortical inhibitory interneurons</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>555</volume>
        <fpage>457</fpage>
        <lpage>462</lpage>
        <pub-id pub-id-type="doi">10.1038/nature25999</pub-id>
        <?supplied-pmid 29513653?>
        <pub-id pub-id-type="pmid">29513653</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Visel</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Minovitsky</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Dubchak</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Pennacchio</surname>
            <given-names>LA</given-names>
          </name>
        </person-group>
        <article-title>VISTA Enhancer Browser—a database of tissue-specific human enhancers</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2007</year>
        <volume>35</volume>
        <fpage>D88</fpage>
        <lpage>D92</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkl822</pub-id>
        <?supplied-pmid 17130149?>
        <pub-id pub-id-type="pmid">17130149</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <mixed-citation publication-type="other">Gorkin, D. et al. Systematic mapping of chromatin state landscapes during mouse development. <italic>bioRxiv</italic>10.1101/166652 (2017).</mixed-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Phillips</surname>
            <given-names>JE</given-names>
          </name>
          <name>
            <surname>Corces</surname>
            <given-names>VG</given-names>
          </name>
        </person-group>
        <article-title>CTCF: master weaver of the genome</article-title>
        <source>Cell</source>
        <year>2009</year>
        <volume>137</volume>
        <fpage>1194</fpage>
        <lpage>1211</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2009.06.001</pub-id>
        <?supplied-pmid 19563753?>
        <pub-id pub-id-type="pmid">19563753</pub-id>
      </element-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kageyama</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Ishibashi</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Takebayashi</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Tomita</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>bHLH Transcription factors and mammalian neuronal differentiation</article-title>
        <source>Int. J. Biochem. Cell Biol.</source>
        <year>1997</year>
        <volume>29</volume>
        <fpage>1389</fpage>
        <lpage>1399</lpage>
        <pub-id pub-id-type="doi">10.1016/S1357-2725(97)89968-2</pub-id>
        <?supplied-pmid 9570134?>
        <pub-id pub-id-type="pmid">9570134</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <mixed-citation publication-type="other">Erichson, N. B., Mathelin, L., Brunton, S. L. &amp; Kutz, J. N. Diffusion maps meet Nystrom. <italic>arXiv </italic><ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1802.08762">https://arxiv.org/abs/1802.08762</ext-link> (2018).</mixed-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zeisel</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Molecular architecture of the mouse nervous system</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>174</volume>
        <fpage>999</fpage>
        <lpage>1014.e22</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.06.021</pub-id>
        <?supplied-pmid 30096314?>
        <pub-id pub-id-type="pmid">30096314</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Yan</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Powell</surname>
            <given-names>DR</given-names>
          </name>
          <name>
            <surname>Curtis</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Wong</surname>
            <given-names>NC</given-names>
          </name>
        </person-group>
        <article-title>From reads to insight: a hitchhiker’s guide to ATAC-seq data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>22</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-1929-3</pub-id>
        <?supplied-pmid 32014034?>
        <pub-id pub-id-type="pmid">32014034</pub-id>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Blondel</surname>
            <given-names>VD</given-names>
          </name>
          <name>
            <surname>Guillaume</surname>
            <given-names>J-L</given-names>
          </name>
          <name>
            <surname>Lambiotte</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Lefebvre</surname>
            <given-names>E</given-names>
          </name>
        </person-group>
        <article-title>Fast unfolding of communities in large networks</article-title>
        <source>J. Stat. Mech. Theory Exp.</source>
        <year>2008</year>
        <volume>2008</volume>
        <fpage>P10008</fpage>
        <pub-id pub-id-type="doi">10.1088/1742-5468/2008/10/P10008</pub-id>
      </element-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">Hafemeister, C. &amp; Satija, R. Normalization and variance stabilization of single-cell RNA-seq data using regularized negative binomial regression. <italic>bioRxiv</italic>10.1101/576827 (2019).</mixed-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <mixed-citation publication-type="other">Li, M., Kwok, J. T. &amp; Lu, B.-L. Making large-scale Nyström approximation possible. in <italic>Proc. 27th International Conference on Machine Learning</italic> 631–638 (2010).</mixed-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <mixed-citation publication-type="other">Kumar, S., Mohri, M. &amp; Talwalkar, A. Ensemble Nyström method. in <italic>Proc. 22nd International Conference on Neural Information Processing Systems</italic> 1060–1068 (2009).</mixed-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Luo</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell methylomes identify neuronal subtypes and regulatory elements in mammalian cortex</article-title>
        <source>Science</source>
        <year>2017</year>
        <volume>357</volume>
        <fpage>600</fpage>
        <lpage>604</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aan3351</pub-id>
        <?supplied-pmid 28798132?>
        <pub-id pub-id-type="pmid">28798132</pub-id>
      </element-citation>
    </ref>
    <ref id="CR54">
      <label>54.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lister</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Global epigenomic reconfiguration during mammalian brain development</article-title>
        <source>Science</source>
        <year>2013</year>
        <volume>341</volume>
        <fpage>1237905</fpage>
        <pub-id pub-id-type="doi">10.1126/science.1237905</pub-id>
        <?supplied-pmid 23828890?>
        <pub-id pub-id-type="pmid">23828890</pub-id>
      </element-citation>
    </ref>
    <ref id="CR55">
      <label>55.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Picelli</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Tn5 transposase and tagmentation procedures for massively scaled sequencing projects</article-title>
        <source>Genome Res.</source>
        <year>2014</year>
        <volume>24</volume>
        <fpage>2033</fpage>
        <lpage>2040</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.177881.114</pub-id>
        <?supplied-pmid 25079858?>
        <pub-id pub-id-type="pmid">25079858</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
